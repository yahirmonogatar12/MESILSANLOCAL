<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Material - Almac√©n</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=LG+regular&display=swap" rel="stylesheet">
    
    <!-- Estilos globales -->
    <link rel="stylesheet" href="/static/css/control_material_almacen.css">
    
    <!-- Estilos responsive para m√≥vil -->
    <link rel="stylesheet" href="/static/css/control_material_almacen_responsive.css">
    
    <!-- Scripts necesarios -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/fontawesome.all.min.js"></script>
    <script src="/static/js/Chart.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script src="/static/js/sweetalert2.all.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/daterangepicker.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/flatpickr.min.js"></script>
    <script src="/static/js/autoNumeric.min.js"></script>
    <script src="/static/js/control_material_almacen.js"></script>
    
    
</head>
<body>
<!-- Fila 1: SOLO Forma de material, ancho completo -->
<div class="material-container2">

    <div class="material-form-section">
        <div class="material-form-group" >
            <label>
                    Forma de material
            </label>
            <select id="forma_material">
                <option>
                    OriginCode
                </option>
            </select>
        </div>
    </div>

    <div class="material-form-section">    
        <div class="material-form-row four-column">
            <div class="material-form-group">
                <label>
                    Cliente
                </label>
                <select id="cliente">
                    <option value="">
                        Seleccionar
                    </option>
                    <option value="LG_REFRIS">
                        LG_REFRIS
                    </option>
                    <option value="LG_ESTUFAS">
                        LG_ESTUFAS
                    </option>
                </select>
            </div>
            <div class="material-form-group">
                <label>C√≥digo de material original</label>
                <div style="display: flex; align-items: center; gap: 8px; min-width: 0;">
                    <input type="text" id="codigoMaterialOriginal" style="flex: 1; min-width: 0;" placeholder="Escanear o ingresar c√≥digo..." onkeydown="procesarScaneo(event)">
                    <button type="button" onclick="abrirEscanerQR()" class="material-btn mobile-only-btn" title="Escanear QR con c√°mara" style="padding: 5px 12px; font-size: 16px; line-height: 1;">üì∏</button>
                </div>
            </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>C√≥digo de material</label>
            <div style="position: relative; min-width: 0;">
                <select id="codigoMaterialSelect" onclick="event.preventDefault(); abrirModalCodigoMaterial();" readonly style="cursor: pointer; width: 100%;">
                    <option value="">Seleccionar</option>
                </select>
                
          
                <div id="modalCodigoMaterial" class="dropdown-modal">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar c√≥digo, nombre o especificaci√≥n..." onkeyup="filtrarTablaModal()">
                    <div class="dropdown-table-container">
                        <table class="dropdown-table">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Especificaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCodigosBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="material-form-group">
            <label>Material importaci√≥n/local</label>
            <select id="material_importacion_local">
                <option value="Customer Supply">Customer Supply</option>
                <option value="Local">Local</option>
                <option value="Importaci√≥n">Importaci√≥n</option>
            </select>
        </div>
        <div class="material-form-group">
            <label>Fecha de recibo</label>
            <input type="date" id="fecha_recibo">
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>
    <div class="material-form-row four-column">
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Fecha de fabricaci√≥n</label>
            <input type="date" id="fecha_fabricacion">
        </div>
        <div class="material-form-group">
            <label>Cantidad actual:</label>
            <input type="text" id="cantidad_actual">
        </div>
        <div class="material-form-group">
            <label>N√∫mero de lote de material</label>
            <input type="text" id="numero_lote_material">
        </div>
    </div>
        </div>
        
    
<div class="material-form-section2">
    <div class="material-form-row four-column" style="align-items: center;">
        <div class="material-form-group">
            <label>C√≥digo de material recibido</label>
            <input type="text" id="codigo_material_recibido">
        </div>
        <div class="material-form-group">
            <label>N√∫mero de parte:</label>
            <input type="text" id="numero_parte_lower">
        </div>
        <div class="material-form-group">
            <label>Cantidad estandarizada</label>
            <input type="text" id="cantidad_estandarizada">
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        
        <div class="material-form-group">
            <label>C√≥digo de material</label>
            <input type="text" id="codigo_material_lower">
        </div>
        <div class="material-form-group">
            <label>Propiedad de material</label>
            <input type="text" id="propiedad_material">
        </div>
        <div class="material-form-group">
            <label>Especificaci√≥n de material</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="almacen_especificacion_material" readonly placeholder="Se carga autom√°ticamente al seleccionar c√≥digo" style="flex: 1;">
                <label class="checkbox-label-almacen" style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer; white-space: nowrap;">
                    <input type="checkbox" id="checkbox_registro_almacen" class="checkbox-almacen" style="transform: scale(1.0); accent-color: #27ae60;">
                    Registro autom√°tico
                </label>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group"></div>
        <div class="material-form-group"></div>
        <div class="material-form-group" style="justify-self: end;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <button class="material-btn orange botones-almacen" id="btnGuardar" onclick="guardarFormulario()">Guardar</button>
                <button class="material-btn botones-almacen" id="btnImprimir" onclick="manejarImpresion()">Imprimir</button>
                <button class="material-btn botones-almacen" id="btnConfigImpresora" onclick="verificarImpresoraZebra()" style="background: #6c757d; font-size: 9px; padding: 6px 8px; min-width: 80px; text-align: center;">CONF. DE IMPRESORA</button>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>
</div>

        <!-- Botonera usando el dise√±o de CONTROL_DE_MATERIAL -->
        

        <!-- Secci√≥n de filtros usando el dise√±o de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; overflow: hidden;">
                <label style="margin: 0; color: lightgray; font-size: 11px; white-space: nowrap;">Fecha de recibo</label>
                <input type="date" id="filtro_fecha_inicio" style="width: 130px; height: 24px; font-size: 10px; font-family: sans-serif; min-width: 100px;">
                <span style="color: lightgray; font-size: 11px;">~</span>
                <input type="date" id="filtro_fecha_fin" style="width: 130px; height: 24px; font-size: 10px; min-width: 100px;">
            </div>
            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button class="material-btn" id="btnConsultar" onclick="consultarRegistros()">Consultar</button>
                <button class="material-btn secondary" onclick="exportarExcel()">Exportar Excel</button>
            </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="material-table-container">
            <table class="material-table" id="tablaControlAlmacen">
                <thead>
                    <tr>
                        <th>C√≥digo de material recibido</th>
                        <th>C√≥digo de material</th>
                        <th>N√∫mero de parte</th>
                        <th>N√∫mero de lote de material</th>
                        <th>Propiedad de material</th>
                        <th>Cantidad actual</th>
                        <th>Cantidad estandarizada</th>
                        <th>Ubicaci√≥n de salida</th>
                        <th>Fecha de recibo</th>
                        <th>Especificaci√≥n</th>
                        <th>Material importaci√≥n/local</th>
                        <th>Estado de desecho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="12" class="no-data">
                            No hay datos para mostrar. Haga clic en "Consultar" para cargar los registros.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p class="total-info">Total Rows: 0</p>
        </div>

    </div>

    <style>
        /* Estilos para selecci√≥n de filas de tabla */
        .fila-seleccionada {
            background-color: #007bff !important;
            color: white !important;
        }
        
        .fila-clickeable {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .fila-clickeable:hover {
            background-color: #f0f8ff !important;
        }
        
        .fila-seleccionada:hover {
            background-color: #0056b3 !important;
        }
    </style>

    <script>
        // Funci√≥n para resolver error de closeMobileSidebar
        function closeMobileSidebar() {
            // Esta funci√≥n es llamada desde alg√∫n lugar pero no estaba definida
            // Agregar l√≥gica aqu√≠ si es necesario cerrar alg√∫n sidebar m√≥vil
        }
        
        let codigosMaterial = [];
        
        // Variables para manejo de selecci√≥n de tabla
        let filaSeleccionada = null;
        let datosFilaSeleccionada = null;

        // FUNCIONES DIRECTAS PARA BOTONES DE PRUEBA ZPL
        function mostrarEjemploZPLDirecto() {
            const datosEjemplo = {
                codigoCompleto: '0RH5602C622,202507170003',
                codigoMaterial: '0RH5602C622',
                numeroSerie: '202507170003',
                fecha: '17/07/2025',
                cantidadEstandarizada: '5000',
                descripcionMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            const zplEjemplo = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT188,55^A0N,16,15^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT187,102^A0N,18,18^FH\\^CI28^FDQTY:^FS^CI27
^FT5,95^BQN,2,8
^FH\\^FDLA,${datosEjemplo.codigoCompleto}^FS
^FT188,15^A0N,25,25^FH\\^CI28^FD${datosEjemplo.codigoMaterial}^FS^CI27
^FT188,40^A0N,25,25^FH\\^CI28^FD${datosEjemplo.numeroSerie}^FS^CI27
^FT188,75^A0N,21,20^FH\\^CI28^FD${datosEjemplo.fecha}^FS^CI27
^FT188,125^A0N,21,20^FH\\^CI28^FD${datosEjemplo.descripcionMaterial}^FS^CI27
^FT188,147^A0N,21,20^FH\\^CI28^FD^FS^CI27
^FT223,104^A0N,22,20^FH\\^CI28^FD${datosEjemplo.cantidadEstandarizada}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                align-items: center; z-index: 10003; padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                        üìã Formato ZPL Actualizado - Zebra ZD421
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #6f42c1; margin-bottom: 10px;">üìä Variables que se insertan autom√°ticamente:</h4>
                        <ul style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 0;">
                            <li><strong>C√≥digo completo:</strong> ${datosEjemplo.codigoCompleto}</li>
                            <li><strong>C√≥digo material:</strong> ${datosEjemplo.codigoMaterial}</li>
                            <li><strong>N√∫mero serie:</strong> ${datosEjemplo.numeroSerie}</li>
                            <li><strong>Fecha entrada:</strong> ${datosEjemplo.fecha}</li>
                            <li><strong>Cantidad:</strong> ${datosEjemplo.cantidadEstandarizada}</li>
                            <li><strong>Descripci√≥n:</strong> ${datosEjemplo.descripcionMaterial}</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">üñ®Ô∏è Comando ZPL Generado:</h4>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; border: 1px solid #dee2e6;">${zplEjemplo}</pre>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #dc3545; margin-bottom: 10px;">‚ö° Caracter√≠sticas del formato:</h4>
                        <ul style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 0; border: 1px solid #ffeaa7;">
                            <li>‚úÖ Compatible con Zebra ZD421</li>
                            <li>‚úÖ C√≥digo QR autom√°tico con datos completos</li>
                            <li>‚úÖ Variables din√°micas del formulario</li>
                            <li>‚úÖ Formato de fecha DD/MM/YYYY</li>
                            <li>‚úÖ Campos de cantidad y descripci√≥n configurables</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="this.closest('div').parentNode.remove()" 
                            style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            ‚úì Entendido
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Funci√≥n global para inicializar cuando se muestra el control de almac√©n
        window.inicializarControlAlmacenModule = function() {
            // Peque√±o delay para asegurar que el DOM est√© completamente renderizado
            setTimeout(() => {
                inicializarControlAlmacen();
                configurarListenersAdicionales();
                // Asegurar que las fechas siempre est√©n actuales al cambiar de m√≥dulo
                establecerFechasActuales();
            }, 100);
        };

        // Cargar c√≥digos de material al cargar la p√°gina
        function inicializarControlAlmacen() {
            // *** TABLA VISIBLE POR DEFECTO PARA DEBUGGING ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            // Establecer fecha actual en todos los campos de fecha
            establecerFechasActuales();
            
            cargarCodigosMaterial();
            cargarClienteSeleccionado(); // Cargar la √∫ltima selecci√≥n de cliente
            cargarSiguienteSecuencial(); // Cargar el siguiente n√∫mero secuencial
        }

        // Nueva funci√≥n para establecer fechas actuales
        function establecerFechasActuales() {
            // Usar el mismo m√©todo que setFechasHoy() para evitar problemas de zona horaria
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fechaHoy = `${year}-${month}-${day}`;
            
            // Establecer fecha actual en campos principales
            const fechaRecibo = document.getElementById('fecha_recibo');
            const fechaFabricacion = document.getElementById('fecha_fabricacion');
            const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
            const filtroFechaFin = document.getElementById('filtro_fecha_fin');
            
            if (fechaRecibo) fechaRecibo.value = fechaHoy;
            if (fechaFabricacion) fechaFabricacion.value = fechaHoy;
            if (filtroFechaInicio) filtroFechaInicio.value = fechaHoy;
            if (filtroFechaFin) filtroFechaFin.value = fechaHoy;
        }

        // Verificar si el DOM ya est√° listo o esperar a que lo est√©
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarControlAlmacen);
        } else {
            // DOM ya est√° listo, ejecutar inmediatamente
            inicializarControlAlmacen();
        }

        // Funci√≥n para cargar la √∫ltima selecci√≥n de cliente
        async function cargarClienteSeleccionado() {
            try {
                const response = await fetch('/cargar_cliente_seleccionado');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cliente) {
                        const selectCliente = document.getElementById('cliente');
                        if (selectCliente) {
                            selectCliente.value = data.cliente;
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar cliente seleccionado:', error);
            }
        }

        // Funci√≥n para guardar la selecci√≥n de cliente
        async function guardarClienteSeleccionado(cliente) {
            try {
                const response = await fetch('/guardar_cliente_seleccionado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cliente: cliente })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (!data.success) {
                        console.error('‚ùå Error al guardar cliente:', data.error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al guardar cliente:', error);
            }
        }

        async function cargarCodigosMaterial() {
            try {
                const response = await fetch('/obtener_codigos_material');
                
                if (response.ok) {
                    codigosMaterial = await response.json();
                } else {
                    console.error('Error al cargar c√≥digos de material, status:', response.status);
                    // Si hay error, usar datos de prueba
                    codigosMaterial = [
                        {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                        {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                        {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                    ];
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                // Si hay error, usar datos de prueba
                codigosMaterial = [
                    {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                    {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                    {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                ];
            }
        }

        function abrirModalCodigoMaterial() {
            const modal = document.getElementById('modalCodigoMaterial');
            const tbody = document.getElementById('tablaCodigosBody');
            const searchInput = document.getElementById('searchInput');
            
            // Cerrar otros dropdowns si est√°n abiertos
            cerrarModalCodigoMaterial();
            
            // Limpiar b√∫squeda
            searchInput.value = '';
            
            // Llenar la tabla
            tbody.innerHTML = '';
            
            if (codigosMaterial.length === 0) {
                // Mostrar mensaje de "no hay datos"
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: #666;">No hay c√≥digos disponibles</td>';
            } else {
                codigosMaterial.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
            
            // Mostrar el modal con animaci√≥n suave
            modal.style.display = 'block';
            
            // Enfocar el campo de b√∫squeda
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }

        function cerrarModalCodigoMaterial() {
            document.getElementById('modalCodigoMaterial').style.display = 'none';
        }

        function seleccionarCodigo(codigo) {
            const select = document.getElementById('codigoMaterialSelect');
            
            // Buscar la informaci√≥n completa del c√≥digo seleccionado
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigo);
            
            // Actualizar el select con el c√≥digo seleccionado
            select.innerHTML = `
                <option value="${codigo}" selected>${codigo}</option>
                <option value="">Seleccionar</option>
            `;
            
            // Mostrar la especificaci√≥n inmediatamente al seleccionar
            if (codigoCompleto) {
                select.title = `${codigoCompleto.codigo} - ${codigoCompleto.nombre} - ${codigoCompleto.spec}`;
                
                // Llenar inmediatamente el campo de especificaci√≥n
                llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || codigoCompleto.spec || '');
            }
            
            cerrarModalCodigoMaterial();
            
            // Llenar autom√°ticamente los campos inferiores despu√©s de seleccionar
            setTimeout(() => {
                llenarCamposInferiores(codigo);
            }, 500);
        }

        function filtrarTablaModal() {
            const input = document.getElementById('searchInput');
            const filtro = input.value.toLowerCase();
            const tbody = document.getElementById('tablaCodigosBody');
            
            tbody.innerHTML = '';
            
            const codigosFiltrados = codigosMaterial.filter(codigo => 
                codigo.codigo.toLowerCase().includes(filtro) ||
                codigo.nombre.toLowerCase().includes(filtro) ||
                codigo.spec.toLowerCase().includes(filtro)
            );
            
            if (codigosFiltrados.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 15px;">No se encontraron resultados</td>';
            } else {
                codigosFiltrados.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCodigoMaterial');
            const select = document.getElementById('codigoMaterialSelect');
            
            // Si se hace clic fuera del modal y del select, cerrar el modal
            if (!modal.contains(event.target) && !select.contains(event.target)) {
                cerrarModalCodigoMaterial();
            }
        });

        // Configurar listeners adicionales cuando la p√°gina est√© lista
        function configurarListenersAdicionales() {
            // Agregar event listener al select de cliente
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    const clienteSeleccionado = this.value;
                    if (clienteSeleccionado) {
                        guardarClienteSeleccionado(clienteSeleccionado);
                        
                        // Resaltar visualmente que se guard√≥
                        this.style.backgroundColor = '#d4edda';
                        this.style.borderColor = '#c3e6cb';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, 1500);
                    }
                });
            }
            
            // Agregar listener adicional al bot√≥n de consultar para asegurar que funcione
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', function(e) {
                    // Solo prevenir default si no hay onclick definido
                    if (!this.onclick) {
                        e.preventDefault();
                        consultarRegistros();
                    }
                });
            }
        }

        // Verificar si el DOM ya est√° listo para configurar listeners adicionales
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarListenersAdicionales);
        } else {
            // DOM ya est√° listo, ejecutar inmediatamente
            configurarListenersAdicionales();
        }

        function procesarScaneo(event) {
            // Detectar Enter (cuando termina el escaneo)
            if (event.key === 'Enter') {
                event.preventDefault();
                const codigoCompleto = event.target.value.trim();
                
                if (codigoCompleto) {
                    parsearYDistribuirCodigo(codigoCompleto);
                }
            }
        }

        function procesarCodigoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const codigoCompleto = input.value.trim();
            
            if (codigoCompleto) {
                parsearYDistribuirCodigo(codigoCompleto);
            } else {
                alert('Por favor, ingrese o escanear un c√≥digo antes de procesar.');
            }
        }

        async function parsearYDistribuirCodigo(codigoCompleto) {
            try {
                // Primero intentar con las reglas de trazabilidad
                const resultado = await aplicarReglasEscaneo(codigoCompleto);
                
                if (resultado) {
                    // Si se encontr√≥ una regla que coincide, usar esos datos
                    if (resultado.partNumber) {
                        // Usar el partNumber como c√≥digo de material
                        buscarYSeleccionarCodigoMaterial(resultado.partNumber);
                    }
                    
                    if (resultado.lotNumber) {
                        const inputLote = document.getElementById('numero_lote_material');
                        if (inputLote) {
                            inputLote.value = resultado.lotNumber;
                        }
                    }
                    
                    mostrarNotificacionEscaneo(resultado.partNumber, null, resultado.lotNumber);
                    return;
                }
                
                // Si no funciona con reglas, usar el m√©todo anterior como fallback
                const partes = codigoCompleto.split('-');
                
                if (partes.length < 8) {
                    alert('Formato de c√≥digo inv√°lido. No se encontr√≥ regla aplicable y no tiene el formato esperado con "/" ');
                    return;
                }
                
                // Extraer SOLO el c√≥digo de material y n√∫mero de lote (m√©todo anterior)
                const codigoMaterial = partes[0];           // M2124740058
                const numeroLote = partes[7];               // IA3116H14
                
                // Distribuir a los campos correspondientes
                if (codigoMaterial) {
                    buscarYSeleccionarCodigoMaterial(codigoMaterial);
                }
                
                if (numeroLote) {
                    const inputLote = document.getElementById('numero_lote_material');
                    if (inputLote) {
                        inputLote.value = numeroLote;
                    }
                }
                
                mostrarNotificacionEscaneo(codigoMaterial, null, numeroLote);
                
            } catch (error) {
                console.error('Error al procesar c√≥digo escaneado:', error);
                alert('Error al procesar el c√≥digo escaneado');
            }
        }

        function buscarYSeleccionarCodigoMaterial(codigo) {
            // Buscar si el c√≥digo existe en la lista de materiales
            const codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
            
            if (codigoEncontrado) {
                // Si existe, seleccionarlo autom√°ticamente
                seleccionarCodigo(codigo);
            } else {
                // Si no existe, mostrar en el dropdown pero sin seleccionar
                const select = document.getElementById('codigoMaterialSelect');
                select.innerHTML = `
                    <option value="${codigo}" selected>${codigo} (C√≥digo escaneado - no encontrado en BD)</option>
                    <option value="">Seleccionar</option>
                `;
                select.style.backgroundColor = '#fff3cd'; // Resaltar en amarillo
                console.warn('C√≥digo de material no encontrado en la base de datos:', codigo);
                
                // Tambi√©n llenar campos b√°sicos aunque no est√© en BD
                llenarCamposInferiores(codigo);
                
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 3000);
            }
        }

        function mostrarNotificacionEscaneo(codigo, cantidad, lote) {
            // Llenar autom√°ticamente los campos inferiores
            llenarCamposInferiores(codigo);
        }

        // Contador global para n√∫meros secuenciales del c√≥digo de material recibido
        let contadorSecuencial = 1;
        let proximoCodigoCompleto = '';

        // Funci√≥n para cargar el siguiente n√∫mero secuencial desde la base de datos
        async function cargarSiguienteSecuencial(codigoMaterial = '') {
            try {
                // Construir URL con c√≥digo de material si est√° disponible
                let url = '/obtener_siguiente_secuencial';
                if (codigoMaterial) {
                    url += `?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                }
                
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        contadorSecuencial = data.siguiente_secuencial || 1;
                        proximoCodigoCompleto = data.proximo_codigo_completo || '';
                        
                    } else {
                        contadorSecuencial = 1;
                        proximoCodigoCompleto = '';
                        console.warn(`‚ö†Ô∏è Respuesta sin √©xito, usando valores por defecto`);
                    }
                } else {
                    contadorSecuencial = 1;
                    proximoCodigoCompleto = '';
                    console.error(`‚ùå Error en respuesta HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al cargar secuencial:', error);
                contadorSecuencial = 1;
                proximoCodigoCompleto = '';
            }
        }

        function llenarCamposInferiores(codigoMaterial) {
            
            // Buscar la informaci√≥n completa del c√≥digo de material
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
            
            // FORZAR recarga del contador espec√≠fico para este c√≥digo de material
            
            cargarSiguienteSecuencial(codigoMaterial).then(() => {
                
                // USAR DIRECTAMENTE proximoCodigoCompleto del servidor
                let codigoMaterialRecibidoCompleto = proximoCodigoCompleto;
                
                // Solo como fallback si el servidor no devuelve el c√≥digo completo
                if (!codigoMaterialRecibidoCompleto) {
                    const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const secuenciaFormateada = String(contadorSecuencial).padStart(4, '0');
                    codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}${secuenciaFormateada}`;
                    console.warn(`‚ö†Ô∏è Usando c√≥digo generado como fallback: ${codigoMaterialRecibidoCompleto}`);
                }
                
                
                if (codigoCompleto) {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ‚úÖ CORREGIDO: Usar el verdadero n√∫mero de parte de la base de datos
                    llenarCampoPorId('numero_parte_lower', codigoCompleto.numero_parte || '');
                    llenarCampoPorId('cantidad_estandarizada', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('cantidad_actual', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('propiedad_material', codigoCompleto.propiedad_material || '');
                    llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || '');
                    llenarCampoPorId('numero_lote_material', '');
                    
                } else {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ‚úÖ CORREGIDO: Si no hay informaci√≥n completa, dejar vac√≠o en lugar de usar secuencial
                    llenarCampoPorId('numero_parte_lower', '');
                    llenarCampoPorId('almacen_especificacion_material', '');
                    llenarCampoPorId('numero_lote_material', '');
                }
            }).catch(error => {
                console.error('‚ùå Error al cargar secuencial:', error);
                // En caso de error, usar valores por defecto
                const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}0001`;
                llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                llenarCampoPorId('codigo_material_lower', codigoMaterial);
                // ‚úÖ CORREGIDO: Si hay error, usar el n√∫mero de parte de la selecci√≥n (si existe)
                const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
                llenarCampoPorId('numero_parte_lower', codigoCompleto ? (codigoCompleto.numero_parte || '') : '');
            });
        }

        function llenarCampoPorId(idCampo, valor) {
            const campo = document.getElementById(idCampo);
            if (campo && valor) {
                campo.value = valor;
                
                // Resaltar visualmente el campo que se llen√≥
                campo.style.backgroundColor = '#e3f2fd';
                campo.style.transition = 'background-color 0.3s';
                
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 2000);
                
            } else if (!campo) {
                console.warn(`‚ùå Campo no encontrado con ID: ${idCampo}`);
            } else if (!valor) {
                console.warn(`‚ö†Ô∏è Valor vac√≠o para campo: ${idCampo}`);
            }
        }

        function llenarCampoInferior(labelTexto, valor) {
            const labels = document.querySelectorAll('label');
            let campoEncontrado = false;
            
            // Buscar desde el final hacia atr√°s para encontrar los campos inferiores
            for (let i = labels.length - 1; i >= 0; i--) {
                const label = labels[i];
                if (label.textContent.includes(labelTexto)) {
                    // Si es "C√≥digo de material:" tomar el √∫ltimo (inferior)
                    if (labelTexto === 'C√≥digo de material:' && campoEncontrado) {
                        continue; // Saltar el primero, queremos el √∫ltimo
                    }
                    
                    const input = label.parentNode.querySelector('input');
                    if (input) {
                        input.value = valor;
                        input.style.backgroundColor = '#e3f2fd'; // Resaltar en azul claro
                        input.style.transition = 'background-color 0.3s';
                        
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 3000);
                        
                        campoEncontrado = true;
                        
                        // Para "C√≥digo de material:" solo tomar el √∫ltimo
                        if (labelTexto !== 'C√≥digo de material:') {
                            break;
                        }
                    }
                }
            }
            
            if (!campoEncontrado) {
                console.warn('Campo no encontrado:', labelTexto);
            }
        }

        // Funci√≥n para reiniciar el contador (opcional, para usar cuando sea necesario)
        // Funci√≥n para recargar el contador desde la base de datos
        function recargarContador() {
            cargarSiguienteSecuencial();
        }

        // Funci√≥n opcional para forzar recarga del contador (para testing/debug)
        function forzarRecargaContador() {
            cargarSiguienteSecuencial().then(() => {
            });
        }

        // Funci√≥n para verificar y llenar manualmente (para testing)
        function llenarCamposInferioresManual() {
            const selectCodigo = document.getElementById('codigoMaterialSelect');
            const codigoSeleccionado = selectCodigo.value;
            
            if (codigoSeleccionado) {
                llenarCamposInferiores(codigoSeleccionado);
            } else {
                alert('Por favor, seleccione primero un c√≥digo de material');
            }
        }

        // Funci√≥n para guardar el formulario
        function guardarFormulario() {
            try {
                // Recopilar todos los datos del formulario
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: document.getElementById('codigoMaterialOriginal').value,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: document.getElementById('numero_lote_material').value,
                    codigo_material_recibido: document.getElementById('codigo_material_recibido').value,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value
                };
                
                // Validar campos requeridos
                if (!formData.codigo_material_original) {
                    alert('Por favor, ingrese el c√≥digo de material original');
                    return;
                }
                
                
                // Deshabilitar bot√≥n mientras se guarda
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                // Enviar datos al servidor
                fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    
                    // Verificar si la respuesta es JSON
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // Si no es JSON, probablemente es una redirecci√≥n a login
                        throw new Error('No autenticado - redirigiendo a login');
                    }
                })
                .then(data => {
                    if (data.success) {
                        mostrarNotificacionImpresion('Registro guardado exitosamente', 'success');
                        
                        // *** CAPTURAR DATOS ANTES DE LIMPIAR FORMULARIO ***
                        const datosParaEtiqueta = {
                            codigo: formData.codigo_material_recibido,
                            numeroLote: formData.numero_lote_material || '',
                            numeroParte: formData.numero_parte || '',
                            cantidadActual: formData.cantidad_actual || '',
                            propiedadMaterial: formData.especificacion || ''
                        };
                        
                        
                        // *** NUEVA FUNCIONALIDAD: Impresi√≥n autom√°tica directa ***
                        const codigoMaterialRecibido = formData.codigo_material_recibido;
                        if (codigoMaterialRecibido && codigoMaterialRecibido.trim() !== '') {
                            
                            // Imprimir directamente sin confirmaciones CON DATOS CAPTURADOS
                            setTimeout(() => {
                                imprimirZebraAutomaticoConDatos(datosParaEtiqueta);
                            }, 500);
                        }
                        
                        // IMPORTANTE: Esperar un poco y luego recargar el siguiente secuencial
                        setTimeout(async () => {
                            const codigoActual = document.getElementById('codigoMaterialSelect').value;
                            if (codigoActual) {
                                await cargarSiguienteSecuencial(codigoActual);
                                
                                // Despu√©s de recargar, actualizar los campos inferiores con la nueva secuencia
                                llenarCamposInferiores(codigoActual);
                            } else {
                                await cargarSiguienteSecuencial();
                            }
                        }, 500); // Esperar 500ms para asegurar que la BD se actualice
                        
                        // Limpiar formulario
                        limpiarFormulario();
                        // Recargar tabla autom√°ticamente
                        consultarRegistros();
                    } else {
                        mostrarNotificacionImpresion('Error al guardar: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('No autenticado')) {
                        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
                        window.location.href = '/login';
                    } else {
                        mostrarNotificacionImpresion('Error al guardar el registro: ' + error.message, 'error');
                    }
                })
                .finally(() => {
                    // Rehabilitar bot√≥n
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                });
                
            } catch (error) {
                console.error('Error al procesar formulario:', error);
                mostrarNotificacionImpresion('Error al procesar el formulario', 'error');
            }
        }
        
        // Funci√≥n para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('forma_material').selectedIndex = 0;
            document.getElementById('cliente').selectedIndex = 0;
            document.getElementById('codigoMaterialOriginal').value = '';
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 0;
            
            // Restablecer fechas a hoy
            setFechasHoy();
            
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            
            // *** OCULTAR LA TABLA AL LIMPIAR FORMULARIO ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'none';
            }
            
            // El contador secuencial se recarga desde BD despu√©s de cada guardado exitoso
        }
        
        // Establecer fechas a hoy al cargar la p√°gina
function setFechasHoy() {
    // Obtener la fecha local (no UTC) para evitar desfase de zona horaria
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hoyLocal = `${year}-${month}-${day}`;
    // Tambi√©n actualiza los filtros de fecha
    const fechaRecibo = document.getElementById('fecha_recibo');
    const fechaFabricacion = document.getElementById('fecha_fabricacion');
    const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
    const filtroFechaFin = document.getElementById('filtro_fecha_fin');
    if (fechaRecibo) fechaRecibo.value = hoyLocal;
    if (fechaFabricacion) fechaFabricacion.value = hoyLocal;
    if (filtroFechaInicio) filtroFechaInicio.value = hoyLocal;
    if (filtroFechaFin) filtroFechaFin.value = hoyLocal;
}
// Llamar al cargar la p√°gina
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setFechasHoy);
} else {
    setFechasHoy();
}

        // Funci√≥n para consultar registros (actualizada para usar la nueva funci√≥n)
        function consultarRegistros() {
            cargarDatosDesdeServidor();
        }

        // Funci√≥n principal de carga de datos (actualizada para usar la nueva funci√≥n)
        function cargarDatosDesdeServidor() {
            
            const fechaInicio = document.getElementById('filtro_fecha_inicio').value;
            const fechaFin = document.getElementById('filtro_fecha_fin').value;
            
            
            // Construir URL con par√°metros
            let url = '/consultar_control_almacen';
            const params = new URLSearchParams();
            
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            
            fetch(url)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    
                    nuevaCargarDatos(data);
                })
                .catch(error => {
                    console.error('‚ùå Error completo:', error);
                    
                    const tbody = document.querySelector('#tablaControlAlmacen tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #e74c3c;">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
                    }
                });
            
        }
        
        // Funci√≥n global para acceso directo (como en CONTROL_DE_MATERIAL.html)
        window.cargarDatosDesdeServidor = cargarDatosDesdeServidor;
        
        // NUEVA FUNCI√ìN FUNCIONAL PARA REEMPLAZAR cargarDatosEnTabla
        function nuevaCargarDatos(datos) {
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            
            // *** MOSTRAR LA TABLA CUANDO SE CARGAN DATOS ***
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            tbody.innerHTML = '';

            if (!datos || datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="material-table .no-data">No hay registros disponibles.</td></tr>';
                return;
            }

            datos.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Hacer la fila clickeable para selecci√≥n
                row.className = 'fila-clickeable';
                row.onclick = () => seleccionarFilaTabla(row, item, index);

                row.innerHTML = `
                    <td>${item.codigo_material_recibido || ''}</td>
                    <td>${item.codigo_material || ''}</td>
                    <td>${item.numero_parte || ''}</td>
                    <td>${item.numero_lote_material || ''}</td>
                    <td>${item.propiedad_material || ''}</td>
                    <td>${item.cantidad_actual || ''}</td>
                    <td>${item.cantidad_estandarizada || ''}</td>
                    <td>${item.ubicacion_salida || ''}</td>
                    <td>${item.fecha_recibo || ''}</td>
                    <td>${item.especificacion || ''}</td>
                    <td>${item.material_importacion_local || ''}</td>
                    <td>${item.estado_desecho || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            // IMPORTANTE: Llama a actualizarTotalFilasTabla() despu√©s de actualizar los datos de la tabla
            actualizarTotalFilasTabla();
        }
        
        // Actualiza el total de filas en la tabla de resultados
        function actualizarTotalFilasTabla() {
            const tabla = document.getElementById('tablaControlAlmacen');
            const totalInfo = document.querySelector('.total-info');
            if (!tabla || !totalInfo) return;
            const tbody = tabla.querySelector('tbody');
            if (!tbody) return;
            // Contar filas que no tengan la clase 'no-data'
            const filas = Array.from(tbody.querySelectorAll('tr'));
            const filasDatos = filas.filter(tr => !tr.classList.contains('no-data'));
            totalInfo.textContent = `Total Rows: ${filasDatos.length}`;
        }
        
        // Funci√≥n para seleccionar fila de tabla
        function seleccionarFilaTabla(fila, datos, index) {
            
            // Verificar datos cr√≠ticos
            
            // Limpiar selecci√≥n anterior
            limpiarSeleccionTabla();
            
            // Marcar nueva selecci√≥n
            fila.classList.add('fila-seleccionada');
            filaSeleccionada = fila;
            datosFilaSeleccionada = datos;
            
        }
        
        // Funci√≥n para limpiar selecci√≥n de tabla
        function limpiarSeleccionTabla() {
            if (filaSeleccionada) {
                filaSeleccionada.classList.remove('fila-seleccionada');
            }
            filaSeleccionada = null;
            datosFilaSeleccionada = null;
        }
        
        // Funci√≥n principal para manejar impresi√≥n
        async function manejarImpresion() {
            
            // *** DEBUG CR√çTICO: VERIFICAR ESTADO DE SELECCI√ìN ***
            
            if (datosFilaSeleccionada) {
            }
            
            if (filaSeleccionada) {
            }
            
            try {
                if (datosFilaSeleccionada) {
                    // Reimprimir etiqueta seleccionada
                    await reimprimirEtiqueta(datosFilaSeleccionada);
                } else {
                    // Imprimir desde formulario
                    await imprimirEtiquetaFormulario();
                }
            } catch (error) {
                console.error('‚ùå Error en manejo de impresi√≥n:', error);
                mostrarNotificacionImpresion('Error de impresi√≥n: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n para reimprimir etiqueta desde datos de tabla
        async function reimprimirEtiqueta(datos) {
            
            // ‚úÖ MAPEAR DATOS USANDO LOS NOMBRES EXACTOS DE LAS COLUMNAS SQL
            const datosEtiqueta = {
                codigo: datos.codigo_material_recibido || '',
                numeroLote: datos.numero_lote_material || '',
                numeroParte: datos.numero_parte || '',
                cantidadActual: datos.cantidad_actual || '',  // ‚úÖ Desde SQL
                propiedadMaterial: datos.propiedad_material || '',
                especificacionMaterial: datos.especificacion || '', // ‚úÖ Desde SQL
                fechaRecibo: datos.fecha_recibo || '', // ‚úÖ Desde SQL
                cantidadEstandarizada: datos.cantidad_estandarizada || '',
                ubicacionSalida: datos.ubicacion_salida || '',
                materialImportacionLocal: datos.material_importacion_local || '',
                estadoDesecho: datos.estado_desecho || ''
            };
            
            
            // Verificar datos cr√≠ticos
            if (!datosEtiqueta.cantidadActual) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: cantidad_actual de SQL est√° vac√≠a');
            }
            if (!datosEtiqueta.especificacionMaterial) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: especificacion de SQL est√° vac√≠a');
            }
            if (!datosEtiqueta.fechaRecibo) {
                console.warn('‚ö†Ô∏è ADVERTENCIA: fecha_recibo de SQL est√° vac√≠a');
            }
            
            // Usar la funci√≥n de impresi√≥n con datos espec√≠ficos
            await imprimirZebraAutomaticoConDatos(datosEtiqueta);
            
            mostrarNotificacionImpresion('Etiqueta reimpresa con datos de SQL', 'success');
        }
        
        // Funci√≥n para imprimir desde formulario
        async function imprimirEtiquetaFormulario() {
            
            const codigo = document.getElementById('codigo_material_recibido')?.value;
            if (!codigo || codigo.trim() === '') {
                throw new Error('No hay c√≥digo de material para imprimir');
            }
            
            
            // Usar la funci√≥n de impresi√≥n autom√°tica existente
            await imprimirZebraAutomatico(codigo);
            
            mostrarNotificacionImpresion('Etiqueta impresa correctamente', 'success');
        }

        
        // Funci√≥n para aplicar reglas de escaneo desde rules.json
        async function aplicarReglasEscaneo(texto) {
            try {
                
                // Obtener las reglas del servidor
                const response = await fetch('/obtener_reglas_escaneo');
                if (!response.ok) {
                    console.warn('No se pudieron obtener las reglas de escaneo');
                    return null;
                }
                
                const reglas = await response.json();
                
                // Probar cada regla hasta encontrar una que coincida
                for (const [proveedor, regla] of Object.entries(reglas)) {
                    
                    const resultado = aplicarRegla(texto, regla);
                    if (resultado) {
                        
                        return {
                            supplier: proveedor,
                            partNumber: resultado.partNumber,
                            lotNumber: resultado.lotNumber
                        };
                    } else {
                    }
                }
                
                return null;
                
            } catch (error) {
                console.error('Error al aplicar reglas de escaneo:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar una regla espec√≠fica
        function aplicarRegla(texto, regla) {
            try {
                
                // Manejar diferentes tipos de reglas seg√∫n tu rules.json
                if ('sequence_pattern' in regla) {
                    return aplicarReglaSecuencias(texto, regla);
                } else if ('character_pattern' in regla) {
                    return aplicarReglaCaracteres(texto, regla);
                } else if ('pattern' in regla) {
                    return aplicarReglaRegex(texto, regla);
                } else {
                    console.warn('Tipo de regla no soportado:', regla);
                    return null;
                }
            } catch (error) {
                console.error('Error aplicando regla:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de secuencias (como ROHM)
        function aplicarReglaSecuencias(texto, regla) {
            try {
                
                const secuencias = regla.sequence_pattern;
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                const maxLongitudPart = regla.partNumberMaxLength;
                const maxLongitudLote = regla.lotNumberMaxLength;
                
                // Dividir el texto seg√∫n las secuencias
                let partes = [texto];
                
                for (const secuencia of secuencias) {
                    let nuevasPartes = [];
                    
                    for (const parte of partes) {
                        if (secuencia.type === 'spaces') {
                            // Dividir por la cantidad exacta de espacios consecutivos
                            const espacios = ' '.repeat(secuencia.count);
                            const subpartes = parte.split(espacios); // Dividir por todos los separadores
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'tabs') {
                            const tabs = '\t'.repeat(secuencia.count);
                            const subpartes = parte.split(tabs);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'newlines') {
                            const newlines = '\n'.repeat(secuencia.count);
                            const subpartes = parte.split(newlines);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'custom') {
                            const custom = (secuencia.separator || '').repeat(secuencia.count);
                            const subpartes = parte.split(custom);
                            nuevasPartes.push(...subpartes);
                        } else {
                            nuevasPartes.push(parte);
                        }
                    }
                    
                    partes = nuevasPartes;
                }
                
                
                // Verificar que tengamos suficientes partes
                if (partes.length <= Math.max(indicePart, indiceLote)) {
                    return null;
                }
                
                let partNumber = (partes[indicePart] || '').trim();
                let lotNumber = (partes[indiceLote] || '').trim();
                
                // Aplicar longitudes m√°ximas si est√°n definidas (como en Python)
                if (maxLongitudPart && partNumber.length > maxLongitudPart) {
                    partNumber = partNumber.substring(0, maxLongitudPart);
                }
                if (maxLongitudLote && lotNumber.length > maxLongitudLote) {
                    lotNumber = lotNumber.substring(0, maxLongitudLote);
                }
                
                // *** NUEVA FUNCIONALIDAD: Extracci√≥n espec√≠fica del lote ***
                if (regla.lotNumberStart !== undefined && regla.lotNumberLength !== undefined) {
                    const startPos = regla.lotNumberStart;
                    const length = regla.lotNumberLength;
                    
                    
                    if (lotNumber.length >= startPos + length) {
                        lotNumber = lotNumber.substring(startPos, startPos + length).trim();
                    } else {
                    }
                }
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaSecuencias:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de regex (como LEGACY)
        function aplicarReglaRegex(texto, regla) {
            try {
                
                const patron = new RegExp(regla.pattern);
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                
                const coincidencia = texto.match(patron);
                
                if (!coincidencia) {
                    return null;
                }
                
                
                const partNumber = coincidencia[indicePart]?.trim() || '';
                const lotNumber = coincidencia[indiceLote]?.trim() || '';
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaRegex:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de patr√≥n de caracteres
        function aplicarReglaCaracteres(texto, regla) {
            try {
                const patronCaracteres = regla.character_pattern;
                const inicioPartNumber = regla.partNumberStart;
                const longitudPartNumber = regla.partNumberLength;
                const inicioLotNumber = regla.lotNumberStart;
                const longitudLotNumber = regla.lotNumberLength;
                
                
                // Verificar longitud m√≠nima (igual que Python)
                const longitudMinima = Math.max(inicioPartNumber + longitudPartNumber, inicioLotNumber + longitudLotNumber);
                if (texto.length < longitudMinima) {
                    return null;
                }
                
                // VALIDACI√ìN ESTRICTA DE PATR√ìN (igual que Python)
                if (texto.length !== patronCaracteres.length) {
                    return null;
                }
                
                // Verificar patr√≥n car√°cter por car√°cter (igual que Python)
                for (let i = 0; i < texto.length; i++) {
                    const charTexto = texto[i];
                    const charPatron = patronCaracteres[i];
                    
                    if (charPatron === 'X') {
                        // X = cualquier car√°cter
                        continue;
                    } else if (charPatron === 'N') {
                        // N = cualquier n√∫mero
                        if (!/\d/.test(charTexto)) {
                            return null;
                        }
                    } else if (charPatron === 'A') {
                        // A = cualquier letra
                        if (!/[a-zA-Z]/.test(charTexto)) {
                            return null;
                        }
                        
                    } else if (charPatron === 'AN') {
                        // AN = alfanum√©rico
                        if (!/[a-zA-Z0-9]/.test(charTexto)) {
                            return null;
                        }
                    } else {
                        // Car√°cter espec√≠fico debe coincidir exactamente
                        if (charTexto !== charPatron) {
                            return null;
                        }
                    }
                }
                
                
                // Extraer partNumber y lotNumber seg√∫n las posiciones EXACTAS (igual que Python)
                const partNumber = texto.substring(inicioPartNumber, inicioPartNumber + longitudPartNumber).trim();
                const lotNumber = texto.substring(inicioLotNumber, inicioLotNumber + longitudLotNumber).trim();
                
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaCaracteres:', error);
                return null;
            }
        }

        function exportarExcel() {
            try {
                alert('Generando archivo Excel, por favor espere...');
                fetch('/exportar_excel', {
                    method: 'GET'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Error en el servidor');
                    }
                    return response.blob();
                })
                .then(function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `materiales_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    alert('Archivo Excel descargado exitosamente');
                })
                .catch(function(error) {
                    console.error('Error al exportar Excel:', error);
                    alert('Error al exportar el archivo Excel: ' + error.message);
                });
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('Error al exportar el archivo Excel');
            }
        }

        // === AUTOCOMPLETADO PARA CONTROL DE ALMAC√âN ===
        // Configurar autocompletado en el campo "codigo_material_recibido"
        function configurarAutocompletadoAlmacen() {
            const codigoRecibidoInput = document.getElementById('codigo_material_recibido');
            if (codigoRecibidoInput) {
                
                // Funci√≥n para buscar el c√≥digo en la base de datos
                async function buscarCodigoRecibidoAlmacen() {
                    const codigo = codigoRecibidoInput.value.trim();
                    
                    if (!codigo) {
                        return;
                    }
                    
                    
                    try {
                        const url = `/buscar_codigo_recibido?codigo_material_recibido=${encodeURIComponent(codigo)}`;
                        
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.success && data.registro) {
                                
                                // Llenar campos con la informaci√≥n encontrada
                                if (data.registro.numero_lote_material) {
                                    document.getElementById('numero_lote_material').value = data.registro.numero_lote_material;
                                }
                                if (data.registro.codigo_material_original) {
                                    document.getElementById('codigoMaterialOriginal').value = data.registro.codigo_material_original;
                                }
                                if (data.registro.codigo_material) {
                                    document.getElementById('codigo_material_lower').value = data.registro.codigo_material;
                                }
                                if (data.registro.numero_parte) {
                                    document.getElementById('numero_parte_lower').value = data.registro.numero_parte;
                                }
                                if (data.registro.cantidad_actual) {
                                    document.getElementById('cantidad_actual').value = data.registro.cantidad_actual;
                                }
                                if (data.registro.cantidad_estandarizada) {
                                    document.getElementById('cantidad_estandarizada').value = data.registro.cantidad_estandarizada;
                                }
                                if (data.registro.propiedad_material) {
                                    document.getElementById('propiedad_material').value = data.registro.propiedad_material;
                                }
                                
                                // Resaltar campos que se llenaron autom√°ticamente
                                const campos = ['numero_lote_material', 'codigoMaterialOriginal', 'codigo_material_lower', 
                                            'numero_parte_lower', 'cantidad_actual', 'cantidad_estandarizada', 'propiedad_material'];
                                campos.forEach(id => {
                                    const campo = document.getElementById(id);
                                    if (campo && campo.value) {
                                        campo.style.backgroundColor = '#d4edda';
                                        campo.style.borderColor = '#c3e6cb';
                                        setTimeout(() => {
                                            campo.style.backgroundColor = '';
                                            campo.style.borderColor = '';
                                        }, 3000);
                                    }
                                });
                                
                                alert('C√≥digo encontrado y campos completados autom√°ticamente');
                            } else {
                                alert('C√≥digo de material recibido no encontrado en el almac√©n');
                            }
                        } else {
                            console.error(`‚ùå ALMAC√âN: Error del servidor: ${response.status}`);
                            const errorText = await response.text();
                            console.error('Error text:', errorText);
                            alert(`Error del servidor: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('üí• ALMAC√âN: Error al buscar c√≥digo recibido:', error);
                        alert('Error al buscar el c√≥digo en la base de datos');
                    }
                }
                
                // Evento para cuando se pierde el foco del campo (change)
                codigoRecibidoInput.addEventListener('change', function() {
                    buscarCodigoRecibidoAlmacen();
                });
                
                // Evento para cuando se presiona Enter
                codigoRecibidoInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        buscarCodigoRecibidoAlmacen();
                    }
                });
                
            } else {
                console.error('‚ùå ALMAC√âN: Campo codigo_material_recibido NO encontrado en el DOM');
            }
        }

        // Inicializar autocompletado cuando se carga la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarAutocompletadoAlmacen);
        } else {
            configurarAutocompletadoAlmacen();
        }

        // ==================== QR SCANNER FUNCTIONALITY ====================
        let html5QrCode = null;

        // Funci√≥n para abrir el esc√°ner QR
        function abrirEscanerQR() {
            // Si ya existe un modal, lo eliminamos para recrearlo
            const existingModal = document.getElementById('modalQRScanner');
            if (existingModal) {
                existingModal.remove();
            }

            // Crear el contenido del modal
            const modalHTML = `
                <div id="modalQRScanner" style="display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                    <div style="position: relative; padding: 20px; width: 90%; max-width: 500px; background-color: #fff; border-radius: 8px; text-align: center;">
                        <button onclick="cerrarEscanerQR()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        <h3 style="margin-bottom: 20px;">Escanear C√≥digo QR</h3>
                        <p style="margin-bottom: 20px;">Tome una foto del c√≥digo QR para escanearlo.</p>
                        
                        <!-- Bot√≥n estilizado que activa el input de archivo -->
                        <button onclick="document.getElementById('qr-input-file').click()" style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            üì∏ Tomar Foto
                        </button>
                        
                        <!-- Input de archivo oculto -->
                        <input type="file" id="qr-input-file" accept="image/*" capture="environment" style="display: none;">
                        
                        <div id="qr-status" style="margin-top: 20px; font-weight: bold;"></div>
                        <img id="qr-image-preview" style="max-width: 100%; max-height: 200px; margin-top: 15px; display: none;" />
                    </div>
                </div>
            `;

            // A√±adir el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar el listener para el input de archivo
            const qrInput = document.getElementById('qr-input-file');
            qrInput.addEventListener('change', handleFileSelect);

            // Peque√±o delay para la animaci√≥n de entrada
            setTimeout(() => {
                const modal = document.getElementById('modalQRScanner');
                if(modal) modal.style.opacity = '1';
            }, 10);
        }

        // Funci√≥n para cerrar el esc√°ner QR
        function cerrarEscanerQR() {
            const modal = document.getElementById('modalQRScanner');
            if (modal) {
                modal.remove();
            }
        }

        // Funci√≥n para manejar la selecci√≥n de archivo (foto tomada)
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const statusDiv = document.getElementById('qr-status');
            const imagePreview = document.getElementById('qr-image-preview');
            
            statusDiv.textContent = 'Procesando imagen...';
            statusDiv.style.color = '#007bff';
            imagePreview.style.display = 'block';
            imagePreview.src = URL.createObjectURL(file);

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-status", { verbose: false });
            }

            try {
                const decodedText = await html5QrCode.scanFile(file, false);
                onScanSuccess(decodedText);
            } catch (err) {
                console.error('Error al escanear la imagen:', err);
                statusDiv.textContent = '‚ùå No se pudo detectar un c√≥digo QR. Intente de nuevo.';
                statusDiv.style.color = 'red';
                imagePreview.style.display = 'none';
            }
        }

        // Funci√≥n llamada cuando se escanea exitosamente
        function onScanSuccess(decodedText) {
            
            const statusDiv = document.getElementById('qr-status');
            if (statusDiv) {
                statusDiv.textContent = '‚úÖ ¬°C√≥digo escaneado exitosamente!';
                statusDiv.style.color = 'green';
            }
            
            // Llenar el campo de texto con el c√≥digo escaneado
            const inputCodigo = document.getElementById('codigoMaterialOriginal');
            if (inputCodigo) {
                inputCodigo.value = decodedText;
                
                // Resaltar el campo
                inputCodigo.style.backgroundColor = '#d4edda';
                inputCodigo.style.borderColor = '#28a745';
            }
            
            // Procesar el c√≥digo autom√°ticamente y cerrar el modal
            setTimeout(() => {
                parsearYDistribuirCodigo(decodedText);
                cerrarEscanerQR();
                
                // Restaurar estilos del campo despu√©s de un tiempo
                if (inputCodigo) {
                    setTimeout(() => {
                        inputCodigo.style.backgroundColor = '';
                        inputCodigo.style.borderColor = '';
                    }, 3000);
                }
            }, 1000);
        }

        // Cerrar modal al hacer clic fuera de √©l (si se necesita)
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalQRScanner');
            if (modal && event.target === modal) {
                cerrarEscanerQR();
            }
        });
        // ==================== FIN QR SCANNER FUNCTIONALITY ====================

    </script>

    <!-- Script para QR autom√°tico despu√©s de guardar - NO MODIFICA FUNCIONES EXISTENTES -->
    <script>
        // Funci√≥n simple para generar QR cuando se llame expl√≠citamente
        window.generarQRMaterialRecibido = function() {
            // Obtener el c√≥digo de material recibido
            const codigoMaterialRecibido = document.getElementById('codigo_material_recibido');
            
            if (codigoMaterialRecibido && codigoMaterialRecibido.value.trim() !== '') {
                
                // Usar el generador QR simple
                if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                    QRAlmacenSimple.generarQR(codigoMaterialRecibido.value.trim());
                } else {
                    console.warn('‚ö†Ô∏è Generador QR no disponible');
                }
            } else {
                console.warn('‚ö†Ô∏è No hay c√≥digo de material recibido para generar QR');
            }
        };

        
        // Funci√≥n para mostrar estado de configuraci√≥n de impresora al cargar
        function mostrarEstadoImpresora() {
            const config = localStorage.getItem('zebra_config');
            if (config) {
                const cfg = JSON.parse(config);
                const tipoTexto = cfg.tipo === 'simple' ? 'Simple' : 'Completa';
                const metodoTexto = cfg.metodo === 'usb' ? 'USB' : `Red ${cfg.ip}`;
                
                // Configuraci√≥n activada - no hay bot√≥n que actualizar
            } else {
            }
        }
        
        // Ejecutar al cargar la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mostrarEstadoImpresora);
        } else {
            mostrarEstadoImpresora();
        }

        // ============= FUNCI√ìN DE IMPRESI√ìN AUTOM√ÅTICA DIRECTA =============
        
        /**
         * Funci√≥n para imprimir directamente en Zebra sin confirmaciones
         * Se ejecuta autom√°ticamente despu√©s de guardar un material
         */
        async function imprimirZebraAutomatico(codigo) {
            
            try {
                // 1. Verificar configuraci√≥n de impresora
                const config = localStorage.getItem('zebra_config');
                // üåê CONFIGURACI√ìN DE SERVIDORES
                // Cambiar estas URLs seg√∫n donde est√© hospedado el sistema
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    // Servidor principal (aplicaci√≥n web) - CAMBIAR SEG√öN NECESIDAD
                    server_url: 'http://localhost:5000',        // Para desarrollo local
                    // server_url: 'https://mi-dominio.com',    // Para dominio web
                    // server_url: 'http://192.168.0.211:5000', // Para servidor espec√≠fico
                    
                    // Servicio de impresi√≥n (SIEMPRE local en cada PC)
                    service_url: 'http://localhost:5003'
                };
                
                // üîß FUNCIONES HELPER PARA URLs
                function getServerUrl(endpoint = '') {
                    // Si el endpoint ya es absoluto, devolverlo como est√°
                    if (endpoint.startsWith('http://') || endpoint.startsWith('https://')) {
                        return endpoint;
                    }
                    
                    // Si es una ruta relativa, usar la URL base configurada
                    const baseUrl = configuracion.server_url.replace(/\/$/, ''); // Quitar / final si existe
                    return baseUrl + endpoint;
                }
                
                function getPrintServiceUrl(endpoint = '') {
                    const baseUrl = configuracion.service_url.replace(/\/$/, '');
                    return baseUrl + endpoint;
                }
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                } else {
                    // Guardar configuraci√≥n por defecto
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL seg√∫n el tipo configurado
                const comandoZPL = generarComandoZPLDirecto(codigo, configuracion.tipo);
                
                // 3. Mostrar notificaci√≥n de inicio
                mostrarNotificacionImpresion('Enviando a impresora Zebra ZT230...', 'info');
                
                // 4. Enviar al servicio de impresi√≥n Win32
                await enviarAServicioWin32(comandoZPL, codigo, configuracion);
                
            } catch (error) {
                console.error('‚ùå Error en impresi√≥n autom√°tica:', error);
                mostrarNotificacionImpresion('Error al imprimir: ' + error.message, 'error');
                
                // Fallback: Usar m√©todo anterior
                try {
                    await enviarPorBackendAnterior(comandoZPL, codigo, configuracion);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback tambi√©n fall√≥:', fallbackError);
                    // √öltimo fallback: Mostrar QR en modal
                    if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                        QRAlmacenSimple.generarQR(codigo);
                    }
                }
            }
        }
        
        /**
         * NUEVA FUNCI√ìN: Impresi√≥n autom√°tica con datos espec√≠ficos
         * Esta funci√≥n recibe directamente los datos en lugar de leerlos del formulario
         */
        async function imprimirZebraAutomaticoConDatos(datosEtiqueta) {
            try {
                // 1. Verificar configuraci√≥n de impresora
                const config = localStorage.getItem('zebra_config');
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    server_url: 'http://localhost:5000',
                    service_url: 'http://localhost:5003'
                };
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                } else {
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL usando la funci√≥n que S√ç FUNCIONA
                const comandoZPL = generarComandoZPLConDatos(datosEtiqueta, configuracion.tipo);
                
                // 3. Mostrar notificaci√≥n de inicio
                mostrarNotificacionImpresion('Enviando a impresora Zebra ZT230...', 'info');
                
                // 4. Enviar al servicio de impresi√≥n Win32
                await enviarAServicioWin32(comandoZPL, datosEtiqueta.codigo, configuracion);
                
            } catch (error) {
                console.error('‚ùå ERROR EN IMPRESI√ìN CON DATOS ESPEC√çFICOS:', error);
                console.error('‚ùå Tipo de error:', error.name);
                console.error('‚ùå Mensaje:', error.message);
                console.error('‚ùå Stack:', error.stack);
                
                mostrarNotificacionImpresion('Error al imprimir: ' + error.message, 'error');
                
                
                // **FALLBACK CONTROLADO** - Solo si es un error espec√≠fico de red/servicio
                const esErrorRed = error.message.includes('fetch') || 
                                   error.message.includes('network') || 
                                   error.message.includes('Failed to fetch') ||
                                   error.message.includes('NetworkError') ||
                                   error.name === 'TypeError';
                
                const esErrorServicio = error.message.includes('5003') || 
                                       error.message.includes('localhost') ||
                                       error.message.includes('service');
                
                if (esErrorRed || esErrorServicio) {
                    
                    try {
                        // Generar ZPL usando solo los datos que tenemos
                        const codigoParaFallback = datosEtiqueta.codigo || 'CODIGO_ERROR';
                        
                        // Generar ZPL directamente sin usar servicio
                        const zplFallback = generarComandoZPLConDatos(datosEtiqueta, 'material');
                        
                        // Mostrar el ZPL en consola para que el usuario pueda copiarlo
                        
                        // Intentar usando m√©todo de formulario como √∫ltimo recurso
                        await imprimirZebraAutomatico(codigoParaFallback);
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback tambi√©n fall√≥:', fallbackError);
                        
                        // √öltimo recurso: mostrar el ZPL generado
                        const zplUltimoRecurso = generarComandoZPLConDatos(datosEtiqueta, 'material');
                        
                        mostrarNotificacionImpresion('ZPL generado - Ver consola para c√≥digo manual', 'info');
                        
                        // √öltimo fallback: Mostrar QR en modal si existe
                        if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                            QRAlmacenSimple.generarQR(datosEtiqueta.codigo);
                        }
                    }
                } else {
                    // Solo mostrar el ZPL generado sin intentar impresi√≥n adicional
                    try {
                        const zplGenerado = generarComandoZPLConDatos(datosEtiqueta, 'material');
                    } catch (zplError) {
                        console.error('No se pudo generar ZPL:', zplError);
                    }
                }
            }
        }
        
        /**
         * Funci√≥n para enviar al servicio Win32 de impresi√≥n
         */
        async function enviarAServicioWin32(comandoZPL, codigo, configuracion) {
            const serviceUrl = configuracion.service_url || 'http://localhost:5003';
            
            try {
                
                // Verificar si el servicio est√° disponible
                const statusResponse = await fetch(`${serviceUrl}/`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`Servicio no disponible (${statusResponse.status})`);
                }
                
                const statusData = await statusResponse.json();
                
                // COMPATIBILIDAD: Si el servicio no devuelve zebra_printer, verificar que est√© ejecut√°ndose
                // Tu servicio devuelve { "service": "Zebra Print Service Flask Integrado", "status": "running" }
                if (!statusData.zebra_printer && statusData.status !== 'running') {
                    throw new Error('Servicio de impresi√≥n no est√° funcionando correctamente');
                }
                
                // Si el servicio est√° ejecut√°ndose, asumir que la impresora est√° disponible
                if (statusData.status === 'running') {
                } else if (!statusData.zebra_printer) {
                    throw new Error('No se detect√≥ impresora Zebra ZT230 en el servicio');
                }
                
                // Enviar comando ZPL para impresi√≥n con el formato correcto para tu servicio
                const printResponse = await fetch(`${serviceUrl}/print`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zpl_content: comandoZPL,  // Tu servicio espera "zpl_content"
                        codigo: codigo,
                        source: 'ILSAN_MES_Control_Almacen'
                    })
                });
                
                const printResult = await printResponse.json();
                
                if (printResponse.ok && printResult.status === 'printed') {
                    mostrarNotificacionImpresion(`Etiqueta impresa en ${printResult.printer}`, 'success');
                    
                    // Log adicional
                    
                } else {
                    throw new Error(printResult.error || 'Error desconocido en impresi√≥n');
                }
                
            } catch (error) {
                console.error('‚ùå Error en servicio Win32:', error);
                
                // Verificar si es error de conexi√≥n al servicio
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('Servicio de impresi√≥n no disponible. Verifique que print_service.py est√© ejecut√°ndose.');
                } else {
                    throw error;
                }
            }
        }
        
        /**
         * Funci√≥n fallback para usar el m√©todo anterior
         */
        async function enviarPorBackendAnterior(comandoZPL, codigo, configuracion) {
            
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: configuracion.metodo,
                        ip: configuracion.ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacionImpresion('Etiqueta procesada correctamente', 'success');
                } else {
                    throw new Error(result.error || 'Error en m√©todo fallback');
                }
                
            } catch (error) {
                console.error('‚ùå Error en m√©todo fallback:', error);
                throw error;
            }
        }
        
        /**
         * Funci√≥n para obtener la cantidad actual de forma robusta
         * Intenta m√∫ltiples fuentes y siempre devuelve un valor v√°lido
         */
        function getCantidadActual() {
            
            // 1. Intentar obtener del campo principal
            let cantidad = document.getElementById('cantidad_actual')?.value;
            
            // 2. Si est√° vac√≠o, intentar cantidad_estandarizada (que viene de la BD)
            if (!cantidad || cantidad.trim() === '') {
                cantidad = document.getElementById('cantidad_estandarizada')?.value;
            }
            
            // 3. Si sigue vac√≠o, buscar en el c√≥digo seleccionado directamente
            if (!cantidad || cantidad.trim() === '') {
                const codigoSeleccionado = document.getElementById('codigoMaterialSelect')?.value;
                if (codigoSeleccionado && codigosMaterial.length > 0) {
                    const materialInfo = codigosMaterial.find(c => c.codigo === codigoSeleccionado);
                    if (materialInfo && materialInfo.cantidad_estandarizada) {
                        cantidad = materialInfo.cantidad_estandarizada;
                    }
                }
            }
            
            // 4. SOLO como √∫ltimo recurso usar valor por defecto
            if (!cantidad || cantidad.trim() === '') {
                console.warn('‚ö†Ô∏è No se encontr√≥ cantidad en ning√∫n lado, usando valor m√≠nimo por defecto');
                cantidad = '1';
            }
            
            return cantidad.toString().trim();
        }
        
        /**
         * NUEVA FUNCI√ìN: Generar comando ZPL con datos espec√≠ficos
         * Esta funci√≥n recibe directamente los datos en lugar de leerlos del formulario
         */
        function generarComandoZPLConDatos(datosEtiqueta, tipo = 'material') {
            
            // ‚úÖ USAR FECHA DE LA TABLA si existe, sino fecha actual
            let fecha, fechaHora;
            if (datosEtiqueta.fechaRecibo) {
                // Convertir fecha de tabla (YYYY-MM-DD) a formato espa√±ol (DD/MM/YYYY)
                const fechaTabla = new Date(datosEtiqueta.fechaRecibo);
                fecha = fechaTabla.toLocaleDateString('es-ES');
                fechaHora = fechaTabla.toLocaleString('es-ES');
            } else {
                // Fallback a fecha actual
                fecha = new Date().toLocaleDateString('es-ES');
                fechaHora = new Date().toLocaleString('es-ES');
            }
            
            // Usar los datos espec√≠ficos pasados como par√°metro
            const codigo = datosEtiqueta.codigo || '';
            const numeroLote = datosEtiqueta.numeroLote || '';
            const numeroParte = datosEtiqueta.numeroParte || '';
            
            // *** CORRECCI√ìN CR√çTICA: CONVERTIR A STRING Y VALIDAR ***
            let cantidadActual = String(datosEtiqueta.cantidadActual || '');
            
            // ‚úÖ USAR ESPECIFICACI√ìN DE LA TABLA si existe, sino propiedad
            let especificacion = String(datosEtiqueta.especificacionMaterial || datosEtiqueta.propiedadMaterial || '');
            
            // Si la cantidad est√° vac√≠a, usar valor por defecto
            if (!cantidadActual || cantidadActual.trim() === '' || cantidadActual === 'undefined') {
                // Intentar obtener de la fuente original si est√° disponible
                if (window.datosFilaSeleccionada && window.datosFilaSeleccionada.cantidad_actual) {
                    cantidadActual = String(window.datosFilaSeleccionada.cantidad_actual);
                } else {
                    cantidadActual = '1';
                }
            }
            
            // Si la especificaci√≥n est√° vac√≠a, usar valor por defecto
            if (!especificacion || especificacion.trim() === '' || especificacion === 'undefined') {
                // Intentar obtener de la fuente original si est√° disponible
                if (window.datosFilaSeleccionada && window.datosFilaSeleccionada.especificacion) {
                    especificacion = String(window.datosFilaSeleccionada.especificacion);
                } else {
                    especificacion = 'Material';
                }
            }
            
            // === DEBUG: VERIFICAR VALORES ESPEC√çFICOS ===
            
            // Verificar si los campos cr√≠ticos est√°n vac√≠os
            if (!cantidadActual || cantidadActual.trim() === '') {
                console.error('‚ùå ERROR CR√çTICO: cantidadActual est√° VAC√çO en datos espec√≠ficos');
            } else {
            }
            
            if (!especificacion || especificacion.trim() === '') {
                console.error('‚ùå ERROR CR√çTICO: especificaci√≥n est√° VAC√çA en datos espec√≠ficos');
            } else {
            }
            
            if (!datosEtiqueta.fechaRecibo) {
                console.error('‚ùå ERROR CR√çTICO: fechaRecibo de SQL est√° VAC√çA');
            } else {
            }
            
            // Crear datos para el QR con informaci√≥n COMPACTA para evitar "STRING TOO LONG"
            
            // *** DEBUG CR√çTICO: VERIFICAR VALORES ANTES DE CONSTRUIR ZPL ***
            
            // Verificar si alguna variable est√° undefined o null y forzar valores (CON CONVERSI√ìN A STRING)
            if (!cantidadActual || String(cantidadActual).trim() === '' || cantidadActual === 'undefined') {
                console.error('‚ùå ERROR CR√çTICO: cantidadActual vac√≠o, FORZANDO valor SQL');
                cantidadActual = String(datosEtiqueta.cantidadActual || '1');
            }
            // Validaci√≥n final de datos antes de crear ZPL
            if (!cantidadActual || String(cantidadActual).trim() === '' || cantidadActual === 'undefined') {
                cantidadActual = String(datosEtiqueta.cantidadActual || '1');
            }
            if (!fecha || String(fecha).trim() === '') {
                if (datosEtiqueta.fechaRecibo) {
                    const fechaTabla = new Date(datosEtiqueta.fechaRecibo);
                    fecha = fechaTabla.toLocaleDateString('es-ES');
                } else {
                    fecha = new Date().toLocaleDateString('es-ES');
                }
            }
            if (!especificacion || String(especificacion).trim() === '') {
                especificacion = String(datosEtiqueta.especificacionMaterial || datosEtiqueta.propiedadMaterial || 'Material');
            }
            
            const datosQR = {
                c: codigo.substring(0, 15),  // C√≥digo acortado
                f: fecha.substring(0, 10),   // Fecha de tabla o actual
                l: numeroLote.substring(0, 8), // Lote acortado
                p: numeroParte.substring(0, 8), // Parte acortado
                q: cantidadActual.substring(0, 6), // Cantidad acortada
                m: especificacion.substring(0, 6), // Especificaci√≥n acortada
                s: 'OK',  // Estado simplificado
                e: 'ILSAN' // Empresa acortada
            };
            
            // Convertir a JSON ultra compacto para el QR
            const textoQR = JSON.stringify(datosQR).replace(/"/g, '').replace(/:/g, '=').replace(/,/g, '|');
            
            let comandoZPL;
            
            if (tipo === 'simple') {
                // Etiqueta simple optimizada para 33.2mm x 14mm
                comandoZPL = `^XA
^PW264^LL112
^FO5,5^BQN,2,2^FDQA,${codigo}^FS
^FO50,8^ADN,8,5^FD${codigo}^FS
^FO50,25^ADN,6,4^FD${fechaHora}^FS
^FO5,45^ADN,5,3^FDMAT.REC^FS
^FO5,60^ADN,5,3^FDILSAN^FS
^XZ`;
            } else {
                // Etiqueta usando dise√±o proporcionado por el usuario
                // Split especificaci√≥n at the opening parenthesis
                const especificacionParts = especificacion.split('(');
                const especificacionLine1 = especificacionParts[0] ? especificacionParts[0].trim() : '';
                const especificacionLine2 = especificacionParts[1] ? '(' + especificacionParts[1] : '';
                
                comandoZPL = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT188,55^A0N,16,15^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT187,102^A0N,18,18^FH\\^CI28^FDQTY:^FS^CI27
^FT5,135^BQN,2,8
^FH\\^FDLA,${codigo}^FS
^FT188,15^A0N,25,25^FH\\^CI28^FD${codigo.split(',')[0] || codigo}^FS^CI27
^FT188,40^A0N,25,25^FH\\^CI28^FD${codigo.split(',')[1] || ''}^FS^CI27
^FT188,75^A0N,21,20^FH\\^CI28^FD${fecha}^FS^CI27
^FT188,125^A0N,21,20^FH\\^CI28^FD${especificacionLine1}^FS^CI27
^FT188,147^A0N,21,20^FH\\^CI28^FD${especificacionLine2}^FS^CI27
^FT223,104^A0N,22,20^FH\\^CI28^FD${cantidadActual}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            }
            
            
            // *** DEBUG FINAL: MOSTRAR FRAGMENTOS ESPEC√çFICOS DEL ZPL ***
            const fragmentos = comandoZPL.split('\n');
            fragmentos.forEach((linea, index) => {
                if (linea.includes('FD') && linea.includes('FS')) {
                    if (linea.includes(cantidadActual)) {
                    }
                    if (linea.includes(fecha)) {
                    }
                    if (especificacion && linea.includes(especificacion.split('(')[0].trim())) {
                    }
                }
            });
            
            // Verificar que los datos aparezcan en el ZPL
            
            if (cantidadActual && comandoZPL.includes(cantidadActual)) {
            } else {
                const fragmentoCantidad = comandoZPL.match(/\^FD.*\^FS/g)?.find(f => f.includes(cantidadActual));
                if (fragmentoCantidad) {
                } else {
                }
            }
            
            if (especificacion && comandoZPL.includes(especificacion.split('(')[0].trim())) {
            } else {
            }
            
            if (fecha && comandoZPL.includes(fecha)) {
            } else {
            }
            
            return comandoZPL;
        }
        
        /**
         * Funci√≥n para generar comando ZPL optimizado para impresi√≥n directa
         */
        function generarComandoZPLDirecto(codigo, tipo = 'material') {
            const fechaHora = new Date().toLocaleString('es-ES');
            const fecha = new Date().toLocaleDateString('es-ES');
            
            
            // Obtener informaci√≥n adicional del material desde los campos del formulario
            const numeroLote = document.getElementById('numero_lote_material')?.value || '';
            const numeroParte = document.getElementById('numero_parte_lower')?.value || '';
            
            // *** USAR LA NUEVA FUNCI√ìN ROBUSTA PARA CANTIDAD ***
            const cantidadActual = getCantidadActual();
            
            const propiedad = document.getElementById('almacen_especificacion_material')?.value || '';
            
            // === DEBUG: VERIFICAR VALORES DE LOS CAMPOS ===
            
            // Ya no necesitamos verificar si est√° vac√≠a porque getCantidadActual() garantiza un valor
            
            if (!propiedad || propiedad.trim() === '') {
                console.warn('‚ö†Ô∏è ADVERTENCIA: Campo almacen_especificacion_material est√° VAC√çO');
                if (document.getElementById('almacen_especificacion_material')) {
                }
            }
            
            // Preparar variables para el ZPL
            const hora = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
            
            let zplCommand;
            
            if (tipo === 'simple') {
                // Etiqueta simple optimizada para 33.2mm x 14mm
                zplCommand = `^XA
^PW264^LL112
^FO5,2^BQN,2,2^FDQA,${codigo}^FS
^FO50,8^ADN,8,5^FD${codigo}^FS
^FO50,25^ADN,6,4^FD${fechaHora}^FS
^FO5,45^ADN,5,3^FDMAT.REC^FS
^FO5,60^ADN,5,3^FDILSAN^FS
^XZ`;
            } else {
                // Etiqueta usando dise√±o proporcionado por el usuario
                // Split propiedad at the opening parenthesis
                const propiedadParts = propiedad.split('(');
                const propiedadLine1 = propiedadParts[0] ? propiedadParts[0].trim() : '';
                const propiedadLine2 = propiedadParts[1] ? '(' + propiedadParts[1] : '';
                
                zplCommand = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT188,55^A0N,16,15^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT187,102^A0N,18,18^FH\\^CI28^FDQTY:^FS^CI27
^FT5,95^BQN,2,8
^FH\\^FDLA,${codigo}^FS
^FT188,15^A0N,25,25^FH\\^CI28^FD${codigo.split(',')[0] || codigo}^FS^CI27
^FT188,40^A0N,25,25^FH\\^CI28^FD${codigo.split(',')[1] || ''}^FS^CI27
^FT188,75^A0N,21,20^FH\\^CI28^FD${fecha}^FS^CI27
^FT188,125^A0N,21,20^FH\\^CI28^FD${propiedadLine1}^FS^CI27
^FT188,147^A0N,21,20^FH\\^CI28^FD${propiedadLine2}^FS^CI27
^FT223,104^A0N,22,20^FH\\^CI28^FD${cantidadActual}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            }
            
            
            return zplCommand;
        }
        
        /**
         * Env√≠o por USB (m√©todo principal para impresoras conectadas localmente)
         */
        async function enviarPorUSB(comandoZPL, codigo) {
            
            // M√©todo principal: Usar el nuevo endpoint optimizado
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'usb'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacionImpresion('Etiqueta impresa correctamente', 'success');
                    return;
                } else {
                    throw new Error(result.error || 'Error de impresi√≥n USB');
                }
                
            } catch (error) {
                console.error('‚ùå Error de impresi√≥n USB:', error);
                throw new Error('Error de impresi√≥n USB: ' + error.message);
            }
        }
        
        /**
         * Env√≠o por red (para impresoras con IP fija)
         */
        async function enviarPorRed(comandoZPL, ip, codigo) {
            
            try {
                // Usar el nuevo endpoint optimizado para red
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'red',
                        ip: ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacionImpresion('Etiqueta enviada a impresora de red', 'success');
                } else {
                    throw new Error(result.error || 'Error de comunicaci√≥n con impresora');
                }
                
            } catch (error) {
                console.error('‚ùå Error de red:', error);
                throw new Error('Error de comunicaci√≥n de red: ' + error.message);
            }
        }
        
        /**
         * Funci√≥n para mostrar notificaciones de impresi√≥n (toast discreto)
         */
        function mostrarNotificacionImpresion(mensaje, tipo) {
            // Remover notificaci√≥n anterior
            const notifAnterior = document.getElementById('print-notification');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            const colores = {
                info: '#4A90E2',      // Tu azul caracter√≠stico
                success: '#4CAF50',   // Tu verde caracter√≠stico  
                error: '#dc3545'      // Tu rojo caracter√≠stico
            };
            
            const notificacion = document.createElement('div');
            notificacion.id = 'print-notification';
            notificacion.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 9999;
                font-family: Arial, sans-serif;
                font-size: 13px;
                font-weight: 500;
                max-width: 280px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease-out;
                cursor: pointer;
                line-height: 1.3;
            `;
            
            // Sin emojis, solo texto limpio y compacto
            notificacion.textContent = mensaje;
            
            // A√±adir al DOM y mostrar
            document.body.appendChild(notificacion);
            
            // Trigger animaci√≥n despu√©s de a√±adir al DOM
            setTimeout(() => {
                notificacion.style.opacity = '1';
                notificacion.style.transform = 'translateY(0)';
            }, 10);
            
            // Click para cerrar manualmente
            notificacion.addEventListener('click', () => {
                cerrarNotificacion(notificacion);
            });
            
            // Auto-cerrar seg√∫n el tipo (m√°s r√°pido para no molestar)
            const duracion = tipo === 'error' ? 4000 : 2500; // M√°s corto
            setTimeout(() => {
                cerrarNotificacion(notificacion);
            }, duracion);
        }
        
        // Funci√≥n helper para cerrar notificaci√≥n
        function cerrarNotificacion(notificacion) {
            if (notificacion && notificacion.parentNode) {
                notificacion.style.opacity = '0';
                notificacion.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.remove();
                    }
                }, 300);
            }
        }
        
        /**
         * Funci√≥n para verificar la impresora Zebra conectada
         */
        async function verificarImpresoraZebra() {
            const btnConfig = document.getElementById('btnConfigImpresora');
            if (btnConfig) {
                btnConfig.disabled = true;
                btnConfig.textContent = 'VERIFICANDO...';
            }
            
            try {
                
                // 1. Verificar servicio de impresi√≥n Win32
                const serviceUrl = 'http://localhost:5003';
                
                const statusResponse = await fetch(`${serviceUrl}/`, {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`Servicio no disponible (${statusResponse.status})`);
                }
                
                const statusData = await statusResponse.json();
                
                // 2. Obtener informaci√≥n detallada de impresoras
                let infoImpresoras = '';
                let estadoColor = '#009944'; // Verde por defecto
                let estadoTexto = 'ACTIVO';
                let estadoBorde = '#009944';
                
                if (statusData.zebra_printer) {
                    // Nuevo formato del servicio que incluye zebra_printer
                    estadoColor = '#009944';
                    estadoTexto = 'ACTIVO';
                    estadoBorde = '#009944';
                    infoImpresoras = `
**SERVICIO DE IMPRESI√ìN ACTIVO:**
‚Ä¢ Estado: running
‚Ä¢ Servicio: Zebra Print Service Flask Integrado
‚Ä¢ Puerto: 5003
‚Ä¢ Nota: Impresora Zebra ZT230 asumida disponible`;
                } else if (statusData.status === 'running') {
                    // Formato antiguo - servicio funcionando pero sin info espec√≠fica
                    estadoColor = '#009944';
                    estadoTexto = 'ACTIVO';
                    estadoBorde = '#009944';
                    infoImpresoras = `
**SERVICIO DE IMPRESI√ìN ACTIVO:**
‚Ä¢ Estado: ${statusData.status}
‚Ä¢ Servicio: ${statusData.service || 'Zebra Print Service Flask Integrado'}
‚Ä¢ Puerto: 5003
‚Ä¢ Nota: Impresora Zebra ZT230 asumida disponible`;
                } else {
                    estadoColor = '#833C0D';
                    estadoTexto = 'INACTIVO';
                    estadoBorde = '#833C0D';
                    infoImpresoras = `
**PROBLEMA DETECTADO:**
‚Ä¢ El servicio no est√° funcionando correctamente
‚Ä¢ Estado: ${statusData.status || 'Desconocido'}`;
                }
                
                // 3. Verificar configuraci√≥n local
                const config = localStorage.getItem('zebra_config');
                let configInfo = '';
                
                if (config) {
                    const cfg = JSON.parse(config);
                    const tipoTexto = cfg.tipo === 'simple' ? 'Simple' : 'Completa';
                    const metodoTexto = cfg.metodo === 'usb' ? 'USB' : `Red (${cfg.ip})`;
                    
                    configInfo = `

**CONFIGURACI√ìN ACTUAL:**
‚Ä¢ M√©todo: ${metodoTexto}
‚Ä¢ Tipo de etiqueta: ${tipoTexto}
‚Ä¢ Impresi√≥n autom√°tica: Activada
‚Ä¢ URL del servicio: ${cfg.service_url || 'http://localhost:5003'}`;
                } else {
                    configInfo = `

**CONFIGURACI√ìN:**
‚Ä¢ No hay configuraci√≥n guardada
‚Ä¢ Se usar√°n valores por defecto`;
                }
                
                // 4. Mostrar modal con informaci√≥n completa
                const modalHTML = `
                <div id="modalVerificacionImpresora" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(50, 50, 62, 0.9); 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000;
                ">
                    <div style="
                        background: #32323E; 
                        padding: 30px; 
                        border-radius: 10px; 
                        max-width: 600px; 
                        width: 90%; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                        border: 2px solid ${estadoBorde};
                    ">
                        <h3 style="
                            margin: 0 0 20px 0; 
                            color: #ecf0f1; 
                            background: ${estadoColor};
                            padding: 15px;
                            border-radius: 6px;
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            position: relative;
                        ">
                            <span style="
                                position: absolute;
                                left: 15px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                background: #ecf0f1;
                                display: inline-block;
                            "></span>
                            CONFIGURACI√ìN DE IMPRESORA ZEBRA - ${estadoTexto}
                        </h3>
                        
                        <div style="
                            background: #33334D; 
                            padding: 20px; 
                            border-radius: 8px; 
                            margin-bottom: 20px;
                            border: 1px solid ${estadoBorde};
                        ">
                            <pre style="
                                margin: 0; 
                                white-space: pre-wrap; 
                                font-size: 14px; 
                                line-height: 1.6;
                                color: #ecf0f1;
                                font-family: Arial, sans-serif;
                            ">${infoImpresoras}${configInfo}</pre>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="cerrarModalVerificacion()" style="
                                padding: 12px 30px; 
                                background: #636779; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                margin-right: 10px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                            " onmouseover="this.style.background='#7B8181'" onmouseout="this.style.background='#636779'">
                                Cerrar
                            </button>
                            <button onclick="probarImpresion()" style="
                                padding: 12px 30px; 
                                background: ${estadoColor}; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                                ${estadoTexto === 'INACTIVO' ? 'opacity: 0.6; cursor: not-allowed;' : ''}
                            " ${estadoTexto === 'ACTIVO' ? `onmouseover="this.style.background='#27ae60'" onmouseout="this.style.background='${estadoColor}'"` : 'onclick="event.preventDefault(); mostrarNotificacionImpresion(\'Servicio inactivo - no se puede probar impresi√≥n\', \'error\'); return false;"'}>
                                ${estadoTexto === 'ACTIVO' ? 'Probar Impresi√≥n' : 'Servicio Inactivo'}
                            </button>
                        </div>
                    </div>
                </div>`;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Mensaje de √©xito
                mostrarNotificacionImpresion('Verificaci√≥n completada', 'success');
                
            } catch (error) {
                console.error('‚ùå Error al verificar impresora:', error);
                
                let mensajeError = 'Error desconocido';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    mensajeError = 'Servicio de impresi√≥n no disponible. Verifique que print_service.py est√© ejecut√°ndose en puerto 5003.';
                } else {
                    mensajeError = error.message;
                }
                
                // Mostrar modal de error
                const modalErrorHTML = `
                <div id="modalVerificacionImpresora" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(50, 50, 62, 0.9); 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000;
                ">
                    <div style="
                        background: #32323E; 
                        padding: 30px; 
                        border-radius: 10px; 
                        max-width: 500px; 
                        width: 90%;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                        border: 2px solid #833C0D;
                        animation: pulse-red 2s infinite;
                    ">
                        <style>
                            @keyframes pulse-red {
                                0% { border-color: #833C0D; }
                                50% { border-color: #9C4910; }
                                100% { border-color: #833C0D; }
                            }
                        </style>
                        <h3 style="
                            margin: 0 0 20px 0; 
                            color: #ecf0f1; 
                            background: #833C0D;
                            padding: 15px;
                            border-radius: 6px;
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            position: relative;
                        ">
                            <span style="
                                position: absolute;
                                left: 15px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                background: #ecf0f1;
                                display: inline-block;
                                animation: blink 1s infinite;
                            "></span>
                            <style>
                                @keyframes blink {
                                    0%, 50% { opacity: 1; }
                                    51%, 100% { opacity: 0.3; }
                                }
                            </style>
                            ERROR DE CONEXI√ìN - SERVICIO INACTIVO
                        </h3>
                        
                        <div style="
                            background: #44324A; 
                            color: #ecf0f1; 
                            padding: 15px; 
                            border-radius: 8px; 
                            margin-bottom: 20px;
                            border: 1px solid #833C0D;
                        ">
                            <p style="margin: 0; font-size: 14px; line-height: 1.5;">${mensajeError}</p>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="cerrarModalVerificacion()" style="
                                padding: 12px 30px; 
                                background: #833C0D; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                            " onmouseover="this.style.background='#9C4910'" onmouseout="this.style.background='#833C0D'">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>`;
                
                document.body.insertAdjacentHTML('beforeend', modalErrorHTML);
                
                mostrarNotificacionImpresion('Error al verificar impresora: ' + mensajeError, 'error');
                
            } finally {
                // Restaurar bot√≥n
                if (btnConfig) {
                    btnConfig.disabled = false;
                    btnConfig.textContent = 'CONF. DE IMPRESORA';
                }
            }
        }
        
        /**
         * Funci√≥n para cerrar el modal de verificaci√≥n
         */
        function cerrarModalVerificacion() {
            const modal = document.getElementById('modalVerificacionImpresora');
            if (modal) {
                modal.remove();
            }
        }
        
        /**
         * Funci√≥n para probar impresi√≥n desde el modal
         */
        async function probarImpresion() {
            try {
                const codigoPrueba = 'TEST-' + Date.now();
                
                mostrarNotificacionImpresion('Enviando prueba de impresi√≥n...', 'info');
                
                // Usar la funci√≥n de impresi√≥n autom√°tica existente
                await imprimirZebraAutomatico(codigoPrueba);
                
                mostrarNotificacionImpresion('Prueba de impresi√≥n enviada correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error en prueba de impresi√≥n:', error);
                mostrarNotificacionImpresion('Error en prueba de impresi√≥n: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n para configurar autom√°ticamente la impresora si no est√° configurada
        function configurarImpresoraAutomatica() {
            const config = localStorage.getItem('zebra_config');
            
            if (!config) {
                
                // Configuraci√≥n por defecto para ZT230 con servicio Win32
                const configDefault = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    service_url: 'http://localhost:5003',
                    use_win32_service: true
                };
                
                localStorage.setItem('zebra_config', JSON.stringify(configDefault));
                
                
                // Configuraci√≥n autom√°tica completada - no hay bot√≥n que actualizar
                
                return configDefault;
            }
            
            const configActual = JSON.parse(config);
            
            // Actualizar configuraci√≥n existente para incluir servicio Win32
            if (!configActual.service_url) {
                configActual.service_url = 'http://localhost:5003';
                configActual.use_win32_service = true;
                localStorage.setItem('zebra_config', JSON.stringify(configActual));
            }
            
            return configActual;
        }
        
        // Funci√≥n para mostrar instrucciones de instalaci√≥n del servicio
        window.mostrarInstruccionesServicio = function() {
            const instrucciones = `
üñ®Ô∏è SERVICIO DE IMPRESI√ìN AUTOM√ÅTICA ZEBRA ZT230

üìã INSTRUCCIONES DE INSTALACI√ìN:

1Ô∏è‚É£ PREPARACI√ìN:
   ‚Ä¢ Aseg√∫rese de que Python 3.8+ est√© instalado
   ‚Ä¢ Conecte la impresora Zebra ZT230 por USB
   ‚Ä¢ Verifique que la impresora est√© configurada en Windows

2Ô∏è‚É£ INSTALACI√ìN:
   ‚Ä¢ Navegue a la carpeta del proyecto ILSAN_MES
   ‚Ä¢ Ejecute el archivo: start_print_service.bat
   ‚Ä¢ El servicio se instalar√° autom√°ticamente

3Ô∏è‚É£ VERIFICACI√ìN:
   ‚Ä¢ Ejecute: testServicioWin32() en la consola
   ‚Ä¢ Debe mostrar la impresora ZT230 detectada
   ‚Ä¢ Se ejecutar√° un test de impresi√≥n autom√°tico

4Ô∏è‚É£ USO:
   ‚Ä¢ Una vez configurado, la impresi√≥n ser√° autom√°tica
   ‚Ä¢ Al guardar un material se imprimir√° sin confirmaciones
   ‚Ä¢ No se necesitan m√°s configuraciones

üîß TROUBLESHOOTING:
   ‚Ä¢ Si hay error: pip install flask pywin32
   ‚Ä¢ Verificar nombre de impresora en Panel de Control
   ‚Ä¢ Verificar que puerto 5000 est√© libre

üí° VENTAJAS:
   ‚úÖ Impresi√≥n totalmente autom√°tica
   ‚úÖ Sin di√°logos ni confirmaciones
   ‚úÖ Detecci√≥n autom√°tica de impresora
   ‚úÖ Logs detallados para diagn√≥stico
   ‚úÖ Fallback a m√©todos anteriores
            `;
            
            alert(instrucciones);
        };
        
        // Configurar impresora autom√°ticamente al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            configurarImpresoraAutomatica();
            
            // Verificar servicio en background (sin bloquear)
            setTimeout(async () => {
                try {
                    const response = await fetch(configuracion.server_url + '/', { 
                        method: 'GET',
                        signal: AbortSignal.timeout(3000) // Timeout de 3 segundos
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Servicio detectado - ya no hay bot√≥n que actualizar
                    }
                } catch (error) {
                }
            }, 2000);
        });
        
        
        // ============= ZEBRA PRINTING FUNCTIONALITY =============

        
        /**
         * Funci√≥n para probar etiqueta peque√±a (33.2mm x 14mm)
         */
        window.testEtiquetaPequena = function(codigo = 'TEST-PEQUENA-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L2025001',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESISTOR'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                }
            });
            
            // Generar comando ZPL optimizado para etiqueta peque√±a
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            return comandoZPL;
        };

        /**
         * Funci√≥n para mostrar layout de etiqueta peque√±a
         */
        window.mostrarLayoutPequeno = function() {
        };

        /**
         * Funci√≥n para mostrar resumen de la nueva funcionalidad QR
         */
        window.mostrarResumenQR = function() {
            const resumen = `
üéØ === NUEVA FUNCIONALIDAD: QR CON INFORMACI√ìN COMPLETA ===

üìã ¬øQU√â SE AGREG√ì?
   ‚úÖ QR ahora incluye TODA la informaci√≥n del material
   ‚úÖ Generaci√≥n autom√°tica de JSON con todos los datos
   ‚úÖ Compatibilidad con etiquetas simples y completas
   ‚úÖ Optimizaci√≥n para etiquetas peque√±as (33.2mm x 14mm)
   ‚úÖ Funciones de prueba y diagn√≥stico

üì± INFORMACI√ìN INCLUIDA EN EL QR:
   ‚Ä¢ C√≥digo del material (completo con consecutivo)
   ‚Ä¢ Fecha de creaci√≥n
   ‚Ä¢ N√∫mero de lote
   ‚Ä¢ N√∫mero de parte
   ‚Ä¢ Cantidad actual
   ‚Ä¢ Propiedad del material
   ‚Ä¢ Estado (ACTIVO)
   ‚Ä¢ Empresa (ILSAN_ELECTRONICS)

üîß FUNCIONES NUEVAS DISPONIBLES:
   ‚Ä¢ testQRCompleto() - Prueba con datos simulados
   ‚Ä¢ testEtiquetaPequena() - Optimizada para 33.2mm x 14mm
   ‚Ä¢ mostrarLayoutPequeno() - Visualizaci√≥n del dise√±o
   ‚Ä¢ verificarQRCompleto() - Muestra contenido del QR

üìä TIPOS DE ETIQUETA:
   üè∑Ô∏è SIMPLE: QR b√°sico + texto esencial (para etiquetas peque√±as)
   üè∑Ô∏è MATERIAL: QR completo + informaci√≥n detallada

üìè OPTIMIZACI√ìN PARA MEDIDAS REALES:
   ‚Ä¢ 33.2mm x 14mm = 264 x 112 dots a 300dpi
   ‚Ä¢ QR compacto pero con informaci√≥n completa
   ‚Ä¢ Fuentes escaladas para m√°xima legibilidad
   ‚Ä¢ Aprovechamiento total del espacio disponible

üéÆ C√ìMO PROBAR:
   1. testEtiquetaPequena() - Etiqueta optimizada para medidas reales
   2. mostrarLayoutPequeno() - Ver dise√±o de la etiqueta
   3. testImpresionReal() - Imprimir etiqueta real (¬°CUIDADO!)

üì± AL ESCANEAR EL QR OBTENDR√ÅS:
   Un JSON con toda la informaci√≥n que puedes procesar autom√°ticamente
   
üí° BENEFICIOS:
   ‚úÖ Trazabilidad completa del material
   ‚úÖ Informaci√≥n accesible sin conectividad
   ‚úÖ Compatibilidad con sistemas externos
   ‚úÖ Backup de informaci√≥n en la etiqueta f√≠sica
   ‚úÖ Optimizado para etiquetas de tama√±o real
            `;
            
            alert(resumen);
        };
        
        
        // Funci√≥n para generar solo el ZPL sin enviar a impresora
        window.testSoloZPL = function() {
            if (!datosFilaSeleccionada) {
                simularSeleccionFila();
            }
            
            // Mapear datos para etiqueta
            const datosEtiqueta = {
                codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                numeroParte: datosFilaSeleccionada.numero_parte || '',
                cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
            };
            
            // Generar ZPL
            const comandoZPL = generarComandoZPLConDatos(datosEtiqueta, 'material');
            
            // Verificar contenido cr√≠tico
            const verificaciones = [
                { nombre: 'Cantidad 10000', encontrado: comandoZPL.includes('10000') },
                { nombre: 'Especificaci√≥n 10NF', encontrado: comandoZPL.includes('10NF') },
                { nombre: 'Fecha 22/07/2025', encontrado: comandoZPL.includes('22/07/2025') },
                { nombre: 'C√≥digo 0CC103BK5BA', encontrado: comandoZPL.includes('0CC103BK5BA') }
            ];
            
            // Mostrar resultado
            verificaciones.forEach(({ nombre, encontrado }) => {
            });
            
            const todoCorrecto = verificaciones.every(v => v.encontrado);
            
            return { comandoZPL, datosEtiqueta, verificaciones, todoCorrecto };
        };
        
        // Funci√≥n para probar el flujo completo de impresi√≥n
        window.testFlujoCompleto = function() {
            // Simular datos
            const datosSimulados = simularSeleccionFila();
            
            // Analizar ZPL que se generar√≠a
            const zplAnalizado = analizarZPLGenerado();
            
            
            return { datosSimulados, zplAnalizado, listo: true };
        };
        
        // Funci√≥n para analizar exactamente qu√© ZPL se genera
        window.analizarZPLGenerado = function() {
            
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Mapear datos exactamente como lo hace reimprimirEtiqueta()
            const datosEtiqueta = {
                codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                numeroParte: datosFilaSeleccionada.numero_parte || '',
                cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
            };
            
            
            // Generar ZPL con la funci√≥n que usa reimprimirEtiqueta()
            const zplOriginal = generarComandoZPLConDatos(datosEtiqueta, 'material');
            
            // Analizar el ZPL l√≠nea por l√≠nea
            const lineasZPL = zplOriginal.split('\n');
            
            lineasZPL.forEach((linea, index) => {
                // Buscar l√≠neas que contienen datos cr√≠ticos
                if (linea.includes('^FD') && linea.includes('^FS')) {
                    const contenido = linea.match(/\^FD([^F]*)\^FS/);
                    if (contenido) {
                        const valor = contenido[1];
                        
                        // Identificar qu√© tipo de dato es
                        if (valor === datosEtiqueta.cantidadActual) {
                        } else if (valor.includes(datosEtiqueta.especificacionMaterial?.split('(')[0]?.trim() || '')) {
                        } else if (valor.includes('/07/') || valor.includes('/2025')) {
                        } else if (valor === datosEtiqueta.codigo || valor.includes(',')) {
                        } else if (valor === 'QTY:') {
                        } else if (valor === 'Fecha de entrada:') {
                        } else if (valor.length > 0) {
                        }
                    }
                }
            });
            
            // Verificar datos espec√≠ficos esperados
            
            const verificaciones = [
                { nombre: 'Cantidad 10000', valor: '10000', presente: zplOriginal.includes('10000') },
                { nombre: 'Fecha 22/07/2025', valor: '22/07/2025', presente: zplOriginal.includes('22/07/2025') },
                { nombre: 'Especificaci√≥n 10NF', valor: '10NF', presente: zplOriginal.includes('10NF') },
                { nombre: 'C√≥digo 0CC103BK5BA', valor: '0CC103BK5BA', presente: zplOriginal.includes('0CC103BK5BA') }
            ];
            
            verificaciones.forEach(({ nombre, valor, presente }) => {
                const estado = presente ? '‚úÖ' : '‚ùå';
                if (!presente) {
                }
            });
            
            // Mostrar fragmento problem√°tico si la cantidad es 1
            if (zplOriginal.includes('^FD1^FS')) {
                const lineasProblema = lineasZPL.filter(linea => linea.includes('^FD1^FS'));
                lineasProblema.forEach(linea => {
                });
            }
            
            
            return zplOriginal;
        };
        
        // Funci√≥n para diagnosticar por qu√© se generan 2 c√≥digos ZPL
        window.diagnosticarZPLDuplicado = function() {
            
            // Revisar si hay fila seleccionada
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Probar SOLO la generaci√≥n ZPL, sin enviar a impresora
            
            try {
                // Mapear datos como lo hace reimprimirEtiqueta()
                const datosEtiqueta = {
                    codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                    numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                    numeroParte: datosFilaSeleccionada.numero_parte || '',
                    cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                    propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                    especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                    fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
                };
                
                
                // Verificar campos cr√≠ticos
                const camposCriticos = {
                    'C√≥digo': datosEtiqueta.codigo,
                    'Cantidad Actual': datosEtiqueta.cantidadActual,
                    'Fecha Recibo': datosEtiqueta.fechaRecibo,
                    'Especificaci√≥n': datosEtiqueta.especificacionMaterial
                };
                
                Object.entries(camposCriticos).forEach(([nombre, valor]) => {
                    const estado = valor && valor.trim() !== '' ? '‚úÖ' : '‚ùå';
                });
                
                // Generar ZPL solo para ver el resultado
                const zplGenerado = generarComandoZPLConDatos(datosEtiqueta, 'material');
                
                
                // Buscar campos espec√≠ficos en el ZPL
                
                // Buscar cantidad en el ZPL
                const cantidadMatch = zplGenerado.match(/\^FD(\d+)\^FS.*QTY/i);
                if (cantidadMatch) {
                    if (cantidadMatch[1] !== datosEtiqueta.cantidadActual) {
                        console.error('‚ùå ERROR: Cantidad en ZPL no coincide con datos SQL!');
                    } else {
                    }
                } else {
                    console.error('‚ùå No se encontr√≥ cantidad en ZPL');
                }
                
                // Buscar especificaci√≥n en el ZPL
                const especMatch = zplGenerado.match(/\^FD([^F]+)\^FS.*especif/i);
                if (especMatch) {
                } else {
                }
                
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
            }
        };
        
        // Funci√≥n para limpiar toda selecci√≥n y probar con fila real
        window.limpiarYProbarSeleccion = function() {
            
            // Limpiar cualquier selecci√≥n anterior (incluso simulada)
            limpiarSeleccionTabla();
            
            
        };
        
        // Funci√≥n para verificar estado actual de selecci√≥n
        window.verificarEstadoActual = function() {
            
            if (filaSeleccionada) {
            }
            
            if (datosFilaSeleccionada) {
            }
            
        };
        
        // Funci√≥n para simular selecci√≥n de fila con datos espec√≠ficos
        window.simularSeleccionFila = function() {
            // Datos exactos de la imagen
            const datosSimulados = {
                codigo_material_recibido: '0CC103BK5BA',
                numero_lote_material: '0CC103BK5BA',
                numero_parte: '0CC103BK5BA',
                cantidad_actual: '10000',
                fecha_recibo: '2025-07-22',
                especificacion: '10NF 10% 50V X7R (SMD 1005)',
                propiedad_material: 'SMD',
                cantidad_estandarizada: '10000',
                ubicacion_salida: '',
                material_importacion_local: 'L',
                estado_desecho: 'Cu'
            };
            
            // Simular selecci√≥n
            datosFilaSeleccionada = datosSimulados;
            
            // Crear elemento fila simulado
            const filaSimulada = document.createElement('tr');
            filaSimulada.className = 'fila-clickeable fila-seleccionada';
            filaSimulada.innerHTML = '<td>Fila simulada para prueba</td>';
            filaSeleccionada = filaSimulada;
            
            
            return datosSimulados;
        };
        
        // Funci√≥n para comparar selecci√≥n real vs simulada
        window.compararSelecciones = function() {
            
            if (datosFilaSeleccionada) {
                
                // Verificar si los valores cr√≠ticos est√°n presentes
                const datosCriticos = {
                    codigo: datosFilaSeleccionada.codigo_material_recibido,
                    cantidad: datosFilaSeleccionada.cantidad_actual,
                    fecha: datosFilaSeleccionada.fecha_recibo,
                    especificacion: datosFilaSeleccionada.especificacion
                };
                
                Object.entries(datosCriticos).forEach(([campo, valor]) => {
                    const estado = valor ? '‚úÖ' : '‚ùå';
                    const tipo = typeof valor;
                    const longitud = valor ? valor.length : 0;
                });
                
                // Comparar con datos esperados de la imagen
                const datosEsperados = {
                    codigo_material_recibido: '0CC103BK5BA',
                    cantidad_actual: '10000',
                    fecha_recibo: '2025-07-22',
                    especificacion: '10NF 10% 50V X7R (SMD 1005)'
                };
                
                Object.entries(datosEsperados).forEach(([campo, esperado]) => {
                    const actual = datosFilaSeleccionada[campo];
                    const coincide = actual === esperado;
                    const estado = coincide ? '‚úÖ' : '‚ùå';
                });
                
            } else {
            }
            
        };
        
        // Nueva funci√≥n para probar con datos espec√≠ficos que vemos en la imagen
        window.testConDatosEspecificos = function() {
            
            // Datos exactos de la imagen del usuario
            const datosImagen = {
                codigo_material_recibido: '0CC103BK5BA',
                numero_lote_material: '0CC103BK5BA',
                numero_parte: '0CC103BK5BA',
                cantidad_actual: '10000',  // ‚úÖ Cantidad de la imagen
                fecha_recibo: '2025-07-22', // ‚úÖ Fecha de la imagen
                especificacion: '10NF 10% 50V X7R (SMD 1005)', // ‚úÖ Especificaci√≥n de la imagen
                propiedad_material: 'SMD',
                cantidad_estandarizada: '10000',
                ubicacion_salida: '',
                material_importacion_local: 'L',
                estado_desecho: 'Cu'
            };
            
            
            
            // Probar directamente la funci√≥n de reimpresi√≥n
            reimprimirEtiqueta(datosImagen)
                .then(() => {
                })
                .catch(error => {
                    console.error('‚ùå Error en test con datos espec√≠ficos:', error);
                });
        };
        
        // === FUNCIONES DE TESTING SIMPLIFICADAS ===
        window.testSeleccionTabla = function() {
            
            if (datosFilaSeleccionada) {
            }
            
        };
        
        window.mostrarEstadoSeleccion = function() {
            
            if (!filaSeleccionada) {
                return;
            }
            
            
            if (datosFilaSeleccionada) {
                
            }
        };
        
        // Nueva funci√≥n para probar reimpresi√≥n directamente
        window.testReimpresion = function() {
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Verificar datos cr√≠ticos antes de reimpresi√≥n
            
            // Verificar si los datos est√°n completos
            const datos = {
                cantidad: datosFilaSeleccionada.cantidad_actual || 'VAC√çO',
                fecha: datosFilaSeleccionada.fecha_recibo || 'VAC√çO',
                especificacion: datosFilaSeleccionada.especificacion || 'VAC√çO',
                codigo: datosFilaSeleccionada.codigo_material_recibido || 'VAC√çO'
            };
            
            Object.entries(datos).forEach(([key, value]) => {
                const status = value === 'VAC√çO' ? '‚ùå' : '‚úÖ';
            });
            
            // Probar la funci√≥n de reimpresi√≥n
            reimprimirEtiqueta(datosFilaSeleccionada)
                .then(() => {
                })
                .catch(error => {
                    console.error('‚ùå Error en test de reimpresi√≥n:', error);
                });
        };
        
        /**
         * Funci√≥n para probar etiqueta con fuentes GRANDES (solucionando texto peque√±o)
         */
        window.testFuentesGrandes = function(codigo = 'TEST-GRANDE-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                } else {
                }
            });
            
            // Generar comando ZPL con fuentes GRANDES
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            // Extraer y mostrar informaci√≥n del QR
            const qrMatch = comandoZPL.match(/\^FDQA,(.+?)\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
            }
            
            // Verificar comandos espec√≠ficos
            if (comandoZPL.includes('^XFR:si.ZPL^FS')) {
            }
            
            if (comandoZPL.includes('^PQ1,0,1')) {
            }
            
            
            return comandoZPL;
        };

        /**
         * Funci√≥n para mostrar comparaci√≥n antes/despu√©s de la optimizaci√≥n
         */
        window.mostrarComparacionOptimizacion = function() {
        };
        
        /**
         * Funci√≥n para probar PLANTILLA PROFESIONAL del usuario
         */
        window.testPlantillaProfesional = function(codigo = 'TEST-PROF-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                } else {
                }
            });
            
            // Generar comando ZPL con plantilla profesional
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            // Extraer y mostrar informaci√≥n del QR
            const qrMatch = comandoZPL.match(/\\^FDLA,(.+?)\\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
            }
            
            
            return comandoZPL;
        };
        
        /**
         * Funci√≥n para probar la nueva funci√≥n getCantidadActual()
         */
        window.testGetCantidadActual = function(cantidadPrueba = '2500') {
            
            // 1. Limpiar todos los campos posibles
            const camposPosibles = [
                'cantidad_actual',
                'cantidad_estandarizada', 
                'cantidad',
                'qty',
                'quantity',
                'cantidad_material'
            ];
            
            camposPosibles.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            // 2. Probar sin ning√∫n valor
            let cantidad = getCantidadActual();
            
            // 3. Llenar cantidad_actual y probar
            const campoCantidad = document.getElementById('cantidad_actual');
            if (campoCantidad) {
                campoCantidad.value = cantidadPrueba;
                cantidad = getCantidadActual();
            } else {
            }
            
            // 4. Probar fallback a cantidad_estandarizada
            if (campoCantidad) campoCantidad.value = '';
            const campoEstandarizada = document.getElementById('cantidad_estandarizada');
            if (campoEstandarizada) {
                campoEstandarizada.value = '999';
                cantidad = getCantidadActual();
            } else {
            }
            
            // 5. Generar ZPL de prueba con la nueva funci√≥n
            if (campoCantidad) campoCantidad.value = cantidadPrueba;
            const codigoPrueba = 'TEST-GET-CANTIDAD-' + Date.now().toString().slice(-4);
            const zpl = generarComandoZPLDirecto(codigoPrueba, 'material');
            
            const contieneQuantidad = zpl.includes(`^FD${cantidadPrueba}^FS`);
            
            
            return {
                funcionTrabaja: true,
                cantidadObtenida: cantidad,
                zplContieneCantidad: contieneQuantidad
            };
        };
        
        /**
         * Funci√≥n para verificar el estado actual de los campos de cantidad
         */
        window.verificarCamposCantidad = function() {
            
            const campos = [
                'cantidad_actual',
                'cantidad_estandarizada',
                'cantidad',
                'qty', 
                'quantity',
                'cantidad_material'
            ];
            
            let camposEncontrados = [];
            let camposConValor = [];
            
            campos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    camposEncontrados.push(id);
                    const valor = elemento.value || '';
                    if (valor.trim() !== '') {
                        camposConValor.push({ id, valor });
                    } else {
                    }
                } else {
                }
            });
            
            
            // Probar la funci√≥n actual
            const cantidadActual = getCantidadActual();
            
            return {
                camposEncontrados,
                camposConValor,
                cantidadActual
            };
        };
        
        /**
         * Funci√≥n para verificar cantidad en BD directamente
         */
        window.verificarCantidadBD = function(codigoMaterial = '0RH5602C622') {
            
            if (codigosMaterial.length === 0) {
                return;
            }
            
            const materialInfo = codigosMaterial.find(c => c.codigo === codigoMaterial);
            
            if (materialInfo) {
                
                // Probar getCantidadActual con este c√≥digo seleccionado
                const select = document.getElementById('codigoMaterialSelect');
                if (select) {
                    select.value = codigoMaterial;
                    const cantidad = getCantidadActual();
                }
                
                return materialInfo;
            } else {
                codigosMaterial.forEach((material, index) => {
                });
                return null;
            }
        };
        
        
        // ========== FUNCIONES GLOBALES PARA DEBUGGING CANTIDAD ==========
        
        /**
         * Test global para getCantidadActual()
         */
        window.testCantidadActual = function() {
            
            // Mostrar estado de todos los campos relevantes
            const campos = [
                'cantidad_actual',
                'cantidad_estandarizada', 
                'codigoMaterialSelect'
            ];
            
            campos.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                } else {
                }
            });
            
            // Mostrar estado del array codigosMaterial
            if (typeof codigosMaterial !== 'undefined') {
                const codigoSeleccionado = document.getElementById('codigoMaterialSelect')?.value;
                if (codigoSeleccionado) {
                    const material = codigosMaterial.find(m => m.codigo === codigoSeleccionado);
                }
            } else {
            }
            
            // Ejecutar funci√≥n y mostrar resultado
            const resultado = getCantidadActual();
            
            return resultado;
        };
        
        /**
         * Diagn√≥stico completo de cantidad
         */
        window.diagnosticarCantidadCompleto = function() {
            
            // 1. Verificar campos
            verificarCamposCantidad();
            
            // 2. Verificar BD
            verificarCantidadBD();
            
            // 3. Test de funci√≥n
            const resultado = window.testCantidadActual();
            
            // 4. Resumen
            
            if (resultado === '1') {
                console.warn('‚ö†Ô∏è ATENCI√ìN: Se est√° usando el valor por defecto');
            } else {
            }
            
            return resultado;
        };
        
        /**
         * Funci√≥n para probar con datos espec√≠ficos
         */
        window.probarConCantidadEspecifica = function(cantidad = '5000') {
            
            // Llenar campo cantidad_actual
            const campoActual = document.getElementById('cantidad_actual');
            if (campoActual) {
                campoActual.value = cantidad;
                
                // Resaltar visualmente
                campoActual.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    campoActual.style.backgroundColor = '';
                }, 2000);
            }
            
            // Probar la funci√≥n
            const resultado = getCantidadActual();
            
            if (resultado === cantidad) {
            } else {
                console.warn(`‚ö†Ô∏è Esperado: "${cantidad}", Obtenido: "${resultado}"`);
            }
            
            return resultado;
        };
        
        /**
         * Funci√≥n para testear ZPL con cantidad espec√≠fica
         */
        window.testZPLConCantidad = function(cantidad = '2500', codigo = 'TEST-CANTIDAD-' + Date.now()) {
            
            // 1. Llenar cantidad
            probarConCantidadEspecifica(cantidad);
            
            // 2. Generar ZPL
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            // 3. Verificar que la cantidad est√© en el ZPL
            const contieneCantidad = comandoZPL.includes(cantidad);
            
            if (contieneCantidad) {
            } else {
                console.warn('‚ö†Ô∏è La cantidad NO se est√° insertando en el ZPL');
            }
            
            return { comandoZPL, contieneCantidad };
        };
        
        /**
         * Funci√≥n para probar la funci√≥n ORIGINAL que S√ç FUNCIONABA
         */
        window.testFuncionOriginalQueFunc = function(codigo = 'TEST-ORIGINAL-' + Date.now()) {
            
            // Crear datos espec√≠ficos de prueba (como los que se capturan en guardarFormulario)
            const datosEspecificos = {
                codigo: codigo,
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            
            // Usar la funci√≥n original que funcionaba
            const comandoZPL = generarComandoZPLConDatos(datosEspecificos, 'material');
            
            
            
            return comandoZPL;
        };
        
        /**
         * Funci√≥n para probar impresi√≥n con datos espec√≠ficos
         */
        window.testImprimirConDatosEspecificos = function() {
            
            const datosEtiqueta = {
                codigo: 'TEST-DATOS-ESPECIFICOS-' + Date.now(),
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            
            try {
                // Usar la funci√≥n de impresi√≥n que usa generarComandoZPLConDatos()
                imprimirZebraAutomaticoConDatos(datosEtiqueta);
            } catch (error) {
                console.error('‚ùå Error:', error);
            }
        };
        
        /**
         * Funci√≥n para comparar la funci√≥n original vs la actual
         */
        window.compararFunciones = function(codigo = 'TEST-COMPARE-' + Date.now()) {
            
            // Datos de prueba
            const datosEspecificos = {
                codigo: codigo,
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            const zplOriginal = generarComandoZPLConDatos(datosEspecificos, 'material');
            
            
            // Llenar campos temporalmente para la funci√≥n actual
            const campoActual = document.getElementById('cantidad_actual');
            const campoEspecificacion = document.getElementById('almacen_especificacion_material');
            const campoNumero = document.getElementById('numero_parte_lower');
            
            if (campoActual) campoActual.value = '5000';
            if (campoEspecificacion) campoEspecificacion.value = '56KJ 1/10W (SMD 1608)';
            if (campoNumero) campoNumero.value = '56KJ 1/10W (SMD 1608)';
            
            const zplActual = generarComandoZPLDirecto(codigo, 'material');
            
            return { original: zplOriginal, actual: zplActual };
        };
        
        // Mostrar funciones principales disponibles
    </script>

</body>
</html>