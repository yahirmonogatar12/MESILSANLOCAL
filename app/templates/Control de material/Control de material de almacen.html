<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Material - Almac√©n</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=LG+regular&display=swap" rel="stylesheet">
    
    <!-- Estilos globales -->
    <link rel="stylesheet" href="/static/css/control_material_almacen.css">
    
    <!-- Scripts necesarios -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/fontawesome.all.min.js"></script>
    <script src="/static/js/Chart.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script src="/static/js/sweetalert2.all.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/daterangepicker.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/flatpickr.min.js"></script>
    <script src="/static/js/autoNumeric.min.js"></script>
    <script src="/static/js/control_material_almacen.js"></script>
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
</head>
<body>
     <!-- Fila 1: SOLO Forma de material, ancho completo -->
<div class="material-container2">

    <div class="material-form-section">
        <div class="material-form-group" >
            <label>
                    Forma de material
            </label>
            <select id="forma_material">
                <option>
                    OriginCode
                </option>
            </select>
        </div>
    </div>

    <div class="material-form-section">    
        <div class="material-form-row four-column">
            <div class="material-form-group">
                <label>
                    Cliente
                </label>
                <select id="cliente">
                    <option value="">
                        Seleccionar
                    </option>
                    <option value="LG_REFRIS">
                        LG_REFRIS
                    </option>
                    <option value="LG_ESTUFAS">
                        LG_ESTUFAS
                    </option>
                </select>
            </div>
            <div class="material-form-group">
                <label>C√≥digo de material original</label>
                <div style="display: flex; align-items: center; gap: 8px; min-width: 0;">
                    <input type="text" id="codigoMaterialOriginal" style="flex: 1; min-width: 0;" placeholder="Escanear c√≥digo aqu√≠..." onkeydown="procesarScaneo(event)">
                    <button type="button" id="btnCameraQR" onclick="abrirEscanerQR()" style="padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        QR
                    </button>
                </div>
            </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>C√≥digo de material</label>
            <div style="position: relative; min-width: 0;">
                <select id="codigoMaterialSelect" onclick="event.preventDefault(); abrirModalCodigoMaterial();" readonly style="cursor: pointer; width: 100%;">
                    <option value="">Seleccionar</option>
                </select>
                
          
                <div id="modalCodigoMaterial" class="dropdown-modal">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar c√≥digo, nombre o especificaci√≥n..." onkeyup="filtrarTablaModal()">
                    <div class="dropdown-table-container">
                        <table class="dropdown-table">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Especificaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCodigosBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="material-form-group">
            <label>Material importaci√≥n/local</label>
            <select id="material_importacion_local">
                <option value="Customer Supply">Customer Supply</option>
                <option value="Local">Local</option>
                <option value="Importaci√≥n">Importaci√≥n</option>
            </select>
        </div>
        <div class="material-form-group">
            <label>Fecha de recibo</label>
            <input type="date" id="fecha_recibo" value="2025-07-08">
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>
    <div class="material-form-row four-column">
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Fecha de fabricaci√≥n</label>
            <input type="date" id="fecha_fabricacion" value="2025-07-08">
        </div>
        <div class="material-form-group">
            <label>Cantidad actual:</label>
            <input type="text" id="cantidad_actual">
        </div>
        <div class="material-form-group">
            <label>N√∫mero de lote de material</label>
            <input type="text" id="numero_lote_material">
        </div>
    </div>
        </div>
        
    
<div class="material-form-section2">
    <div class="material-form-row four-column" style="align-items: center;">
        <div class="material-form-group">
            <label>C√≥digo de material recibido</label>
            <input type="text" id="codigo_material_recibido">
        </div>
        <div class="material-form-group">
            <label>N√∫mero de parte:</label>
            <input type="text" id="numero_parte_lower">
        </div>
        <div class="material-form-group">
            <label>Cantidad estandarizada</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="cantidad_estandarizada" style="flex: 1;">
                <button class="material-btn gray" style="white-space: nowrap;">Conf. de impresora</button>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        
        <div class="material-form-group">
            <label>C√≥digo de material</label>
            <input type="text" id="codigo_material_lower">
        </div>
        <div class="material-form-group">
            <label>Propiedad de material</label>
            <input type="text" id="propiedad_material">
        </div>
        <div class="material-form-group">
            <label>Especificaci√≥n de material</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="almacen_especificacion_material" readonly placeholder="Se carga autom√°ticamente al seleccionar c√≥digo" style="flex: 1;">
                <label class="checkbox-label-almacen" style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer; white-space: nowrap;">
                    <input type="checkbox" id="checkbox_registro_almacen" class="checkbox-almacen" style="transform: scale(1.0); accent-color: #27ae60;">
                    Registro autom√°tico
                </label>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
        <div class="material-form-group"></div>
        <div class="material-form-group"></div>
        <div class="material-form-group" style="justify-self: end;">
             <div style="display: flex; gap: 4px; align-items: center;">
                <button class="material-btn orange botones-almacen" id="btnGuardar" onclick="guardarFormulario()">Guardar</button>
                <button class="material-btn botones-almacen">Imprimir</button>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vac√≠o para mantener estructura -->
        </div>
    </div>
</div>

        <!-- Botonera usando el dise√±o de CONTROL_DE_MATERIAL -->
        

        <!-- Secci√≥n de filtros usando el dise√±o de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; overflow: hidden;">
                <label style="margin: 0; color: lightgray; font-size: 11px; white-space: nowrap;">Fecha de recibo</label>
                <input type="date" id="filtro_fecha_inicio" value="2025-07-08" style="width: 130px; height: 24px; font-size: 10px; font-family: sans-serif; min-width: 100px;">
                <span style="color: lightgray; font-size: 11px;">~</span>
                <input type="date" id="filtro_fecha_fin" value="2025-07-08" style="width: 130px; height: 24px; font-size: 10px; min-width: 100px;">
            </div>
            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button class="material-btn" id="btnConsultar" onclick="consultarRegistros()">Consultar</button>
                <button class="material-btn secondary" onclick="exportarExcel()">Exportar Excel</button>
            </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="material-table-container">
            <table class="material-table" id="tablaControlAlmacen">
                <thead>
                    <tr>
                        <th>C√≥digo de material recibido</th>
                        <th>C√≥digo de material</th>
                        <th>N√∫mero de parte</th>
                        <th>N√∫mero de lote de material</th>
                        <th>Propiedad de material</th>
                        <th>Cantidad actual</th>
                        <th>Cantidad estandarizada</th>
                        <th>Ubicaci√≥n de salida</th>
                        <th>Fecha de recibo</th>
                        <th>Especificaci√≥n</th>
                        <th>Material importaci√≥n/local</th>
                        <th>Estado de desecho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="12" class="no-data">
                            No hay datos para mostrar. Haga clic en "Consultar" para cargar los registros.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p class="total-info">Total Rows: 0</p>
        </div>

    </div>

    <!-- Modal para Esc√°ner QR -->
    <div id="modalQRScanner" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
        <div style="position: relative; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; background-color: #fff; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                <h3 style="margin: 0; color: #3498db;">üì∑ Esc√°ner QR/C√≥digo de Barras</h3>
                <button onclick="cerrarEscanerQR()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #e74c3c;">√ó</button>
            </div>
            
            <div id="qrReaderContainer" style="width: 100%; max-width: 500px; margin: 0 auto;">
                <div id="qrReader" style="width: 100%;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: #666; font-size: 14px;">
                    üéØ Apunte la c√°mara hacia el c√≥digo QR o c√≥digo de barras<br>
                    üì± El escaneo se realizar√° autom√°ticamente cuando se detecte el c√≥digo
                </p>
                <div id="qrStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;">
                    <span id="qrStatusText"></span>
                </div>
                
                <!-- Entrada manual alternativa -->
                <div id="entradaManualContainer" style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; display: none;">
                    <p style="margin: 0 0 10px 0; color: #666; font-size: 12px;">üí° <strong>Entrada Manual:</strong></p>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="codigoManualQR" placeholder="Pegue el c√≥digo aqu√≠..." onkeydown="if(event.key==='Enter') procesarCodigoManualQR()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <button onclick="procesarCodigoManualQR()" style="padding: 8px 12px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                            ‚úÖ Usar
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="cambiarCamara()" id="btnCambiarCamara" style="padding: 8px 16px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    üîÑ Cambiar C√°mara
                </button>
                <button onclick="mostrarEntradaManual()" style="padding: 8px 16px; background-color: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    ‚å®Ô∏è Entrada Manual
                </button>
                <button onclick="cerrarEscanerQR()" style="padding: 8px 16px; background-color: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        let codigosMaterial = [];

        // Funci√≥n global para inicializar cuando se muestra el control de almac√©n
        window.inicializarControlAlmacenModule = function() {
            // Peque√±o delay para asegurar que el DOM est√© completamente renderizado
            setTimeout(() => {
                inicializarControlAlmacen();
                configurarListenersAdicionales();
            }, 100);
        };

        // Funci√≥n de test de conectividad b√°sica y simple
        window.testConectividadAlmacen = function() {
            fetch('/consultar_control_almacen')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Error HTTP: ' + response.status);
                    }
                })
                .then(data => {
                    // NO cargar autom√°ticamente los datos, solo verificar conectividad
                })
                .catch(error => {
                    console.error('‚ùå Error de conectividad:', error);
                });
        };

        // Cargar c√≥digos de material al cargar la p√°gina
        function inicializarControlAlmacen() {
            // *** TABLA VISIBLE POR DEFECTO PARA DEBUGGING ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            cargarCodigosMaterial();
            cargarClienteSeleccionado(); // Cargar la √∫ltima selecci√≥n de cliente
            cargarSiguienteSecuencial(); // Cargar el siguiente n√∫mero secuencial
        }

        // Verificar si el DOM ya est√° listo o esperar a que lo est√©
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarControlAlmacen);
        } else {
            // DOM ya est√° listo, ejecutar inmediatamente
            inicializarControlAlmacen();
        }

        // Funci√≥n para cargar la √∫ltima selecci√≥n de cliente
        async function cargarClienteSeleccionado() {
            try {
                const response = await fetch('/cargar_cliente_seleccionado');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cliente) {
                        const selectCliente = document.getElementById('cliente');
                        if (selectCliente) {
                            selectCliente.value = data.cliente;
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar cliente seleccionado:', error);
            }
        }

        // Funci√≥n para guardar la selecci√≥n de cliente
        async function guardarClienteSeleccionado(cliente) {
            try {
                const response = await fetch('/guardar_cliente_seleccionado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cliente: cliente })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (!data.success) {
                        console.error('‚ùå Error al guardar cliente:', data.error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al guardar cliente:', error);
            }
        }

        async function cargarCodigosMaterial() {
            try {
                const response = await fetch('/obtener_codigos_material');
                
                if (response.ok) {
                    codigosMaterial = await response.json();
                } else {
                    console.error('Error al cargar c√≥digos de material, status:', response.status);
                    // Si hay error, usar datos de prueba
                    codigosMaterial = [
                        {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                        {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                        {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                    ];
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                // Si hay error, usar datos de prueba
                codigosMaterial = [
                    {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                    {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                    {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                ];
            }
        }

        function abrirModalCodigoMaterial() {
            const modal = document.getElementById('modalCodigoMaterial');
            const tbody = document.getElementById('tablaCodigosBody');
            const searchInput = document.getElementById('searchInput');
            
            // Cerrar otros dropdowns si est√°n abiertos
            cerrarModalCodigoMaterial();
            
            // Limpiar b√∫squeda
            searchInput.value = '';
            
            // Llenar la tabla
            tbody.innerHTML = '';
            
            if (codigosMaterial.length === 0) {
                // Mostrar mensaje de "no hay datos"
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: #666;">No hay c√≥digos disponibles</td>';
            } else {
                codigosMaterial.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
            
            // Mostrar el modal con animaci√≥n suave
            modal.style.display = 'block';
            
            // Enfocar el campo de b√∫squeda
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }

        function cerrarModalCodigoMaterial() {
            document.getElementById('modalCodigoMaterial').style.display = 'none';
        }

        function seleccionarCodigo(codigo) {
            const select = document.getElementById('codigoMaterialSelect');
            
            // Buscar la informaci√≥n completa del c√≥digo seleccionado
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigo);
            
            // Actualizar el select con el c√≥digo seleccionado
            select.innerHTML = `
                <option value="${codigo}" selected>${codigo}</option>
                <option value="">Seleccionar</option>
            `;
            
            // Mostrar la especificaci√≥n inmediatamente al seleccionar
            if (codigoCompleto) {
                select.title = `${codigoCompleto.codigo} - ${codigoCompleto.nombre} - ${codigoCompleto.spec}`;
                
                // Llenar inmediatamente el campo de especificaci√≥n
                llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || codigoCompleto.spec || '');
                console.log(`üìã Especificaci√≥n cargada inmediatamente: ${codigoCompleto.especificacion_material || codigoCompleto.spec}`);
                console.log(`üìã N√∫mero de parte disponible: ${codigoCompleto.numero_parte}`);
            }
            
            cerrarModalCodigoMaterial();
            
            // Llenar autom√°ticamente los campos inferiores despu√©s de seleccionar
            setTimeout(() => {
                llenarCamposInferiores(codigo);
            }, 500);
        }

        function filtrarTablaModal() {
            const input = document.getElementById('searchInput');
            const filtro = input.value.toLowerCase();
            const tbody = document.getElementById('tablaCodigosBody');
            
            tbody.innerHTML = '';
            
            const codigosFiltrados = codigosMaterial.filter(codigo => 
                codigo.codigo.toLowerCase().includes(filtro) ||
                codigo.nombre.toLowerCase().includes(filtro) ||
                codigo.spec.toLowerCase().includes(filtro)
            );
            
            if (codigosFiltrados.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 15px;">No se encontraron resultados</td>';
            } else {
                codigosFiltrados.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCodigoMaterial');
            const select = document.getElementById('codigoMaterialSelect');
            
            // Si se hace clic fuera del modal y del select, cerrar el modal
            if (!modal.contains(event.target) && !select.contains(event.target)) {
                cerrarModalCodigoMaterial();
            }
        });

        // Configurar listeners adicionales cuando la p√°gina est√© lista
        function configurarListenersAdicionales() {
            // Agregar event listener al select de cliente
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    const clienteSeleccionado = this.value;
                    if (clienteSeleccionado) {
                        guardarClienteSeleccionado(clienteSeleccionado);
                        
                        // Resaltar visualmente que se guard√≥
                        this.style.backgroundColor = '#d4edda';
                        this.style.borderColor = '#c3e6cb';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, 1500);
                    }
                });
            }
            
            // Agregar listener adicional al bot√≥n de consultar para asegurar que funcione
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', function(e) {
                    // Solo prevenir default si no hay onclick definido
                    if (!this.onclick) {
                        e.preventDefault();
                        consultarRegistros();
                    }
                });
            }
        }

        // Verificar si el DOM ya est√° listo para configurar listeners adicionales
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarListenersAdicionales);
        } else {
            // DOM ya est√° listo, ejecutar inmediatamente
            configurarListenersAdicionales();
        }

        function procesarScaneo(event) {
            // Detectar Enter (cuando termina el escaneo)
            if (event.key === 'Enter') {
                event.preventDefault();
                const codigoCompleto = event.target.value.trim();
                
                if (codigoCompleto) {
                    parsearYDistribuirCodigo(codigoCompleto);
                }
            }
        }

        function procesarCodigoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const codigoCompleto = input.value.trim();
            
            if (codigoCompleto) {
                parsearYDistribuirCodigo(codigoCompleto);
            } else {
                alert('Por favor, ingrese o escanear un c√≥digo antes de procesar.');
            }
        }

        async function parsearYDistribuirCodigo(codigoCompleto) {
            try {
                // Primero intentar con las reglas de trazabilidad
                const resultado = await aplicarReglasEscaneo(codigoCompleto);
                
                if (resultado) {
                    // Si se encontr√≥ una regla que coincide, usar esos datos
                    if (resultado.partNumber) {
                        // Usar el partNumber como c√≥digo de material
                        buscarYSeleccionarCodigoMaterial(resultado.partNumber);
                    }
                    
                    if (resultado.lotNumber) {
                        const inputLote = document.getElementById('numero_lote_material');
                        if (inputLote) {
                            inputLote.value = resultado.lotNumber;
                        }
                    }
                    
                    mostrarNotificacionEscaneo(resultado.partNumber, null, resultado.lotNumber);
                    return;
                }
                
                // Si no funciona con reglas, usar el m√©todo anterior como fallback
                const partes = codigoCompleto.split('-');
                
                if (partes.length < 8) {
                    alert('Formato de c√≥digo inv√°lido. No se encontr√≥ regla aplicable y no tiene el formato esperado con "/" ');
                    return;
                }
                
                // Extraer SOLO el c√≥digo de material y n√∫mero de lote (m√©todo anterior)
                const codigoMaterial = partes[0];           // M2124740058
                const numeroLote = partes[7];               // IA3116H14
                
                // Distribuir a los campos correspondientes
                if (codigoMaterial) {
                    buscarYSeleccionarCodigoMaterial(codigoMaterial);
                }
                
                if (numeroLote) {
                    const inputLote = document.getElementById('numero_lote_material');
                    if (inputLote) {
                        inputLote.value = numeroLote;
                    }
                }
                
                mostrarNotificacionEscaneo(codigoMaterial, null, numeroLote);
                
            } catch (error) {
                console.error('Error al procesar c√≥digo escaneado:', error);
                alert('Error al procesar el c√≥digo escaneado');
            }
        }

        function buscarYSeleccionarCodigoMaterial(codigo) {
            // Buscar si el c√≥digo existe en la lista de materiales
            const codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
            
            if (codigoEncontrado) {
                // Si existe, seleccionarlo autom√°ticamente
                seleccionarCodigo(codigo);
            } else {
                // Si no existe, mostrar en el dropdown pero sin seleccionar
                const select = document.getElementById('codigoMaterialSelect');
                select.innerHTML = `
                    <option value="${codigo}" selected>${codigo} (C√≥digo escaneado - no encontrado en BD)</option>
                    <option value="">Seleccionar</option>
                `;
                select.style.backgroundColor = '#fff3cd'; // Resaltar en amarillo
                console.warn('C√≥digo de material no encontrado en la base de datos:', codigo);
                
                // Tambi√©n llenar campos b√°sicos aunque no est√© en BD
                llenarCamposInferiores(codigo);
                
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 3000);
            }
        }

        function mostrarNotificacionEscaneo(codigo, cantidad, lote) {
            // Llenar autom√°ticamente los campos inferiores
            llenarCamposInferiores(codigo);
        }

        // Contador global para n√∫meros secuenciales del c√≥digo de material recibido
        let contadorSecuencial = 1;
        let proximoCodigoCompleto = '';

        // Funci√≥n para cargar el siguiente n√∫mero secuencial desde la base de datos
        async function cargarSiguienteSecuencial(codigoMaterial = '') {
            try {
                // Construir URL con c√≥digo de material si est√° disponible
                let url = '/obtener_siguiente_secuencial';
                if (codigoMaterial) {
                    url += `?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                }
                
                console.log(`üîç Cargando secuencial desde: ${url}`);
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üìä Respuesta del servidor:`, data);
                    
                    if (data.success) {
                        contadorSecuencial = data.siguiente_secuencial || 1;
                        proximoCodigoCompleto = data.proximo_codigo_completo || '';
                        
                        console.log(`‚úÖ Variables actualizadas:`);
                        console.log(`   - contadorSecuencial: ${contadorSecuencial}`);
                        console.log(`   - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                    } else {
                        contadorSecuencial = 1;
                        proximoCodigoCompleto = '';
                        console.warn(`‚ö†Ô∏è Respuesta sin √©xito, usando valores por defecto`);
                    }
                } else {
                    contadorSecuencial = 1;
                    proximoCodigoCompleto = '';
                    console.error(`‚ùå Error en respuesta HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al cargar secuencial:', error);
                contadorSecuencial = 1;
                proximoCodigoCompleto = '';
            }
        }

        function llenarCamposInferiores(codigoMaterial) {
            console.log(`üîç llenarCamposInferiores llamado con: ${codigoMaterial}`);
            
            // Buscar la informaci√≥n completa del c√≥digo de material
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
            console.log(`üì¶ Informaci√≥n completa encontrada:`, codigoCompleto);
            
            // FORZAR recarga del contador espec√≠fico para este c√≥digo de material
            console.log(`üîÑ Recargando contador para c√≥digo: ${codigoMaterial}`);
            
            cargarSiguienteSecuencial(codigoMaterial).then(() => {
                console.log(`üìä Variables despu√©s de cargar:`);
                console.log(`   - contadorSecuencial: ${contadorSecuencial}`);
                console.log(`   - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                
                // USAR DIRECTAMENTE proximoCodigoCompleto del servidor
                let codigoMaterialRecibidoCompleto = proximoCodigoCompleto;
                
                // Solo como fallback si el servidor no devuelve el c√≥digo completo
                if (!codigoMaterialRecibidoCompleto) {
                    const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const secuenciaFormateada = String(contadorSecuencial).padStart(4, '0');
                    codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}${secuenciaFormateada}`;
                    console.warn(`‚ö†Ô∏è Usando c√≥digo generado como fallback: ${codigoMaterialRecibidoCompleto}`);
                }
                
                console.log(`üè∑Ô∏è C√≥digo material recibido final: ${codigoMaterialRecibidoCompleto}`);
                
                if (codigoCompleto) {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ‚úÖ CORREGIDO: Usar el verdadero n√∫mero de parte de la base de datos
                    llenarCampoPorId('numero_parte_lower', codigoCompleto.numero_parte || '');
                    llenarCampoPorId('cantidad_estandarizada', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('cantidad_actual', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('propiedad_material', codigoCompleto.propiedad_material || '');
                    llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || '');
                    llenarCampoPorId('numero_lote_material', '');
                    
                    console.log(`üìã N√∫mero de parte de DB cargado: ${codigoCompleto.numero_parte}`);
                    console.log(`üìã Especificaci√≥n de material cargada: ${codigoCompleto.especificacion_material}`);
                } else {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ‚úÖ CORREGIDO: Si no hay informaci√≥n completa, dejar vac√≠o en lugar de usar secuencial
                    llenarCampoPorId('numero_parte_lower', '');
                    llenarCampoPorId('almacen_especificacion_material', '');
                    llenarCampoPorId('numero_lote_material', '');
                }
            }).catch(error => {
                console.error('‚ùå Error al cargar secuencial:', error);
                // En caso de error, usar valores por defecto
                const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}0001`;
                llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                llenarCampoPorId('codigo_material_lower', codigoMaterial);
                // ‚úÖ CORREGIDO: Si hay error, usar el n√∫mero de parte de la selecci√≥n (si existe)
                const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
                llenarCampoPorId('numero_parte_lower', codigoCompleto ? (codigoCompleto.numero_parte || '') : '');
            });
        }

        function llenarCampoPorId(idCampo, valor) {
            const campo = document.getElementById(idCampo);
            if (campo && valor) {
                campo.value = valor;
                console.log(`‚úÖ Campo ${idCampo} llenado con: ${valor}`);
                
                // Resaltar visualmente el campo que se llen√≥
                campo.style.backgroundColor = '#e3f2fd';
                campo.style.transition = 'background-color 0.3s';
                
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 2000);
                
            } else if (!campo) {
                console.warn(`‚ùå Campo no encontrado con ID: ${idCampo}`);
            } else if (!valor) {
                console.warn(`‚ö†Ô∏è Valor vac√≠o para campo: ${idCampo}`);
            }
        }

        function llenarCampoInferior(labelTexto, valor) {
            const labels = document.querySelectorAll('label');
            let campoEncontrado = false;
            
            // Buscar desde el final hacia atr√°s para encontrar los campos inferiores
            for (let i = labels.length - 1; i >= 0; i--) {
                const label = labels[i];
                if (label.textContent.includes(labelTexto)) {
                    // Si es "C√≥digo de material:" tomar el √∫ltimo (inferior)
                    if (labelTexto === 'C√≥digo de material:' && campoEncontrado) {
                        continue; // Saltar el primero, queremos el √∫ltimo
                    }
                    
                    const input = label.parentNode.querySelector('input');
                    if (input) {
                        input.value = valor;
                        input.style.backgroundColor = '#e3f2fd'; // Resaltar en azul claro
                        input.style.transition = 'background-color 0.3s';
                        
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 3000);
                        
                        campoEncontrado = true;
                        
                        // Para "C√≥digo de material:" solo tomar el √∫ltimo
                        if (labelTexto !== 'C√≥digo de material:') {
                            break;
                        }
                    }
                }
            }
            
            if (!campoEncontrado) {
                console.warn('Campo no encontrado:', labelTexto);
            }
        }

        // Funci√≥n para reiniciar el contador (opcional, para usar cuando sea necesario)
        // Funci√≥n para recargar el contador desde la base de datos
        function recargarContador() {
            cargarSiguienteSecuencial();
            console.log('Recargando contador secuencial desde la base de datos...');
        }

        // Funci√≥n opcional para forzar recarga del contador (para testing/debug)
        function forzarRecargaContador() {
            console.log('üîÑ Forzando recarga del contador secuencial...');
            cargarSiguienteSecuencial().then(() => {
                console.log(`‚úÖ Contador recargado. Pr√≥ximo secuencial: ${String(contadorSecuencial).padStart(4, '0')}`);
            });
        }

        // Funci√≥n para verificar y llenar manualmente (para testing)
        function llenarCamposInferioresManual() {
            const selectCodigo = document.getElementById('codigoMaterialSelect');
            const codigoSeleccionado = selectCodigo.value;
            
            if (codigoSeleccionado) {
                llenarCamposInferiores(codigoSeleccionado);
            } else {
                alert('Por favor, seleccione primero un c√≥digo de material');
            }
        }

        // FUNCI√ìN DE DIAGN√ìSTICO PARA DEBUGGEAR EL SECUENCIAL
        window.diagnosticarSecuencial = async function(codigoMaterial = '0RH5602C622') {
            console.log('üî¨ === DIAGN√ìSTICO COMPLETO DEL SECUENCIAL ===');
            console.log(`üéØ C√≥digo de material a probar: ${codigoMaterial}`);
            
            try {
                // 1. Probar el endpoint directamente
                const url = `/obtener_siguiente_secuencial?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                console.log(`üì° URL de prueba: ${url}`);
                
                const response = await fetch(url);
                console.log(`üìä Status de respuesta: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üìã Respuesta completa del servidor:`, data);
                    
                    // 2. Mostrar detalles de la respuesta
                    console.log('üîç Detalles de la respuesta:');
                    console.log(`  - success: ${data.success}`);
                    console.log(`  - siguiente_secuencial: ${data.siguiente_secuencial}`);
                    console.log(`  - proximo_codigo_completo: ${data.proximo_codigo_completo}`);
                    console.log(`  - fecha_actual: ${data.fecha_actual}`);
                    console.log(`  - secuencial_mas_alto_encontrado: ${data.secuencial_mas_alto_encontrado}`);
                    console.log(`  - patron_busqueda: ${data.patron_busqueda}`);
                    
                    // 3. Actualizar variables globales
                    contadorSecuencial = data.siguiente_secuencial || 1;
                    proximoCodigoCompleto = data.proximo_codigo_completo || '';
                    
                    console.log('‚úÖ Variables globales actualizadas:');
                    console.log(`  - contadorSecuencial: ${contadorSecuencial}`);
                    console.log(`  - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                    
                    // 4. Probar llenar campos
                    console.log('üîÑ Probando llenar campos...');
                    llenarCamposInferiores(codigoMaterial);
                    
                } else {
                    console.error(`‚ùå Error HTTP: ${response.status}`);
                    const text = await response.text();
                    console.error(`‚ùå Respuesta de error: ${text}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
            }
            
            console.log('üî¨ === FIN DIAGN√ìSTICO ===');
        };

        // FUNCI√ìN PARA VERIFICAR BASE DE DATOS
        window.verificarBaseDatos = async function() {
            console.log('üóÉÔ∏è === VERIFICANDO BASE DE DATOS ===');
            
            try {
                // Hacer una consulta para ver todos los registros
                const response = await fetch('/consultar_control_almacen');
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üìä Total de registros en BD: ${data.length}`);
                    
                    // Filtrar solo los registros con 0RH5602C622
                    const registrosFiltrados = data.filter(r => 
                        r.codigo_material_recibido && 
                        r.codigo_material_recibido.includes('0RH5602C622')
                    );
                    
                    console.log(`üéØ Registros con 0RH5602C622: ${registrosFiltrados.length}`);
                    registrosFiltrados.forEach((registro, index) => {
                        console.log(`  ${index + 1}. ${registro.codigo_material_recibido} - ${registro.fecha_registro}`);
                    });
                    
                } else {
                    console.error('‚ùå Error al consultar BD:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Error en verificaci√≥n BD:', error);
            }
        };

        // Funci√≥n para guardar el formulario
        function guardarFormulario() {
            try {
                // Recopilar todos los datos del formulario
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: document.getElementById('codigoMaterialOriginal').value,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: document.getElementById('numero_lote_material').value,
                    codigo_material_recibido: document.getElementById('codigo_material_recibido').value,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value
                };
                
                // Validar campos requeridos
                if (!formData.codigo_material_original) {
                    alert('Por favor, ingrese el c√≥digo de material original');
                    return;
                }
                
                console.log('Datos a guardar:', formData);
                
                // Deshabilitar bot√≥n mientras se guarda
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                // Enviar datos al servidor
                fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    console.log('Save response status:', response.status);
                    console.log('Save response headers:', response.headers.get('content-type'));
                    
                    // Verificar si la respuesta es JSON
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // Si no es JSON, probablemente es una redirecci√≥n a login
                        throw new Error('No autenticado - redirigiendo a login');
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert('Registro guardado exitosamente');
                        
                        // IMPORTANTE: Esperar un poco y luego recargar el siguiente secuencial
                        setTimeout(async () => {
                            const codigoActual = document.getElementById('codigoMaterialSelect').value;
                            if (codigoActual) {
                                console.log(`üîÑ Recargando siguiente lote para c√≥digo '${codigoActual}' despu√©s de guardar...`);
                                await cargarSiguienteSecuencial(codigoActual);
                                console.log(`‚úÖ Secuencial recargado: ${contadorSecuencial}`);
                                
                                // Despu√©s de recargar, actualizar los campos inferiores con la nueva secuencia
                                llenarCamposInferiores(codigoActual);
                            } else {
                                console.log('üîÑ Recargando lote por defecto despu√©s de guardar...');
                                await cargarSiguienteSecuencial();
                            }
                        }, 500); // Esperar 500ms para asegurar que la BD se actualice
                        
                        // Limpiar formulario
                        limpiarFormulario();
                        // Recargar tabla autom√°ticamente
                        consultarRegistros();
                    } else {
                        alert('Error al guardar: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('No autenticado')) {
                        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
                        window.location.href = '/login';
                    } else {
                        alert('Error al guardar el registro: ' + error.message);
                    }
                })
                .finally(() => {
                    // Rehabilitar bot√≥n
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                });
                
            } catch (error) {
                console.error('Error al procesar formulario:', error);
                alert('Error al procesar el formulario');
            }
        }
        
        // Funci√≥n para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('forma_material').selectedIndex = 0;
            document.getElementById('cliente').selectedIndex = 0;
            document.getElementById('codigoMaterialOriginal').value = '';
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 0;
            
            // Restablecer fechas a hoy
            setFechasHoy();
            
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            
            // *** OCULTAR LA TABLA AL LIMPIAR FORMULARIO ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'none';
                console.log('‚úÖ Tabla ocultada despu√©s de limpiar formulario');
            }
            
            // El contador secuencial se recarga desde BD despu√©s de cada guardado exitoso
            console.log('Formulario limpiado. Pr√≥ximo n√∫mero secuencial ser√°:', String(contadorSecuencial).padStart(4, '0'));
        }
        
        // Establecer fechas a hoy al cargar la p√°gina
function setFechasHoy() {
    // Obtener la fecha local (no UTC) para evitar desfase de zona horaria
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hoyLocal = `${year}-${month}-${day}`;
    // Tambi√©n actualiza los filtros de fecha
    const fechaRecibo = document.getElementById('fecha_recibo');
    const fechaFabricacion = document.getElementById('fecha_fabricacion');
    const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
    const filtroFechaFin = document.getElementById('filtro_fecha_fin');
    if (fechaRecibo) fechaRecibo.value = hoyLocal;
    if (fechaFabricacion) fechaFabricacion.value = hoyLocal;
    if (filtroFechaInicio) filtroFechaInicio.value = hoyLocal;
    if (filtroFechaFin) filtroFechaFin.value = hoyLocal;
}
// Llamar al cargar la p√°gina
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setFechasHoy);
} else {
    setFechasHoy();
}

        // Funci√≥n para consultar registros (actualizada para usar la nueva funci√≥n)
        function consultarRegistros() {
            console.log('üîÑ === CONSULTANDO REGISTROS (ACTUALIZADA) ===');
            console.log('üîÑ Llamando a cargarDatosDesdeServidor...');
            cargarDatosDesdeServidor();
        }

        // Funci√≥n principal de carga de datos (actualizada para usar la nueva funci√≥n)
        function cargarDatosDesdeServidor() {
            console.log('üöÄ === INICIANDO cargarDatosDesdeServidor (ACTUALIZADA) ===');
            
            const fechaInicio = document.getElementById('filtro_fecha_inicio').value;
            const fechaFin = document.getElementById('filtro_fecha_fin').value;
            
            console.log('üìÖ Filtros:', { fechaInicio, fechaFin });
            
            // Construir URL con par√°metros
            let url = '/consultar_control_almacen';
            const params = new URLSearchParams();
            
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            console.log('üì° URL final:', url);
            
            fetch(url)
                .then(response => {
                    console.log('üì® Respuesta recibida - Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Datos parseados:', data);
                    console.log('üìä Cantidad de registros:', data ? data.length : 0);
                    
                    console.log('üîÑ Llamando a nuevaCargarDatos (funci√≥n funcional)...');
                    nuevaCargarDatos(data);
                    console.log('‚úÖ nuevaCargarDatos ejecutada');
                })
                .catch(error => {
                    console.error('‚ùå Error completo:', error);
                    
                    const tbody = document.querySelector('#tablaControlAlmacen tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #e74c3c;">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
                    }
                });
            
            console.log('üöÄ === FIN cargarDatosDesdeServidor (fetch iniciado) ===');
        }
        
        // Funci√≥n global para acceso directo (como en CONTROL_DE_MATERIAL.html)
        window.cargarDatosDesdeServidor = cargarDatosDesdeServidor;
        
        // NUEVA FUNCI√ìN FUNCIONAL PARA REEMPLAZAR cargarDatosEnTabla
        function nuevaCargarDatos(datos) {
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            
            // *** MOSTRAR LA TABLA CUANDO SE CARGAN DATOS ***
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            tbody.innerHTML = '';

            if (!datos || datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="material-table .no-data">No hay registros disponibles.</td></tr>';
                return;
            }

            datos.forEach(item => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${item.codigo_material_recibido || ''}</td>
                    <td>${item.codigo_material || ''}</td>
                    <td>${item.numero_parte || ''}</td>
                    <td>${item.numero_lote_material || ''}</td>
                    <td>${item.propiedad_material || ''}</td>
                    <td>${item.cantidad_actual || ''}</td>
                    <td>${item.cantidad_estandarizada || ''}</td>
                    <td>${item.ubicacion_salida || ''}</td>
                    <td>${item.fecha_recibo || ''}</td>
                    <td>${item.especificacion || ''}</td>
                    <td>${item.material_importacion_local || ''}</td>
                    <td>${item.estado_desecho || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            // IMPORTANTE: Llama a actualizarTotalFilasTabla() despu√©s de actualizar los datos de la tabla
            actualizarTotalFilasTabla();
        }
        
        // Actualiza el total de filas en la tabla de resultados
        function actualizarTotalFilasTabla() {
            const tabla = document.getElementById('tablaControlAlmacen');
            const totalInfo = document.querySelector('.total-info');
            if (!tabla || !totalInfo) return;
            const tbody = tabla.querySelector('tbody');
            if (!tbody) return;
            // Contar filas que no tengan la clase 'no-data'
            const filas = Array.from(tbody.querySelectorAll('tr'));
            const filasDatos = filas.filter(tr => !tr.classList.contains('no-data'));
            totalInfo.textContent = `Total Rows: ${filasDatos.length}`;
        }
        
        // Funci√≥n de test para la nueva funci√≥n
        window.testNuevaFuncionFinal = function() {
            console.log('üß™ PROBANDO NUEVA FUNCI√ìN FINAL');
            fetch('/consultar_control_almacen')
                .then(response => response.json())
                .then(data => {
                    console.log('üì° Datos recibidos:', data.length);
                    nuevaCargarDatos(data);
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                });
        };
        
        // Funci√≥n de test para verificar la funcionalidad
        window.testControlAlmacenModule = function() {
            console.log('üß™ === EJECUTANDO TEST DEL M√ìDULO ===');
            
            const elementos = {
                'tablaControlAlmacen': document.getElementById('tablaControlAlmacen'),
                'btnConsultar': document.getElementById('btnConsultar'),
                'filtro_fecha_inicio': document.getElementById('filtro_fecha_inicio'),
                'filtro_fecha_fin': document.getElementById('filtro_fecha_fin'),
                'tbody': document.querySelector('#tablaControlAlmacen tbody')
            };
            
            let errores = [];
            
            Object.keys(elementos).forEach(key => {
                if (elementos[key]) {
                    console.log(`‚úÖ ${key}: OK`);
                } else {
                    console.error(`‚ùå ${key}: FALTA`);
                    errores.push(key);
                }
            });
            
            // Test de funciones simplificadas
            const funciones = [
                'consultarRegistros',
                'cargarDatosDesdeServidor',
                'cargarDatosEnTabla',
                'cargarCodigosMaterial'
            ];
            
            funciones.forEach(func => {
                if (typeof window[func] === 'function' || typeof eval(func) === 'function') {
                    console.log(`‚úÖ Funci√≥n ${func}: OK`);
                } else {
                    console.error(`‚ùå Funci√≥n ${func}: FALTA`);
                    errores.push(`Funci√≥n ${func}`);
                }
            });
            
            if (errores.length === 0) {
                console.log('üéâ ¬°TODOS LOS TESTS PASARON!');
                console.log('‚úÖ M√≥dulo Control de Almac√©n: Todos los componentes est√°n funcionando correctamente');
                
                // Test adicional: Intentar cargar datos
                console.log('üîÑ Ejecutando test de carga de datos...');
                cargarDatosDesdeServidor();
                
            } else {
                console.error('‚ùå ERRORES ENCONTRADOS:', errores);
                console.warn('‚ùå Errores en el m√≥dulo: ' + errores.join(', '));
            }
            
            return errores.length === 0;
        };

        // Funciones de test simples para diagn√≥stico r√°pido
        window.testCargarDatos = function() {
            console.log('üß™ TEST: Probando carga de datos...');
            cargarDatosDesdeServidor();
        };
        
        window.testConectividad = function() {
            console.log('üîó TEST: Conectividad b√°sica...');
            testConectividadAlmacen();
        };

        // Funci√≥n de test espec√≠fica para diagnosticar el problema de la tabla
        window.testTablaEspecifico = function() {
            console.log('üî¨ === TEST ESPEC√çFICO DE TABLA ===');
            
            // 1. Verificar elementos DOM
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            const btnConsultar = document.getElementById('btnConsultar');
            
            console.log('üîç Verificaci√≥n DOM:');
            console.log('- Tabla:', tabla);
            console.log('- Tbody:', tbody);
            console.log('- Bot√≥n consultar:', btnConsultar);
            
            // 2. Test directo con datos simulados
            console.log('üß™ Probando con datos simulados...');
            const datosSimulados = [
                {
                    id: 1,
                    codigo_material_recibido: 'TEST001/20250708001',
                    codigo_material: 'TEST001',
                    numero_parte: '0001',
                    numero_lote_material: 'LOTE001',
                    propiedad_material: 'Prueba',
                    cantidad_actual: '1000',
                    cantidad_estandarizada: '1000',
                    ubicacion_salida: 'A1',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Local',
                    estado_desecho: 0
                }
            ];
            
            console.log('üìã Datos simulados:', datosSimulados);
            cargarDatosEnTabla(datosSimulados);
            
            // 3. Test con datos reales del servidor
            console.log('üåê Probando con datos reales del servidor...');
            setTimeout(() => {
                cargarDatosDesdeServidor();
            }, 2000);
        };
        
        // Funci√≥n para limpiar tabla y probar desde cero
        window.limpiarYProbar = function() {
            console.log('üßπ Limpiando tabla y probando...');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">Tabla limpiada - ejecutando test...</td></tr>';
                setTimeout(() => {
                    testTablaEspecifico();
                }, 1000);
            }
        };

        // Funci√≥n de test para la nueva versi√≥n ultra simple
        window.testNuevaFuncion = function() {
            console.log('üöÄ === PROBANDO NUEVA FUNCI√ìN ===');
            
            const datosTest = [
                {
                    id: 1,
                    codigo_material_recibido: 'TEST001/20250708001',
                    codigo_material: 'TEST001',
                    numero_parte: '0001',
                    numero_lote_material: 'LOTE001',
                    propiedad_material: 'Material de Prueba',
                    cantidad_actual: '1000',
                    cantidad_estandarizada: '1000',
                    ubicacion_salida: 'A1-01',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Local',
                    estado_desecho: 0
                },
                {
                    id: 2,
                    codigo_material_recibido: 'TEST002/20250708002',
                    codigo_material: 'TEST002',
                    numero_parte: '0002',
                    numero_lote_material: 'LOTE002',
                    propiedad_material: 'Material de Prueba 2',
                    cantidad_actual: '2000',
                    cantidad_estandarizada: '2000',
                    ubicacion_salida: 'B1-01',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Importaci√≥n',
                    estado_desecho: 1
                }
            ];
            
            console.log('üìã Datos de test:', datosTest);
            console.log('üîÑ Llamando a cargarDatosEnTabla...');
            cargarDatosEnTabla(datosTest);
        };
        
        // Funci√≥n para probar con datos reales del servidor
        window.testConDatosReales = function() {
            console.log('üåê === PROBANDO CON DATOS REALES ===');
            
            fetch('/consultar_control_almacen')
                .then(response => {
                    console.log('üì° Respuesta:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Datos del servidor:', data);
                    console.log('üìä Cantidad:', data.length);
                    console.log('üìä Primer elemento:', data[0]);
                    
                    console.log('üîÑ Llamando a la nueva funci√≥n...');
                    cargarDatosEnTabla(data);
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                });
        };

        // FUNCI√ìN DE PRUEBA ULTRA B√ÅSICA - SOLO PARA VERIFICAR QUE FUNCIONA
        function mostrarDatosBasico(datos) {
            console.log('üü¢üü¢üü¢ FUNCI√ìN B√ÅSICA INICIADA');
            console.log('üü¢ Datos recibidos:', datos);
            
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            console.log('üü¢ Tbody encontrado:', tbody);
            
            if (!tbody) {
                console.error('‚ùå NO SE ENCONTR√ì TBODY');
                return;
            }
            
            // PASO 1: Mostrar mensaje de prueba visible
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px; background-color: lime; color: black; font-size: 16px; font-weight: bold;">‚úÖ FUNCI√ìN EJECUTADA - DATOS: ' + (datos ? datos.length : 0) + '</td></tr>';
            console.log('üü¢ MENSAJE VERDE INSERTADO');
            
            // PASO 2: Actualizar el contador
            const totalInfo = document.querySelector('.total-info');
            if (totalInfo) {
                totalInfo.textContent = 'FUNCI√ìN EJECUTADA ‚úÖ - Total: ' + (datos ? datos.length : 0);
                totalInfo.style.color = 'lime';
                totalInfo.style.fontSize = '16px';
                totalInfo.style.fontWeight = 'bold';
            }
            
            console.log('üü¢üü¢üü¢ FUNCI√ìN B√ÅSICA TERMINADA');
            console.log('‚úÖ Funci√≥n b√°sica ejecutada - Datos: ' + (datos ? datos.length : 0));
        }
        
        // FUNCI√ìN DE PRUEBA INMEDIATA
        window.probarFuncionBasica = function() {
            console.log('üöÄ INICIANDO PRUEBA B√ÅSICA');
            
            const datosTest = [
                { id: 1, codigo_material: 'TEST1', cantidad_actual: '100' },
                { id: 2, codigo_material: 'TEST2', cantidad_actual: '200' }
            ];
            
            mostrarDatosBasico(datosTest);
        };
        
        // FUNCI√ìN PARA PROBAR CON DATOS REALES
        window.probarConDatosReales = function() {
            console.log('üåê PROBANDO CON DATOS REALES');
            
            fetch('/consultar_control_almacen')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Datos del servidor:', data);
                    mostrarDatosBasico(data);
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    console.warn('‚ùå Error: ' + error.message);
                });
        };

        // Funci√≥n de test para verificar que el bot√≥n consultar funcione
        window.testBotonConsultar = function() {
            console.log('üß™ === PROBANDO BOT√ìN CONSULTAR ===');
            
            // Verificar que la funci√≥n consultarRegistros est√© disponible
            if (typeof consultarRegistros === 'function') {
                console.log('‚úÖ consultarRegistros disponible');
            } else {
                console.error('‚ùå consultarRegistros NO disponible');
                return;
            }
            
            // Verificar que la funci√≥n cargarDatosDesdeServidor est√© disponible
            if (typeof cargarDatosDesdeServidor === 'function') {
                console.log('‚úÖ cargarDatosDesdeServidor disponible');
            } else {
                console.error('‚ùå cargarDatosDesdeServidor NO disponible');
                return;
            }
            
            // Verificar que la funci√≥n nuevaCargarDatos est√© disponible
            if (typeof nuevaCargarDatos === 'function') {
                console.log('‚úÖ nuevaCargarDatos disponible');
            } else {
                console.error('‚ùå nuevaCargarDatos NO disponible');
                return;
            }
            
            // Verificar que el bot√≥n exista
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                console.log('‚úÖ Bot√≥n consultar encontrado');
                console.log('‚úÖ Onclick:', btnConsultar.onclick);
                console.log('‚úÖ Atributo onclick:', btnConsultar.getAttribute('onclick'));
            } else {
                console.error('‚ùå Bot√≥n consultar NO encontrado');
                return;
            }
            
            console.log('üöÄ Ejecutando consultarRegistros() directamente...');
            consultarRegistros();
        };
        
        // Funci√≥n para verificar el flujo completo
        window.verificarFlujoCompleto = function() {
            console.log('üîç === VERIFICANDO FLUJO COMPLETO ===');
            console.log('1. consultarRegistros -> cargarDatosDesdeServidor -> nuevaCargarDatos');
            
            console.log('üîó Paso 1: consultarRegistros');
            console.log('üîó Paso 2: cargarDatosDesdeServidor');
            console.log('üîó Paso 3: nuevaCargarDatos');
            
            testBotonConsultar();
        };

        // Funci√≥n para aplicar reglas de escaneo desde rules.json
        async function aplicarReglasEscaneo(texto) {
            try {
                console.log('=== APLICANDO REGLAS DE ESCANEO ===');
                console.log('Texto escaneado:', texto);
                console.log('Longitud del texto:', texto.length);
                
                // Obtener las reglas del servidor
                const response = await fetch('/obtener_reglas_escaneo');
                if (!response.ok) {
                    console.warn('No se pudieron obtener las reglas de escaneo');
                    return null;
                }
                
                const reglas = await response.json();
                console.log('Reglas de escaneo cargadas:', reglas);
                
                // Probar cada regla hasta encontrar una que coincida
                for (const [proveedor, regla] of Object.entries(reglas)) {
                    console.log(`\n--- Probando regla para proveedor: ${proveedor} ---`);
                    console.log('Tipo de regla:', regla.creation_mode || 'no especificado');
                    
                    const resultado = aplicarRegla(texto, regla);
                    if (resultado) {
                        console.log(`‚úÖ REGLA ${proveedor} APLICADA EXITOSAMENTE:`);
                        console.log('- Proveedor:', proveedor);
                        console.log('- Part Number:', resultado.partNumber);
                        console.log('- Lot Number:', resultado.lotNumber);
                        console.log('- Part Number length:', resultado.partNumber.length);
                        console.log('- Lot Number length:', resultado.lotNumber.length);
                        
                        return {
                            supplier: proveedor,
                            partNumber: resultado.partNumber,
                            lotNumber: resultado.lotNumber
                        };
                    } else {
                        console.log(`‚ùå Regla ${proveedor} no coincide`);
                    }
                }
                
                console.log('‚ùå Ninguna regla coincide con el texto escaneado');
                return null;
                
            } catch (error) {
                console.error('Error al aplicar reglas de escaneo:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar una regla espec√≠fica
        function aplicarRegla(texto, regla) {
            try {
                console.log('Aplicando regla:', regla);
                
                // Manejar diferentes tipos de reglas seg√∫n tu rules.json
                if ('sequence_pattern' in regla) {
                    return aplicarReglaSecuencias(texto, regla);
                } else if ('character_pattern' in regla) {
                    return aplicarReglaCaracteres(texto, regla);
                } else if ('pattern' in regla) {
                    return aplicarReglaRegex(texto, regla);
                } else {
                    console.warn('Tipo de regla no soportado:', regla);
                    return null;
                }
            } catch (error) {
                console.error('Error aplicando regla:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de secuencias (como ROHM)
        function aplicarReglaSecuencias(texto, regla) {
            try {
                console.log('Aplicando regla de secuencias para:', texto);
                console.log('Regla:', regla);
                
                const secuencias = regla.sequence_pattern;
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                const maxLongitudPart = regla.partNumberMaxLength;
                const maxLongitudLote = regla.lotNumberMaxLength;
                
                // Dividir el texto seg√∫n las secuencias
                let partes = [texto];
                
                for (const secuencia of secuencias) {
                    let nuevasPartes = [];
                    
                    for (const parte of partes) {
                        if (secuencia.type === 'spaces') {
                            // Dividir por la cantidad exacta de espacios consecutivos
                            const espacios = ' '.repeat(secuencia.count);
                            const subpartes = parte.split(espacios); // Dividir por todos los separadores
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'tabs') {
                            const tabs = '\t'.repeat(secuencia.count);
                            const subpartes = parte.split(tabs);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'newlines') {
                            const newlines = '\n'.repeat(secuencia.count);
                            const subpartes = parte.split(newlines);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'custom') {
                            const custom = (secuencia.separator || '').repeat(secuencia.count);
                            const subpartes = parte.split(custom);
                            nuevasPartes.push(...subpartes);
                        } else {
                            nuevasPartes.push(parte);
                        }
                    }
                    
                    partes = nuevasPartes;
                }
                
                console.log('Partes divididas:', partes);
                
                // Verificar que tengamos suficientes partes
                if (partes.length <= Math.max(indicePart, indiceLote)) {
                    console.log('No suficientes partes para extraer datos');
                    return null;
                }
                
                let partNumber = (partes[indicePart] || '').trim();
                let lotNumber = (partes[indiceLote] || '').trim();
                
                // Aplicar longitudes m√°ximas si est√°n definidas (como en Python)
                if (maxLongitudPart && partNumber.length > maxLongitudPart) {
                    partNumber = partNumber.substring(0, maxLongitudPart);
                }
                if (maxLongitudLote && lotNumber.length > maxLongitudLote) {
                    lotNumber = lotNumber.substring(0, maxLongitudLote);
                }
                
                // *** NUEVA FUNCIONALIDAD: Extracci√≥n espec√≠fica del lote ***
                if (regla.lotNumberStart !== undefined && regla.lotNumberLength !== undefined) {
                    const startPos = regla.lotNumberStart;
                    const length = regla.lotNumberLength;
                    
                    console.log('üéØ Aplicando extracci√≥n espec√≠fica del lote:');
                    console.log('- Lote original:', lotNumber);
                    console.log('- Posici√≥n inicio:', startPos);
                    console.log('- Longitud:', length);
                    console.log('- Lote original length:', lotNumber.length);
                    
                    if (lotNumber.length >= startPos + length) {
                        lotNumber = lotNumber.substring(startPos, startPos + length).trim();
                        console.log('- Lote extra√≠do:', lotNumber);
                    } else {
                        console.log('‚ùå Lote muy corto para extracci√≥n espec√≠fica');
                    }
                }
                
                console.log('Datos extra√≠dos por secuencias:');
                console.log('- Part Number:', partNumber);
                console.log('- Lot Number:', lotNumber);
                console.log('- Part Number length:', partNumber.length);
                console.log('- Lot Number length:', lotNumber.length);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaSecuencias:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de regex (como LEGACY)
        function aplicarReglaRegex(texto, regla) {
            try {
                console.log('Aplicando regla regex para:', texto);
                
                const patron = new RegExp(regla.pattern);
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                
                const coincidencia = texto.match(patron);
                
                if (!coincidencia) {
                    console.log('El texto no coincide con el patr√≥n regex');
                    return null;
                }
                
                console.log('Coincidencias regex:', coincidencia);
                
                const partNumber = coincidencia[indicePart]?.trim() || '';
                const lotNumber = coincidencia[indiceLote]?.trim() || '';
                
                console.log('Datos extra√≠dos por regex:');
                console.log('- Part Number:', partNumber);
                console.log('- Lot Number:', lotNumber);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaRegex:', error);
                return null;
            }
        }
        
        // Funci√≥n para aplicar regla de patr√≥n de caracteres
        function aplicarReglaCaracteres(texto, regla) {
            try {
                const patronCaracteres = regla.character_pattern;
                const inicioPartNumber = regla.partNumberStart;
                const longitudPartNumber = regla.partNumberLength;
                const inicioLotNumber = regla.lotNumberStart;
                const longitudLotNumber = regla.lotNumberLength;
                
                console.log('Aplicando regla de caracteres:');
                console.log('- Patr√≥n:', patronCaracteres);
                console.log('- Texto:', texto);
                console.log('- Texto length:', texto.length);
                console.log('- Patr√≥n length:', patronCaracteres.length);
                console.log('- Part Number: posici√≥n', inicioPartNumber, 'longitud', longitudPartNumber);
                console.log('- Lot Number: posici√≥n', inicioLotNumber, 'longitud', longitudLotNumber);
                
                // Verificar longitud m√≠nima (igual que Python)
                const longitudMinima = Math.max(inicioPartNumber + longitudPartNumber, inicioLotNumber + longitudLotNumber);
                if (texto.length < longitudMinima) {
                    console.log(`‚ùå Texto muy corto. Esperado: ${longitudMinima}, Actual: ${texto.length}`);
                    return null;
                }
                
                // VALIDACI√ìN ESTRICTA DE PATR√ìN (igual que Python)
                if (texto.length !== patronCaracteres.length) {
                    console.log(`‚ùå Longitud no coincide. Patr√≥n: ${patronCaracteres.length}, Texto: ${texto.length}`);
                    return null;
                }
                
                // Verificar patr√≥n car√°cter por car√°cter (igual que Python)
                for (let i = 0; i < texto.length; i++) {
                    const charTexto = texto[i];
                    const charPatron = patronCaracteres[i];
                    
                    if (charPatron === 'X') {
                        // X = cualquier car√°cter
                        continue;
                    } else if (charPatron === 'N') {
                        // N = cualquier n√∫mero
                        if (!/\d/.test(charTexto)) {
                            console.log(`‚ùå Car√°cter en posici√≥n ${i} no es n√∫mero. Esperado: N, Actual: "${charTexto}"`);
                            return null;
                        }
                    } else if (charPatron === 'A') {
                        // A = cualquier letra
                        if (!/[a-zA-Z]/.test(charTexto)) {
                            console.log(`‚ùå Car√°cter en posici√≥n ${i} no es letra. Esperado: A, Actual: "${charTexto}"`);
                            return null;
                        }
                   
                    } else if (charPatron === 'AN') {
                        // AN = alfanum√©rico
                        if (!/[a-zA-Z0-9]/.test(charTexto)) {
                            console.log(`‚ùå Car√°cter en posici√≥n ${i} no es alfanum√©rico. Esperado: AN, Actual: "${charTexto}"`);
                            return null;
                        }
                    } else {
                        // Car√°cter espec√≠fico debe coincidir exactamente
                        if (charTexto !== charPatron) {
                            console.log(`‚ùå Car√°cter en posici√≥n ${i} no coincide. Esperado: "${charPatron}", Actual: "${charTexto}"`);
                            return null;
                        }
                    }
                }
                
                console.log('‚úÖ Patr√≥n validado correctamente');
                
                // Extraer partNumber y lotNumber seg√∫n las posiciones EXACTAS (igual que Python)
                const partNumber = texto.substring(inicioPartNumber, inicioPartNumber + longitudPartNumber).trim();
                const lotNumber = texto.substring(inicioLotNumber, inicioLotNumber + longitudLotNumber).trim();
                
                console.log('Extracci√≥n exacta:');
                console.log(`- Part Number extra√≠do: "${partNumber}" (de posici√≥n ${inicioPartNumber} a ${inicioPartNumber + longitudPartNumber})`);
                console.log(`- Lot Number extra√≠do: "${lotNumber}" (de posici√≥n ${inicioLotNumber} a ${inicioLotNumber + longitudLotNumber})`);
                console.log('- Part Number length extra√≠do:', partNumber.length);
                console.log('- Lot Number length extra√≠do:', lotNumber.length);
                
                console.log('‚úÖ Datos finales extra√≠dos:');
                console.log('- Part Number final:', partNumber);
                console.log('- Lot Number final:', lotNumber);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaCaracteres:', error);
                return null;
            }
        }

        function exportarExcel() {
            try {
                alert('Generando archivo Excel, por favor espere...');
                fetch('/exportar_excel', {
                    method: 'GET'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Error en el servidor');
                    }
                    return response.blob();
                })
                .then(function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `materiales_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    alert('Archivo Excel descargado exitosamente');
                })
                .catch(function(error) {
                    console.error('Error al exportar Excel:', error);
                    alert('Error al exportar el archivo Excel: ' + error.message);
                });
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('Error al exportar el archivo Excel');
            }
        }

        // === AUTOCOMPLETADO PARA CONTROL DE ALMAC√âN ===
        // Configurar autocompletado en el campo "codigo_material_recibido"
        function configurarAutocompletadoAlmacen() {
            const codigoRecibidoInput = document.getElementById('codigo_material_recibido');
            if (codigoRecibidoInput) {
                console.log('‚úÖ ALMAC√âN: Campo codigo_material_recibido encontrado y configurado');
                
                // Funci√≥n para buscar el c√≥digo en la base de datos
                async function buscarCodigoRecibidoAlmacen() {
                    const codigo = codigoRecibidoInput.value.trim();
                    console.log(`üîç ALMAC√âN: Buscando c√≥digo: "${codigo}"`);
                    
                    if (!codigo) {
                        console.log('‚ö†Ô∏è ALMAC√âN: C√≥digo vac√≠o, no se ejecuta b√∫squeda');
                        return;
                    }
                    
                    console.log('üì° ALMAC√âN: Enviando petici√≥n al servidor...');
                    
                    try {
                        const url = `/buscar_codigo_recibido?codigo_material_recibido=${encodeURIComponent(codigo)}`;
                        console.log(`üåê ALMAC√âN: URL: ${url}`);
                        
                        const response = await fetch(url);
                        console.log(`üì° ALMAC√âN: Respuesta del servidor: Status ${response.status}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('üì¶ ALMAC√âN: Datos recibidos:', data);
                            
                            if (data.success && data.registro) {
                                console.log('‚úÖ ALMAC√âN: C√≥digo encontrado, llenando campos...');
                                
                                // Llenar campos con la informaci√≥n encontrada
                                if (data.registro.numero_lote_material) {
                                    document.getElementById('numero_lote_material').value = data.registro.numero_lote_material;
                                }
                                if (data.registro.codigo_material_original) {
                                    document.getElementById('codigoMaterialOriginal').value = data.registro.codigo_material_original;
                                }
                                if (data.registro.codigo_material) {
                                    document.getElementById('codigo_material_lower').value = data.registro.codigo_material;
                                }
                                if (data.registro.numero_parte) {
                                    document.getElementById('numero_parte_lower').value = data.registro.numero_parte;
                                }
                                if (data.registro.cantidad_actual) {
                                    document.getElementById('cantidad_actual').value = data.registro.cantidad_actual;
                                }
                                if (data.registro.cantidad_estandarizada) {
                                    document.getElementById('cantidad_estandarizada').value = data.registro.cantidad_estandarizada;
                                }
                                if (data.registro.propiedad_material) {
                                    document.getElementById('propiedad_material').value = data.registro.propiedad_material;
                                }
                                
                                // Resaltar campos que se llenaron autom√°ticamente
                                const campos = ['numero_lote_material', 'codigoMaterialOriginal', 'codigo_material_lower', 
                                              'numero_parte_lower', 'cantidad_actual', 'cantidad_estandarizada', 'propiedad_material'];
                                campos.forEach(id => {
                                    const campo = document.getElementById(id);
                                    if (campo && campo.value) {
                                        campo.style.backgroundColor = '#d4edda';
                                        campo.style.borderColor = '#c3e6cb';
                                        setTimeout(() => {
                                            campo.style.backgroundColor = '';
                                            campo.style.borderColor = '';
                                        }, 3000);
                                    }
                                });
                                
                                console.log('‚úÖ ALMAC√âN: Autocompletado exitoso');
                                alert('C√≥digo encontrado y campos completados autom√°ticamente');
                            } else {
                                console.log('‚ùå ALMAC√âN: C√≥digo no encontrado en respuesta');
                                alert('C√≥digo de material recibido no encontrado en el almac√©n');
                            }
                        } else {
                            console.error(`‚ùå ALMAC√âN: Error del servidor: ${response.status}`);
                            const errorText = await response.text();
                            console.error('Error text:', errorText);
                            alert(`Error del servidor: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('üí• ALMAC√âN: Error al buscar c√≥digo recibido:', error);
                        alert('Error al buscar el c√≥digo en la base de datos');
                    }
                }
                
                // Evento para cuando se pierde el foco del campo (change)
                codigoRecibidoInput.addEventListener('change', function() {
                    console.log('üéØ ALMAC√âN: Evento "change" activado');
                    buscarCodigoRecibidoAlmacen();
                });
                
                // Evento para cuando se presiona Enter
                codigoRecibidoInput.addEventListener('keypress', function(event) {
                    console.log(`‚å®Ô∏è ALMAC√âN: Tecla presionada: ${event.key}`);
                    if (event.key === 'Enter') {
                        console.log('üéØ ALMAC√âN: Enter presionado, ejecutando b√∫squeda');
                        event.preventDefault();
                        buscarCodigoRecibidoAlmacen();
                    }
                });
                
            } else {
                console.error('‚ùå ALMAC√âN: Campo codigo_material_recibido NO encontrado en el DOM');
            }
        }

        // Inicializar autocompletado cuando se carga la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarAutocompletadoAlmacen);
        } else {
            configurarAutocompletadoAlmacen();
        }

        // FUNCI√ìN DE DIAGN√ìSTICO PARA CONSECUTIVOS
        window.diagnosticarConsecutivos = async function(codigoMaterial = '0RH5602C622') {
            console.log('ü©∫ === DIAGN√ìSTICO DE CONSECUTIVOS ===');
            console.log(`üìã C√≥digo de material a usar: ${codigoMaterial}`);
            
            try {
                // 1. Probar endpoint directamente
                const url = `/obtener_siguiente_secuencial?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                console.log(`üåê URL a llamar: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('üìä Respuesta del servidor:');
                console.log('   ‚úÖ success:', data.success);
                console.log('   üî¢ siguiente_secuencial:', data.siguiente_secuencial);
                console.log('   üìÖ fecha_actual:', data.fecha_actual);
                console.log('   üì¶ codigo_material:', data.codigo_material);
                console.log('   üìà secuencial_mas_alto_encontrado:', data.secuencial_mas_alto_encontrado);
                console.log('   üîç patron_busqueda:', data.patron_busqueda);
                console.log('   üìù proximo_codigo_completo:', data.proximo_codigo_completo);
                
                // 2. Verificar variables globales
                console.log('üîß Variables globales actuales:');
                console.log('   contadorSecuencial:', contadorSecuencial);
                console.log('   proximoCodigoCompleto:', proximoCodigoCompleto);
                
                // 3. Probar cargar funci√≥n
                console.log('üîÑ Probando cargarSiguienteSecuencial...');
                await cargarSiguienteSecuencial(codigoMaterial);
                
                console.log('üîß Variables despu√©s de cargar:');
                console.log('   contadorSecuencial:', contadorSecuencial);
                console.log('   proximoCodigoCompleto:', proximoCodigoCompleto);
                
                // 4. Probar generar c√≥digo fallback
                const fechaHoy = new Date().toISOString().slice(0,10).replace(/-/g,'')
                const codigoFallback = `${codigoMaterial},${fechaHoy}${String(contadorSecuencial).padStart(4, '0')}`;
                console.log(`üìù C√≥digo fallback generado: ${codigoFallback}`);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
                return null;
            }
            
            console.log('ü©∫ === FIN DIAGN√ìSTICO ===');
        };

        // FUNCI√ìN PARA VERIFICAR REGISTROS EN LA BASE DE DATOS
        window.verificarRegistrosConsecutivos = async function() {
            console.log('üìã === VERIFICANDO REGISTROS EN BD ===');
            
            try {
                // Consultar registros recientes
                const response = await fetch('/consultar_control_almacen?fecha_desde=2025-07-11&fecha_hasta=2025-07-11');
                const data = await response.json();
                
                console.log(`üìä Registros encontrados: ${data.length}`);
                
                data.forEach((registro, index) => {
                    console.log(`üìù Registro ${index + 1}:`);
                    console.log(`   üÜî ID: ${registro.id}`);
                    console.log(`   üì¶ codigo_material_recibido: "${registro.codigo_material_recibido}"`);
                    console.log(`   üìÖ fecha_registro: ${registro.fecha_registro}`);
                    console.log(`   üè∑Ô∏è codigo_material: ${registro.codigo_material}`);
                });
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Error al verificar registros:', error);
                return null;
            }
            
            console.log('üìã === FIN VERIFICACI√ìN ===');
        };

        // ...existing code...

        // ==================== QR SCANNER FUNCTIONALITY ====================
        let html5QrCode = null;
        let currentCameraId = null;
        let availableCameras = [];

        // Funci√≥n para procesar c√≥digo manual desde el modal QR
        function procesarCodigoManualQR() {
            const input = document.getElementById('codigoManualQR');
            const codigo = input.value.trim();
            
            if (codigo) {
                // Cerrar el modal del esc√°ner
                cerrarEscanerQR();
                
                // Poner el c√≥digo en el campo principal
                document.getElementById('codigoMaterialOriginal').value = codigo;
                
                // Procesar el c√≥digo
                parsearYDistribuirCodigo(codigo);
                
                console.log('‚úÖ C√≥digo procesado manualmente:', codigo);
            } else {
                alert('Por favor, ingrese un c√≥digo v√°lido');
                input.focus();
            }
        }

        // Funci√≥n para mostrar la entrada manual cuando falla la c√°mara
        function mostrarEntradaManual() {
            const container = document.getElementById('entradaManualContainer');
            if (container) {
                container.style.display = 'block';
                
                // Enfocar el input despu√©s de un breve delay
                setTimeout(() => {
                    const input = document.getElementById('codigoManualQR');
                    if (input) {
                        input.focus();
                    }
                }, 300);
            }
        }

        // Funci√≥n para abrir el esc√°ner QR
        function abrirEscanerQR() {
            const modal = document.getElementById('modalQRScanner');
            modal.style.display = 'block';
            
            // Peque√±o delay para asegurar que el DOM est√© renderizado
            setTimeout(() => {
                inicializarEscanerQR();
            }, 100);
        }

        // Funci√≥n para cerrar el esc√°ner QR
        function cerrarEscanerQR() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('üì∑ Esc√°ner QR detenido');
                }).catch(err => {
                    console.error('‚ùå Error al detener esc√°ner:', err);
                });
            }
            
            document.getElementById('modalQRScanner').style.display = 'none';
            mostrarEstadoQR('', 'none');
        }

        // Funci√≥n para inicializar el esc√°ner QR
        async function inicializarEscanerQR() {
            try {
                mostrarEstadoQR('üîÑ Inicializando c√°mara...', 'info');
                
                // Detectar si es Android
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isHttps = location.protocol === 'https:';
                
                console.log(`üì± Dispositivo Android: ${isAndroid}`);
                console.log(`üîí HTTPS: ${isHttps}`);
                
                // Para Android, intentar con configuraci√≥n espec√≠fica
                if (isAndroid && !isHttps) {
                    mostrarEstadoQR('‚ö†Ô∏è Android requiere HTTPS para c√°mara. Probando configuraci√≥n alternativa...', 'warning');
                }
                
                // Intentar obtener permisos expl√≠citamente
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        // Solicitar permisos de c√°mara expl√≠citamente
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: isAndroid ? { ideal: 'environment' } : 'environment'
                            } 
                        });
                        
                        // Detener el stream inmediatamente, solo era para obtener permisos
                        stream.getTracks().forEach(track => track.stop());
                        console.log('‚úÖ Permisos de c√°mara obtenidos');
                        
                    } catch (permissionError) {
                        console.error('‚ùå Error de permisos:', permissionError);
                        mostrarEstadoQR('‚ùå Error de permisos de c√°mara. Permita el acceso en su navegador.', 'error');
                        return;
                    }
                }
                
                // Obtener las c√°maras disponibles
                const devices = await Html5Qrcode.getCameras();
                availableCameras = devices;
                
                console.log(`üì∑ C√°maras encontradas: ${devices.length}`);
                devices.forEach((device, index) => {
                    console.log(`üì∑ C√°mara ${index}: ${device.label} (${device.id})`);
                });
                
                if (devices && devices.length > 0) {
                    // Para Android, usar configuraci√≥n espec√≠fica de c√°mara
                    if (isAndroid) {
                        // Buscar c√°mara trasera para Android
                        currentCameraId = devices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('rear') ||
                            device.label.toLowerCase().includes('environment') ||
                            device.label.includes('0') // A veces la c√°mara trasera es la primera
                        )?.id || devices[devices.length - 1].id; // √öltima como fallback
                    } else {
                        // Para otros dispositivos
                        currentCameraId = devices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('rear') ||
                            device.label.toLowerCase().includes('environment')
                        )?.id || devices[0].id;
                    }
                    
                    console.log(`üì∑ Usando c√°mara: ${currentCameraId}`);
                    
                    // Mostrar/ocultar bot√≥n de cambiar c√°mara
                    const btnCambiarCamara = document.getElementById('btnCambiarCamara');
                    btnCambiarCamara.style.display = devices.length > 1 ? 'inline-block' : 'none';
                    
                    // Inicializar el esc√°ner con configuraci√≥n espec√≠fica para Android
                    html5QrCode = new Html5Qrcode("qrReader");
                    
                    const config = isAndroid ? {
                        fps: 5, // Menor FPS para Android
                        qrbox: { width: 200, height: 200 }, // Menor √°rea de escaneo
                        aspectRatio: 1.0,
                        disableFlip: false,
                        videoConstraints: {
                            facingMode: { ideal: "environment" },
                            advanced: [{ focusMode: "continuous" }]
                        }
                    } : {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        disableFlip: false
                    };
                    
                    console.log('üì∑ Configuraci√≥n de esc√°ner:', config);
                    
                    await html5QrCode.start(
                        currentCameraId,
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    mostrarEstadoQR('üì∑ C√°mara lista - Apunte hacia el c√≥digo', 'success');
                    
                } else {
                    mostrarEstadoQR('‚ùå No se encontraron c√°maras disponibles', 'error');
                }
                
            } catch (err) {
                console.error('‚ùå Error al inicializar esc√°ner QR:', err);
                
                // Mensajes de error espec√≠ficos para Android
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isHttps = location.protocol === 'https:';
                
                let errorMessage = '‚ùå Error al acceder a la c√°mara.';
                
                if (isAndroid && !isHttps) {
                    errorMessage = '‚ùå Android requiere HTTPS para acceder a la c√°mara. Use Chrome y permita el acceso.';
                } else if (isAndroid) {
                    errorMessage = '‚ùå Error en Android. Intente: 1) Recargar p√°gina 2) Permitir c√°mara en configuraci√≥n 3) Usar Chrome.';
                } else {
                    errorMessage = '‚ùå Error al acceder a la c√°mara. Verifique los permisos en su navegador.';
                }
                
                mostrarEstadoQR(errorMessage, 'error');
                
                // Mostrar autom√°ticamente la entrada manual despu√©s de error
                setTimeout(() => {
                    mostrarEntradaManual();
                }, 1500);
                
                // Ofrecer fallback manual adicional (mantener el c√≥digo existente tambi√©n)
                setTimeout(() => {
                    const statusDiv = document.getElementById('qrStatus');
                    statusDiv.innerHTML = `
                        <div style="margin-top: 10px;">
                            <p style="color: #666; font-size: 12px;">
                                üí° <strong>Alternativa:</strong> Puede escribir o pegar el c√≥digo manualmente en el campo de texto principal.
                            </p>
                            <button onclick="cerrarEscanerQR()" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Usar entrada manual
                            </button>
                        </div>
                    `;
                }, 2000);
            }
        }

        // Funci√≥n llamada cuando se escanea exitosamente
        function onScanSuccess(decodedText, decodedResult) {
            console.log('‚úÖ QR escaneado:', decodedText);
            mostrarEstadoQR('‚úÖ ¬°C√≥digo escaneado exitosamente!', 'success');
            
            // Llenar el campo de texto con el c√≥digo escaneado
            const inputCodigo = document.getElementById('codigoMaterialOriginal');
            inputCodigo.value = decodedText;
            
            // Resaltar el campo
            inputCodigo.style.backgroundColor = '#d4edda';
            inputCodigo.style.borderColor = '#28a745';
            
            // Procesar el c√≥digo autom√°ticamente
            setTimeout(() => {
                parsearYDistribuirCodigo(decodedText);
                cerrarEscanerQR();
                
                // Restaurar estilos del campo despu√©s de un tiempo
                setTimeout(() => {
                    inputCodigo.style.backgroundColor = '';
                    inputCodigo.style.borderColor = '';
                }, 3000);
            }, 500);
        }

        // Funci√≥n llamada cuando falla el escaneo (normal, se ejecuta continuamente)
        function onScanFailure(error) {
            // No hacer nada, esto es normal durante el escaneo continuo
            // console.log('Escaneando...', error);
        }

        // Funci√≥n para cambiar entre c√°maras disponibles
        async function cambiarCamara() {
            if (availableCameras.length <= 1) {
                mostrarEstadoQR('‚ÑπÔ∏è Solo hay una c√°mara disponible', 'info');
                return;
            }
            
            try {
                // Detener el esc√°ner actual
                if (html5QrCode && html5QrCode.isScanning) {
                    await html5QrCode.stop();
                }
                
                // Encontrar la siguiente c√°mara
                const currentIndex = availableCameras.findIndex(cam => cam.id === currentCameraId);
                const nextIndex = (currentIndex + 1) % availableCameras.length;
                currentCameraId = availableCameras[nextIndex].id;
                
                console.log(`üì∑ Cambiando a c√°mara: ${currentCameraId}`);
                mostrarEstadoQR('üîÑ Cambiando c√°mara...', 'info');
                
                // Reiniciar con la nueva c√°mara
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                await html5QrCode.start(
                    currentCameraId,
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                
                mostrarEstadoQR('üì∑ C√°mara cambiada - Apunte hacia el c√≥digo', 'success');
                
            } catch (err) {
                console.error('‚ùå Error al cambiar c√°mara:', err);
                mostrarEstadoQR('‚ùå Error al cambiar c√°mara', 'error');
            }
        }

        // Funci√≥n para mostrar estados del esc√°ner
        function mostrarEstadoQR(mensaje, tipo) {
            const statusDiv = document.getElementById('qrStatus');
            const statusText = document.getElementById('qrStatusText');
            
            if (tipo === 'none') {
                statusDiv.style.display = 'none';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusText.textContent = mensaje;
            
            // Colores seg√∫n el tipo
            switch(tipo) {
                case 'success':
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.borderLeft = '4px solid #28a745';
                    break;
                case 'error':
                    statusDiv.style.backgroundColor = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.borderLeft = '4px solid #dc3545';
                    break;
                case 'info':
                    statusDiv.style.backgroundColor = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    statusDiv.style.borderLeft = '4px solid #17a2b8';
                    break;
                default:
                    statusDiv.style.backgroundColor = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.style.borderLeft = '4px solid #ffc107';
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalQRScanner');
            const modalContent = modal.querySelector('div > div');
            
            if (event.target === modal && !modalContent.contains(event.target)) {
                cerrarEscanerQR();
            }
        });

        // ==================== FIN QR SCANNER FUNCTIONALITY ====================

    </script>
</body>
</html>