<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="autocomplete" content="off">
    <title>Control de Material - Almacén</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=LG+regular&display=swap" rel="stylesheet">
    
    <!-- Estilos globales -->
    <link rel="stylesheet" href="/static/css/control_material_almacen.css">
    
    <!-- Estilos responsive para móvil -->
    <link rel="stylesheet" href="/static/css/control_material_almacen_responsive.css">
    
    <!-- Scripts necesarios -->
    <!-- Scripts usando CDN para asegurar disponibilidad -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.9.0/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.8.1/dist/autoNumeric.min.js"></script>
    <!-- Control Material Almacén JS - puede mantenerse local si existe -->
    <script src="/static/js/control_material_almacen.js"></script>
    <script src="/static/js/material-edit-drawer.js"></script>
    
    <!-- CSS para modal de registro de reglas de trazabilidad -->
    <style>
        /* Modal de trazabilidad */
        .trazabilidad-modal {
            display: none;
            position: fixed !important;
            z-index: 15000 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.8) !important;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }
        
        .trazabilidad-modal-content {
            background-color: #40424F;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            color: #ecf0f1;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: relative !important;
            z-index: 15001 !important;
        }
        
        .trazabilidad-modal h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .trazabilidad-raw-text {
            background-color: #2c3e50;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 16px;
            margin: 15px 0;
            border: 2px dashed #3498db;
            user-select: text;
            cursor: text;
            color: #ecf0f1;
            word-break: break-all;
        }
        
        .trazabilidad-field {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .trazabilidad-field label {
            font-weight: 500;
            color: #ecf0f1;
        }
        
        .trazabilidad-field input {
            padding: 8px;
            font-size: 14px;
            background-color: #e3f2fd;
            color: #2c3e50;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #95a5a6;
        }
        
        .trazabilidad-buttons {
            margin-top: 20px;
            text-align: right;
        }
        
        .trazabilidad-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        
        .trazabilidad-btn.primary {
            background-color: #3498db;
        }
        
        .trazabilidad-btn.primary:hover {
            background-color: #2980b9;
        }
        
        .trazabilidad-btn.danger {
            background-color: #3498db;
        }
        
        .trazabilidad-btn.danger:hover {
            background-color: #2980b9;
        }
        
        .trazabilidad-help {
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #bdc3c7;
        }

        /* Estilos adicionales para botones activos */
        .btn-seleccion.activo {
            background-color: #28a745 !important;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .instruccion-seleccion {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        /* Estilos para campo de escaneo mejorado */
        .campo-escaneo-listo {
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff) !important;
            border: 2px solid #28a745 !important;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.3) !important;
        }

        .campo-escaneo-activo {
            background: linear-gradient(135deg, #ffe6e6, #fff0f0) !important;
            border: 2px solid #dc3545 !important;
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.5) !important;
            animation: pulso-escaneo 1.5s infinite ease-in-out;
        }

        .campo-escaneo-procesando {
            background: linear-gradient(135deg, #fff3cd, #fef7e0) !important;
            border: 2px solid #ffc107 !important;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.3) !important;
        }

        .campo-escaneo-exito {
            background: linear-gradient(135deg, #d1edff, #e3f2fd) !important;
            border: 2px solid #007bff !important;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3) !important;
        }

        /* Indicador de escaneo */
        .indicador-escaneo {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 8px;
            font-weight: bold;
            color: #666;
            pointer-events: none;
            z-index: 10;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 3px;
            border-radius: 2px;
        }

        /* Animación de pulso para modo activo */
        @keyframes pulso-escaneo {
            0%, 100% { 
                box-shadow: 0 0 12px rgba(220, 53, 69, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(220, 53, 69, 0.8);
            }
        }

        #codigoMaterialOriginal::placeholder {
            color: #28a745;
            font-weight: 500;
        }

        .indicador-escaneo {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            z-index: 1;
        }

        /* Estilos para registro automático */
        .registro-automatico-activo {
            animation: pulso-registro 2s infinite ease-in-out;
        }

        @keyframes pulso-registro {
            0%, 100% { 
                color: #28a745;
                text-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
            }
            50% { 
                color: #20c997;
                text-shadow: 0 0 10px rgba(40, 167, 69, 0.8);
            }
        }

        .countdown-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff7f00, #ff4500);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(255, 127, 0, 0.4);
            z-index: 10001;
            cursor: pointer;
            text-align: center;
            animation: pulso-countdown 1s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .countdown-indicator:hover {
            background: linear-gradient(135deg, #ff4500, #dc143c);
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 127, 0, 0.6);
        }

        @keyframes pulso-countdown {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.02); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .celda-clickeable {
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative;
        }

        /* Mejorar la selección de texto en celdas largas */
        .celda-clickeable.codigo-material-cell {
            user-select: none; /* Prevenir selección accidental de texto */
            position: relative;
        }

        /* Crear una capa invisible clickeable sobre las celdas con overflow */
        .celda-clickeable::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            cursor: pointer;
        }

        /* Asegurar que el texto sea visible */
        .celda-clickeable > * {
            position: relative;
            z-index: 0;
        }

        /* Asegurar que las celdas con overflow sean clickeables */
        .material-table tbody tr td {
            position: relative;
            z-index: 1;
        }

        .material-table tbody tr.fila-clickeable td {
            pointer-events: auto;
        }

        .material-table input[type="radio"] {
            accent-color: #3498db;
            cursor: pointer;
        }

        .material-table input[type="radio"]:hover {
            transform: scale(1.3);
            transition: transform 0.2s ease;
        }

        /* 🎯 ESTILOS DE FOCUS Y SELECCIÓN DE TABLA - ALTA PRIORIDAD */        
        
        /* Focus en filas - MÁXIMA PRIORIDAD */
        #tablaControlAlmacen tbody tr.fila-clickeable:focus td,
        #tablaControlAlmacen tbody tr.fila-seleccionada:focus td,
        #tablaControlAlmacen tbody tr[tabindex]:focus td {
            background-color: #2980b9 !important; 
            outline: none !important; 
            outline-offset: 0 !important;
            box-shadow: none !important; 
            border-color: inherit !important; 
            
        }
        
        /* Radio buttons focus */
        #tablaControlAlmacen input[type="radio"]:focus {
            outline: 4px solid #2980b9 !important;
            outline-offset: 4px !important;
            box-shadow: 0 0 15px rgba(41, 128, 185, 0.9) !important;
        }

        /* 🎨 Estilos personalizados para SweetAlert - Tema oscuro */
        .swal2-popup {
            background-color: #40424F !important;
            color: #ecf0f1 !important;
            border-radius: 12px !important;
            border: 1px solid #555 !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        }

        .swal2-title {
            color: #ecf0f1 !important;
            font-weight: 600 !important;
        }

        .swal2-content {
            color: #bdc3c7 !important;
        }

        .swal2-confirm {
            background-color: #3498db !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 8px 20px !important;
            font-weight: 500 !important;
        }

        .swal2-confirm:hover {
            background-color: #2980b9 !important;
        }

        .swal2-cancel {
            background-color: #2980b9 !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 8px 20px !important;
            font-weight: 500 !important;
        }

        .swal2-cancel:hover {
            background-color: #2980b9 !important;
        }

        .swal2-icon.swal2-success {
            border-color: #27ae60 !important;
            color: #27ae60 !important;
        }

        .swal2-icon.swal2-error {
            border-color: #3498db !important;
            color: #3498db !important;
        }

        .swal2-icon.swal2-warning {
            border-color: #f39c12 !important;
            color: #f39c12 !important;
        }

        .swal2-icon.swal2-info {
            border-color: #3498db !important;
            color: #3498db !important;
        }

        .swal2-toast {
            background-color: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-radius: 8px !important;
            border: 1px solid #555 !important;
        }

        .swal2-toast .swal2-title {
            color: #ecf0f1 !important;
            font-size: 14px !important;
        }

        .swal2-toast .swal2-content {
            color: #bdc3c7 !important;
            font-size: 13px !important;
        }

        /* Personalizar el loading spinner */
        .swal2-loading .swal2-loader {
            border-color: #3498db transparent #3498db transparent !important;
        }

        /* Personalizar el overlay/backdrop */
        .swal2-backdrop {
            background-color: rgba(0,0,0,0.6) !important;
        }
    </style>
    
</head>
<body>

<!-- Modal de Registro de Reglas de Trazabilidad -->
<div id="trazabilidad-modal" class="trazabilidad-modal">
    <div class="trazabilidad-modal-content">
        <h2>Registrar Nueva Regla de Trazabilidad</h2>
        <p>No se encontró una regla para este código. Por favor, define una nueva regla:</p>
        
        <form autocomplete="off">
        <div class="trazabilidad-field">
            <label for="trazabilidad-supplier">Proveedor:</label>
            <input type="text" id="trazabilidad-supplier" placeholder="Ej: ROHM, SMART, etc." autocomplete="off">
        </div>
        
        <label>Texto Escaneado:</label>
        <div id="trazabilidad-raw-text" class="trazabilidad-raw-text"></div>
        
        <div class="trazabilidad-field">
            <label for="trazabilidad-part-number">Número de Parte:</label>
            <input type="text" id="trazabilidad-part-number" placeholder="Selecciona del texto arriba" autocomplete="off">
        </div>
        
        <div class="trazabilidad-field">
            <label for="trazabilidad-lot-number">Número de Lote:</label>
            <input type="text" id="trazabilidad-lot-number" placeholder="Opcional - Selecciona del texto arriba" autocomplete="off">
        </div>
        </form>
        
        <div class="trazabilidad-buttons">
            <button class="trazabilidad-btn danger" onclick="cerrarModalTrazabilidad()">Cancelar</button>
            <button class="trazabilidad-btn primary" onclick="guardarReglaTrazabilidad()">Crear Regla</button>
        </div>
    </div>
</div>

<!-- Los modales se crean dinámicamente en JavaScript (ver createModalsAlmacen() más abajo) -->

<!-- Modal de Carga -->
<div id="modal-carga" class="loading-modal">
    <div class="loading-modal-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Consultando datos<span class="loading-dots"></span></div>
        <div class="loading-subtext">Por favor espere mientras cargamos la información</div>
    </div>
</div>

<!-- Formulario principal con autocomplete deshabilitado -->
<form autocomplete="off" data-form-type="other"
<!-- Fila 1: SOLO Forma de material, ancho completo -->
<div class="material-container2">

    <div class="material-form-section">
        <div class="material-form-group" >
            <label>
                    Forma de material
            </label>
            <select id="forma_material" autocomplete="off">
                <option>
                    OriginCode
                </option>
            </select>
        </div>
    </div>

    <div class="material-form-section">    
        <div class="material-form-row four-column">
            <div class="material-form-group">
                <label>
                    Cliente
                </label>
                <select id="cliente" autocomplete="off">
                    <option value="">
                        Seleccionar
                    </option>
                    <option value="LG_REFRIS" selected>
                        LG_REFRIS
                    </option>
                    <option value="LG_ESTUFAS">
                        LG_ESTUFAS
                    </option>
                </select>
            </div>
            <div class="material-form-group">
                <label>Código de material original</label>
                <div style="display: flex; align-items: center; gap: 8px; min-width: 0; position: relative;">
                    <div style="position: relative; flex: 1; min-width: 0;">
                        <input type="text" id="codigoMaterialOriginal" name="codigo_unico_escaneo" class="campo-escaneo-listo" style="flex: 1; min-width: 0; width: 100%; padding-right: 80px;" placeholder="Escanear código o seleccionar material..." onkeydown="procesarScaneo(event)" onfocus="activarModoEscaneo()" onblur="desactivarModoEscaneo()" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" data-form-type="other">
                        <span id="indicadorEscaneo" class="indicador-escaneo">LISTO</span>
                        <button type="button" onclick="limpiarCampoManual()" style="position: absolute; right: 28px; top: 50%; transform: translateY(-50%); padding: 2px 6px; font-size: 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Limpiar campo">X</button>
                    </div>
                    <button type="button" onclick="abrirEscanerQR()" class="material-btn mobile-only-btn" title="Escanear QR con cámara" style="padding: 5px 12px; font-size: 12px; line-height: 1;">CAM</button>
                </div>
            </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Código de material</label>
            <div style="position: relative; min-width: 0;">
                <select id="codigoMaterialSelect" onclick="event.preventDefault(); abrirModalCodigoMaterial();" readonly style="cursor: pointer; width: 100%;">
                    <option value="">Seleccionar</option>
                </select>
                
          
                <div id="modalCodigoMaterial" class="dropdown-modal">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar código, nombre o especificación..." onkeyup="filtrarTablaModal()">
                    <div class="dropdown-table-container">
                        <table class="dropdown-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Especificación</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCodigosBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="material-form-group">
            <label>Material importación/local</label>
            <select id="material_importacion_local">
                <option value="Customer Supply">Customer Supply</option>
                <option value="Local" selected>Local</option>
                <option value="Importación">Importación</option>
            </select>
        </div>
        <div class="material-form-group">
            <label>Fecha de recibo</label>
            <input type="date" id="fecha_recibo">
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>
    <div class="material-form-row four-column">
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Fecha de fabricación</label>
            <input type="date" id="fecha_fabricacion">
        </div>
        <div class="material-form-group">
            <label>Cantidad actual:</label>
            <input type="text" id="cantidad_actual">
        </div>
        <div class="material-form-group">
            <label>Número de lote de material</label>
            <input type="text" id="numero_lote_material">
        </div>
    </div>
        </div>
        
    
<div class="material-form-section2">
    <div class="material-form-row four-column" style="align-items: center;">
        <div class="material-form-group">
            <label>Código de material recibido</label>
            <input type="text" id="codigo_material_recibido">
        </div>
        <div class="material-form-group">
            <label>Número de parte:</label>
            <input type="text" id="numero_parte_lower">
        </div>
        <div class="material-form-group">
            <label>Cantidad estandarizada</label>
            <input type="text" id="cantidad_estandarizada">
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        
        <div class="material-form-group">
            <label>Código de material</label>
            <input type="text" id="codigo_material_lower">
        </div>
        <div class="material-form-group">
            <label>Propiedad de material</label>
            <input type="text" id="propiedad_material">
        </div>
        <div class="material-form-group">
            <label>Especificación de material</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="almacen_especificacion_material" readonly placeholder="Se carga automáticamente al seleccionar código" style="flex: 1;">
                <label class="checkbox-label-almacen" style="display: none; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer; white-space: nowrap; transition: all 0.3s ease;" id="label_registro_automatico">
                    <input type="checkbox" id="checkbox_registro_almacen" class="checkbox-almacen" style="display: none;" disabled title="FUNCIÓN DESACTIVADA PERMANENTEMENTE">
                    <span id="texto_registro_automatico">Registro automático (DESACTIVADO)</span>
                </label>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group"></div>
        <div class="material-form-group"></div>
        <div class="material-form-group" style="justify-self: end;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <button type="button" class="material-btn orange botones-almacen" id="btnGuardar" style="display: none !important;">Guardar</button>
                <button type="button" class="material-btn botones-almacen" id="btnUnidades" style="background: #28a745; display: inline-block !important;">UNIDADES</button>
                <button type="button" class="material-btn botones-almacen" id="btnImprimir" style="display: inline-block;">Imprimir</button>
                <button type="button" class="material-btn botones-almacen" id="btnConfigImpresora" style="background: #6c757d; font-size: 9px; padding: 6px 8px; min-width: 80px; text-align: center;">CONF. DE IMPRESORA</button>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>
</div>
</form>
<!-- Fin del formulario principal -->

        <!-- Botonera usando el diseño de CONTROL_DE_MATERIAL -->
        

        <!-- Sección de filtros usando el diseño de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; overflow: hidden;">
                <label style="margin: 0; color: lightgray; font-size: 11px; white-space: nowrap;">Fecha de recibo</label>
                <input type="date" id="filtro_fecha_inicio" style="width: 130px; height: 24px; font-size: 10px; font-family: sans-serif; min-width: 100px;">
                <span style="color: lightgray; font-size: 11px;">~</span>
                <input type="date" id="filtro_fecha_fin" style="width: 130px; height: 24px; font-size: 10px; min-width: 100px;">
            </div>
            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button type="button" class="material-btn" id="btnConsultar">Consultar</button>
                <button type="button" class="material-btn secondary" id="btnExportarExcel">Exportar Excel</button>
                <input type="file" id="importarExcelAlmacen" style="display:none" accept=".xlsx,.xls" />
                <button type="button" class="material-btn secondary" id="btnImportarExcel">Importar Excel</button>
            </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="material-table-container">
            <table class="material-table" id="tablaControlAlmacen">
                <thead>
                    <tr>
                        <th style="width: 40px; text-align: center;">Sel.</th>
                        <th>Código de material recibido</th>
                        <th>Código de material</th>
                        <th>Número de parte</th>
                        <th>Número de lote de material</th>
                        <th>Propiedad de material</th>
                        <th>Cantidad actual</th>
                        <th>Cantidad estandarizada</th>
                        <th>Ubicación de salida</th>
                        <th>Fecha de recibo</th>
                        <th>Especificación</th>
                        <th>Material importación/local</th>
                        <th style="display: none;">Estado de desecho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="12" class="no-data">
                            No hay datos para mostrar. Haga clic en "Consultar" para cargar los registros.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p class="total-info">Total Rows: 0</p>
        </div>

    </div>

    <style>
        /* Estilos para selección de filas de tabla */
        .fila-seleccionada {
            background-color: #007bff !important;
            color: white !important;
        }
        
        .fila-clickeable {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .fila-clickeable:hover {
            background-color: #f0f8ff !important;
        }
        
        .fila-seleccionada:hover {
            background-color: #0056b3 !important;
        }
    </style>

    <script>
        // Función para resolver error de closeMobileSidebar
        function closeMobileSidebar() {
            // Esta función es llamada desde algún lugar pero no estaba definida
            // Agregar lógica aquí si es necesario cerrar algún sidebar móvil
        }
        
        let codigosMaterial = [];
        
        // Variables para manejo de selección de tabla
        let filaSeleccionada = null;
        let datosFilaSeleccionada = null;

        // ====== Event Delegation (CRÍTICO PARA CARGA DINÁMICA) ======
        /**
         * Función de inicialización usando Event Delegation
         * Esta función puede llamarse múltiples veces sin causar problemas
         */
        function initializeControlAlmacenEventListeners() {
            
            // Protección contra inicialización múltiple
            if (!document.body.dataset.controlAlmacenListenersAttached) {
                
                // Event delegation para clicks en botones principales
                document.body.addEventListener('click', function(e) {
                    const target = e.target;
                    
                    // Excluir clicks dentro de modales para no interferir con su funcionalidad
                    if (target.closest('#modal-asignacion-lotes') || 
                        target.closest('#modal-unidades') || 
                        target.closest('#trazabilidad-modal') ||
                        target.closest('#modalCodigoMaterial')) {
                        return;
                    }
                    
                    // Botón Guardar
                    if (target.id === 'btnGuardar' || target.closest('#btnGuardar')) {
                        e.preventDefault();
                        guardarFormulario();
                        return;
                    }
                    
                    // Botón UNIDADES
                    if (target.id === 'btnUnidades' || target.closest('#btnUnidades')) {
                        e.preventDefault();
                        abrirModalUnidades();
                        return;
                    }
                    
                    // Botón Imprimir
                    if (target.id === 'btnImprimir' || target.closest('#btnImprimir')) {
                        e.preventDefault();
                        manejarImpresion();
                        return;
                    }
                    
                    // Botón Config Impresora
                    if (target.id === 'btnConfigImpresora' || target.closest('#btnConfigImpresora')) {
                        e.preventDefault();
                        verificarImpresoraZebra();
                        return;
                    }
                    
                    // Botón Consultar
                    if (target.id === 'btnConsultar' || target.closest('#btnConsultar')) {
                        e.preventDefault();
                        consultarRegistros();
                        return;
                    }
                    
                    // Botón Exportar Excel
                    if (target.id === 'btnExportarExcel' || target.closest('#btnExportarExcel')) {
                        e.preventDefault();
                        exportarExcel();
                        return;
                    }
                    
                    // Botón Importar Excel
                    if (target.id === 'btnImportarExcel' || target.closest('#btnImportarExcel')) {
                        e.preventDefault();
                        const fileInput = document.getElementById('importarExcelAlmacen');
                        if (fileInput) fileInput.click();
                        return;
                    }
                });
                
                // Event delegation para change en file input
                document.body.addEventListener('change', function(e) {
                    if (e.target.id === 'importarExcelAlmacen') {
                        importarExcelAlmacen();
                    }
                });
                
                document.body.dataset.controlAlmacenListenersAttached = 'true';
            }
        }

        // FUNCIONES DIRECTAS PARA BOTONES DE PRUEBA ZPL
        function mostrarEjemploZPLDirecto() {
            const datosEjemplo = {
                codigoCompleto: '0RH5602C622,202507170003',
                codigoMaterial: '0RH5602C622',
                numeroSerie: '202507170003',
                fecha: '17/07/2025',
                cantidadEstandarizada: '5000',
                descripcionMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            const zplEjemplo = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT170,70^A0N,22,20^FH\\^CI28^FDQTY:^FS^CI27
^FT15,0^BQN,2,5
^FH\\^FDLA,${datosEjemplo.codigoCompleto}^FS
^FT170,1^A0N,32,30^FH\\^CI28^FD${datosEjemplo.codigoMaterial}^FS^CI27
^FT170,50^A0N,32,30^FH\\^CI28^FD${datosEjemplo.numeroSerie}^FS^CI27
^FT15,125^A0N,22,20^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT15,150^A0N,27,25^FH\\^CI28^FD${datosEjemplo.fecha}^FS^CI27
^FT170,100^A0N,30,28^FH\\^CI28^FD${datosEjemplo.descripcionMaterial}^FS^CI27
^FT170,123^A0N,30,28^FH\\^CI28^FD^FS^CI27
^FT210,75^A0N,28,26^FH\\^CI28^FD${datosEjemplo.cantidadEstandarizada}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                align-items: center; z-index: 10003; padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                         Formato ZPL Actualizado - Zebra ZD421
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #6f42c1; margin-bottom: 10px;">Variables que se insertan automáticamente:</h4>
                        <ul style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 0;">
                            <li><strong>Código completo:</strong> ${datosEjemplo.codigoCompleto}</li>
                            <li><strong>Código material:</strong> ${datosEjemplo.codigoMaterial}</li>
                            <li><strong>Número serie:</strong> ${datosEjemplo.numeroSerie}</li>
                            <li><strong>Fecha entrada:</strong> ${datosEjemplo.fecha}</li>
                            <li><strong>Cantidad:</strong> ${datosEjemplo.cantidadEstandarizada}</li>
                            <li><strong>Descripción:</strong> ${datosEjemplo.descripcionMaterial}</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">🖨️ Comando ZPL Generado:</h4>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; border: 1px solid #dee2e6;">${zplEjemplo}</pre>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #dc3545; margin-bottom: 10px;">Características del formato:</h4>
                        <ul style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 0; border: 1px solid #ffeaa7;">
                            <li>Compatible con Zebra ZD421</li>
                            <li>Código QR automático con datos completos</li>
                            <li>Variables dinámicas del formulario</li>
                            <li>Formato de fecha DD/MM/YYYY</li>
                            <li>Campos de cantidad y descripción configurables</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="this.closest('div').parentNode.remove()" 
                            style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Función global para inicializar cuando se muestra el control de almacén
        window.inicializarControlAlmacenModule = function() {
            // Pequeño delay para asegurar que el DOM esté completamente renderizado
            setTimeout(() => {
                inicializarControlAlmacen();
                configurarListenersAdicionales();
                // Asegurar que las fechas siempre estén actuales al cambiar de módulo
                establecerFechasActuales();
            }, 100);
        };

        // Cargar códigos de material al cargar la página
        function inicializarControlAlmacen() {
            // *** TABLA VISIBLE POR DEFECTO PARA DEBUGGING ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            // *** CONFIGURAR PROTECCIÓN ANTI-TAB/ENTER EN CAMPO DE ESCANEO ***
            const campoEscaneo = document.getElementById('codigoMaterialOriginal');
            if (campoEscaneo) {
                // *** NUEVO: Solo mantener foco DURANTE escritura activa, no de forma permanente ***
                let escribiendoActivamente = false;
                
                // Activar bandera cuando empieza a escribir
                campoEscaneo.addEventListener('input', function(e) {
                    escribiendoActivamente = true;
                    // Desactivar la bandera después de 3 segundos sin escritura (fin de escaneo)
                    clearTimeout(campoEscaneo._timeoutEscaneo);
                    campoEscaneo._timeoutEscaneo = setTimeout(() => {
                        escribiendoActivamente = false;
                    }, 3000);
                });
                
                // Permitir salir del campo con Tab/Enter SOLO si no está escribiendo
                campoEscaneo.addEventListener('keydown', function(e) {
                    if ((e.key === 'Tab' || e.key === 'Enter') && escribiendoActivamente) {
                        // Solo prevenir si está escribiendo activamente
                        e.preventDefault();
                        e.stopPropagation();
                        // NO devolver foco automáticamente - dejar que se procese el escaneo
                    }
                    // Si NO está escribiendo activamente, permitir salir normalmente
                });
                
                // No devolver foco en blur - permitir navegación libre
                // Solo mantener foco durante el evento 'input' activo (mientras escanea)
            }
            
            // Establecer fecha actual en todos los campos de fecha
            establecerFechasActuales();
            
            // Forzar selección de LG_REFRIS como cliente por defecto
            forzarClienteLGRefris();
            
            // Forzar selección de "Local" en material importación/local
            forzarMaterialLocal();
            
            cargarCodigosMaterial();
            cargarClienteSeleccionado(); // Cargar la última selección de cliente
            cargarSiguienteSecuencial(); // Cargar el siguiente número secuencial
        }

        // Nueva función para establecer fechas actuales
        function establecerFechasActuales() {
            // Usar el mismo método que setFechasHoy() para evitar problemas de zona horaria
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fechaHoy = `${year}-${month}-${day}`;
            
            // Establecer fecha actual en campos principales
            const fechaRecibo = document.getElementById('fecha_recibo');
            const fechaFabricacion = document.getElementById('fecha_fabricacion');
            const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
            const filtroFechaFin = document.getElementById('filtro_fecha_fin');
            
            if (fechaRecibo) fechaRecibo.value = fechaHoy;
            if (fechaFabricacion) fechaFabricacion.value = fechaHoy;
            if (filtroFechaInicio) filtroFechaInicio.value = fechaHoy;
            if (filtroFechaFin) filtroFechaFin.value = fechaHoy;
        }

        // Nueva función para forzar cliente LG_REFRIS siempre
        function forzarClienteLGRefris() {
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.value = 'LG_REFRIS';
                // También agregar un listener para evitar que se cambie
                selectCliente.addEventListener('change', function() {
                    if (this.value !== 'LG_REFRIS') {
                        this.value = 'LG_REFRIS';
                        // Opcional: mostrar mensaje
                        // alert('El cliente debe ser LG_REFRIS');
                    }
                });
            }
        }

        // Nueva función para forzar Material importación/local como "Local" siempre
        function forzarMaterialLocal() {
            const selectMaterial = document.getElementById('material_importacion_local');
            if (selectMaterial) {
                selectMaterial.value = 'Local';
                // También agregar un listener para evitar que se cambie
                selectMaterial.addEventListener('change', function() {
                    if (this.value !== 'Local') {
                        this.value = 'Local';
                        // Opcional: mostrar mensaje
                        // alert('El material debe ser Local');
                    }
                });
            }
        }

        // ====== Exponer función de inicialización inmediatamente (CRÍTICO) ======
        window.initializeControlAlmacenEventListeners = initializeControlAlmacenEventListeners;

        // ====== Auto-inicialización ======
        // Ejecutar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeControlAlmacenEventListeners();
                inicializarControlAlmacen();
            });
        } else {
            initializeControlAlmacenEventListeners();
            inicializarControlAlmacen();
        }

        // Función para cargar la última selección de cliente - siempre LG_REFRIS
        async function cargarClienteSeleccionado() {
            try {
                // Siempre establecer LG_REFRIS como cliente por defecto
                const selectCliente = document.getElementById('cliente');
                if (selectCliente) {
                    selectCliente.value = 'LG_REFRIS';
                    // Guardar la selección por defecto
                    await guardarClienteSeleccionado('LG_REFRIS');
                }
            } catch (error) {
                console.error('Error al cargar cliente seleccionado:', error);
                // En caso de error, asegurar que LG_REFRIS esté seleccionado
                const selectCliente = document.getElementById('cliente');
                if (selectCliente) {
                    selectCliente.value = 'LG_REFRIS';
                }
            }
        }

        // Función para guardar la selección de cliente
        async function guardarClienteSeleccionado(cliente) {
            try {
                const response = await fetch('/guardar_cliente_seleccionado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cliente: cliente })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (!data.success) {
                        console.error('Error al guardar cliente:', data.error);
                    }
                }
            } catch (error) {
                console.error('Error de conexión al guardar cliente:', error);
            }
        }

        async function cargarCodigosMaterial(busqueda = '') {
            try {
                // Construir URL con parámetro de búsqueda si existe
                const url = busqueda ? `/obtener_codigos_material?busqueda=${encodeURIComponent(busqueda)}` : '/obtener_codigos_material';
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Si es una búsqueda, no sobrescribir codigosMaterial completo
                    if (busqueda) {
                        return data; // Devolver resultados de búsqueda
                    } else {
                        codigosMaterial = data; // Cargar datos completos
                        return data;
                    }
                } else {
                    console.error('Error al cargar códigos de material, status:', response.status);
                    // Si hay error, usar datos de prueba
                    const datosPrueba = [
                        {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                        {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                        {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                    ];
                    
                    if (!busqueda) {
                        codigosMaterial = datosPrueba;
                    }
                    return datosPrueba;
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                // Si hay error, usar datos de prueba
                const datosPrueba = [
                    {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                    {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                    {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                ];
                
                if (!busqueda) {
                    codigosMaterial = datosPrueba;
                }
                return datosPrueba;
            }
        }

        function abrirModalCodigoMaterial() {
            const modal = document.getElementById('modalCodigoMaterial');
            const searchInput = document.getElementById('searchInput');
            
            // Cerrar otros dropdowns si están abiertos
            cerrarModalCodigoMaterial();
            
            // Limpiar búsqueda
            searchInput.value = '';
            
            // Mostrar todos los materiales cargados usando la nueva función
            mostrarResultadosEnTabla(codigosMaterial);
            
            // Mostrar el modal con animación suave
            modal.style.display = 'block';
            
            // Enfocar el campo de búsqueda
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }

        function cerrarModalCodigoMaterial() {
            document.getElementById('modalCodigoMaterial').style.display = 'none';
        }

        function seleccionarCodigo(codigo) {
            const select = document.getElementById('codigoMaterialSelect');
            
            // Buscar la información completa del código seleccionado
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigo);
            
            // Actualizar el select con el código seleccionado
            select.innerHTML = `
                <option value="${codigo}" selected>${codigo}</option>
                <option value="">Seleccionar</option>
            `;
            
            // Llenar también el campo de código original para permitir entrada sin escanear
            const campoOriginal = document.getElementById('codigoMaterialOriginal');
            if (campoOriginal) {
                campoOriginal.value = codigo;
                campoOriginal.style.backgroundColor = '#e3f2fd';
                setTimeout(() => {
                    campoOriginal.style.backgroundColor = '';
                }, 2000);
            }
            
            // Mostrar la especificación inmediatamente al seleccionar
            if (codigoCompleto) {
                select.title = `${codigoCompleto.codigo} - ${codigoCompleto.nombre} - ${codigoCompleto.spec}`;
                
                // Llenar inmediatamente los campos que podemos llenar sin secuencial
                llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || codigoCompleto.spec || '');
                llenarCampoPorId('numero_parte_lower', codigoCompleto.numero_parte || '');
                llenarCampoPorId('codigo_material_lower', codigoCompleto.numero_parte || '');
                llenarCampoPorId('cantidad_estandarizada', codigoCompleto.cantidad_estandarizada || '');
                llenarCampoPorId('cantidad_actual', codigoCompleto.cantidad_estandarizada || '');
                llenarCampoPorId('propiedad_material', codigoCompleto.propiedad_material || '');
                
                // ✅ VERIFICAR MATERIAL EXISTENTE PARA HABILITAR BOTÓN UNIDADES
                verificarMaterialExistente(codigo);
            }
            
            cerrarModalCodigoMaterial();
            
            // Llenar el código secuencial después de seleccionar
            setTimeout(() => {
                cargarSiguienteSecuencial(codigo).then(() => {
                    if (proximoCodigoCompleto) {
                        llenarCampoPorId('codigo_material_recibido', proximoCodigoCompleto);
                    }
                }).catch(error => {
                    console.error('Error al cargar secuencial:', error);
                });
            }, 100);
        }

        // Variable para el timeout del debounce
        let timeoutBusqueda = null;

        async function filtrarTablaModal() {
            const input = document.getElementById('searchInput');
            const filtro = input.value.trim();
            const tbody = document.getElementById('tablaCodigosBody');
            
            // Limpiar timeout anterior
            if (timeoutBusqueda) {
                clearTimeout(timeoutBusqueda);
            }
            
            // Si no hay filtro, mostrar todos los materiales cargados
            if (filtro === '') {
                mostrarResultadosEnTabla(codigosMaterial);
                return;
            }
            
            // Agregar indicador de carga
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 15px;"><i class="fas fa-spinner fa-spin"></i> Buscando...</td></tr>';
            
            // Implementar debounce para evitar demasiadas consultas
            timeoutBusqueda = setTimeout(async () => {
                try {
                    // Llamar al servidor con búsqueda inteligente
                    const resultados = await cargarCodigosMaterial(filtro);
                    
                    // Mostrar resultados
                    mostrarResultadosEnTabla(resultados);
                    
                } catch (error) {
                    console.error('Error en búsqueda:', error);
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 15px; color: #dc3545;">Error en la búsqueda</td></tr>';
                }
            }, 500); // Esperar 500ms después de que el usuario deje de escribir
        }
        
        function mostrarResultadosEnTabla(resultados) {
            const tbody = document.getElementById('tablaCodigosBody');
            tbody.innerHTML = '';
            
            if (resultados.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 15px;">No se encontraron resultados</td>';
            } else {
                resultados.forEach(codigo => {
                    const fila = tbody.insertRow();
                    
                    // Resaltar coincidencias si están marcadas
                    const codigoMostrar = codigo.coincidencia ? `<strong>${codigo.codigo}</strong>` : codigo.codigo;
                    const nombreMostrar = codigo.coincidencia ? `<strong>${codigo.nombre}</strong>` : codigo.nombre;
                    
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')" style="cursor: pointer;">${codigoMostrar}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')" style="cursor: pointer;">${nombreMostrar}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')" style="cursor: pointer;">${codigo.spec}</td>
                    `;
                    
                    // Agregar clase para resaltar filas con coincidencias
                    if (codigo.coincidencia) {
                        fila.style.backgroundColor = '#fff3cd';
                    }
                });
            }
        }

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCodigoMaterial');
            const select = document.getElementById('codigoMaterialSelect');
            
            // Si se hace clic fuera del modal y del select, cerrar el modal
            if (!modal.contains(event.target) && !select.contains(event.target)) {
                cerrarModalCodigoMaterial();
            }
        });

        // Configurar listeners adicionales cuando la página esté lista
        function configurarListenersAdicionales() {
            // Agregar event listener al select de cliente
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    const clienteSeleccionado = this.value;
                    if (clienteSeleccionado) {
                        guardarClienteSeleccionado(clienteSeleccionado);
                        
                        // Resaltar visualmente que se guardó
                        this.style.backgroundColor = '#d4edda';
                        this.style.borderColor = '#c3e6cb';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, 1500);
                    }
                });
            }
            
            // Agregar listener adicional al botón de consultar para asegurar que funcione
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', function(e) {
                    // Solo prevenir default si no hay onclick definido
                    if (!this.onclick) {
                        e.preventDefault();
                        consultarRegistros();
                    }
                });
            }
            
            // *** NUEVO: Agregar listener para checkbox de registro automático ***
            const checkboxRegistroAuto = document.getElementById('checkbox_registro_almacen');
            if (checkboxRegistroAuto) {
                checkboxRegistroAuto.addEventListener('change', function() {
                    const labelRegistro = document.getElementById('label_registro_automatico');
                    const textoRegistro = document.getElementById('texto_registro_automatico');
                    
                    if (this.checked) {
                        // Activado - cambiar estilo
                        labelRegistro.style.color = '#28a745';
                        labelRegistro.style.fontWeight = 'bold';
                        textoRegistro.textContent = 'Registro automático ACTIVO';
                        
                        // Registro automático activado
                        
                        // NO verificar inmediatamente - solo tras escaneo
                        // setTimeout(() => {
                        //     verificarRegistroAutomaticoTrasEscaneo();
                        // }, 500);
                    } else {
                        // Desactivado - restaurar estilo
                        labelRegistro.style.color = '#ecf0f1';
                        labelRegistro.style.fontWeight = 'normal';
                        textoRegistro.textContent = 'Registro automático';
                        
                        // Registro automático desactivado
                    }
                });
            }
        }

        // Verificar si el DOM ya está listo para configurar listeners adicionales
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarListenersAdicionales);
        } else {
            // DOM ya está listo, ejecutar inmediatamente
            configurarListenersAdicionales();
        }

        // Variables globales para detección automática de escaneo
        let ultimoTiempoEscaneo = 0;
        let bufferEscaneo = '';
        let timeoutEscaneo = null;
        let yaGuardadoEnEsteEscaneo = false; // *** NUEVA VARIABLE DE CONTROL ***

        // Funciones para controlar el indicador de escaneo
        function activarModoEscaneo() {
            const campo = document.getElementById('codigoMaterialOriginal');
            const indicador = document.getElementById('indicadorEscaneo');
            
            campo.className = 'campo-escaneo-activo';
            indicador.textContent = 'ACTIVO';
            indicador.title = 'Modo escaneo activo - Listo para recibir datos';
        }

        function desactivarModoEscaneo() {
            const campo = document.getElementById('codigoMaterialOriginal');
            const indicador = document.getElementById('indicadorEscaneo');
            
            if (campo.value.trim() === '') {
                campo.className = 'campo-escaneo-listo';
                indicador.textContent = 'LISTO';
                indicador.title = 'Campo listo para escanear';
            }
        }

        function procesarScaneo(event) {
            const tiempoActual = Date.now();
            const input = event.target;
            
            // *** PREVENIR TAB Y ENTER PARA MANTENER FOCO EN CAMPO DE ESCANEO ***
            if (event.key === 'Tab') {
                event.preventDefault();
                input.focus(); // Forzar que el foco permanezca aquí
                return;
            }
            
            // Detectar Enter (método tradicional) - Solo prevenir comportamiento por defecto
            if (event.key === 'Enter') {
                event.preventDefault();
                input.focus(); // Asegurar que el foco permanezca aquí
                return;
            }
            
            // *** DETECTAR NUEVO ESCANEO Y RESETEAR CONTROL ***
            if (event.key && event.key.length === 1 && input.value.length === 0) {
                // Se está empezando a escribir en campo vacío - nuevo escaneo
                yaGuardadoEnEsteEscaneo = false;
            }
            
            // Detección automática por velocidad de tipeo (escáneres son muy rápidos)
            const velocidadEscaneo = tiempoActual - ultimoTiempoEscaneo;
            ultimoTiempoEscaneo = tiempoActual;
            
            // Si la velocidad es muy rápida (< 50ms entre caracteres), probablemente es un escáner
            if (velocidadEscaneo < 50 && event.key.length === 1) {
                bufferEscaneo += event.key;
                
                // Limpiar timeout anterior
                if (timeoutEscaneo) {
                    clearTimeout(timeoutEscaneo);
                }
                
                // Establecer timeout para procesar automáticamente después de pausa
                timeoutEscaneo = setTimeout(() => {
                    const codigoCompleto = input.value.trim();
                    if (codigoCompleto && codigoCompleto.length > 10) { // Mínimo 10 caracteres para ser válido
                        parsearYDistribuirCodigo(codigoCompleto);
                        // NO limpiar automáticamente - dejar el código visible
                    }
                    bufferEscaneo = '';
                }, 100); // Esperar 100ms después de la última tecla
            }
            
            // Detectar códigos largos (típicos de escáneres) y procesarlos automáticamente
            // *** CÓDIGO AUTOMÁTICO DESACTIVADO PARA EVITAR BUCLES INFINITOS ***
            // setTimeout(() => {
            //     const codigoActual = input.value.trim();
            //     if (codigoActual.length >= 15) { // Códigos típicos de materiales son largos
            //         console.log('Código largo detectado - procesando automáticamente:', codigoActual);
            //         parsearYDistribuirCodigo(codigoActual);
            //         // NO limpiar automáticamente - dejar que el usuario vea el código
            //     }
            // }, 200);
        }

        function limpiarCampoEscaneo(input) {
            // Limpiar el campo después de procesar
            setTimeout(() => {
                const indicador = document.getElementById('indicadorEscaneo');
                
                input.value = '';
                input.className = 'campo-escaneo-listo';
                input.placeholder = 'Listo para escanear...';
                indicador.textContent = 'LISTO';
                indicador.title = 'Campo listo para escanear';
                input.focus(); // Mantener foco para siguiente escaneo
            }, 100);
        }

        function limpiarCampoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const indicador = document.getElementById('indicadorEscaneo');
            
            input.value = '';
            input.className = 'campo-escaneo-listo';
            input.placeholder = 'Listo para escanear...';
            indicador.textContent = 'LISTO';
            indicador.title = 'Campo listo para escanear';
            input.focus();
            
            // *** RESETEAR CONTROL DE GUARDADO AL LIMPIAR MANUALMENTE ***
            yaGuardadoEnEsteEscaneo = false;
            
            // *** LIMPIAR BUFFERS Y TIMEOUTS PARA PREVENIR BUCLES ***
            bufferEscaneo = '';
            if (timeoutEscaneo) {
                clearTimeout(timeoutEscaneo);
                timeoutEscaneo = null;
            }
            ultimoTiempoEscaneo = 0;
        }

        function procesarCodigoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const codigoCompleto = input.value.trim();
            
            if (codigoCompleto) {
                parsearYDistribuirCodigo(codigoCompleto);
            } else {
                alert('Por favor, ingrese o escanear un código antes de procesar.');
            }
        }

        async function parsearYDistribuirCodigo(codigoCompleto) {
            try {
                //  VERIFICAR QUE EL CÓDIGO ESTÉ EN EL CAMPO CORRECTO
                const campoEscaneo = document.getElementById('codigoMaterialOriginal');
                if (campoEscaneo) {
                    // Asegurar que el código escaneado esté en el campo de escaneo
                    if (campoEscaneo.value !== codigoCompleto) {
                        campoEscaneo.value = codigoCompleto;
                    }
                }
                
                // Primero intentar con las reglas de trazabilidad
                const resultado = await aplicarReglasEscaneo(codigoCompleto);
                
                if (resultado) {
                    // Si se encontró una regla que coincide, usar esos datos
                    if (resultado.partNumber) {
                        // Usar el partNumber como código de material
                        buscarYSeleccionarCodigoMaterial(resultado.partNumber);
                    }
                    
                    if (resultado.lotNumber) {
                        const inputLote = document.getElementById('numero_lote_material');
                        if (inputLote) {
                            inputLote.value = resultado.lotNumber;
                        } else {
                            console.error('No se encontró el campo numero_lote_material');
                        }
                    }
                    
                    mostrarNotificacionEscaneo(resultado.partNumber, null, resultado.lotNumber);
                    
                    // NO limpiar el campo automáticamente - permitir que el usuario vea el código
                    return;
                }
                
                // Si no se encontró regla de trazabilidad, abrir modal para registrar nueva regla
                // Guardar el código escaneado para uso en el modal
                window.ultimoCodigoEscaneado = codigoCompleto;
                abrirModalTrazabilidad();
                return;
                
                // COMENTADO: El método anterior como fallback ya no se usa
                // Se prefiere usar el sistema de trazabilidad
                /*
                // Si no funciona con reglas, usar el método anterior como fallback
                const partes = codigoCompleto.split('-');
                
                if (partes.length < 8) {
                    alert('Formato de código inválido. No se encontró regla aplicable y no tiene el formato esperado con "/" ');
                    return;
                }
                
                // Extraer SOLO el código de material y número de lote (método anterior)
                const codigoMaterial = partes[0];           // M2124740058
                const numeroLote = partes[7];               // IA3116H14
                
                // Distribuir a los campos correspondientes
                if (codigoMaterial) {
                    buscarYSeleccionarCodigoMaterial(codigoMaterial);
                }
                
                if (numeroLote) {
                    const inputLote = document.getElementById('numero_lote_material');
                    if (inputLote) {
                        inputLote.value = numeroLote;
                    }
                }
                
                mostrarNotificacionEscaneo(codigoMaterial, null, numeroLote);
                */
                
            } catch (error) {
                console.error('Error al procesar código escaneado:', error);
                alert('Error al procesar el código escaneado');
            }
        }

        // Función temporal de prueba para el modal
        function probarModalTrazabilidad() {
            window.ultimoCodigoEscaneado = 'H5602C622,202507250003';
            abrirModalTrazabilidad();
        }

        // Función de prueba para verificar funcionamiento completo
        function probarSistemaCompleto() {
            
            // Simular un código escaneado
            const codigoPrueba = 'H5602C622,202507250003';
            
            // Procesar el código
            parsearYDistribuirCodigo(codigoPrueba);
        }

        // Función específica para probar la regla PRUEBA corregida
        function probarReglaPrueba() {
            
            const codigoPrueba = '0RH5602C622,202507250003';
            
            // Manualmente probar la extracción según la regla corregida
            const partNumber = codigoPrueba.substring(0, 11); // Posición 0-10
            const lotNumber = codigoPrueba.substring(12, 24); // Posición 12-23
            
            
            // Ahora probar con la función completa
            parsearYDistribuirCodigo(codigoPrueba);
        }

        // Función para probar la creación de regla desde el modal
        function probarCreacionReglaModal() {
            
            // Simular código escaneado
            const codigoPrueba = '0RH5602C622,202507250003';
            window.ultimoCodigoEscaneado = codigoPrueba;
            
            // Abrir modal
            abrirModalTrazabilidad();
            
            // Llenar automáticamente los campos para prueba
            setTimeout(() => {
                document.getElementById('trazabilidad-supplier').value = 'PRUEBA';
                document.getElementById('trazabilidad-part-number').value = '0RH5602C622';
                document.getElementById('trazabilidad-lot-number').value = '202507250003';
                
            }, 500);
        }

        async function buscarYSeleccionarCodigoMaterial(codigo) {
            
            try {
                // Primero intentar búsqueda exacta local
                let codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
                
                // Si no se encuentra exactamente, usar búsqueda inteligente del servidor
                if (!codigoEncontrado) {
                    
                    // Llamar al servidor con búsqueda inteligente
                    const resultadosBusqueda = await cargarCodigosMaterial(codigo);
                    
                    if (resultadosBusqueda && resultadosBusqueda.length > 0) {
                        // Tomar el primer resultado (más relevante)
                        codigoEncontrado = resultadosBusqueda[0];
                    }
                }
                
                if (codigoEncontrado) {
                    
                    // Si existe, seleccionarlo automáticamente
                    seleccionarCodigo(codigoEncontrado.codigo);
                    
                    
                } else {
                    console.warn(`❌ Código de material no encontrado en la base de datos: ${codigo}`);
                    
                    // Si no existe, mostrar en el dropdown pero sin seleccionar
                    const select = document.getElementById('codigoMaterialSelect');
                    select.innerHTML = `
                        <option value="${codigo}" selected>${codigo} (Código escaneado - no encontrado en BD)</option>
                        <option value="">Seleccionar</option>
                    `;
                    select.style.backgroundColor = '#fff3cd'; // Resaltar en amarillo
                    
                    // También llenar campos básicos aunque no esté en BD - usar código original ya que no hay número de parte
                    llenarCamposInferiores(codigo);
                    
                    // Mostrar notificación de advertencia
                    mostrarNotificacionImpresion(`Código no encontrado: ${codigo}`, 'warning');
                    
                    setTimeout(() => {
                        select.style.backgroundColor = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error en búsqueda inteligente:', error);
                
                // En caso de error, usar comportamiento original
                const codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
                
                if (codigoEncontrado) {
                    seleccionarCodigo(codigo);
                } else {
                    const select = document.getElementById('codigoMaterialSelect');
                    select.innerHTML = `
                        <option value="${codigo}" selected>${codigo} (Error en búsqueda)</option>
                        <option value="">Seleccionar</option>
                    `;
                    console.warn('Código de material no encontrado en la base de datos:', codigo);
                    // Usar código original ya que no se encontró número de parte
                    llenarCamposInferiores(codigo);
                }
            }
        }

        function mostrarNotificacionEscaneo(codigo, cantidad, lote) {
            // Llenar automáticamente los campos inferiores
            // El parámetro 'codigo' puede ser código de material o número de parte dependiendo del contexto
            llenarCamposInferiores(codigo);
            
            // NO limpiar campo - permitir que el usuario vea el código procesado
            
            // Verificar material existente después de que se llenen los campos
            setTimeout(() => {
                verificarMaterialExistente(codigo);
            }, 200); // Dar tiempo para que se llenen los campos primero
            
            // *** VERIFICACIÓN RÁPIDA DE REGISTRO AUTOMÁTICO TRAS ESCANEO ***
            setTimeout(() => {
                // verificarRegistroAutomaticoTrasEscaneo(); // DESACTIVADO PERMANENTEMENTE
            }, 500); // Reducido a 0.5 segundos para mayor velocidad
        }

        function mostrarNotificacionExito(titulo, detalle) {
            // Crear notificación temporal
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 10001;
                font-family: 'Segoe UI', sans-serif;
                font-size: 14px;
                max-width: 350px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            notificacion.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">${titulo}</div>
                <div style="font-size: 12px; opacity: 0.9;">${detalle}</div>
            `;
            
            document.body.appendChild(notificacion);
            
            // Animar entrada
            setTimeout(() => {
                notificacion.style.transform = 'translateX(0)';
            }, 100);
            
            // Remover después de 3 segundos
            setTimeout(() => {
                notificacion.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 3000);
        }

        // Contador global para números secuenciales del código de material recibido
        let contadorSecuencial = 1;
        let proximoCodigoCompleto = '';

        // Función para cargar el siguiente número secuencial desde la base de datos
        async function cargarSiguienteSecuencial(codigoMaterial = '') {
            try {
                // Construir URL con código de material si está disponible
                let url = '/obtener_siguiente_secuencial';
                if (codigoMaterial) {
                    url += `?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                }
                
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        contadorSecuencial = data.siguiente_secuencial || 1;
                        proximoCodigoCompleto = data.proximo_codigo_completo || '';
                        
                    } else {
                        contadorSecuencial = 1;
                        proximoCodigoCompleto = '';
                        console.warn(` Respuesta sin éxito, usando valores por defecto`);
                    }
                } else {
                    contadorSecuencial = 1;
                    proximoCodigoCompleto = '';
                    console.error(`Error en respuesta HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('Error de conexión al cargar secuencial:', error);
                contadorSecuencial = 1;
                proximoCodigoCompleto = '';
            }
        }

        function llenarCamposInferiores(codigoMaterial) {
            // Esta función ahora es solo para escenarios donde no se ha seleccionado desde el modal
            // Si ya tenemos la información de la selección, no hacer nada
            const campoRecibido = document.getElementById('codigo_material_recibido');
            const campoNumeroParte = document.getElementById('numero_parte_lower');
            
            // Si ya están llenos los campos principales, solo cargar el secuencial
            if (campoNumeroParte && campoNumeroParte.value.trim()) {
                
                // Buscar la información completa del código de material para actualizar especificación
                const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
                let codigoEncontrado = codigoCompleto;
                
                if (!codigoEncontrado) {
                    // Intentar buscar por número de parte también
                    codigoEncontrado = codigosMaterial.find(c => c.numero_parte === codigoMaterial);
                    if (codigoEncontrado) {
                    }
                }
                
                // Actualizar especificación aunque los otros campos ya estén llenos
                if (codigoEncontrado) {
                    const especificacion = codigoEncontrado.especificacion_material || codigoEncontrado.spec || '';
                    llenarCampoPorId('almacen_especificacion_material', especificacion);
                } else {
                    console.warn('❌ No se encontró especificación para:', codigoMaterial);
                }
                
                cargarSiguienteSecuencial(codigoMaterial).then(() => {
                    if (proximoCodigoCompleto && (!campoRecibido || !campoRecibido.value.trim())) {
                        llenarCampoPorId('codigo_material_recibido', proximoCodigoCompleto);
                    }
                }).catch(error => {
                    console.error('❌ Error al cargar secuencial:', error);
                });
                return;
            }
            
            // Buscar la información completa del código de material
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
            
            let codigoEncontrado = codigoCompleto;
            
            if (!codigoEncontrado) {
                console.warn('⚠️ Código no encontrado en codigosMaterial:', codigoMaterial);
                // Intentar buscar por número de parte también
                codigoEncontrado = codigosMaterial.find(c => c.numero_parte === codigoMaterial);
                if (codigoEncontrado) {
                } else {
                    console.warn('❌ Tampoco encontrado por número de parte');
                }
            } else {
            }
            
            // Cargar secuencial y llenar campos
            cargarSiguienteSecuencial(codigoMaterial).then(() => {
                // Llenar código recibido secuencial
                if (proximoCodigoCompleto) {
                    llenarCampoPorId('codigo_material_recibido', proximoCodigoCompleto);
                }
                
                // Llenar otros campos si tenemos la información
                if (codigoEncontrado) {
                    llenarCampoPorId('codigo_material_lower', codigoEncontrado.numero_parte || '');
                    llenarCampoPorId('numero_parte_lower', codigoEncontrado.numero_parte || '');
                    llenarCampoPorId('cantidad_estandarizada', codigoEncontrado.cantidad_estandarizada || '');
                    llenarCampoPorId('cantidad_actual', codigoEncontrado.cantidad_estandarizada || '');
                    llenarCampoPorId('propiedad_material', codigoEncontrado.propiedad_material || '');
                    llenarCampoPorId('almacen_especificacion_material', codigoEncontrado.especificacion_material || codigoEncontrado.spec || '');
                    
                } else {
                    console.warn('❌ No se pudo llenar la especificación - código no encontrado');
                }
            }).catch(error => {
                console.error('Error al cargar secuencial:', error);
            });
        }

        function llenarCampoPorId(idCampo, valor) {
            const campo = document.getElementById(idCampo);
            if (campo) {
                // Siempre asignar el valor, incluso si está vacío
                campo.value = valor || '';
                
                // Solo resaltar si hay un valor no vacío
                if (valor && valor.trim()) {
                    // Resaltar visualmente el campo que se llenó
                    campo.style.backgroundColor = '#e3f2fd';
                    campo.style.transition = 'background-color 0.3s';
                    
                    setTimeout(() => {
                        campo.style.backgroundColor = '';
                    }, 2000);
                }
            } else {
                console.warn(`❌ Campo no encontrado con ID: ${idCampo}`);
            }
        }

        function llenarCampoInferior(labelTexto, valor) {
            const labels = document.querySelectorAll('label');
            let campoEncontrado = false;
            
            // Buscar desde el final hacia atrás para encontrar los campos inferiores
            for (let i = labels.length - 1; i >= 0; i--) {
                const label = labels[i];
                if (label.textContent.includes(labelTexto)) {
                    // Si es "Código de material:" tomar el último (inferior)
                    if (labelTexto === 'Código de material:' && campoEncontrado) {
                        continue; // Saltar el primero, queremos el último
                    }
                    
                    const input = label.parentNode.querySelector('input');
                    if (input) {
                        input.value = valor;
                        input.style.backgroundColor = '#e3f2fd'; // Resaltar en azul claro
                        input.style.transition = 'background-color 0.3s';
                        
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 3000);
                        
                        campoEncontrado = true;
                        
                        // Para "Código de material:" solo tomar el último
                        if (labelTexto !== 'Código de material:') {
                            break;
                        }
                    }
                }
            }
            
            if (!campoEncontrado) {
                console.warn('Campo no encontrado:', labelTexto);
            }
        }

        // Función para reiniciar el contador (opcional, para usar cuando sea necesario)
        // Función para recargar el contador desde la base de datos
        function recargarContador() {
            cargarSiguienteSecuencial();
        }

        // Función opcional para forzar recarga del contador (para testing/debug)
        function forzarRecargaContador() {
            cargarSiguienteSecuencial().then(() => {
            });
        }

        // Función para verificar y llenar manualmente (para testing)
        function llenarCamposInferioresManual() {
            const selectCodigo = document.getElementById('codigoMaterialSelect');
            const codigoSeleccionado = selectCodigo.value;
            
            if (codigoSeleccionado) {
                llenarCamposInferiores(codigoSeleccionado);
            } else {
                alert('Por favor, seleccione primero un código de material');
            }
        }

        // Función para guardar el formulario
        function guardarFormulario() {
            try {
                // Recopilar todos los datos del formulario
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: document.getElementById('codigoMaterialOriginal').value,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: document.getElementById('numero_lote_material').value,
                    codigo_material_recibido: document.getElementById('codigo_material_recibido').value,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value,
                    // *** NUEVO: Agregar lote interno si fue generado ***
                    lote_interno: window.loteInternoParaGuardar || null
                };
                
                // Validar campos requeridos - mejorada para permitir entrada sin escanear
                if (!formData.codigo_material_original && !formData.codigo_material) {
                    alert('Por favor, ingrese el código de material original (escaneando) o seleccione un material del dropdown');
                    return;
                }
                
                // Si no hay código original pero sí hay material seleccionado, usar el código del material seleccionado
                if (!formData.codigo_material_original && formData.codigo_material) {
                    formData.codigo_material_original = formData.codigo_material;
                }
                
                // Validar que haya código de material recibido (secuencial)
                if (!formData.codigo_material_recibido) {
                    alert('No se pudo generar el código de material recibido. Por favor, seleccione nuevamente el material.');
                    return;
                }
                
                
                // Deshabilitar botón mientras se guarda
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                // Enviar datos al servidor
                fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    
                    // Verificar si la respuesta es JSON
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // Si no es JSON, probablemente es una redirección a login
                        throw new Error('No autenticado - redirigiendo a login');
                    }
                })
                .then(data => {
                    if (data.success) {
                        // Registro guardado exitosamente
                        
                        // *** CAPTURAR DATOS ANTES DE LIMPIAR FORMULARIO ***
                        const datosParaEtiqueta = {
                            codigo: formData.codigo_material_recibido,
                            numeroLote: formData.numero_lote_material || '',
                            numeroParte: formData.numero_parte || '',
                            cantidadActual: formData.cantidad_actual || '',
                            propiedadMaterial: formData.especificacion || ''
                        };
                        
                        
                        // *** NUEVA FUNCIONALIDAD: Impresión automática directa ***
                        const codigoMaterialRecibido = formData.codigo_material_recibido;
                        if (codigoMaterialRecibido && codigoMaterialRecibido.trim() !== '') {
                            
                            // Imprimir directamente sin confirmaciones CON DATOS CAPTURADOS
                            setTimeout(() => {
                                imprimirZebraAutomaticoConDatos(datosParaEtiqueta);
                            }, 500);
                        }
                        
                        // IMPORTANTE: Esperar un poco y luego recargar el siguiente secuencial
                        setTimeout(async () => {
                            const codigoActual = document.getElementById('codigoMaterialSelect').value;
                            if (codigoActual) {
                                await cargarSiguienteSecuencial(codigoActual);
                                
                                // Después de recargar, actualizar los campos inferiores con la nueva secuencia
                                llenarCamposInferiores(codigoActual);
                            } else {
                                await cargarSiguienteSecuencial();
                            }
                        }, 500); // Esperar 500ms para asegurar que la BD se actualice
                        
                        // Limpiar formulario automáticamente después de guardar exitosamente
                        limpiarFormularioParaSiguienteEscaneo();
                        
                        // *** NUEVA: Recargar tabla automáticamente después de guardar ***
                        // Hacerlo después de 800ms para darle tiempo a la BD
                        setTimeout(() => {
                            consultarRegistros();
                        }, 800);
                        
                        // Actualizar inventario consolidado
                        actualizarInventarioConsolidadoTrasEdicion();
                    } else {
                        mostrarNotificacionImpresion('Error al guardar: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('No autenticado')) {
                        alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                        window.location.href = '/login';
                    } else {
                        mostrarNotificacionImpresion('Error al guardar el registro: ' + error.message, 'error');
                    }
                })
                .finally(() => {
                    // Rehabilitar botón
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                });
                
            } catch (error) {
                console.error('Error al procesar formulario:', error);
                mostrarNotificacionImpresion('Error al procesar el formulario', 'error');
            }
        }
        
        // Función para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('forma_material').selectedIndex = 0;
            document.getElementById('cliente').selectedIndex = 0;
            // NO limpiar el campo de escaneo automáticamente
            // document.getElementById('codigoMaterialOriginal').value = '';
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 1; // Local por defecto
            
            // Restablecer fechas a hoy
            setFechasHoy();
            
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            
            // *** OCULTAR LA TABLA AL LIMPIAR FORMULARIO ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'none';
            }
            
            // El contador secuencial se recarga desde BD después de cada guardado exitoso
        }

        // Función específica para limpiar después de guardar exitosamente
        function limpiarFormularioParaSiguienteEscaneo() {
            // Limpiar TODOS los campos para el siguiente escaneo
            document.getElementById('forma_material').selectedIndex = 0;
            // NO limpiar cliente - mantener selección para eficiencia
            // document.getElementById('cliente').selectedIndex = 0;
            
            // *** LIMPIEZA RÁPIDA DEL CAMPO DE ESCANEO ***
            // Mostrar resultado brevemente y limpiar rápido para escaneo continuo
            const inputEscaneo = document.getElementById('codigoMaterialOriginal');
            const indicador = document.getElementById('indicadorEscaneo');
            
            // Cambiar visual para indicar que se guardó exitosamente
            inputEscaneo.className = 'campo-escaneo-exito';
            indicador.textContent = 'GUARDADO';
            indicador.title = 'Código guardado exitosamente';
            
            // *** LIMPIAR RÁPIDAMENTE DESPUÉS DE 1 SEGUNDO PARA ESCANEO CONTINUO ***
            setTimeout(() => {
                inputEscaneo.value = '';
                inputEscaneo.className = 'campo-escaneo-listo';
                inputEscaneo.placeholder = 'Listo para escanear siguiente código...';
                indicador.textContent = 'LISTO';
                indicador.title = 'Campo listo para escanear';
                
                // *** RESETEAR CONTROL PARA SIGUIENTE ESCANEO ***
                yaGuardadoEnEsteEscaneo = false;
                
                // Enfocar para siguiente escaneo
                inputEscaneo.focus();
            }, 1000); // Reducido a 1 segundo para mayor velocidad
            
            // Limpiar select de código de material
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 1; // Local por defecto
            
            // Restablecer fechas a hoy
            setFechasHoy();
            
            // Limpiar todos los campos del formulario
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            document.getElementById('almacen_especificacion_material').value = '';

        }

        // *** NUEVA FUNCIÓN: Verificar registro automático SOLO tras escaneo ***
        function verificarRegistroAutomaticoTrasEscaneo() {
            // *** CONTROL: No permitir múltiples guardados del mismo escaneo ***
            if (yaGuardadoEnEsteEscaneo) {
                return;
            }
            
            // Verificar si el checkbox de registro automático está marcado
            const checkboxRegistroAuto = document.getElementById('checkbox_registro_almacen');
            
            if (!checkboxRegistroAuto || !checkboxRegistroAuto.checked) {
                return; // No hacer nada si no está marcado
            }
            
            // Verificar que los campos esenciales estén llenos
            const validacion = validarCamposParaRegistroAuto();
            
            // Si todos los campos están llenos, guardar automáticamente
            if (validacion.valido) {
                
                // *** MARCAR COMO YA GUARDADO ANTES DE GUARDAR ***
                yaGuardadoEnEsteEscaneo = true;
                
                guardarFormulario();
                
            } else {
                // Campos faltantes para registro automático
            }
        }

        // *** FUNCIÓN: Contador específico para escaneo automático ***
        function mostrarContadorAutomaticoEscaneo(segundos) {
            // Verificar si ya existe un contador activo
            const contadorExistente = document.getElementById('contador_automatico_escaneo');
            if (contadorExistente) {
                return;
            }
            
            // Crear elemento de contador específico para escaneo
            const contador = document.createElement('div');
            contador.className = 'countdown-indicator';
            contador.id = 'contador_automatico_escaneo';
            
            let segundosRestantes = segundos;
            
            function actualizarContador() {
                contador.innerHTML = `
                    <div style="font-size: 18px; margin-bottom: 5px;">📱 ESCANEO DETECTADO</div>
                    <div style="font-size: 14px;">Guardando automáticamente en <strong>${segundosRestantes}s</strong></div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Click para cancelar</div>
                `;
                
                if (segundosRestantes <= 0) {
                    // Guardar automáticamente
                    guardarFormulario();
                    contador.remove();
                } else {
                    segundosRestantes--;
                    setTimeout(actualizarContador, 1000);
                }
            }
            
            // Permitir cancelar haciendo click en el contador
            contador.addEventListener('click', function() {
                this.remove();
                // *** RESETEAR CONTROL AL CANCELAR ***
                yaGuardadoEnEsteEscaneo = false;
                // Guardado automático cancelado
            });
            
            // Agregar al DOM y comenzar contador
            document.body.appendChild(contador);
            actualizarContador();
        }

        // *** FUNCIÓN AUXILIAR: Validar campos para registro automático ***
        function validarCamposParaRegistroAuto() {
            const camposRequeridos = [
                { id: 'codigoMaterialOriginal', nombre: 'Código original' },
                { id: 'codigo_material_recibido', nombre: 'Código recibido' },
                { id: 'almacen_especificacion_material', nombre: 'Especificación' }
            ];
            
            const camposFaltantes = [];
            
            for (const campo of camposRequeridos) {
                const elemento = document.getElementById(campo.id);
                if (!elemento || !elemento.value || elemento.value.trim() === '') {
                    camposFaltantes.push(campo.nombre);
                }
            }
            
            return {
                valido: camposFaltantes.length === 0,
                camposFaltantes: camposFaltantes
            };
        }
        
        // Establecer fechas a hoy al cargar la página
function setFechasHoy() {
    // Obtener la fecha local (no UTC) para evitar desfase de zona horaria
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hoyLocal = `${year}-${month}-${day}`;
    // También actualiza los filtros de fecha
    const fechaRecibo = document.getElementById('fecha_recibo');
    const fechaFabricacion = document.getElementById('fecha_fabricacion');
    const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
    const filtroFechaFin = document.getElementById('filtro_fecha_fin');
    if (fechaRecibo) fechaRecibo.value = hoyLocal;
    if (fechaFabricacion) fechaFabricacion.value = hoyLocal;
    if (filtroFechaInicio) filtroFechaInicio.value = hoyLocal;
    if (filtroFechaFin) filtroFechaFin.value = hoyLocal;
}
// Llamar al cargar la página
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setFechasHoy);
} else {
    setFechasHoy();
}

        // Función para consultar registros (actualizada para usar la nueva función)
        function consultarRegistros() {
            cargarDatosDesdeServidor();
        }

        // Función principal de carga de datos (actualizada para usar la nueva función)
        function cargarDatosDesdeServidor() {
            
            // Mostrar modal de carga
            mostrarModalCarga();
            
            const fechaInicio = document.getElementById('filtro_fecha_inicio').value;
            const fechaFin = document.getElementById('filtro_fecha_fin').value;
            
            
            // Construir URL con parámetros
            let url = '/consultar_control_almacen';
            const params = new URLSearchParams();
            
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            
            fetch(url)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    
                    nuevaCargarDatos(data);
                    // Ocultar modal de carga
                    ocultarModalCarga();
                })
                .catch(error => {
                    console.error('❌ Error completo:', error);
                    
                    const tbody = document.querySelector('#tablaControlAlmacen tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #3498db;">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
                    }
                    // Ocultar modal de carga en caso de error
                    ocultarModalCarga();
                });
            
        }
        
        // Función global para acceso directo (como en CONTROL_DE_MATERIAL.html)
        window.cargarDatosDesdeServidor = cargarDatosDesdeServidor;
        
        // NUEVA FUNCIÓN FUNCIONAL PARA REEMPLAZAR cargarDatosEnTabla
        function nuevaCargarDatos(datos) {
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            
            // *** MOSTRAR LA TABLA CUANDO SE CARGAN DATOS ***
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            tbody.innerHTML = '';

            if (!datos || datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="material-table .no-data">No hay registros disponibles.</td></tr>';
                return;
            }

            datos.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Hacer la fila clickeable para selección - mejorado para textos largos
                row.className = 'fila-clickeable';
                row.style.cursor = 'pointer';
                row.tabIndex = 0; // Hacer la fila enfocable
                
                // Usar addEventListener para mejor control de eventos
                row.addEventListener('click', function(e) {
                    // Evitar propagación desde elementos hijos
                    e.stopPropagation();
                    seleccionarFilaTabla(this, item, index);
                });
                
                // Agregar soporte para navegación con teclado
                row.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        seleccionarFilaTabla(this, item, index);
                    }
                });
                
                // Agregar eventos de focus para mejorar visibilidad (sin contornos gruesos)
                row.addEventListener('focus', function() {
                    this.style.outline = '';
                    this.style.outlineOffset = '';
                });
                
                row.addEventListener('blur', function() {
                    if (!this.classList.contains('fila-seleccionada')) {
                        this.style.outline = '';
                        this.style.outlineOffset = '';
                    }
                });
                
                // Agregar evento de doble clic para edición
                row.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    abrirEdicionControlAlmacen(item);
                });

                // Crear las celdas con clases específicas para el tooltip
                const codigoMaterialCell = `<td class="codigo-material-cell celda-clickeable" data-full-text="${item.codigo_material || ''}" title="${item.codigo_material || ''}">${item.codigo_material || ''}</td>`;

                row.innerHTML = `
                    <td style="text-align: center; width: 40px;">
                        <input type="radio" name="filaSeleccionada" value="${index}" style="cursor: pointer; transform: scale(1.2);">
                    </td>
                    <td class="celda-clickeable">${item.codigo_material_recibido || ''}</td>
                    ${codigoMaterialCell}
                    <td class="celda-clickeable">${item.numero_parte || ''}</td>
                    <td class="celda-clickeable">${item.numero_lote_material || ''}</td>
                    <td class="celda-clickeable">${item.propiedad_material || ''}</td>
                    <td class="celda-clickeable">${item.cantidad_actual || ''}</td>
                    <td class="celda-clickeable">${item.cantidad_estandarizada || ''}</td>
                    <td class="celda-clickeable">${item.ubicacion_salida || ''}</td>
                    <td class="celda-clickeable">${item.fecha_recibo || ''}</td>
                    <td class="celda-clickeable">${item.especificacion || ''}</td>
                    <td class="celda-clickeable">${item.material_importacion_local || ''}</td>
                    <td class="celda-clickeable" style="display: none;">${(item.estado_desecho === 1 || item.estado_desecho === '1') ? 'Activo' : (item.estado_desecho === 0 || item.estado_desecho === '0') ? 'Desecho' : (item.estado_desecho || '')}</td>
                `;
                tbody.appendChild(row);
                
                // Agregar listener específico al radio button
                const radioButton = row.querySelector('input[type="radio"]');
                if (radioButton) {
                    radioButton.addEventListener('change', function() {
                        if (this.checked) {
                            seleccionarFilaTabla(row, item, index);
                        }
                    });
                }
                
                // Agregar listeners adicionales a todas las celdas para asegurar clickeabilidad
                const celdas = row.querySelectorAll('.celda-clickeable');
                celdas.forEach(celda => {
                    celda.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // Propagar el click a la fila padre
                        seleccionarFilaTabla(row, item, index);
                    });
                    
                    celda.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                        abrirEdicionControlAlmacen(item);
                    });
                });
            });
            
            // IMPORTANTE: Llama a actualizarTotalFilasTabla() después de actualizar los datos de la tabla
            actualizarTotalFilasTabla();
        }
        
        // Actualiza el total de filas en la tabla de resultados
        function actualizarTotalFilasTabla() {
            const tabla = document.getElementById('tablaControlAlmacen');
            const totalInfo = document.querySelector('.total-info');
            if (!tabla || !totalInfo) return;
            const tbody = tabla.querySelector('tbody');
            if (!tbody) return;
            // Contar filas que no tengan la clase 'no-data'
            const filas = Array.from(tbody.querySelectorAll('tr'));
            const filasDatos = filas.filter(tr => !tr.classList.contains('no-data'));
            totalInfo.textContent = `Total Rows: ${filasDatos.length}`;
        }
        
        // Función para seleccionar fila de tabla
        function seleccionarFilaTabla(fila, datos, index) {
            
            // Verificar datos críticos
            
            // Limpiar selección anterior
            limpiarSeleccionTabla();
            
            // Marcar nueva selección con la clase correcta
            fila.classList.add('fila-seleccionada', 'selected');
            filaSeleccionada = fila;
            datosFilaSeleccionada = datos;
            
            // Marcar el radio button correspondiente
            const radioButton = fila.querySelector('input[type="radio"]');
            if (radioButton) {
                radioButton.checked = true;
            }
            
        }
        
        // Función para limpiar selección de tabla
        function limpiarSeleccionTabla() {
            // Remover clase de todas las filas
            const todasLasFilas = document.querySelectorAll('.fila-clickeable');
            todasLasFilas.forEach(fila => {
                fila.classList.remove('fila-seleccionada', 'seleccionada', 'selected');
            });
            
            // Desmarcar todos los radio buttons
            const todosLosRadios = document.querySelectorAll('input[name="filaSeleccionada"]');
            todosLosRadios.forEach(radio => {
                radio.checked = false;
            });
            
            filaSeleccionada = null;
            datosFilaSeleccionada = null;
        }
        
        // Función principal para manejar impresión
        async function manejarImpresion() {
            
            // *** DEBUG CRÍTICO: VERIFICAR ESTADO DE SELECCIÓN ***
            
            if (datosFilaSeleccionada) {
            }
            
            if (filaSeleccionada) {
            }
            
            try {
                if (datosFilaSeleccionada) {
                    // Reimprimir etiqueta seleccionada
                    await reimprimirEtiqueta(datosFilaSeleccionada);
                } else {
                    // Imprimir desde formulario
                    await imprimirEtiquetaFormulario();
                }
            } catch (error) {
                console.error('❌ Error en manejo de impresión:', error);
                mostrarNotificacionImpresion('Error de impresión: ' + error.message, 'error');
            }
        }
        
        // Función para reimprimir etiqueta desde datos de tabla
        async function reimprimirEtiqueta(datos) {
            
            //  MAPEAR DATOS USANDO LOS NOMBRES EXACTOS DE LAS COLUMNAS SQL
            const datosEtiqueta = {
                codigo: datos.codigo_material_recibido || '',
                numeroLote: datos.numero_lote_material || '',
                numeroParte: datos.numero_parte || '',
                cantidadActual: datos.cantidad_actual || '',  //  Desde SQL
                propiedadMaterial: datos.propiedad_material || '',
                especificacionMaterial: datos.especificacion || '', //  Desde SQL
                fechaRecibo: datos.fecha_recibo || '', //  Desde SQL
                cantidadEstandarizada: datos.cantidad_estandarizada || '',
                ubicacionSalida: datos.ubicacion_salida || '',
                materialImportacionLocal: datos.material_importacion_local || ''
                // estadoDesecho: datos.estado_desecho || '' // Funcionalidad futura - deshabilitado
            };
            
            
            // Verificar datos críticos
            if (!datosEtiqueta.cantidadActual) {
                console.warn(' ADVERTENCIA: cantidad_actual de SQL está vacía');
            }
            if (!datosEtiqueta.especificacionMaterial) {
                console.warn(' ADVERTENCIA: especificacion de SQL está vacía');
            }
            if (!datosEtiqueta.fechaRecibo) {
                console.warn(' ADVERTENCIA: fecha_recibo de SQL está vacía');
            }
            
            // Usar la función de impresión con datos específicos
            await imprimirZebraAutomaticoConDatos(datosEtiqueta);
            
            // Etiqueta reimpresa con datos de SQL
        }
        
        // Función para imprimir desde formulario
        async function imprimirEtiquetaFormulario() {
            
            const codigo = document.getElementById('codigo_material_recibido')?.value;
            if (!codigo || codigo.trim() === '') {
                throw new Error('No hay código de material para imprimir');
            }
            
            
            // Usar la función de impresión automática existente
            await imprimirZebraAutomatico(codigo);
            
            // Etiqueta impresa correctamente
        }

        
        // Función para aplicar reglas de escaneo desde rules.json
        async function aplicarReglasEscaneo(texto) {
            try {
                
                // Obtener las reglas del servidor
                const response = await fetch('/obtener_reglas_escaneo');
                if (!response.ok) {
                    console.warn('No se pudieron obtener las reglas de escaneo');
                    return null;
                }
                
                const reglas = await response.json();
                
                // Probar cada regla hasta encontrar una que coincida
                for (const [proveedor, regla] of Object.entries(reglas)) {
                    
                    const resultado = aplicarRegla(texto, regla);
                    if (resultado) {
                        
                        return {
                            supplier: proveedor,
                            partNumber: resultado.partNumber,
                            lotNumber: resultado.lotNumber
                        };
                    } else {
                    }
                }
                
                return null;
                
            } catch (error) {
                console.error('Error al aplicar reglas de escaneo:', error);
                return null;
            }
        }
        
        // Función para aplicar una regla específica
        function aplicarRegla(texto, regla) {
            try {
                
                // Manejar diferentes tipos de reglas según tu rules.json
                if ('sequence_pattern' in regla) {
                    return aplicarReglaSecuencias(texto, regla);
                } else if ('character_pattern' in regla) {
                    return aplicarReglaCaracteres(texto, regla);
                } else if ('pattern' in regla) {
                    return aplicarReglaRegex(texto, regla);
                } else {
                    console.warn('Tipo de regla no soportado:', regla);
                    return null;
                }
            } catch (error) {
                console.error('Error aplicando regla:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de secuencias (como ROHM)
        function aplicarReglaSecuencias(texto, regla) {
            try {
                
                const secuencias = regla.sequence_pattern;
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                const maxLongitudPart = regla.partNumberMaxLength;
                const maxLongitudLote = regla.lotNumberMaxLength;
                
                // Dividir el texto según las secuencias
                let partes = [texto];
                
                for (const secuencia of secuencias) {
                    let nuevasPartes = [];
                    
                    for (const parte of partes) {
                        if (secuencia.type === 'spaces') {
                            // Dividir por la cantidad exacta de espacios consecutivos
                            const espacios = ' '.repeat(secuencia.count);
                            const subpartes = parte.split(espacios); // Dividir por todos los separadores
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'tabs') {
                            const tabs = '\t'.repeat(secuencia.count);
                            const subpartes = parte.split(tabs);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'newlines') {
                            const newlines = '\n'.repeat(secuencia.count);
                            const subpartes = parte.split(newlines);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'custom') {
                            const custom = (secuencia.separator || '').repeat(secuencia.count);
                            const subpartes = parte.split(custom);
                            nuevasPartes.push(...subpartes);
                        } else {
                            nuevasPartes.push(parte);
                        }
                    }
                    
                    partes = nuevasPartes;
                }
                
                
                // Verificar que tengamos suficientes partes
                if (partes.length <= Math.max(indicePart, indiceLote)) {
                    return null;
                }
                
                let partNumber = (partes[indicePart] || '').trim();
                let lotNumber = (partes[indiceLote] || '').trim();
                
                // Aplicar longitudes máximas si están definidas (como en Python)
                if (maxLongitudPart && partNumber.length > maxLongitudPart) {
                    partNumber = partNumber.substring(0, maxLongitudPart);
                }
                if (maxLongitudLote && lotNumber.length > maxLongitudLote) {
                    lotNumber = lotNumber.substring(0, maxLongitudLote);
                }
                
                // *** NUEVA FUNCIONALIDAD: Extracción específica del lote ***
                if (regla.lotNumberStart !== undefined && regla.lotNumberLength !== undefined) {
                    const startPos = regla.lotNumberStart;
                    const length = regla.lotNumberLength;
                    
                    
                    if (lotNumber.length >= startPos + length) {
                        lotNumber = lotNumber.substring(startPos, startPos + length).trim();
                    } else {
                    }
                }
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaSecuencias:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de regex (como LEGACY)
        function aplicarReglaRegex(texto, regla) {
            try {
                
                const patron = new RegExp(regla.pattern);
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                
                const coincidencia = texto.match(patron);
                
                if (!coincidencia) {
                    return null;
                }
                
                
                const partNumber = coincidencia[indicePart]?.trim() || '';
                const lotNumber = coincidencia[indiceLote]?.trim() || '';
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaRegex:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de patrón de caracteres
        function aplicarReglaCaracteres(texto, regla) {
            try {
                const patronCaracteres = regla.character_pattern;
                const inicioPartNumber = regla.partNumberStart;
                const longitudPartNumber = regla.partNumberLength;
                const inicioLotNumber = regla.lotNumberStart;
                const longitudLotNumber = regla.lotNumberLength;
                
                
                // Verificar longitud mínima (igual que Python)
                const longitudMinima = Math.max(inicioPartNumber + longitudPartNumber, inicioLotNumber + longitudLotNumber);
                if (texto.length < longitudMinima) {
                    return null;
                }
                
                // VALIDACIÓN ESTRICTA DE PATRÓN (igual que Python)
                if (texto.length !== patronCaracteres.length) {
                    return null;
                }
                
                // Verificar patrón carácter por carácter (igual que Python)
                for (let i = 0; i < texto.length; i++) {
                    const charTexto = texto[i];
                    const charPatron = patronCaracteres[i];
                    
                    if (charPatron === 'X') {
                        // X = cualquier carácter
                        continue;
                    } else if (charPatron === 'N') {
                        // N = cualquier número
                        if (!/\d/.test(charTexto)) {
                            return null;
                        }
                    } else if (charPatron === 'A') {
                        // A = cualquier letra
                        if (!/[a-zA-Z]/.test(charTexto)) {
                            return null;
                        }
                        
                    } else if (charPatron === 'AN') {
                        // AN = alfanumérico
                        if (!/[a-zA-Z0-9]/.test(charTexto)) {
                            return null;
                        }
                    } else {
                        // Carácter específico debe coincidir exactamente
                        if (charTexto !== charPatron) {
                            return null;
                        }
                    }
                }
                
                
                // Extraer partNumber y lotNumber según las posiciones EXACTAS (igual que Python)
                const partNumber = texto.substring(inicioPartNumber, inicioPartNumber + longitudPartNumber).trim();
                const lotNumber = texto.substring(inicioLotNumber, inicioLotNumber + longitudLotNumber).trim();
                
                
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaCaracteres:', error);
                return null;
            }
        }

        function exportarExcel() {
            try {
                alert('Generando archivo Excel, por favor espere...');
                fetch('/exportar_excel', {
                    method: 'GET'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Error en el servidor');
                    }
                    return response.blob();
                })
                .then(function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `materiales_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    alert('Archivo Excel descargado exitosamente');
                })
                .catch(function(error) {
                    console.error('Error al exportar Excel:', error);
                    alert('Error al exportar el archivo Excel: ' + error.message);
                });
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('Error al exportar el archivo Excel');
            }
        }

        // === AUTOCOMPLETADO PARA CONTROL DE ALMACÉN ===
        // Configurar autocompletado en el campo "codigo_material_recibido"
        function configurarAutocompletadoAlmacen() {
            const codigoRecibidoInput = document.getElementById('codigo_material_recibido');
            if (codigoRecibidoInput) {
                
                // Función para buscar el código en la base de datos
                async function buscarCodigoRecibidoAlmacen() {
                    const codigo = codigoRecibidoInput.value.trim();
                    
                    if (!codigo) {
                        return;
                    }
                    
                    
                    try {
                        const url = `/buscar_codigo_recibido?codigo_material_recibido=${encodeURIComponent(codigo)}`;
                        
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.success && data.registro) {
                                
                                // Llenar campos con la información encontrada
                                if (data.registro.numero_lote_material) {
                                    document.getElementById('numero_lote_material').value = data.registro.numero_lote_material;
                                }
                                if (data.registro.codigo_material_original) {
                                    document.getElementById('codigoMaterialOriginal').value = data.registro.codigo_material_original;
                                }
                                if (data.registro.codigo_material) {
                                    document.getElementById('codigo_material_lower').value = data.registro.codigo_material;
                                }
                                if (data.registro.numero_parte) {
                                    document.getElementById('numero_parte_lower').value = data.registro.numero_parte;
                                }
                                if (data.registro.cantidad_actual) {
                                    document.getElementById('cantidad_actual').value = data.registro.cantidad_actual;
                                }
                                if (data.registro.cantidad_estandarizada) {
                                    document.getElementById('cantidad_estandarizada').value = data.registro.cantidad_estandarizada;
                                }
                                if (data.registro.propiedad_material) {
                                    document.getElementById('propiedad_material').value = data.registro.propiedad_material;
                                }
                                
                                // Resaltar campos que se llenaron automáticamente
                                const campos = ['numero_lote_material', 'codigoMaterialOriginal', 'codigo_material_lower', 
                                            'numero_parte_lower', 'cantidad_actual', 'cantidad_estandarizada', 'propiedad_material'];
                                campos.forEach(id => {
                                    const campo = document.getElementById(id);
                                    if (campo && campo.value) {
                                        campo.style.backgroundColor = '#d4edda';
                                        campo.style.borderColor = '#c3e6cb';
                                        setTimeout(() => {
                                            campo.style.backgroundColor = '';
                                            campo.style.borderColor = '';
                                        }, 3000);
                                    }
                                });
                                
                                alert('Código encontrado y campos completados automáticamente');
                            } else {
                                alert('Código de material recibido no encontrado en el almacén');
                            }
                        } else {
                            console.error(`❌ ALMACÉN: Error del servidor: ${response.status}`);
                            const errorText = await response.text();
                            console.error('Error text:', errorText);
                            alert(`Error del servidor: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('💥 ALMACÉN: Error al buscar código recibido:', error);
                        alert('Error al buscar el código en la base de datos');
                    }
                }
                
                // Evento para cuando se pierde el foco del campo (change)
                codigoRecibidoInput.addEventListener('change', function() {
                    buscarCodigoRecibidoAlmacen();
                });
                
                // Evento para cuando se presiona Enter
                codigoRecibidoInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        buscarCodigoRecibidoAlmacen();
                    }
                });
                
            } else {
                console.error('❌ ALMACÉN: Campo codigo_material_recibido NO encontrado en el DOM');
            }
        }

        // Inicializar autocompletado cuando se carga la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarAutocompletadoAlmacen);
        } else {
            configurarAutocompletadoAlmacen();
        }

        // ==================== QR SCANNER FUNCTIONALITY ====================
        let html5QrCode = null;

        // Función para abrir el escáner QR
        function abrirEscanerQR() {
            // Si ya existe un modal, lo eliminamos para recrearlo
            const existingModal = document.getElementById('modalQRScanner');
            if (existingModal) {
                existingModal.remove();
            }

            // Crear el contenido del modal
            const modalHTML = `
                <div id="modalQRScanner" style="display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                    <div style="position: relative; padding: 20px; width: 90%; max-width: 500px; background-color: #fff; border-radius: 8px; text-align: center;">
                        <button onclick="cerrarEscanerQR()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        <h3 style="margin-bottom: 20px;">Escanear Código QR</h3>
                        <p style="margin-bottom: 20px;">Tome una foto del código QR para escanearlo.</p>
                        
                        <!-- Botón estilizado que activa el input de archivo -->
                        <button onclick="document.getElementById('qr-input-file').click()" style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            📸 Tomar Foto
                        </button>
                        
                        <!-- Input de archivo oculto -->
                        <input type="file" id="qr-input-file" accept="image/*" capture="environment" style="display: none;">
                        
                        <div id="qr-status" style="margin-top: 20px; font-weight: bold;"></div>
                        <img id="qr-image-preview" style="max-width: 100%; max-height: 200px; margin-top: 15px; display: none;" />
                    </div>
                </div>
            `;

            // Añadir el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar el listener para el input de archivo
            const qrInput = document.getElementById('qr-input-file');
            qrInput.addEventListener('change', handleFileSelect);

            // Pequeño delay para la animación de entrada
            setTimeout(() => {
                const modal = document.getElementById('modalQRScanner');
                if(modal) modal.style.opacity = '1';
            }, 10);
        }

        // Función para cerrar el escáner QR
        function cerrarEscanerQR() {
            const modal = document.getElementById('modalQRScanner');
            if (modal) {
                modal.remove();
            }
        }

        // Función para manejar la selección de archivo (foto tomada)
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const statusDiv = document.getElementById('qr-status');
            const imagePreview = document.getElementById('qr-image-preview');
            
            statusDiv.textContent = 'Procesando imagen...';
            statusDiv.style.color = '#007bff';
            imagePreview.style.display = 'block';
            imagePreview.src = URL.createObjectURL(file);

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-status", { verbose: false });
            }

            try {
                const decodedText = await html5QrCode.scanFile(file, false);
                onScanSuccess(decodedText);
            } catch (err) {
                console.error('Error al escanear la imagen:', err);
                statusDiv.textContent = '❌ No se pudo detectar un código QR. Intente de nuevo.';
                statusDiv.style.color = 'red';
                imagePreview.style.display = 'none';
            }
        }

        // Función llamada cuando se escanea exitosamente
        function onScanSuccess(decodedText) {
            
            const statusDiv = document.getElementById('qr-status');
            if (statusDiv) {
                statusDiv.textContent = ' ¡Código escaneado exitosamente!';
                statusDiv.style.color = 'green';
            }
            
            // Llenar el campo de texto con el código escaneado
            const inputCodigo = document.getElementById('codigoMaterialOriginal');
            if (inputCodigo) {
                inputCodigo.value = decodedText;
                
                // Resaltar el campo
                inputCodigo.style.backgroundColor = '#d4edda';
                inputCodigo.style.borderColor = '#28a745';
            }
            
            // Procesar el código automáticamente y cerrar el modal
            setTimeout(() => {
                parsearYDistribuirCodigo(decodedText);
                cerrarEscanerQR();
                
                // Restaurar estilos del campo después de un tiempo
                if (inputCodigo) {
                    setTimeout(() => {
                        inputCodigo.style.backgroundColor = '';
                        inputCodigo.style.borderColor = '';
                    }, 3000);
                }
            }, 1000);
        }

        // Cerrar modal al hacer clic fuera de él (si se necesita)
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalQRScanner');
            if (modal && event.target === modal) {
                cerrarEscanerQR();
            }
        });
        // ==================== FIN QR SCANNER FUNCTIONALITY ====================

    </script>

    <!-- Script para QR automático después de guardar - NO MODIFICA FUNCIONES EXISTENTES -->
    <script>

        // ====== CREACIÓN DINÁMICA DE MODALES ======
        // Siguiendo el patrón documentado para evitar problemas con appendChild
        
        function createModalsAlmacen() {
            // Modal de Unidades
            if (!document.getElementById('modal-unidades')) {
                const modalUnidades = document.createElement('div');
                modalUnidades.id = 'modal-unidades';
                modalUnidades.className = 'trazabilidad-modal';
                modalUnidades.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    backdrop-filter: blur(6px);
                    justify-content: center;
                    align-items: center;
                    z-index: 15000;
                `;
                
                modalUnidades.innerHTML = `
                    <div class="trazabilidad-modal-content" style="max-width: 500px; background-color: #32323E; border: 2px solid #20688C; color: #ecf0f1;">
                        <h2 style="color: #ecf0f1; text-align: center; margin-bottom: 20px; font-family: 'LG regular', sans-serif; border-bottom: 2px solid #20688C; padding-bottom: 15px;">Especificar Cantidad de Unidades</h2>
                        <p style="color: #bdc3c7; text-align: center; margin-bottom: 25px; font-family: 'LG regular', sans-serif;">¿Cuántas unidades desea imprimir e ingresar al inventario?</p>
                        
                        <div style="margin-bottom: 25px; padding: 20px; background-color: #2D363D; border-radius: 8px; border: 1px solid #20688C;">
                            <label for="cantidad-unidades" style="color: #3498db; font-weight: bold; font-family: 'LG regular', sans-serif; display: block; margin-bottom: 10px; text-align: center;">Cantidad:</label>
                            <input type="number" id="cantidad-unidades" min="1" max="999" value="1" style="width: 100%; padding: 15px; background: #7B8181; border: 2px solid #3498db; color: #ffffff; font-family: 'LG regular', sans-serif; border-radius: 4px; text-align: center; font-size: 18px; font-weight: bold;">
                        </div>
                        
                        <div style="margin-bottom: 25px; padding: 20px; background-color: #2D363D; border-radius: 8px; border: 2px solid #5A8A5A;">
                            <label style="color: #5A8A5A; font-weight: bold; font-family: 'LG regular', sans-serif; display: block; margin-bottom: 10px; text-align: center;">Lote Interno</label>
                            <div style="display: flex; gap: 10px; align-items: center; justify-content: center;">
                                <input type="checkbox" id="asignar-lote-interno" style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="asignar-lote-interno" style="color: #ecf0f1; font-family: 'LG regular', sans-serif; cursor: pointer; margin: 0;">Generar lote interno automático (DD.MM.YYYY.XXXX)</label>
                            </div>
                            <div id="lote-interno-preview" style="margin-top: 15px; padding: 10px; background-color: #1F2937; border-radius: 4px; border: 1px solid #5A8A5A; color: #5A8A5A; text-align: center; font-family: monospace; display: none;">
                                <small>Formato: </small><span id="lote-interno-preview-text">DD.MM.YYYY.0001</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="material-btn" id="btn-cancelar-unidades" style="background: #3498db; color: white; padding: 12px 20px; border: 2px solid #20688C; border-radius: 4px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer; transition: all 0.3s;">Cancelar</button>
                            <button class="material-btn" id="btn-procesar-unidades" style="background: #3498db; color: white; padding: 12px 20px; border: 2px solid #20688C; border-radius: 4px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer; transition: all 0.3s;">Imprimir e Iniciar Asignación</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalUnidades);
            }
            
            // Modal de Asignación de Lotes
            if (!document.getElementById('modal-asignacion-lotes')) {
                const modalAsignacion = document.createElement('div');
                modalAsignacion.id = 'modal-asignacion-lotes';
                modalAsignacion.className = 'trazabilidad-modal';
                modalAsignacion.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    backdrop-filter: blur(6px);
                    justify-content: center;
                    align-items: center;
                    z-index: 15000;
                `;
                
                modalAsignacion.innerHTML = `
                    <div class="trazabilidad-modal-content" style="max-width: 900px; background-color: #32323E; border: 2px solid #20688C; color: #ecf0f1;">
                        <h2 id="titulo-modal-lotes" style="color: #ecf0f1; text-align: center; margin-bottom: 20px; font-family: 'LG regular', sans-serif; border-bottom: 2px solid #20688C; padding-bottom: 15px;">Asignación de Lotes de Proveedor</h2>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background-color: #2D363D; border-radius: 8px; border: 1px solid #20688C;">
                            <p style="color: #bdc3c7; font-family: 'LG regular', sans-serif; margin: 0;">Asigne el lote de proveedor a cada etiqueta impresa escaneando:</p>
                            <div style="text-align: right;">
                                <span style="color: #28a745; font-weight: bold; font-family: 'LG regular', sans-serif;">Asignadas: <span id="contador-asignadas">0</span></span> / 
                                <span style="color: #3498db; font-weight: bold; font-family: 'LG regular', sans-serif;">Total: <span id="contador-total">0</span></span>
                            </div>
                        </div>
                        
                        <div id="seccion-lote-interno" style="display: none; margin-bottom: 20px; padding: 15px; background-color: #27ae60; border-radius: 8px; border: 2px solid #1e8449;">
                            <p style="color: #ffffff; font-family: 'LG regular', sans-serif; margin: 0;"><strong>Lote Interno Asignado:</strong> <span id="lote-interno-display" style="font-size: 1.1em; font-weight: bold;"></span></p>
                        </div>
                        
                        <div style="background: #2D363D; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #20688C;">
                            <div id="seccion-lote-proveedor">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                    <div>
                                        <label style="color: #3498db; font-weight: bold; font-family: 'LG regular', sans-serif; display: block; margin-bottom: 8px;">1. Escanear Lote de Proveedor:</label>
                                        <input type="text" id="escaneo-lote-proveedor" placeholder="Escanee el código del proveedor..." 
                                               style="width: 100%; padding: 12px; background: #7B8181; border: 2px solid #3498db; color: #ffffff; font-family: 'LG regular', sans-serif; border-radius: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: #3498db; font-weight: bold; font-family: 'LG regular', sans-serif; display: block; margin-bottom: 8px;">2. Escanear Etiqueta Impresa:</label>
                                        <input type="text" id="escaneo-etiqueta-impresa" placeholder="Escanee la etiqueta que se imprimió..." 
                                               style="width: 100%; padding: 12px; background: #7B8181; border: 2px solid #636779; color: #ffffff; font-family: 'LG regular', sans-serif; border-radius: 4px; font-size: 12px; cursor: not-allowed;">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="seccion-solo-etiquetas" style="display: none;">
                                <div>
                                    <label style="color: #27ae60; font-weight: bold; font-family: 'LG regular', sans-serif; display: block; margin-bottom: 8px;">Escanear Etiqueta Impresa:</label>
                                    <input type="text" id="escaneo-etiqueta-impresa-solo" placeholder="Escanee la etiqueta que se imprimió..." 
                                           style="width: 100%; padding: 12px; background: #7B8181; border: 2px solid #27ae60; color: #ffffff; font-family: 'LG regular', sans-serif; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #5A7A8A; border-radius: 6px; background-color: #2D363D;">
                            <table style="width: 100%; border-collapse: collapse; font-family: 'LG regular', sans-serif;">
                                <thead style="background: #33334D; position: sticky; top: 0; border-bottom: 2px solid #20688C;">
                                    <tr>
                                        <th style="padding: 6px; border: 0.5px solid #5A7A8A; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 12px;">#</th>
                                        <th style="padding: 6px; border: 0.5px solid #5A7A8A; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 12px;">Etiqueta Impresa</th>
                                        <th style="padding: 6px; border: 0.5px solid #5A7A8A; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 12px;">Lote Proveedor</th>
                                        <th style="padding: 6px; border: 0.5px solid #5A7A8A; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 12px;">Estado</th>
                                        <th style="padding: 6px; border: 0.5px solid #5A7A8A; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 12px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-asignaciones">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="trazabilidad-buttons" style="margin-top: 25px; position: relative; display: flex; justify-content: center; align-items: center;">
                            <button class="material-btn" id="btn-finalizar-asignacion" style="background: #636779; color: white; padding: 12px 24px; border: 2px solid #5A7A8A; border-radius: 6px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: not-allowed; transition: all 0.3s; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" disabled>Finalizar Asignación</button>
                            <button class="material-btn" id="btn-continuar-sin-asignar" style="position: absolute; right: 0; background: #3498db; color: white; padding: 4px 8px; border: 1px solid #2980b9; border-radius: 3px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 10px; box-shadow: 0 1px 3px rgba(52, 152, 219, 0.4); text-transform: uppercase; letter-spacing: 0.3px;">Continuar Sin Asignar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalAsignacion);
            }
            
            // Modal de Advertencia
            if (!document.getElementById('modal-advertencia')) {
                const modalAdvertencia = document.createElement('div');
                modalAdvertencia.id = 'modal-advertencia';
                modalAdvertencia.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 16000;
                    justify-content: center;
                    align-items: center;
                `;
                
                modalAdvertencia.innerHTML = `
                    <div style="background: #2D363D; border: 2px solid #3498db; border-radius: 8px; padding: 25px; max-width: 500px; margin: 20px; box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);">
                        <h3 style="color: #3498db; font-family: 'LG regular', sans-serif; font-weight: bold; margin: 0 0 15px 0; text-align: center; font-size: 18px;">ADVERTENCIA</h3>
                        <div id="mensaje-advertencia" style="color: #ecf0f1; font-family: 'LG regular', sans-serif; margin-bottom: 20px; line-height: 1.5; text-align: center;"></div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button id="btn-cancelar-advertencia" style="background: #636779; color: white; padding: 10px 20px; border: 1px solid #5A7A8A; border-radius: 4px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer;">Cancelar</button>
                            <button id="btn-confirmar-advertencia" style="background: #3498db; color: white; padding: 10px 20px; border: 1px solid #3498db; border-radius: 4px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer;">Continuar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalAdvertencia);
            }
            
            // Modal de Proceso Completado
            if (!document.getElementById('modal-completado')) {
                const modalCompletado = document.createElement('div');
                modalCompletado.id = 'modal-completado';
                modalCompletado.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    justify-content: center;
                    align-items: center;
                `;
                
                modalCompletado.innerHTML = `
                    <div style="background: #2D363D; border: 2px solid #5A8A5A; border-radius: 8px; padding: 25px; max-width: 500px; margin: 20px; box-shadow: 0 4px 20px rgba(90, 138, 90, 0.3);">
                        <h3 style="color: #5A8A5A; font-family: 'LG regular', sans-serif; font-weight: bold; margin: 0 0 15px 0; text-align: center; font-size: 18px;">PROCESO COMPLETADO</h3>
                        <div id="mensaje-completado" style="color: #ecf0f1; font-family: 'LG regular', sans-serif; margin-bottom: 20px; line-height: 1.5; text-align: center;"></div>
                        <div style="display: flex; justify-content: center;">
                            <button id="btn-cerrar-completado" style="background: #5A8A5A; color: white; padding: 10px 20px; border: 1px solid #4a7c59; border-radius: 4px; font-family: 'LG regular', sans-serif; font-weight: bold; cursor: pointer;">OK</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalCompletado);
            }
        }
        
        // Exponer globalmente
        window.createModalsAlmacen = createModalsAlmacen;
        
        // ====== FIN CREACIÓN DINÁMICA DE MODALES ======

        
        // Función para mostrar estado de configuración de impresora al cargar
        function mostrarEstadoImpresora() {
            const config = localStorage.getItem('zebra_config');
            if (config) {
                const cfg = JSON.parse(config);
                const tipoTexto = cfg.tipo === 'simple' ? 'Simple' : 'Completa';
                const metodoTexto = cfg.metodo === 'usb' ? 'USB' : `Red ${cfg.ip}`;
                
                // Configuración activada - no hay botón que actualizar
            } else {
            }
        }
        
        // Ejecutar al cargar la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mostrarEstadoImpresora);
        } else {
            mostrarEstadoImpresora();
        }

        // ============= FUNCIÓN DE IMPRESIÓN AUTOMÁTICA DIRECTA =============
        
        /**
         * Función para imprimir directamente en Zebra sin confirmaciones
         * Se ejecuta automáticamente después de guardar un material
         */
        async function imprimirZebraAutomatico(codigo) {
            
            try {
                // 1. Verificar configuración de impresora
                const config = localStorage.getItem('zebra_config');
                // 🌐 CONFIGURACIÓN DE SERVIDORES
                // Cambiar estas URLs según donde esté hospedado el sistema
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    // Servidor principal (aplicación web) - CAMBIAR SEGÚN NECESIDAD
                    server_url: 'http://localhost:5000',        // Para desarrollo local
                    // server_url: 'https://mi-dominio.com',    // Para dominio web
                    // server_url: 'http://192.168.0.211:5000', // Para servidor específico
                    
                    // Servicio de impresión (SIEMPRE local en cada PC)
                    service_url: 'http://localhost:5003'
                };
                
                // 🔧 FUNCIONES HELPER PARA URLs
                function getServerUrl(endpoint = '') {
                    // Si el endpoint ya es absoluto, devolverlo como está
                    if (endpoint.startsWith('http://') || endpoint.startsWith('https://')) {
                        return endpoint;
                    }
                    
                    // Si es una ruta relativa, usar la URL base configurada
                    const baseUrl = configuracion.server_url.replace(/\/$/, ''); // Quitar / final si existe
                    return baseUrl + endpoint;
                }
                
                function getPrintServiceUrl(endpoint = '') {
                    const baseUrl = configuracion.service_url.replace(/\/$/, '');
                    return baseUrl + endpoint;
                }
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                } else {
                    // Guardar configuración por defecto
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL según el tipo configurado
                const comandoZPL = generarComandoZPLDirecto(codigo, configuracion.tipo);
                
                // 3. Enviando a impresora Zebra ZT230
                
                // 4. Enviar al servicio de impresión Win32
                await enviarAServicioWin32(comandoZPL, codigo, configuracion);
                
            } catch (error) {
                console.error('❌ Error en impresión automática:', error);
                // Error al imprimir
                
                // Fallback: Usar método anterior
                try {
                    await enviarPorBackendAnterior(comandoZPL, codigo, configuracion);
                } catch (fallbackError) {
                    console.error('❌ Fallback también falló:', fallbackError);
                    // Último fallback: Mostrar QR en modal
                    if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                        QRAlmacenSimple.generarQR(codigo);
                    }
                }
            }
        }
        
        /**
         * NUEVA FUNCIÓN: Impresión automática con datos específicos
         * Esta función recibe directamente los datos en lugar de leerlos del formulario
         */
        async function imprimirZebraAutomaticoConDatos(datosEtiqueta) {
            try {
                // 1. Verificar configuración de impresora
                const config = localStorage.getItem('zebra_config');
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    server_url: 'http://localhost:5000',
                    service_url: 'http://localhost:5003'
                };
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                } else {
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL usando la función que SÍ FUNCIONA
                const comandoZPL = generarComandoZPLConDatos(datosEtiqueta, configuracion.tipo);
                
                // 3. Mostrar notificación de inicio
                mostrarNotificacionImpresion('Enviando a impresora Zebra ZT230...', 'info');
                
                // 4. Enviar al servicio de impresión Win32
                await enviarAServicioWin32(comandoZPL, datosEtiqueta.codigo, configuracion);
                
            } catch (error) {
                console.error('❌ ERROR EN IMPRESIÓN CON DATOS ESPECÍFICOS:', error);
                console.error('❌ Tipo de error:', error.name);
                console.error('❌ Mensaje:', error.message);
                console.error('❌ Stack:', error.stack);
                
                mostrarNotificacionImpresion('Error al imprimir: ' + error.message, 'error');
                
                
                // **FALLBACK CONTROLADO** - Solo si es un error específico de red/servicio
                const esErrorRed = error.message.includes('fetch') || 
                                   error.message.includes('network') || 
                                   error.message.includes('Failed to fetch') ||
                                   error.message.includes('NetworkError') ||
                                   error.name === 'TypeError';
                
                const esErrorServicio = error.message.includes('5003') || 
                                       error.message.includes('localhost') ||
                                       error.message.includes('service');
                
                if (esErrorRed || esErrorServicio) {
                    
                    try {
                        // Generar ZPL usando solo los datos que tenemos
                        const codigoParaFallback = datosEtiqueta.codigo || 'CODIGO_ERROR';
                        
                        // Generar ZPL directamente sin usar servicio
                        const zplFallback = generarComandoZPLConDatos(datosEtiqueta, 'material');
                        
                        // Mostrar el ZPL en consola para que el usuario pueda copiarlo
                        
                        // Intentar usando método de formulario como último recurso
                        await imprimirZebraAutomatico(codigoParaFallback);
                        
                    } catch (fallbackError) {
                        console.error('❌ Fallback también falló:', fallbackError);
                        
                        // Último recurso: mostrar el ZPL generado
                        const zplUltimoRecurso = generarComandoZPLConDatos(datosEtiqueta, 'material');
                        
                        mostrarNotificacionImpresion('ZPL generado - Ver consola para código manual', 'info');
                        
                        // Último fallback: Mostrar QR en modal si existe
                        if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                            QRAlmacenSimple.generarQR(datosEtiqueta.codigo);
                        }
                    }
                } else {
                    // Solo mostrar el ZPL generado sin intentar impresión adicional
                    try {
                        const zplGenerado = generarComandoZPLConDatos(datosEtiqueta, 'material');
                    } catch (zplError) {
                        console.error('No se pudo generar ZPL:', zplError);
                    }
                }
            }
        }
        
        /**
         * Función para enviar al servicio Win32 de impresión
         */
        async function enviarAServicioWin32(comandoZPL, codigo, configuracion) {
            const serviceUrl = configuracion.service_url || 'http://localhost:5003';
            
            try {
                
                // Verificar si el servicio está disponible
                const statusResponse = await fetch(`${serviceUrl}/`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`Servicio no disponible (${statusResponse.status})`);
                }
                
                const statusData = await statusResponse.json();
                
                // COMPATIBILIDAD: Si el servicio no devuelve zebra_printer, verificar que esté ejecutándose
                // Tu servicio devuelve { "service": "Zebra Print Service Flask Integrado", "status": "running" }
                if (!statusData.zebra_printer && statusData.status !== 'running') {
                    throw new Error('Servicio de impresión no está funcionando correctamente');
                }
                
                // Si el servicio está ejecutándose, asumir que la impresora está disponible
                if (statusData.status === 'running') {
                } else if (!statusData.zebra_printer) {
                    throw new Error('No se detectó impresora Zebra ZT230 en el servicio');
                }
                
                // Enviar comando ZPL para impresión con el formato correcto para tu servicio
                const printResponse = await fetch(`${serviceUrl}/print`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zpl_content: comandoZPL,  // Tu servicio espera "zpl_content"
                        codigo: codigo,
                        source: 'ILSAN_MES_Control_Almacen'
                    })
                });
                
                const printResult = await printResponse.json();
                
                if (printResponse.ok && printResult.status === 'printed') {
                    // Etiqueta impresa en impresora
                    
                    // Log adicional
                    
                } else {
                    throw new Error(printResult.error || 'Error desconocido en impresión');
                }
                
            } catch (error) {
                console.error('❌ Error en servicio Win32:', error);
                
                // Verificar si es error de conexión al servicio
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('Servicio de impresión no disponible. Verifique que print_service.py esté ejecutándose.');
                } else {
                    throw error;
                }
            }
        }
        
        /**
         * Función fallback para usar el método anterior
         */
        async function enviarPorBackendAnterior(comandoZPL, codigo, configuracion) {
            
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: configuracion.metodo,
                        ip: configuracion.ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Etiqueta procesada correctamente
                } else {
                    throw new Error(result.error || 'Error en método fallback');
                }
                
            } catch (error) {
                console.error('❌ Error en método fallback:', error);
                throw error;
            }
        }
        
        /**
         * Función para obtener la cantidad actual de forma robusta
         * Intenta múltiples fuentes y siempre devuelve un valor válido
         */
        function getCantidadActual() {
            
            // 1. Intentar obtener del campo principal
            let cantidad = document.getElementById('cantidad_actual')?.value;
            
            // 2. Si está vacío, intentar cantidad_estandarizada (que viene de la BD)
            if (!cantidad || cantidad.trim() === '') {
                cantidad = document.getElementById('cantidad_estandarizada')?.value;
            }
            
            // 3. Si sigue vacío, buscar en el código seleccionado directamente
            if (!cantidad || cantidad.trim() === '') {
                const codigoSeleccionado = document.getElementById('codigoMaterialSelect')?.value;
                if (codigoSeleccionado && codigosMaterial.length > 0) {
                    const materialInfo = codigosMaterial.find(c => c.codigo === codigoSeleccionado);
                    if (materialInfo && materialInfo.cantidad_estandarizada) {
                        cantidad = materialInfo.cantidad_estandarizada;
                    }
                }
            }
            
            // 4. SOLO como último recurso usar valor por defecto
            if (!cantidad || cantidad.trim() === '') {
                console.warn(' No se encontró cantidad en ningún lado, usando valor mínimo por defecto');
                cantidad = '1';
            }
            
            return cantidad.toString().trim();
        }
        
        /**
         * NUEVA FUNCIÓN: Generar comando ZPL con datos específicos
         * Esta función recibe directamente los datos en lugar de leerlos del formulario
         */
        function generarComandoZPLConDatos(datosEtiqueta, tipo = 'material') {
            
            //  USAR FECHA DE LA TABLA si existe, sino fecha actual
            let fecha, fechaHora;
            if (datosEtiqueta.fechaRecibo) {
                // Convertir fecha de tabla (YYYY-MM-DD) a formato español (DD/MM/YYYY)
                const fechaTabla = new Date(datosEtiqueta.fechaRecibo);
                fecha = fechaTabla.toLocaleDateString('es-ES');
                fechaHora = fechaTabla.toLocaleString('es-ES');
            } else {
                // Fallback a fecha actual
                fecha = new Date().toLocaleDateString('es-ES');
                fechaHora = new Date().toLocaleString('es-ES');
            }
            
            // Usar los datos específicos pasados como parámetro
            const codigo = datosEtiqueta.codigo || '';
            const numeroLote = datosEtiqueta.numeroLote || '';
            const numeroParte = datosEtiqueta.numeroParte || '';
            
            // *** CORRECCIÓN CRÍTICA: CONVERTIR A STRING Y VALIDAR ***
            let cantidadActual = String(datosEtiqueta.cantidadActual || '');
            
            //  USAR ESPECIFICACIÓN DE LA TABLA si existe, sino propiedad
            let especificacion = String(datosEtiqueta.especificacionMaterial || datosEtiqueta.propiedadMaterial || '');
            
            // Si la cantidad está vacía, usar valor por defecto
            if (!cantidadActual || cantidadActual.trim() === '' || cantidadActual === 'undefined') {
                // Intentar obtener de la fuente original si está disponible
                if (window.datosFilaSeleccionada && window.datosFilaSeleccionada.cantidad_actual) {
                    cantidadActual = String(window.datosFilaSeleccionada.cantidad_actual);
                } else {
                    cantidadActual = '1';
                }
            }
            
            // Si la especificación está vacía, usar valor por defecto
            if (!especificacion || especificacion.trim() === '' || especificacion === 'undefined') {
                // Intentar obtener de la fuente original si está disponible
                if (window.datosFilaSeleccionada && window.datosFilaSeleccionada.especificacion) {
                    especificacion = String(window.datosFilaSeleccionada.especificacion);
                } else {
                    especificacion = 'Material';
                }
            }
            
            // === DEBUG: VERIFICAR VALORES ESPECÍFICOS ===
            
            // Verificar si los campos críticos están vacíos
            if (!cantidadActual || cantidadActual.trim() === '') {
                console.error('❌ ERROR CRÍTICO: cantidadActual está VACÍO en datos específicos');
            } else {
            }
            
            if (!especificacion || especificacion.trim() === '') {
                console.error('❌ ERROR CRÍTICO: especificación está VACÍA en datos específicos');
            } else {
            }
            
            if (!datosEtiqueta.fechaRecibo) {
                console.error('❌ ERROR CRÍTICO: fechaRecibo de SQL está VACÍA');
            } else {
            }
            
            // Crear datos para el QR con información COMPACTA para evitar "STRING TOO LONG"
            
            // *** DEBUG CRÍTICO: VERIFICAR VALORES ANTES DE CONSTRUIR ZPL ***
            
            // Verificar si alguna variable está undefined o null y forzar valores (CON CONVERSIÓN A STRING)
            if (!cantidadActual || String(cantidadActual).trim() === '' || cantidadActual === 'undefined') {
                console.error('❌ ERROR CRÍTICO: cantidadActual vacío, FORZANDO valor SQL');
                cantidadActual = String(datosEtiqueta.cantidadActual || '1');
            }
            // Validación final de datos antes de crear ZPL
            if (!cantidadActual || String(cantidadActual).trim() === '' || cantidadActual === 'undefined') {
                cantidadActual = String(datosEtiqueta.cantidadActual || '1');
            }
            if (!fecha || String(fecha).trim() === '') {
                if (datosEtiqueta.fechaRecibo) {
                    const fechaTabla = new Date(datosEtiqueta.fechaRecibo);
                    fecha = fechaTabla.toLocaleDateString('es-ES');
                } else {
                    fecha = new Date().toLocaleDateString('es-ES');
                }
            }
            if (!especificacion || String(especificacion).trim() === '') {
                especificacion = String(datosEtiqueta.especificacionMaterial || datosEtiqueta.propiedadMaterial || 'Material');
            }
            
            const datosQR = {
                c: codigo.substring(0, 15),  // Código acortado
                f: fecha.substring(0, 10),   // Fecha de tabla o actual
                l: numeroLote.substring(0, 8), // Lote acortado
                p: numeroParte.substring(0, 8), // Parte acortado
                q: cantidadActual.substring(0, 6), // Cantidad acortada
                m: especificacion.substring(0, 6), // Especificación acortada
                s: 'OK',  // Estado simplificado
                e: 'ILSAN' // Empresa acortada
            };
            
            // Convertir a JSON ultra compacto para el QR
            const textoQR = JSON.stringify(datosQR).replace(/"/g, '').replace(/:/g, '=').replace(/,/g, '|');
            
            let comandoZPL;
            
            if (tipo === 'simple') {
                // Etiqueta simple optimizada para 33.2mm x 14mm
                comandoZPL = `^XA
^PW264^LL112
^FO10,5^BQN,2,1^FDQA,${codigo}^FS
^FO55,10^ADN,12,8^FD${codigo}^FS
^FO55,32^ADN,10,7^FD${fechaHora}^FS
^FO5,54^ADN,8,6^FDMAT.REC^FS
^FO5,75^ADN,8,6^FDILSAN^FS
^XZ`;
            } else {
                // Etiqueta usando diseño actualizado por el usuario
                // Split especificación at the opening parenthesis
                const especificacionParts = especificacion.split('(');
                const especificacionLine1 = especificacionParts[0] ? especificacionParts[0].trim() : '';
                const especificacionLine2 = especificacionParts[1] ? '(' + especificacionParts[1] : '';
                
                comandoZPL = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT170,70^A0N,22,20^FH\\^CI28^FDQTY:^FS^CI27
^FT15,0^BQN,2,5
^FH\\^FDLA,${codigo}^FS
^FT170,1^A0N,32,30^FH\\^CI28^FD${codigo.split(',')[0] || codigo}^FS^CI27
^FT170,50^A0N,32,30^FH\\^CI28^FD${codigo.split(',')[1] || ''}^FS^CI27
^FT15,125^A0N,22,20^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT15,150^A0N,27,25^FH\\^CI28^FD${fecha}^FS^CI27
^FT170,100^A0N,30,28^FH\\^CI28^FD${especificacionLine1}^FS^CI27
^FT170,123^A0N,30,28^FH\\^CI28^FD${especificacionLine2}^FS^CI27
^FT210,75^A0N,28,26^FH\\^CI28^FD${cantidadActual}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            }
            
            
            // *** DEBUG FINAL: MOSTRAR FRAGMENTOS ESPECÍFICOS DEL ZPL ***
            const fragmentos = comandoZPL.split('\n');
            fragmentos.forEach((linea, index) => {
                if (linea.includes('FD') && linea.includes('FS')) {
                    if (linea.includes(cantidadActual)) {
                    }
                    if (linea.includes(fecha)) {
                    }
                    if (especificacion && linea.includes(especificacion.split('(')[0].trim())) {
                    }
                }
            });
            
            // Verificar que los datos aparezcan en el ZPL
            
            if (cantidadActual && comandoZPL.includes(cantidadActual)) {
            } else {
                const fragmentoCantidad = comandoZPL.match(/\^FD.*\^FS/g)?.find(f => f.includes(cantidadActual));
                if (fragmentoCantidad) {
                } else {
                }
            }
            
            if (especificacion && comandoZPL.includes(especificacion.split('(')[0].trim())) {
            } else {
            }
            
            if (fecha && comandoZPL.includes(fecha)) {
            } else {
            }
            
            return comandoZPL;
        }
        
        /**
         * Función para generar comando ZPL optimizado para impresión directa
         */
        function generarComandoZPLDirecto(codigo, tipo = 'material') {
            const fechaHora = new Date().toLocaleString('es-ES');
            const fecha = new Date().toLocaleDateString('es-ES');
            
            
            // Obtener información adicional del material desde los campos del formulario
            const numeroLote = document.getElementById('numero_lote_material')?.value || '';
            const numeroParte = document.getElementById('numero_parte_lower')?.value || '';
            
            // *** USAR LA NUEVA FUNCIÓN ROBUSTA PARA CANTIDAD ***
            const cantidadActual = getCantidadActual();
            
            const propiedad = document.getElementById('almacen_especificacion_material')?.value || '';
            
            // === DEBUG: VERIFICAR VALORES DE LOS CAMPOS ===
            
            // Ya no necesitamos verificar si está vacía porque getCantidadActual() garantiza un valor
            
            if (!propiedad || propiedad.trim() === '') {
                console.warn(' ADVERTENCIA: Campo almacen_especificacion_material está VACÍO');
                if (document.getElementById('almacen_especificacion_material')) {
                }
            }
            
            // Preparar variables para el ZPL
            const hora = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
            
            let zplCommand;
            
            if (tipo === 'simple') {
                // Etiqueta simple optimizada para 33.2mm x 14mm
                zplCommand = `^XA
^PW264^LL112
^FO10,2^BQN,2,1^FDQA,${codigo}^FS
^FO55,10^ADN,12,8^FD${codigo}^FS
^FO55,32^ADN,10,7^FD${fechaHora}^FS
^FO5,54^ADN,8,6^FDMAT.REC^FS
^FO5,75^ADN,8,6^FDILSAN^FS
^XZ`;
            } else {
                // Etiqueta usando diseño actualizado por el usuario
                // Split propiedad at the opening parenthesis
                const propiedadParts = propiedad.split('(');
                const propiedadLine1 = propiedadParts[0] ? propiedadParts[0].trim() : '';
                const propiedadLine2 = propiedadParts[1] ? '(' + propiedadParts[1] : '';
                
                zplCommand = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT170,70^A0N,22,20^FH\\^CI28^FDQTY:^FS^CI27
^FT15,0^BQN,2,5
^FH\\^FDLA,${codigo}^FS
^FT170,1^A0N,32,30^FH\\^CI28^FD${codigo.split(',')[0] || codigo}^FS^CI27
^FT170,50^A0N,32,30^FH\\^CI28^FD${codigo.split(',')[1] || ''}^FS^CI27
^FT15,125^A0N,22,20^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT15,150^A0N,27,25^FH\\^CI28^FD${fecha}^FS^CI27
^FT170,100^A0N,30,28^FH\\^CI28^FD${propiedadLine1}^FS^CI27
^FT170,123^A0N,30,28^FH\\^CI28^FD${propiedadLine2}^FS^CI27
^FT210,75^A0N,28,26^FH\\^CI28^FD${cantidadActual}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            }
            
            
            return zplCommand;
        }
        
        /**
         * Envío por USB (método principal para impresoras conectadas localmente)
         */
        async function enviarPorUSB(comandoZPL, codigo) {
            
            // Método principal: Usar el nuevo endpoint optimizado
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'usb'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacionImpresion('Etiqueta impresa correctamente', 'success');
                    return;
                } else {
                    throw new Error(result.error || 'Error de impresión USB');
                }
                
            } catch (error) {
                console.error('❌ Error de impresión USB:', error);
                throw new Error('Error de impresión USB: ' + error.message);
            }
        }
        
        /**
         * Envío por red (para impresoras con IP fija)
         */
        async function enviarPorRed(comandoZPL, ip, codigo) {
            
            try {
                // Usar el nuevo endpoint optimizado para red
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'red',
                        ip: ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacionImpresion('Etiqueta enviada a impresora de red', 'success');
                } else {
                    throw new Error(result.error || 'Error de comunicación con impresora');
                }
                
            } catch (error) {
                console.error('❌ Error de red:', error);
                throw new Error('Error de comunicación de red: ' + error.message);
            }
        }
        
        /**
         * Función para mostrar notificaciones de impresión (toast discreto)
         */
        function mostrarNotificacionImpresion(mensaje, tipo) {
            // Remover notificación anterior
            const notifAnterior = document.getElementById('print-notification');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            const colores = {
                info: '#4A90E2',      // Tu azul característico
                success: '#4CAF50',   // Tu verde característico  
                error: '#dc3545'      // Tu rojo característico
            };
            
            const notificacion = document.createElement('div');
            notificacion.id = 'print-notification';
            notificacion.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 9999;
                font-family: Arial, sans-serif;
                font-size: 13px;
                font-weight: 500;
                max-width: 280px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease-out;
                cursor: pointer;
                line-height: 1.3;
            `;
            
            // Sin emojis, solo texto limpio y compacto
            notificacion.textContent = mensaje;
            
            // Añadir al DOM y mostrar
            document.body.appendChild(notificacion);
            
            // Trigger animación después de añadir al DOM
            setTimeout(() => {
                notificacion.style.opacity = '1';
                notificacion.style.transform = 'translateY(0)';
            }, 10);
            
            // Click para cerrar manualmente
            notificacion.addEventListener('click', () => {
                cerrarNotificacion(notificacion);
            });
            
            // Auto-cerrar según el tipo (más rápido para no molestar)
            const duracion = tipo === 'error' ? 4000 : 2500; // Más corto
            setTimeout(() => {
                cerrarNotificacion(notificacion);
            }, duracion);
        }
        
        // Función helper para cerrar notificación
        function cerrarNotificacion(notificacion) {
            if (notificacion && notificacion.parentNode) {
                notificacion.style.opacity = '0';
                notificacion.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.remove();
                    }
                }, 300);
            }
        }
        
        /**
         * Función para verificar la impresora Zebra conectada
         */
        async function verificarImpresoraZebra() {
            const btnConfig = document.getElementById('btnConfigImpresora');
            if (btnConfig) {
                btnConfig.disabled = true;
                btnConfig.textContent = 'VERIFICANDO...';
            }
            
            try {
                
                // 1. Verificar servicio de impresión Win32
                const serviceUrl = 'http://localhost:5003';
                
                const statusResponse = await fetch(`${serviceUrl}/`, {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`Servicio no disponible (${statusResponse.status})`);
                }
                
                const statusData = await statusResponse.json();
                
                // 2. Obtener información detallada de impresoras
                let infoImpresoras = '';
                let estadoColor = '#009944'; // Verde por defecto
                let estadoTexto = 'ACTIVO';
                let estadoBorde = '#009944';
                
                if (statusData.zebra_printer) {
                    // Nuevo formato del servicio que incluye zebra_printer
                    estadoColor = '#009944';
                    estadoTexto = 'ACTIVO';
                    estadoBorde = '#009944';
                    infoImpresoras = `
**SERVICIO DE IMPRESIÓN ACTIVO:**
• Estado: running
• Servicio: Zebra Print Service Flask Integrado
• Puerto: 5003
• Nota: Impresora Zebra ZT230 asumida disponible`;
                } else if (statusData.status === 'running') {
                    // Formato antiguo - servicio funcionando pero sin info específica
                    estadoColor = '#009944';
                    estadoTexto = 'ACTIVO';
                    estadoBorde = '#009944';
                    infoImpresoras = `
**SERVICIO DE IMPRESIÓN ACTIVO:**
• Estado: ${statusData.status}
• Servicio: ${statusData.service || 'Zebra Print Service Flask Integrado'}
• Puerto: 5003
• Nota: Impresora Zebra ZT230 asumida disponible`;
                } else {
                    estadoColor = '#833C0D';
                    estadoTexto = 'INACTIVO';
                    estadoBorde = '#833C0D';
                    infoImpresoras = `
**PROBLEMA DETECTADO:**
• El servicio no está funcionando correctamente
• Estado: ${statusData.status || 'Desconocido'}`;
                }
                
                // 3. Verificar configuración local
                const config = localStorage.getItem('zebra_config');
                let configInfo = '';
                
                if (config) {
                    const cfg = JSON.parse(config);
                    const tipoTexto = cfg.tipo === 'simple' ? 'Simple' : 'Completa';
                    const metodoTexto = cfg.metodo === 'usb' ? 'USB' : `Red (${cfg.ip})`;
                    
                    configInfo = `

**CONFIGURACIÓN ACTUAL:**
• Método: ${metodoTexto}
• Tipo de etiqueta: ${tipoTexto}
• Impresión automática: Activada
• URL del servicio: ${cfg.service_url || 'http://localhost:5003'}`;
                } else {
                    configInfo = `

**CONFIGURACIÓN:**
• No hay configuración guardada
• Se usarán valores por defecto`;
                }
                
                // 4. Mostrar modal con información completa
                const modalHTML = `
                <div id="modalVerificacionImpresora" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(50, 50, 62, 0.9); 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000;
                ">
                    <div style="
                        background: #32323E; 
                        padding: 30px; 
                        border-radius: 10px; 
                        max-width: 600px; 
                        width: 90%; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                        border: 2px solid ${estadoBorde};
                    ">
                        <h3 style="
                            margin: 0 0 20px 0; 
                            color: #ecf0f1; 
                            background: ${estadoColor};
                            padding: 15px;
                            border-radius: 6px;
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            position: relative;
                        ">
                            <span style="
                                position: absolute;
                                left: 15px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                background: #ecf0f1;
                                display: inline-block;
                            "></span>
                            CONFIGURACIÓN DE IMPRESORA ZEBRA - ${estadoTexto}
                        </h3>
                        
                        <div style="
                            background: #33334D; 
                            padding: 20px; 
                            border-radius: 8px; 
                            margin-bottom: 20px;
                            border: 1px solid ${estadoBorde};
                        ">
                            <pre style="
                                margin: 0; 
                                white-space: pre-wrap; 
                                font-size: 14px; 
                                line-height: 1.6;
                                color: #ecf0f1;
                                font-family: Arial, sans-serif;
                            ">${infoImpresoras}${configInfo}</pre>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="cerrarModalVerificacion()" style="
                                padding: 12px 30px; 
                                background: #636779; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                margin-right: 10px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                            " onmouseover="this.style.background='#7B8181'" onmouseout="this.style.background='#636779'">
                                Cerrar
                            </button>
                            <button onclick="probarImpresion()" style="
                                padding: 12px 30px; 
                                background: ${estadoColor}; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                                ${estadoTexto === 'INACTIVO' ? 'opacity: 0.6; cursor: not-allowed;' : ''}
                            " ${estadoTexto === 'ACTIVO' ? `onmouseover="this.style.background='#27ae60'" onmouseout="this.style.background='${estadoColor}'"` : 'onclick="event.preventDefault(); mostrarNotificacionImpresion(\'Servicio inactivo - no se puede probar impresión\', \'error\'); return false;"'}>
                                ${estadoTexto === 'ACTIVO' ? 'Probar Impresión' : 'Servicio Inactivo'}
                            </button>
                        </div>
                    </div>
                </div>`;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Mensaje de éxito
                mostrarNotificacionImpresion('Verificación completada', 'success');
                
            } catch (error) {
                console.error('❌ Error al verificar impresora:', error);
                
                let mensajeError = 'Error desconocido';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    mensajeError = 'Servicio de impresión no disponible. Verifique que print_service.py esté ejecutándose en puerto 5003.';
                } else {
                    mensajeError = error.message;
                }
                
                // Mostrar modal de error
                const modalErrorHTML = `
                <div id="modalVerificacionImpresora" style="
                    position: fixed; 
                    top: 0; left: 0; 
                    width: 100%; height: 100%; 
                    background: rgba(50, 50, 62, 0.9); 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000;
                ">
                    <div style="
                        background: #32323E; 
                        padding: 30px; 
                        border-radius: 10px; 
                        max-width: 500px; 
                        width: 90%;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                        border: 2px solid #833C0D;
                        animation: pulse-red 2s infinite;
                    ">
                        <style>
                            @keyframes pulse-red {
                                0% { border-color: #833C0D; }
                                50% { border-color: #9C4910; }
                                100% { border-color: #833C0D; }
                            }
                        </style>
                        <h3 style="
                            margin: 0 0 20px 0; 
                            color: #ecf0f1; 
                            background: #833C0D;
                            padding: 15px;
                            border-radius: 6px;
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            position: relative;
                        ">
                            <span style="
                                position: absolute;
                                left: 15px;
                                top: 50%;
                                transform: translateY(-50%);
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                background: #ecf0f1;
                                display: inline-block;
                                animation: blink 1s infinite;
                            "></span>
                            <style>
                                @keyframes blink {
                                    0%, 50% { opacity: 1; }
                                    51%, 100% { opacity: 0.3; }
                                }
                            </style>
                            ERROR DE CONEXIÓN - SERVICIO INACTIVO
                        </h3>
                        
                        <div style="
                            background: #44324A; 
                            color: #ecf0f1; 
                            padding: 15px; 
                            border-radius: 8px; 
                            margin-bottom: 20px;
                            border: 1px solid #833C0D;
                        ">
                            <p style="margin: 0; font-size: 14px; line-height: 1.5;">${mensajeError}</p>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="cerrarModalVerificacion()" style="
                                padding: 12px 30px; 
                                background: #833C0D; 
                                color: #ecf0f1; 
                                border: none; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 16px;
                                font-family: Arial, sans-serif;
                                transition: background-color 0.3s;
                            " onmouseover="this.style.background='#9C4910'" onmouseout="this.style.background='#833C0D'">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>`;
                
                document.body.insertAdjacentHTML('beforeend', modalErrorHTML);
                
                mostrarNotificacionImpresion('Error al verificar impresora: ' + mensajeError, 'error');
                
            } finally {
                // Restaurar botón
                if (btnConfig) {
                    btnConfig.disabled = false;
                    btnConfig.textContent = 'CONF. DE IMPRESORA';
                }
            }
        }
        
        /**
         * Función para cerrar el modal de verificación
         */
        function cerrarModalVerificacion() {
            const modal = document.getElementById('modalVerificacionImpresora');
            if (modal) {
                modal.remove();
            }
        }
        
        /**
         * Función para probar impresión desde el modal
         */
        async function probarImpresion() {
            try {
                const codigoPrueba = 'TEST-' + Date.now();
                
                mostrarNotificacionImpresion('Enviando prueba de impresión...', 'info');
                
                // Usar la función de impresión automática existente
                await imprimirZebraAutomatico(codigoPrueba);
                
                mostrarNotificacionImpresion('Prueba de impresión enviada correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error en prueba de impresión:', error);
                mostrarNotificacionImpresion('Error en prueba de impresión: ' + error.message, 'error');
            }
        }
        
        // Función para configurar automáticamente la impresora si no está configurada
        function configurarImpresoraAutomatica() {
            const config = localStorage.getItem('zebra_config');
            
            if (!config) {
                
                // Configuración por defecto para ZT230 con servicio Win32
                const configDefault = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    service_url: 'http://localhost:5003',
                    use_win32_service: true
                };
                
                localStorage.setItem('zebra_config', JSON.stringify(configDefault));
                
                
                // Configuración automática completada - no hay botón que actualizar
                
                return configDefault;
            }
            
            const configActual = JSON.parse(config);
            
            // Actualizar configuración existente para incluir servicio Win32
            if (!configActual.service_url) {
                configActual.service_url = 'http://localhost:5003';
                configActual.use_win32_service = true;
                localStorage.setItem('zebra_config', JSON.stringify(configActual));
            }
            
            return configActual;
        }
        
        // Función para mostrar instrucciones de instalación del servicio
        window.mostrarInstruccionesServicio = function() {
            const instrucciones = `
🖨️ SERVICIO DE IMPRESIÓN AUTOMÁTICA ZEBRA ZT230

 INSTRUCCIONES DE INSTALACIÓN:

1️⃣ PREPARACIÓN:
   • Asegúrese de que Python 3.8+ esté instalado
   • Conecte la impresora Zebra ZT230 por USB
   • Verifique que la impresora esté configurada en Windows

2️⃣ INSTALACIÓN:
   • Navegue a la carpeta del proyecto ILSAN_MES
   • Ejecute el archivo: start_print_service.bat
   • El servicio se instalará automáticamente

3️⃣ VERIFICACIÓN:
   • Ejecute: testServicioWin32() en la consola
   • Debe mostrar la impresora ZT230 detectada
   • Se ejecutará un test de impresión automático

4️⃣ USO:
   • Una vez configurado, la impresión será automática
   • Al guardar un material se imprimirá sin confirmaciones
   • No se necesitan más configuraciones

🔧 TROUBLESHOOTING:
   • Si hay error: pip install flask pywin32
   • Verificar nombre de impresora en Panel de Control
   • Verificar que puerto 5000 esté libre

💡 VENTAJAS:
    Impresión totalmente automática
    Sin diálogos ni confirmaciones
    Detección automática de impresora
    Logs detallados para diagnóstico
    Fallback a métodos anteriores
            `;
            
            alert(instrucciones);
        };
        
        // Configurar impresora automáticamente al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            configurarImpresoraAutomatica();
            
            // Verificar servicio en background (sin bloquear)
            setTimeout(async () => {
                try {
                    const response = await fetch(configuracion.server_url + '/', { 
                        method: 'GET',
                        signal: AbortSignal.timeout(3000) // Timeout de 3 segundos
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Servicio detectado - ya no hay botón que actualizar
                    }
                } catch (error) {
                }
            }, 2000);
        });
        
        
        // ============= ZEBRA PRINTING FUNCTIONALITY =============

        
        /**
         * Función para probar etiqueta pequeña (33.2mm x 14mm)
         */
        window.testEtiquetaPequena = function(codigo = 'TEST-PEQUENA-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L2025001',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESISTOR'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                }
            });
            
            // Generar comando ZPL optimizado para etiqueta pequeña
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            return comandoZPL;
        };

        /**
         * Función para mostrar layout de etiqueta pequeña
         */
        window.mostrarLayoutPequeno = function() {
        };

        /**
         * Función para mostrar resumen de la nueva funcionalidad QR
         */
        window.mostrarResumenQR = function() {
            const resumen = `
 === NUEVA FUNCIONALIDAD: QR CON INFORMACIÓN COMPLETA ===

 ¿QUÉ SE AGREGÓ?
    QR ahora incluye TODA la información del material
    Generación automática de JSON con todos los datos
    Compatibilidad con etiquetas simples y completas
    Optimización para etiquetas pequeñas (33.2mm x 14mm)
    Funciones de prueba y diagnóstico

📱 INFORMACIÓN INCLUIDA EN EL QR:
   • Código del material (completo con consecutivo)
   • Fecha de creación
   • Número de lote
   • Número de parte
   • Cantidad actual
   • Propiedad del material
   • Estado (ACTIVO)
   • Empresa (ILSAN_ELECTRONICS)

🔧 FUNCIONES NUEVAS DISPONIBLES:
   • testQRCompleto() - Prueba con datos simulados
   • testEtiquetaPequena() - Optimizada para 33.2mm x 14mm
   • mostrarLayoutPequeno() - Visualización del diseño
   • verificarQRCompleto() - Muestra contenido del QR

📊 TIPOS DE ETIQUETA:
   🏷️ SIMPLE: QR básico + texto esencial (para etiquetas pequeñas)
   🏷️ MATERIAL: QR completo + información detallada

📏 OPTIMIZACIÓN PARA MEDIDAS REALES:
   • 33.2mm x 14mm = 264 x 112 dots a 300dpi
   • QR compacto pero con información completa
   • Fuentes escaladas para máxima legibilidad
   • Aprovechamiento total del espacio disponible

🎮 CÓMO PROBAR:
   1. testEtiquetaPequena() - Etiqueta optimizada para medidas reales
   2. mostrarLayoutPequeno() - Ver diseño de la etiqueta
   3. testImpresionReal() - Imprimir etiqueta real (¡CUIDADO!)

📱 AL ESCANEAR EL QR OBTENDRÁS:
   Un JSON con toda la información que puedes procesar automáticamente
   
💡 BENEFICIOS:
    Trazabilidad completa del material
    Información accesible sin conectividad
    Compatibilidad con sistemas externos
    Backup de información en la etiqueta física
    Optimizado para etiquetas de tamaño real
            `;
            
            alert(resumen);
        };
        
        
        // Función para generar solo el ZPL sin enviar a impresora
        window.testSoloZPL = function() {
            if (!datosFilaSeleccionada) {
                simularSeleccionFila();
            }
            
            // Mapear datos para etiqueta
            const datosEtiqueta = {
                codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                numeroParte: datosFilaSeleccionada.numero_parte || '',
                cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
            };
            
            // Generar ZPL
            const comandoZPL = generarComandoZPLConDatos(datosEtiqueta, 'material');
            
            // Verificar contenido crítico
            const verificaciones = [
                { nombre: 'Cantidad 10000', encontrado: comandoZPL.includes('10000') },
                { nombre: 'Especificación 10NF', encontrado: comandoZPL.includes('10NF') },
                { nombre: 'Fecha 22/07/2025', encontrado: comandoZPL.includes('22/07/2025') },
                { nombre: 'Código 0CC103BK5BA', encontrado: comandoZPL.includes('0CC103BK5BA') }
            ];
            
            // Mostrar resultado
            verificaciones.forEach(({ nombre, encontrado }) => {
            });
            
            const todoCorrecto = verificaciones.every(v => v.encontrado);
            
            return { comandoZPL, datosEtiqueta, verificaciones, todoCorrecto };
        };
        
        // Función para probar el flujo completo de impresión
        window.testFlujoCompleto = function() {
            // Simular datos
            const datosSimulados = simularSeleccionFila();
            
            // Analizar ZPL que se generaría
            const zplAnalizado = analizarZPLGenerado();
            
            
            return { datosSimulados, zplAnalizado, listo: true };
        };
        
        // Función para analizar exactamente qué ZPL se genera
        window.analizarZPLGenerado = function() {
            
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Mapear datos exactamente como lo hace reimprimirEtiqueta()
            const datosEtiqueta = {
                codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                numeroParte: datosFilaSeleccionada.numero_parte || '',
                cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
            };
            
            
            // Generar ZPL con la función que usa reimprimirEtiqueta()
            const zplOriginal = generarComandoZPLConDatos(datosEtiqueta, 'material');
            
            // Analizar el ZPL línea por línea
            const lineasZPL = zplOriginal.split('\n');
            
            lineasZPL.forEach((linea, index) => {
                // Buscar líneas que contienen datos críticos
                if (linea.includes('^FD') && linea.includes('^FS')) {
                    const contenido = linea.match(/\^FD([^F]*)\^FS/);
                    if (contenido) {
                        const valor = contenido[1];
                        
                        // Identificar qué tipo de dato es
                        if (valor === datosEtiqueta.cantidadActual) {
                        } else if (valor.includes(datosEtiqueta.especificacionMaterial?.split('(')[0]?.trim() || '')) {
                        } else if (valor.includes('/07/') || valor.includes('/2025')) {
                        } else if (valor === datosEtiqueta.codigo || valor.includes(',')) {
                        } else if (valor === 'QTY:') {
                        } else if (valor === 'Fecha de entrada:') {
                        } else if (valor.length > 0) {
                        }
                    }
                }
            });
            
            // Verificar datos específicos esperados
            
            const verificaciones = [
                { nombre: 'Cantidad 10000', valor: '10000', presente: zplOriginal.includes('10000') },
                { nombre: 'Fecha 22/07/2025', valor: '22/07/2025', presente: zplOriginal.includes('22/07/2025') },
                { nombre: 'Especificación 10NF', valor: '10NF', presente: zplOriginal.includes('10NF') },
                { nombre: 'Código 0CC103BK5BA', valor: '0CC103BK5BA', presente: zplOriginal.includes('0CC103BK5BA') }
            ];
            
            verificaciones.forEach(({ nombre, valor, presente }) => {
                const estado = presente ? '' : '❌';
                if (!presente) {
                }
            });
            
            // Mostrar fragmento problemático si la cantidad es 1
            if (zplOriginal.includes('^FD1^FS')) {
                const lineasProblema = lineasZPL.filter(linea => linea.includes('^FD1^FS'));
                lineasProblema.forEach(linea => {
                });
            }
            
            
            return zplOriginal;
        };
        
        // Función para diagnosticar por qué se generan 2 códigos ZPL
        window.diagnosticarZPLDuplicado = function() {
            
            // Revisar si hay fila seleccionada
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Probar SOLO la generación ZPL, sin enviar a impresora
            
            try {
                // Mapear datos como lo hace reimprimirEtiqueta()
                const datosEtiqueta = {
                    codigo: datosFilaSeleccionada.codigo_material_recibido || '',
                    numeroLote: datosFilaSeleccionada.numero_lote_material || '',
                    numeroParte: datosFilaSeleccionada.numero_parte || '',
                    cantidadActual: datosFilaSeleccionada.cantidad_actual || '',
                    propiedadMaterial: datosFilaSeleccionada.propiedad_material || '',
                    especificacionMaterial: datosFilaSeleccionada.especificacion || '',
                    fechaRecibo: datosFilaSeleccionada.fecha_recibo || '',
                };
                
                
                // Verificar campos críticos
                const camposCriticos = {
                    'Código': datosEtiqueta.codigo,
                    'Cantidad Actual': datosEtiqueta.cantidadActual,
                    'Fecha Recibo': datosEtiqueta.fechaRecibo,
                    'Especificación': datosEtiqueta.especificacionMaterial
                };
                
                Object.entries(camposCriticos).forEach(([nombre, valor]) => {
                    const estado = valor && valor.trim() !== '' ? '' : '❌';
                });
                
                // Generar ZPL solo para ver el resultado
                const zplGenerado = generarComandoZPLConDatos(datosEtiqueta, 'material');
                
                
                // Buscar campos específicos en el ZPL
                
                // Buscar cantidad en el ZPL
                const cantidadMatch = zplGenerado.match(/\^FD(\d+)\^FS.*QTY/i);
                if (cantidadMatch) {
                    if (cantidadMatch[1] !== datosEtiqueta.cantidadActual) {
                        console.error('❌ ERROR: Cantidad en ZPL no coincide con datos SQL!');
                    } else {
                    }
                } else {
                    console.error('❌ No se encontró cantidad en ZPL');
                }
                
                // Buscar especificación en el ZPL
                const especMatch = zplGenerado.match(/\^FD([^F]+)\^FS.*especif/i);
                if (especMatch) {
                } else {
                }
                
                
            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
            }
        };
        
        // Función para limpiar toda selección y probar con fila real
        window.limpiarYProbarSeleccion = function() {
            
            // Limpiar cualquier selección anterior (incluso simulada)
            limpiarSeleccionTabla();
            
            
        };
        
        // Función para verificar estado actual de selección
        window.verificarEstadoActual = function() {
            
            if (filaSeleccionada) {
            }
            
            if (datosFilaSeleccionada) {
            }
            
        };
        
        // Función para simular selección de fila con datos específicos
        window.simularSeleccionFila = function() {
            // Datos exactos de la imagen
            const datosSimulados = {
                codigo_material_recibido: '0CC103BK5BA',
                numero_lote_material: '0CC103BK5BA',
                numero_parte: '0CC103BK5BA',
                cantidad_actual: '10000',
                fecha_recibo: '2025-07-22',
                especificacion: '10NF 10% 50V X7R (SMD 1005)',
                propiedad_material: 'SMD',
                cantidad_estandarizada: '10000',
                ubicacion_salida: '',
                material_importacion_local: 'L',
                estado_desecho: 'Cu'
            };
            
            // Simular selección
            datosFilaSeleccionada = datosSimulados;
            
            // Crear elemento fila simulado
            const filaSimulada = document.createElement('tr');
            filaSimulada.className = 'fila-clickeable fila-seleccionada';
            filaSimulada.innerHTML = '<td>Fila simulada para prueba</td>';
            filaSeleccionada = filaSimulada;
            
            
            return datosSimulados;
        };
        
        // Función para comparar selección real vs simulada
        window.compararSelecciones = function() {
            
            if (datosFilaSeleccionada) {
                
                // Verificar si los valores críticos están presentes
                const datosCriticos = {
                    codigo: datosFilaSeleccionada.codigo_material_recibido,
                    cantidad: datosFilaSeleccionada.cantidad_actual,
                    fecha: datosFilaSeleccionada.fecha_recibo,
                    especificacion: datosFilaSeleccionada.especificacion
                };
                
                Object.entries(datosCriticos).forEach(([campo, valor]) => {
                    const estado = valor ? '' : '❌';
                    const tipo = typeof valor;
                    const longitud = valor ? valor.length : 0;
                });
                
                // Comparar con datos esperados de la imagen
                const datosEsperados = {
                    codigo_material_recibido: '0CC103BK5BA',
                    cantidad_actual: '10000',
                    fecha_recibo: '2025-07-22',
                    especificacion: '10NF 10% 50V X7R (SMD 1005)'
                };
                
                Object.entries(datosEsperados).forEach(([campo, esperado]) => {
                    const actual = datosFilaSeleccionada[campo];
                    const coincide = actual === esperado;
                    const estado = coincide ? '' : '❌';
                });
                
            } else {
            }
            
        };
        
        // Nueva función para probar con datos específicos que vemos en la imagen
        window.testConDatosEspecificos = function() {
            
            // Datos exactos de la imagen del usuario
            const datosImagen = {
                codigo_material_recibido: '0CC103BK5BA',
                numero_lote_material: '0CC103BK5BA',
                numero_parte: '0CC103BK5BA',
                cantidad_actual: '10000',  //  Cantidad de la imagen
                fecha_recibo: '2025-07-22', //  Fecha de la imagen
                especificacion: '10NF 10% 50V X7R (SMD 1005)', //  Especificación de la imagen
                propiedad_material: 'SMD',
                cantidad_estandarizada: '10000',
                ubicacion_salida: '',
                material_importacion_local: 'L',
                estado_desecho: 'Cu'
            };
            
            
            
            // Probar directamente la función de reimpresión
            reimprimirEtiqueta(datosImagen)
                .then(() => {
                })
                .catch(error => {
                    console.error('❌ Error en test con datos específicos:', error);
                });
        };
        
        // === FUNCIONES DE TESTING SIMPLIFICADAS ===
        window.testSeleccionTabla = function() {
            
            if (datosFilaSeleccionada) {
            }
            
        };
        
        window.mostrarEstadoSeleccion = function() {
            
            if (!filaSeleccionada) {
                return;
            }
            
            
            if (datosFilaSeleccionada) {
                
            }
        };
        
        // Nueva función para probar reimpresión directamente
        window.testReimpresion = function() {
            if (!datosFilaSeleccionada) {
                return;
            }
            
            
            // Verificar datos críticos antes de reimpresión
            
            // Verificar si los datos están completos
            const datos = {
                cantidad: datosFilaSeleccionada.cantidad_actual || 'VACÍO',
                fecha: datosFilaSeleccionada.fecha_recibo || 'VACÍO',
                especificacion: datosFilaSeleccionada.especificacion || 'VACÍO',
                codigo: datosFilaSeleccionada.codigo_material_recibido || 'VACÍO'
            };
            
            Object.entries(datos).forEach(([key, value]) => {
                const status = value === 'VACÍO' ? '❌' : '';
            });
            
            // Probar la función de reimpresión
            reimprimirEtiqueta(datosFilaSeleccionada)
                .then(() => {
                })
                .catch(error => {
                    console.error('❌ Error en test de reimpresión:', error);
                });
        };
        
        /**
         * Función para probar etiqueta con fuentes GRANDES (solucionando texto pequeño)
         */
        window.testFuentesGrandes = function(codigo = 'TEST-GRANDE-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                } else {
                }
            });
            
            // Generar comando ZPL con fuentes GRANDES
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            // Extraer y mostrar información del QR
            const qrMatch = comandoZPL.match(/\^FDQA,(.+?)\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
            }
            
            // Verificar comandos específicos
            if (comandoZPL.includes('^XFR:si.ZPL^FS')) {
            }
            
            if (comandoZPL.includes('^PQ1,0,1')) {
            }
            
            
            return comandoZPL;
        };

        /**
         * Función para mostrar comparación antes/después de la optimización
         */
        window.mostrarComparacionOptimizacion = function() {
        };
        
        /**
         * Función para probar PLANTILLA PROFESIONAL del usuario
         */
        window.testPlantillaProfesional = function(codigo = 'TEST-PROF-' + Date.now()) {
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                } else {
                }
            });
            
            // Generar comando ZPL con plantilla profesional
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            
            
            // Extraer y mostrar información del QR
            const qrMatch = comandoZPL.match(/\\^FDLA,(.+?)\\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
            }
            
            
            return comandoZPL;
        };
        
        /**
         * Función para probar la nueva función getCantidadActual()
         */
        window.testGetCantidadActual = function(cantidadPrueba = '2500') {
            
            // 1. Limpiar todos los campos posibles
            const camposPosibles = [
                'cantidad_actual',
                'cantidad_estandarizada', 
                'cantidad',
                'qty',
                'quantity',
                'cantidad_material'
            ];
            
            camposPosibles.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = '';
                }
            });
            
            // 2. Probar sin ningún valor
            let cantidad = getCantidadActual();
            
            // 3. Llenar cantidad_actual y probar
            const campoCantidad = document.getElementById('cantidad_actual');
            if (campoCantidad) {
                campoCantidad.value = cantidadPrueba;
                cantidad = getCantidadActual();
            } else {
            }
            
            // 4. Probar fallback a cantidad_estandarizada
            if (campoCantidad) campoCantidad.value = '';
            const campoEstandarizada = document.getElementById('cantidad_estandarizada');
            if (campoEstandarizada) {
                campoEstandarizada.value = '999';
                cantidad = getCantidadActual();
            } else {
            }
            
            // 5. Generar ZPL de prueba con la nueva función
            if (campoCantidad) campoCantidad.value = cantidadPrueba;
            const codigoPrueba = 'TEST-GET-CANTIDAD-' + Date.now().toString().slice(-4);
            const zpl = generarComandoZPLDirecto(codigoPrueba, 'material');
            
            const contieneQuantidad = zpl.includes(`^FD${cantidadPrueba}^FS`);
            
            
            return {
                funcionTrabaja: true,
                cantidadObtenida: cantidad,
                zplContieneCantidad: contieneQuantidad
            };
        };
        
        /**
         * Función para verificar el estado actual de los campos de cantidad
         */
        window.verificarCamposCantidad = function() {
            
            const campos = [
                'cantidad_actual',
                'cantidad_estandarizada',
                'cantidad',
                'qty', 
                'quantity',
                'cantidad_material'
            ];
            
            let camposEncontrados = [];
            let camposConValor = [];
            
            campos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    camposEncontrados.push(id);
                    const valor = elemento.value || '';
                    if (valor.trim() !== '') {
                        camposConValor.push({ id, valor });
                    } else {
                    }
                } else {
                }
            });
            
            
            // Probar la función actual
            const cantidadActual = getCantidadActual();
            
            return {
                camposEncontrados,
                camposConValor,
                cantidadActual
            };
        };
        
        /**
         * Función para verificar cantidad en BD directamente
         */
        window.verificarCantidadBD = function(codigoMaterial = '0RH5602C622') {
            
            if (codigosMaterial.length === 0) {
                return;
            }
            
            const materialInfo = codigosMaterial.find(c => c.codigo === codigoMaterial);
            
            if (materialInfo) {
                
                // Probar getCantidadActual con este código seleccionado
                const select = document.getElementById('codigoMaterialSelect');
                if (select) {
                    select.value = codigoMaterial;
                    const cantidad = getCantidadActual();
                }
                
                return materialInfo;
            } else {
                codigosMaterial.forEach((material, index) => {
                });
                return null;
            }
        };
        
        
        // ========== FUNCIONES GLOBALES PARA DEBUGGING CANTIDAD ==========
        
        /**
         * Test global para getCantidadActual()
         */
        window.testCantidadActual = function() {
            
            // Mostrar estado de todos los campos relevantes
            const campos = [
                'cantidad_actual',
                'cantidad_estandarizada', 
                'codigoMaterialSelect'
            ];
            
            campos.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                } else {
                }
            });
            
            // Mostrar estado del array codigosMaterial
            if (typeof codigosMaterial !== 'undefined') {
                const codigoSeleccionado = document.getElementById('codigoMaterialSelect')?.value;
                if (codigoSeleccionado) {
                    const material = codigosMaterial.find(m => m.codigo === codigoSeleccionado);
                }
            } else {
            }
            
            // Ejecutar función y mostrar resultado
            const resultado = getCantidadActual();
            
            return resultado;
        };
        
        /**
         * Diagnóstico completo de cantidad
         */
        window.diagnosticarCantidadCompleto = function() {
            
            // 1. Verificar campos
            verificarCamposCantidad();
            
            // 2. Verificar BD
            verificarCantidadBD();
            
            // 3. Test de función
            const resultado = window.testCantidadActual();
            
            // 4. Resumen
            
            if (resultado === '1') {
                console.warn(' ATENCIÓN: Se está usando el valor por defecto');
            } else {
            }
            
            return resultado;
        };
        
        /**
         * Función para probar con datos específicos
         */
        window.probarConCantidadEspecifica = function(cantidad = '5000') {
            
            // Llenar campo cantidad_actual
            const campoActual = document.getElementById('cantidad_actual');
            if (campoActual) {
                campoActual.value = cantidad;
                
                // Resaltar visualmente
                campoActual.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    campoActual.style.backgroundColor = '';
                }, 2000);
            }
            
            // Probar la función
            const resultado = getCantidadActual();
            
            if (resultado === cantidad) {
            } else {
                console.warn(` Esperado: "${cantidad}", Obtenido: "${resultado}"`);
            }
            
            return resultado;
        };
        
        /**
         * Función para testear ZPL con cantidad específica
         */
        window.testZPLConCantidad = function(cantidad = '2500', codigo = 'TEST-CANTIDAD-' + Date.now()) {
            
            // 1. Llenar cantidad
            probarConCantidadEspecifica(cantidad);
            
            // 2. Generar ZPL
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            // 3. Verificar que la cantidad esté en el ZPL
            const contieneCantidad = comandoZPL.includes(cantidad);
            
            if (contieneCantidad) {
            } else {
                console.warn(' La cantidad NO se está insertando en el ZPL');
            }
            
            return { comandoZPL, contieneCantidad };
        };
        
        /**
         * Función para probar la función ORIGINAL que SÍ FUNCIONABA
         */
        window.testFuncionOriginalQueFunc = function(codigo = 'TEST-ORIGINAL-' + Date.now()) {
            
            // Crear datos específicos de prueba (como los que se capturan en guardarFormulario)
            const datosEspecificos = {
                codigo: codigo,
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            
            // Usar la función original que funcionaba
            const comandoZPL = generarComandoZPLConDatos(datosEspecificos, 'material');
            
            
            
            return comandoZPL;
        };
        
        /**
         * Función para probar impresión con datos específicos
         */
        window.testImprimirConDatosEspecificos = function() {
            
            const datosEtiqueta = {
                codigo: 'TEST-DATOS-ESPECIFICOS-' + Date.now(),
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            
            try {
                // Usar la función de impresión que usa generarComandoZPLConDatos()
                imprimirZebraAutomaticoConDatos(datosEtiqueta);
            } catch (error) {
                console.error('❌ Error:', error);
            }
        };
        
        /**
         * Función para comparar la función original vs la actual
         */
        window.compararFunciones = function(codigo = 'TEST-COMPARE-' + Date.now()) {
            
            // Datos de prueba
            const datosEspecificos = {
                codigo: codigo,
                numeroLote: 'L202501',
                numeroParte: '56KJ 1/10W (SMD 1608)',
                cantidadActual: '5000',
                propiedadMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            const zplOriginal = generarComandoZPLConDatos(datosEspecificos, 'material');
            
            
            // Llenar campos temporalmente para la función actual
            const campoActual = document.getElementById('cantidad_actual');
            const campoEspecificacion = document.getElementById('almacen_especificacion_material');
            const campoNumero = document.getElementById('numero_parte_lower');
            
            if (campoActual) campoActual.value = '5000';
            if (campoEspecificacion) campoEspecificacion.value = '56KJ 1/10W (SMD 1608)';
            if (campoNumero) campoNumero.value = '56KJ 1/10W (SMD 1608)';
            
            const zplActual = generarComandoZPLDirecto(codigo, 'material');
            
            return { original: zplOriginal, actual: zplActual };
        };
        
        // Mostrar funciones principales disponibles

        // ========== FUNCIONES DEL NUEVO FLUJO DE UNIDADES ==========
        
        // Variables globales para el flujo de unidades
        let materialExistente = null;
        let etiquetasImpresas = [];
        let asignacionesLotes = [];
        
        // Función para detectar si el material ya existe y mostrar botón UNIDADES
        function verificarMaterialExistente(codigoEscaneado) {
            // Simular verificación en base de datos
            // En implementación real, hacer llamada AJAX
            
            // Por ahora, simular que existe si tiene cierto formato
            if (codigoEscaneado && codigoEscaneado.length > 5) {
                // Usar el número de parte como base para el código consecutivo
                const codigoOriginal = document.getElementById('numero_parte_lower')?.value || codigoEscaneado;
                
                // Obtener la especificación real del campo
                const especificacionReal = document.getElementById('almacen_especificacion_material')?.value || '';
                
                materialExistente = {
                    codigo: codigoOriginal,
                    nombre: 'Material Existente',
                    especificacion: especificacionReal || 'Material'
                };
                
                
                // Mostrar botón UNIDADES y mantener otros visibles
                document.getElementById('btnUnidades').style.display = 'inline-block';
                // Mantener botón Guardar siempre visible
                document.getElementById('btnImprimir').style.display = 'inline-block'; //  MANTENER VISIBLE
                
                // Llenar campos automáticamente
                llenarCamposAutomaticamente(materialExistente);
                
                return true;
            }
            
            // Si no existe, mostrar botones normales
            document.getElementById('btnUnidades').style.display = 'none';
            // Botón Guardar siempre visible
            document.getElementById('btnImprimir').style.display = 'inline-block';
            
            return false;
        }
        
        function llenarCamposAutomaticamente(material) {
            // Llenar campos con datos del material existente
            document.getElementById('codigo_material_recibido').value = material.codigo;
            document.getElementById('almacen_especificacion_material').value = material.especificacion;
            // Agregar más campos según sea necesario
        }
        
        function abrirModalUnidades() {
            if (!materialExistente) {
                alert('Error: No hay material seleccionado');
                return;
            }
            
            createModalsAlmacen();
            
            const modal = document.getElementById('modal-unidades');
            if (!modal) {
                return;
            }
            
            const btnCancelar = document.getElementById('btn-cancelar-unidades');
            const btnProcesar = document.getElementById('btn-procesar-unidades');
            
            if (btnCancelar) {
                btnCancelar.onclick = function() {
                    cerrarModalUnidades();
                };
            }
            
            if (btnProcesar) {
                btnProcesar.onclick = function() {
                    procesarImpresionUnidades();
                };
                // Re-habilitar el botón al abrir el modal (por si quedó deshabilitado)
                btnProcesar.disabled = false;
                btnProcesar.style.opacity = '1';
                btnProcesar.style.cursor = 'pointer';
            }
            
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0,0,0,0.6) !important;
                backdrop-filter: blur(6px) !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 15000 !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
            
            // Enfocar en el campo de cantidad
            setTimeout(() => {
                const inputCantidad = document.getElementById('cantidad-unidades');
                if (inputCantidad) {
                    inputCantidad.focus();
                }
            }, 100);
        }
        
        function cerrarModalUnidades() {
            document.getElementById('modal-unidades').style.display = 'none';
        }
        
        async function procesarImpresionUnidades() {
            const cantidad = parseInt(document.getElementById('cantidad-unidades').value);
            
            if (!cantidad || cantidad < 1 || cantidad > 999) {
                alert('Por favor ingrese una cantidad válida (1-999)');
                return;
            }
            
            // *** CRÍTICO: Deshabilitar botón para evitar clicks múltiples ***
            const btnProcesar = document.getElementById('btn-procesar-unidades');
            if (btnProcesar) {
                btnProcesar.disabled = true;
                btnProcesar.style.opacity = '0.5';
                btnProcesar.style.cursor = 'not-allowed';
            }
            
            try {
                const checkboxLoteInterno = document.getElementById('asignar-lote-interno');
                const usarLoteInterno = checkboxLoteInterno ? checkboxLoteInterno.checked : false;
                
                // *** CRÍTICO: Limpiar variables globales para evitar arrastre de estado anterior ***
                if (!usarLoteInterno) {
                    window.loteInternoGenerado = null;
                    window.loteInternoParaGuardar = null;
                }
                
                // Si se usa lote interno, obtener el primer secuencial y pre-calcular todos los lotes
                if (usarLoteInterno) {
                    if (typeof window.generarLoteInterno === 'function') {
                        mostrarIndicadorProceso('Generando lotes internos consecutivos...');
                        
                        // Obtener el primer lote para extraer el secuencial base
                        const primerLote = await window.generarLoteInterno();
                        
                        // Extraer componentes del lote (ej: "04.11.2025.0003")
                        const partesLote = primerLote.split('.');
                        const fechaBase = partesLote.slice(0, 3).join('.'); // "04.11.2025"
                        const secuencialBase = parseInt(partesLote[3]); // 3
                        
                        // Guardar para referencia
                        window.loteInternoGenerado = primerLote;
                        window.loteInternoParaGuardar = primerLote;
                        
                        ocultarIndicadorProceso();
                        
                        cerrarModalUnidades();
                        
                        etiquetasImpresas = [];
                        const codigoBase = document.getElementById('numero_parte_lower')?.value || materialExistente.codigo;
                        
                        // Crear etiquetas con lotes pre-calculados
                        for (let i = 1; i <= cantidad; i++) {
                            const codigoConsecutivo = generarCodigoConsecutivo(codigoBase, i);
                            
                            // Calcular lote consecutivo para esta etiqueta
                            const secuencial = String(secuencialBase + (i - 1)).padStart(4, '0');
                            const loteInterno = `${fechaBase}.${secuencial}`;
                            
                            etiquetasImpresas.push({
                                numero: i,
                                codigo: codigoConsecutivo,
                                loteProveedor: null,
                                loteInterno: loteInterno, // Lote pre-calculado
                                asignado: false,
                                usandoLoteInterno: usarLoteInterno
                            });
                        }
                        
                        abrirModalAsignacionLotes();
                        imprimirEnSegundoPlano(cantidad);
                    } else {
                        alert('Error: No se pudo generar el lote interno');
                        return;
                    }
                } else {
                    // Sin lote interno: crear etiquetas normales y abrir modal de asignación de lotes de proveedor
                    cerrarModalUnidades();
                    
                    etiquetasImpresas = [];
                    const codigoBase = document.getElementById('numero_parte_lower')?.value || materialExistente.codigo;
                    
                    for (let i = 1; i <= cantidad; i++) {
                        const codigoConsecutivo = generarCodigoConsecutivo(codigoBase, i);
                        etiquetasImpresas.push({
                            numero: i,
                            codigo: codigoConsecutivo,
                            loteProveedor: null,
                            asignado: false,
                            usandoLoteInterno: false
                        });
                    }
                    
                    // Abrir modal de asignación de lotes de proveedor
                    abrirModalAsignacionLotes();
                    imprimirEnSegundoPlano(cantidad);
                }
                
            } catch (error) {
                console.error('Error en impresión:', error);
                alert('Error al imprimir etiquetas: ' + error.message);
                ocultarIndicadorProceso();
                
                // Re-habilitar botón en caso de error
                const btnProcesar = document.getElementById('btn-procesar-unidades');
                if (btnProcesar) {
                    btnProcesar.disabled = false;
                    btnProcesar.style.opacity = '1';
                    btnProcesar.style.cursor = 'pointer';
                }
            }
        }
        
        //  NUEVA FUNCIÓN: Imprimir en segundo plano
        async function imprimirEnSegundoPlano(cantidad) {
            
            for (let i = 0; i < etiquetasImpresas.length; i++) {
                const etiqueta = etiquetasImpresas[i];
                
                try {
                    
                    // Imprimir etiqueta individual (sin esperar a que termine)
                    imprimirEtiquetaIndividual(etiqueta.codigo, i + 1, cantidad)
                        .catch(error => {
                            console.error(`❌ Error imprimiendo etiqueta ${i + 1}:`, error);
                            // Continuar con las siguientes etiquetas aunque una falle
                        });
                    
                    // Pequeño delay entre impresiones para no saturar
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`❌ Error en etiqueta ${i + 1}:`, error);
                    // Continuar con las siguientes
                }
            }
            
            ocultarIndicadorProceso();
        }
        
        function generarCodigoConsecutivo(codigoBase, numero) {
            //  MEJORADO: Extraer el secuencial del código que ya existe en el formulario
            const campoCodigoRecibido = document.getElementById('codigo_material_recibido');
            let secuencialBase = contadorSecuencial; // Fallback al contador global
            
            if (campoCodigoRecibido && campoCodigoRecibido.value.trim()) {
                // Extraer el secuencial del código existente (formato: codigoBase,fechaYsecuencial)
                const codigoExistente = campoCodigoRecibido.value.trim();
                const partes = codigoExistente.split(',');
                
                if (partes.length >= 2) {
                    // Extraer los últimos 4 dígitos como secuencial
                    const fechaYSecuencial = partes[1];
                    if (fechaYSecuencial.length >= 4) {
                        const secuencialExtraido = parseInt(fechaYSecuencial.slice(-4));
                        if (!isNaN(secuencialExtraido)) {
                            secuencialBase = secuencialExtraido;
                        }
                    }
                }
            }
            
            // Usar el formato correcto con coma, como en el backend
            const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const secuencial = (secuencialBase + numero - 1).toString().padStart(4, '0');
            const codigoGenerado = `${codigoBase},${fechaActual}${secuencial}`;
            
            return codigoGenerado;
        }
        
        async function imprimirEtiquetaIndividual(codigo, numero, total) {
            
            try {
                // Imprimir usando la función existente de Zebra
                await imprimirZebraAutomatico(codigo);
                
                // Pequeño delay entre impresiones para evitar saturar la impresora
                await new Promise(resolve => setTimeout(resolve, 1000));
                
            } catch (error) {
                console.error(`Error imprimiendo etiqueta ${numero}:`, error);
                // Continuar con las siguientes etiquetas aunque una falle
                throw new Error(`Error en etiqueta ${numero}: ${error.message}`);
            }
        }
        
        // Nueva función: Imprimir y guardar directamente sin modal de asignación
        async function imprimirYGuardarDirecto(cantidad) {
            try {
                mostrarIndicadorProceso('Imprimiendo etiquetas...');
                
                // Imprimir todas las etiquetas
                for (let i = 0; i < etiquetasImpresas.length; i++) {
                    const etiqueta = etiquetasImpresas[i];
                    
                    try {
                        await imprimirEtiquetaIndividual(etiqueta.codigo, i + 1, cantidad);
                    } catch (error) {
                        console.error(`Error imprimiendo etiqueta ${i + 1}:`, error);
                        // Continuar con las siguientes etiquetas
                    }
                }
                
                // Después de imprimir, guardar en inventario
                mostrarIndicadorProceso('Guardando en inventario...');
                
                let exitosas = 0;
                let fallidas = 0;
                
                for (const item of etiquetasImpresas) {
                    try {
                        await guardarEntradaInventarioDirecto(item);
                        exitosas++;
                    } catch (error) {
                        console.error('Error guardando entrada:', error);
                        fallidas++;
                    }
                }
                
                ocultarIndicadorProceso();
                
                // Mostrar resultado
                const mensaje = `<strong>Etiquetas procesadas:</strong> ${cantidad}<br>` +
                              `<strong>Guardadas exitosamente:</strong> ${exitosas}<br>` +
                              (fallidas > 0 ? `<strong>Con errores:</strong> ${fallidas}<br><br>` : '<br>') +
                              `<span style="color: #5A8A5A; font-weight: bold;">Las etiquetas han sido impresas y registradas en el inventario.</span>`;
                
                mostrarModalCompletado(mensaje);
                
            } catch (error) {
                console.error('Error en proceso de impresión y guardado:', error);
                alert('Error al procesar: ' + error.message);
                ocultarIndicadorProceso();
            }
        }
        
        // Función auxiliar para guardar entrada sin lote de proveedor
        async function guardarEntradaInventarioDirecto(item) {
            try {
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: materialExistente.codigo,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: '', // Sin lote de proveedor en modo manual
                    codigo_material_recibido: item.codigo,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value
                };
                
                const response = await fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al guardar');
                }
                
            } catch (error) {
                console.error('Error en guardarEntradaInventarioDirecto:', error);
                throw error;
            }
        }
        
        function abrirModalAsignacionLotes() {
            // *** CRÍTICO: Crear modales si no existen ***
            createModalsAlmacen();
            
            // *** NUEVO: Detectar si se usa lote interno ***
            const usandoLoteInterno = window.loteInternoParaGuardar !== null && window.loteInternoParaGuardar !== undefined;
            
            // Inicializar tabla de asignaciones
            asignacionesLotes = [...etiquetasImpresas];
            
            // Actualizar contadores
            document.getElementById('contador-total').textContent = etiquetasImpresas.length;
            document.getElementById('contador-asignadas').textContent = '0';
            
            // *** NUEVO: Mostrar/ocultar secciones según lote interno ***
            const seccionLoteProveedor = document.getElementById('seccion-lote-proveedor');
            const seccionLoteInterno = document.getElementById('seccion-lote-interno');
            const seccionSoloEtiquetas = document.getElementById('seccion-solo-etiquetas');
            const tituloModal = document.getElementById('titulo-modal-lotes');
            
            if (usandoLoteInterno) {
                // Si se usa lote interno, ocultar campo de lote proveedor
                if (seccionLoteProveedor) seccionLoteProveedor.style.display = 'none';
                if (seccionSoloEtiquetas) seccionSoloEtiquetas.style.display = 'block';
                if (seccionLoteInterno) seccionLoteInterno.style.display = 'block';
                tituloModal.textContent = 'Escanear Etiquetas Impresas';
                
                // Mostrar el lote interno asignado
                document.getElementById('lote-interno-display').textContent = window.loteInternoParaGuardar;
                
                // Usar el campo combinado
                document.getElementById('escaneo-etiqueta-impresa-solo').value = '';
                document.getElementById('escaneo-etiqueta-impresa-solo').focus();
            } else {
                // Si NO se usa lote interno, mostrar campo de lote proveedor
                if (seccionLoteProveedor) seccionLoteProveedor.style.display = 'block';
                if (seccionSoloEtiquetas) seccionSoloEtiquetas.style.display = 'none';
                if (seccionLoteInterno) seccionLoteInterno.style.display = 'none';
                tituloModal.textContent = 'Asignación de Lotes de Proveedor';
                
                // Limpiar y preparar campos de escaneo normales
                document.getElementById('escaneo-lote-proveedor').value = '';
                document.getElementById('escaneo-etiqueta-impresa').value = '';
                document.getElementById('escaneo-lote-proveedor').focus();
            }
            
            // Restaurar colores iniciales
            const campoLote = document.getElementById('escaneo-lote-proveedor');
            const campoEtiqueta = document.getElementById('escaneo-etiqueta-impresa');
            if (campoLote) {
                campoLote.style.background = '#7B8181';
                campoLote.style.cursor = 'text';
                campoLote.readOnly = false;
            }
            if (campoEtiqueta) {
                campoEtiqueta.style.background = '#7B8181';
                campoEtiqueta.readOnly = false;
            }
            
            actualizarTablaAsignaciones();
            
            const modal = document.getElementById('modal-asignacion-lotes');
            if (!modal) {
                return;
            }
            
            const btnFinalizar = document.getElementById('btn-finalizar-asignacion');
            const btnContinuar = document.getElementById('btn-continuar-sin-asignar');
            
            const inputLoteProveedor = document.getElementById('escaneo-lote-proveedor');
            const inputEtiquetaImpresa = document.getElementById('escaneo-etiqueta-impresa');
            const inputEtiquetaSolo = document.getElementById('escaneo-etiqueta-impresa-solo');
            
            if (inputLoteProveedor) {
                inputLoteProveedor.onkeydown = procesarEscaneoLoteProveedor;
                inputLoteProveedor.oninput = detectarEscaneoLoteAutomatico;
            }
            
            if (inputEtiquetaImpresa) {
                inputEtiquetaImpresa.onkeydown = procesarEscaneoEtiquetaImpresa;
                inputEtiquetaImpresa.oninput = detectarEscaneoEtiquetaAutomatico;
            }
            
            if (inputEtiquetaSolo) {
                inputEtiquetaSolo.onkeydown = procesarEscaneoEtiquetaImpresa;
                inputEtiquetaSolo.oninput = detectarEscaneoEtiquetaAutomatico;
            }
            
            if (btnFinalizar) {
                btnFinalizar.onclick = function() {
                    finalizarAsignacionLotes();
                };
            }
            
            if (btnContinuar) {
                btnContinuar.onclick = function() {
                    continuarSinAsignar();
                };
            }
            
            // Mostrar modal con estilos forzados
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0,0,0,0.6) !important;
                backdrop-filter: blur(6px) !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 15000 !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
            
            setTimeout(() => {
                if (usandoLoteInterno) {
                    const campoSolo = document.getElementById('escaneo-etiqueta-impresa-solo');
                    if (campoSolo) {
                        campoSolo.focus();
                        campoSolo.select();
                    }
                } else if (campoLote) {
                    campoLote.focus();
                    campoLote.select();
                }
            }, 300);
        }
        
        function actualizarTablaAsignaciones() {
            const tbody = document.getElementById('tabla-asignaciones');
            tbody.innerHTML = '';
            
            asignacionesLotes.forEach((item, index) => {
                const fila = document.createElement('tr');
                fila.style.backgroundColor = item.asignado ? '#5A8A5A' : '#2D363D';
                fila.style.color = '#ecf0f1';
                fila.style.fontFamily = "'LG regular', sans-serif";
                
                fila.innerHTML = `
                    <td style="padding: 6px; border: 0.5px solid #5A7A8A; text-align: center; color: #ecf0f1; font-family: 'LG regular', sans-serif; font-size: 11px;">${item.numero}</td>
                    <td style="padding: 6px; border: 0.5px solid #5A7A8A; font-family: 'LG regular', sans-serif; font-size: 10px; color: #ecf0f1;">${item.codigo}</td>
                    <td style="padding: 6px; border: 0.5px solid #5A7A8A; font-family: 'LG regular', sans-serif; font-size: 10px; color: #ecf0f1;">${item.loteInterno || item.loteProveedor || '-'}</td>
                    <td style="padding: 6px; border: 0.5px solid #5A7A8A; text-align: center;">
                        <span style="color: ${item.asignado ? '#ffffff' : '#C85A5A'}; font-weight: bold; font-family: 'LG regular', sans-serif; font-size: 10px;">
                             ${item.asignado ? 'ASIGNADO' : 'PENDIENTE'}
                         </span>
                    </td>
                    <td style="padding: 6px; border: 0.5px solid #5A7A8A; text-align: center;">
                        ${item.asignado ? 
                            `<button onclick="desasignarLote(${index})" style="background: #C85A5A; color: white; border: 1px solid #5A7A8A; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 10px; transition: all 0.3s;">Desasignar</button>` :
                            `<button onclick="enfocarAsignacion(${index})" style="background: #6A9BD1; color: white; border: 1px solid #5A7A8A; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-family: 'LG regular', sans-serif; font-weight: bold; font-size: 10px; transition: all 0.3s;">Asignar</button>`
                        }
                    </td>
                `;
                
                tbody.appendChild(fila);
            });
            
            // Actualizar contador de asignadas
            const asignadas = asignacionesLotes.filter(item => item.asignado).length;
            document.getElementById('contador-asignadas').textContent = asignadas;
            
            // Habilitar/deshabilitar botón finalizar
            const btnFinalizar = document.getElementById('btn-finalizar-asignacion');
            const todasAsignadas = asignadas === asignacionesLotes.length;
            btnFinalizar.disabled = !todasAsignadas;
            
            // Actualizar estilo del botón según su estado
            if (todasAsignadas) {
                btnFinalizar.style.background = '#5A8A5A';
                btnFinalizar.style.cursor = 'pointer';
                btnFinalizar.style.boxShadow = '0 2px 8px rgba(90, 138, 90, 0.4)';
                btnFinalizar.style.borderColor = '#4a7c59';
            } else {
                btnFinalizar.style.background = '#636779';
                btnFinalizar.style.cursor = 'not-allowed';
                btnFinalizar.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                btnFinalizar.style.borderColor = '#5A7A8A';
            }
        }
        
        // Variables de control para evitar ejecuciones múltiples
        let procesandoLote = false;
        let procesandoEtiqueta = false;
        let ultimaEtiquetaProcesada = '';
        
        // Funciones de detección automática de escaneo
        function detectarEscaneoLoteAutomatico(event) {
            // Solo funcionar en el campo específico del modal de asignación de lotes
            if (event.target.id !== 'escaneo-lote-proveedor') {
                return;
            }
            
            const valor = event.target.value.trim();
            
            // Detectar cuando el código tenga longitud típica de lote
            if (valor.length >= 25 && !procesandoLote) { // Evitar ejecuciones múltiples
                procesandoLote = true;
                setTimeout(() => {
                    // Simular Enter para procesar automáticamente
                    const enterEvent = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        which: 13,
                        bubbles: true
                    });
                    event.target.dispatchEvent(enterEvent);
                    
                    // Resetear flag después de un tiempo
                    setTimeout(() => {
                        procesandoLote = false;
                    }, 1000);
                }, 200); // Aumentado el delay para mayor estabilidad
            }
        }
        
        function detectarEscaneoEtiquetaAutomatico(event) {
            // Solo funcionar en el campo específico del modal de asignación de lotes
            if (event.target.id !== 'escaneo-etiqueta-impresa') {
                return;
            }
            
            const valor = event.target.value.trim();
            
            // Detectar cuando el código tenga longitud típica de etiqueta
            if (valor.length >= 20 && !procesandoEtiqueta && ultimaEtiquetaProcesada !== valor) { // Evitar ejecuciones múltiples
                procesandoEtiqueta = true;
                ultimaEtiquetaProcesada = valor;
                setTimeout(() => {
                    // Simular Enter para procesar automáticamente
                    const enterEvent = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        which: 13,
                        bubbles: true
                    });
                    event.target.dispatchEvent(enterEvent);
                    
                    // Resetear flag después de un tiempo
                    setTimeout(() => {
                        procesandoEtiqueta = false;
                    }, 1000);
                }, 200); // Aumentado el delay para mayor estabilidad
            }
        }
        
        function procesarEscaneoLoteProveedor(event) {
            if (event.key === 'Enter' || event.key === 'Tab') {
                event.preventDefault();
                const loteProveedor = event.target.value.trim();
                
                if (loteProveedor) {
                    // Guardar el lote para uso posterior
                    ultimoLoteEscaneado = loteProveedor;
                    // Cambiar colores para indicar progreso
                    const campoEtiqueta = document.getElementById('escaneo-etiqueta-impresa');
                    
                    
                    // Cambiar colores para indicar que el lote fue escaneado
                    event.target.style.background = '#d4edda';
                    event.target.style.border = '2px solid #28a745';
                    event.target.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                    
                    // Desbloquear y resaltar el campo de etiqueta
                    campoEtiqueta.readOnly = false;
                    campoEtiqueta.removeAttribute('readonly');
                    campoEtiqueta.removeAttribute('disabled');
                    campoEtiqueta.style.cursor = 'text';
                    campoEtiqueta.style.pointerEvents = 'auto';
                    campoEtiqueta.style.background = '#fff9e6';
                    campoEtiqueta.style.border = '3px solid #3498db';
                    campoEtiqueta.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.7)';
                    
                    
                    // Enfocar INMEDIATAMENTE el campo de etiqueta para flujo continuo
                    campoEtiqueta.focus();
                    campoEtiqueta.select(); // Seleccionar todo el contenido para sobrescribir fácilmente
                }
            }
        }
        
        // Variable global para mantener el último lote escaneado
        let ultimoLoteEscaneado = '';
        
        // Función para limpiar el lote cuando se necesite
        function limpiarLoteActual() {
            ultimoLoteEscaneado = '';
            const campoLote = document.getElementById('escaneo-lote-proveedor');
            campoLote.value = '';
            campoLote.style.background = '#7B8181';
            campoLote.style.border = '2px solid #e74c3c';
        }
        
        async function procesarEscaneoEtiquetaImpresa(event) {
            if (event.key === 'Enter' || event.key === 'Tab') {
                event.preventDefault();
                const etiquetaEscaneada = event.target.value.trim();
                
                // *** NUEVO: Detectar si se usa lote interno ***
                const usandoLoteInterno = window.loteInternoParaGuardar !== null && window.loteInternoParaGuardar !== undefined;
                const loteProveedor = usandoLoteInterno ? window.loteInternoParaGuardar : (document.getElementById('escaneo-lote-proveedor').value.trim() || ultimoLoteEscaneado);

                // Evitar procesamiento duplicado si ya se está procesando esta etiqueta
                if (procesandoEtiqueta && ultimaEtiquetaProcesada === etiquetaEscaneada) {
                    return;
                }

                // Marcar como procesando y guardar la etiqueta actual
                procesandoEtiqueta = true;
                ultimaEtiquetaProcesada = etiquetaEscaneada;

                // Buscar la etiqueta en la lista
                const indiceEtiqueta = asignacionesLotes.findIndex(item => 
                    item.codigo === etiquetaEscaneada && !item.asignado
                );
                
                if (indiceEtiqueta === -1) {
                    // Verificar si ya fue asignada (para dar un mensaje más específico)
                    const yaAsignada = asignacionesLotes.findIndex(item => 
                        item.codigo === etiquetaEscaneada && item.asignado
                    );
                    
                    if (yaAsignada !== -1) {
                        // No mostrar alerta si ya fue asignada exitosamente
                    } else {
                        alert('Etiqueta no encontrada: ' + etiquetaEscaneada);
                    }
                    
                    // Limpiar solo el campo de etiqueta para reintentar
                    event.target.value = '';
                    event.target.focus();
                    
                    // Resetear flags después de un breve delay
                    setTimeout(() => {
                        procesandoEtiqueta = false;
                        ultimaEtiquetaProcesada = '';
                    }, 500);
                    return;
                }
                
                // Asignar lote automáticamente
                asignacionesLotes[indiceEtiqueta].loteProveedor = loteProveedor;
                asignacionesLotes[indiceEtiqueta].asignado = true;
                
                // El lote interno YA está pre-calculado y asignado al inicio
                // No es necesario generar aquí
                
                // Actualizar tabla inmediatamente
                actualizarTablaAsignaciones();
                
                // Mostrar confirmación visual rápida
                
                // Cambiar color del campo de etiqueta a verde (éxito)
                event.target.style.background = '#d4edda';
                event.target.style.border = '2px solid #28a745';
                event.target.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                
                // *** NUEVO: Manejar limpiar campos según modo ***
                if (usandoLoteInterno) {
                    // Modo lote interno: solo limpiar campo de etiqueta
                    const campoEtiqueta = document.getElementById('escaneo-etiqueta-impresa-solo');
                    
                    setTimeout(() => {
                        campoEtiqueta.value = '';
                        
                        // Resetear flags de procesamiento
                        procesandoEtiqueta = false;
                        ultimaEtiquetaProcesada = '';
                        
                        // Restaurar colores iniciales
                        campoEtiqueta.style.background = '#7B8181';
                        campoEtiqueta.style.border = '2px solid #27ae60';
                        campoEtiqueta.style.boxShadow = 'none';
                        
                        // Volver a enfocar para siguiente escaneo
                        campoEtiqueta.focus();
                    }, 250);
                } else {
                    // Modo lote proveedor: limpiar ambos campos
                    const campoEtiqueta = document.getElementById('escaneo-etiqueta-impresa');
                    const campoLote = document.getElementById('escaneo-lote-proveedor');
                    
                    // Breve pausa visual para mostrar éxito (250ms)
                    setTimeout(() => {
                        campoEtiqueta.value = '';
                        campoLote.value = '';
                        
                        // Limpiar también la variable global del lote
                        ultimoLoteEscaneado = '';
                        
                        // Resetear flags de procesamiento para permitir nuevos escaneos
                        procesandoEtiqueta = false;
                        procesandoLote = false;
                        ultimaEtiquetaProcesada = '';
                        
                        // Restaurar colores iniciales del campo de etiqueta
                        campoEtiqueta.style.background = '#7B8181';
                        campoEtiqueta.style.border = '2px solid #636779';
                        campoEtiqueta.style.boxShadow = 'none';
                        
                        // Resaltar el campo de lote para nueva secuencia
                        campoLote.style.background = '#fff9e6';
                        campoLote.style.border = '3px solid #e74c3c';
                        campoLote.style.boxShadow = '0 0 15px rgba(231, 76, 60, 0.7)';
                        
                        // Flujo automático INMEDIATO: enfocar el campo de lote para nueva secuencia
                        campoLote.focus();
                        campoLote.select();
                    }, 250); // Breve pausa para feedback visual
                }
                
                // Verificar si todas las etiquetas están asignadas
                const totalAsignadas = asignacionesLotes.filter(item => item.asignado).length;
                if (totalAsignadas === asignacionesLotes.length) {
                    setTimeout(() => {
                        alert('¡Todas las etiquetas han sido asignadas! Puede finalizar el proceso.');
                    }, 500);
                }
            }
        }
        
        function enfocarAsignacion(indice) {
            // Enfocar en los campos de escaneo para asignar esta etiqueta específica
            document.getElementById('escaneo-lote-proveedor').focus();
            
            // Opcional: mostrar qué etiqueta se va a asignar
            const etiqueta = asignacionesLotes[indice];
        }
        
        function desasignarLote(indice) {
            if (confirm('¿Está seguro de desasignar este lote?')) {
                asignacionesLotes[indice].loteProveedor = null;
                asignacionesLotes[indice].asignado = false;
                actualizarTablaAsignaciones();
            }
        }
        
        function cancelarAsignacionLotes() {
            if (confirm('¿Está seguro de cancelar todo el proceso? Se perderán todas las asignaciones.')) {
                document.getElementById('modal-asignacion-lotes').style.display = 'none';
                etiquetasImpresas = [];
                asignacionesLotes = [];
                materialExistente = null;
                
                // Restaurar botones originales
                document.getElementById('btnUnidades').style.display = 'none';
                // Botón Guardar siempre visible
                document.getElementById('btnImprimir').style.display = 'inline-block';
            }
        }
        
        function continuarSinAsignar() {
            const sinAsignar = asignacionesLotes.filter(item => !item.asignado);
            
            if (sinAsignar.length > 0) {
                const mensaje = `${sinAsignar.length} etiquetas no han sido asignadas.<br><br>` +
                              `<span style="color: #e74c3c; font-weight: bold;">Las etiquetas sin asignar NO se darán de alta en el inventario.</span><br><br>` +
                              `¿Está seguro de continuar?`;
                
                mostrarModalAdvertencia(mensaje);
            } else {
                finalizarAsignacionLotes();
            }
        }
        
        // Funciones para el modal de advertencia
        function mostrarModalAdvertencia(mensaje) {
            // Asegurar que el modal existe (lo crea si no existe)
            createModalsAlmacen();
            
            document.getElementById('mensaje-advertencia').innerHTML = mensaje;
            const modal = document.getElementById('modal-advertencia');
            
            // Vincular eventos de los botones programáticamente
            const btnCancelar = document.getElementById('btn-cancelar-advertencia');
            const btnConfirmar = document.getElementById('btn-confirmar-advertencia');
            
            if (btnCancelar) {
                btnCancelar.onclick = function() {
                    cerrarModalAdvertencia();
                };
            }
            
            if (btnConfirmar) {
                btnConfirmar.onclick = function() {
                    confirmarAdvertencia();
                };
            }
            
            // Forzar estilos con !important para asegurar que aparezca encima
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0,0,0,0.7) !important;
                z-index: 16000 !important;
                justify-content: center !important;
                align-items: center !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
        }
        
        function cerrarModalAdvertencia() {
            document.getElementById('modal-advertencia').style.display = 'none';
        }
        
        function confirmarAdvertencia() {
            cerrarModalAdvertencia();
            finalizarAsignacionLotes(true);
        }
        
        // Funciones para el modal de proceso completado
        function mostrarModalCompletado(mensaje) {
            // Asegurar que el modal existe
            createModalsAlmacen();
            
            document.getElementById('mensaje-completado').innerHTML = mensaje;
            const modal = document.getElementById('modal-completado');
            
            // Vincular evento del botón programáticamente
            const btnCerrar = document.getElementById('btn-cerrar-completado');
            if (btnCerrar) {
                btnCerrar.onclick = function() {
                    cerrarModalCompletado();
                };
            }
            
            // Forzar estilos
            modal.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0,0,0,0.7) !important;
                z-index: 10000 !important;
                justify-content: center !important;
                align-items: center !important;
                opacity: 1 !important;
                visibility: visible !important;
            `;
        }
        
        function cerrarModalCompletado() {
            document.getElementById('modal-completado').style.display = 'none';
            // Cerrar modal y limpiar después de confirmar
            document.getElementById('modal-asignacion-lotes').style.display = 'none';
            limpiarFormularioCompleto();
        }
        
        // Funciones para el modal de carga
        function mostrarModalCarga() {
            const modal = document.getElementById('modal-carga');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function ocultarModalCarga() {
            const modal = document.getElementById('modal-carga');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        let procesandoFinalizacion = false;
        
        async function finalizarAsignacionLotes(permitirSinAsignar = false) {
            
            if (procesandoFinalizacion) {
                return;
            }
            
            const asignadas = asignacionesLotes.filter(item => item.asignado);
            const sinAsignar = asignacionesLotes.filter(item => !item.asignado);
            
            if (!permitirSinAsignar && sinAsignar.length > 0) {
                alert(`Faltan ${sinAsignar.length} asignaciones por completar`);
                return;
            }
            
            try {
                procesandoFinalizacion = true;
                
                const btnFinalizar = document.getElementById('btn-finalizar-asignacion');
                if (btnFinalizar) {
                    btnFinalizar.disabled = true;
                    btnFinalizar.style.opacity = '0.5';
                }
                
                mostrarIndicadorProceso('Guardando entradas en inventario...');
                
                // GUARDAR CADA ETIQUETA SECUENCIALMENTE
                // (El lote interno ya fue generado al escanear cada etiqueta)
                for (const item of asignadas) {
                    // Guardar inmediatamente
                    await guardarEntradaInventario(item);
                    
                    // Delay para asegurar que la BD se actualice
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                ocultarIndicadorProceso();
                
                const modalAsignacion = document.getElementById('modal-asignacion-lotes');
                
                if (modalAsignacion) {
                    modalAsignacion.style.display = 'none';
                }
                
                limpiarFormularioCompleto();
                
                const mensaje = `Etiquetas guardadas: ${asignadas.length}\n` +
                              (sinAsignar.length > 0 ? `Etiquetas no asignadas: ${sinAsignar.length}\n\n` : '\n') +
                              `Las etiquetas han sido registradas en el inventario correctamente.`;
                
                alert(mensaje);
                
            } catch (error) {
                console.error('Error al finalizar asignaciones:', error);
                alert('Error al guardar en inventario: ' + error.message);
                ocultarIndicadorProceso();
            } finally {
                procesandoFinalizacion = false;
            }
        }
        
        async function guardarEntradaInventario(item) {
            try {
                // Preparar datos del formulario usando el código consecutivo como código_material_recibido
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: materialExistente.codigo,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: item.loteProveedor,
                    lote_interno: item.loteInterno || null,
                    codigo_material_recibido: item.codigo,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value
                };
                
                const response = await fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Error al guardar');
                }
                
                
            } catch (error) {
                console.error('❌ Error guardando entrada:', error);
                throw error;
            }
        }
        
        function limpiarFormularioCompleto() {
            // Limpiar todas las variables globales
            materialExistente = null;
            etiquetasImpresas = [];
            asignacionesLotes = [];
            
            // Limpiar campos del formulario
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('almacen_especificacion_material').value = '';
            
            // Restaurar botones
            document.getElementById('btnUnidades').style.display = 'none';
            // Botón Guardar siempre visible
            document.getElementById('btnImprimir').style.display = 'inline-block';
            
            // Limpiar y restaurar completamente el campo de escaneo
            limpiarCampoManual();
        }
        
        function mostrarIndicadorProceso(mensaje) {
            // Crear o actualizar indicador de proceso
            let indicador = document.getElementById('indicador-proceso');
            if (!indicador) {
                indicador = document.createElement('div');
                indicador.id = 'indicador-proceso';
                indicador.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #3498db, #2980b9);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: bold;
                    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
                    z-index: 10002;
                    text-align: center;
                    animation: pulso-proceso 1.5s infinite;
                `;
                document.body.appendChild(indicador);
                
                // Agregar animación CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulso-proceso {
                        0%, 100% { transform: translate(-50%, -50%) scale(1); }
                        50% { transform: translate(-50%, -50%) scale(1.05); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            indicador.textContent = mensaje;
            indicador.style.display = 'block';
        }
        
        function ocultarIndicadorProceso() {
            const indicador = document.getElementById('indicador-proceso');
            if (indicador) {
                indicador.style.display = 'none';
            }
        }
        
        // La función procesarScaneo ya fue modificada directamente arriba
        
        // ========== FUNCIONES DE MODAL DE TRAZABILIDAD ==========
        
        function abrirModalTrazabilidad() {
            const modal = document.getElementById('trazabilidad-modal');
            
            // Obtener el texto del último código escaneado
            const textoActual = window.ultimoCodigoEscaneado || document.getElementById('codigoMaterialOriginal')?.value || '';
            
            // Llenar el área de texto con el código escaneado
            const areaTexto = document.getElementById('trazabilidad-raw-text');
            if (areaTexto) {
                areaTexto.textContent = textoActual;
                
                // Configurar selección directa de texto
                configurarSeleccionDirecta();
            }
            
            // Mostrar el modal
            modal.style.display = 'flex';
            
            // Limpiar campos
            document.getElementById('trazabilidad-supplier').value = '';
            document.getElementById('trazabilidad-part-number').value = '';
            document.getElementById('trazabilidad-lot-number').value = '';
            
        }

        function configurarSeleccionDirecta() {
            const areaTexto = document.getElementById('trazabilidad-raw-text');
            let ultimoCampoActivo = null;
            
            // Eventos para enfocar campos
            document.getElementById('trazabilidad-part-number').addEventListener('focus', function() {
                ultimoCampoActivo = this;
            });
            
            document.getElementById('trazabilidad-lot-number').addEventListener('focus', function() {
                ultimoCampoActivo = this;
            });
            
            // Evento de selección en el área de texto
            areaTexto.addEventListener('mouseup', function() {
                const seleccion = window.getSelection().toString().trim();
                if (seleccion && ultimoCampoActivo) {
                    ultimoCampoActivo.value = seleccion;
                    ultimoCampoActivo.blur(); // Quitar el foco
                    ultimoCampoActivo = null;
                    window.getSelection().removeAllRanges(); // Limpiar selección
                }
            });
        }

        function cerrarModalTrazabilidad() {
            const modal = document.getElementById('trazabilidad-modal');
            modal.style.display = 'none';
            
            // Limpiar todos los campos
            document.getElementById('trazabilidad-raw-text').textContent = '';
            document.getElementById('trazabilidad-supplier').value = '';
            document.getElementById('trazabilidad-part-number').value = '';
            document.getElementById('trazabilidad-lot-number').value = '';
        }

        // Variables globales para la selección de texto
        let textoSeleccionado = '';
        let campoActivo = '';

        async function guardarReglaTrazabilidad() {
            const proveedor = document.getElementById('trazabilidad-supplier').value.trim();
            const numeroParte = document.getElementById('trazabilidad-part-number').value.trim();
            const numeroLote = document.getElementById('trazabilidad-lot-number').value.trim();
            const textoOriginal = document.getElementById('trazabilidad-raw-text').textContent.trim();
            
            
            // Validar campos requeridos
            if (!proveedor || !numeroParte) {
                alert('Por favor completa al menos los campos de Proveedor y Número de Parte');
                return;
            }
            
            // Crear la regla
            const nuevaRegla = {
                id: Date.now().toString(),
                proveedor: proveedor,
                texto_original: textoOriginal,
                numero_parte: numeroParte,
                numero_lote: numeroLote || '',
                fecha_creacion: new Date().toISOString(),
                activa: true
            };
            
            
            try {
                // Enviar al backend para guardar en rules.json
                const response = await fetch('/guardar_regla_trazabilidad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nuevaRegla)
                });
                
                
                if (response.ok) {
                    const resultado = await response.json();
                    alert('Regla guardada exitosamente');
                    
                    // Cerrar modal
                    cerrarModalTrazabilidad();
                    
                    // Aplicar la regla inmediatamente
                    aplicarReglaInmediata(numeroParte, numeroLote);
                    
                } else {
                    const errorData = await response.json();
                    console.error('❌ Error del servidor:', errorData);
                    throw new Error(errorData.error || 'Error desconocido del servidor');
                }
                
            } catch (error) {
                console.error('❌ Error completo:', error);
                alert('Error al guardar la regla: ' + error.message);
            }
        }

        function aplicarReglaInmediata(numeroParte, numeroLote) {
            // Buscar y seleccionar el código de material
            if (numeroParte) {
                buscarYSeleccionarCodigoMaterial(numeroParte);
            }
            
            // Llenar el número de lote
            if (numeroLote) {
                const inputLote = document.getElementById('numero_lote_material');
                if (inputLote) {
                    inputLote.value = numeroLote;
                }
            }
            
            // Mostrar notificación
            mostrarNotificacionEscaneo(numeroParte, null, numeroLote);
        }

        // Cerrar modal al hacer click fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('trazabilidad-modal');
            if (event.target === modal) {
                cerrarModalTrazabilidad();
            }
        });

        // Función de importación AJAX con fetch
        function importarExcelAlmacen() {
            const fileInput = document.getElementById('importarExcelAlmacen');
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor selecciona un archivo Excel.");
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                alert("Por favor selecciona un archivo Excel válido (.xlsx o .xls)");
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            alert("Procesando archivo, por favor espere...");
            
            fetch('/importar_excel_almacen', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message + " Haga clic en 'Consultar' para ver los datos actualizados.");
                    fileInput.value = ''; // Limpiar input
                    
                    // Actualizar inventario consolidado después de importar
                    actualizarInventarioConsolidadoTrasEdicion();
                } else {
                    alert("Error al importar: " + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error al importar el archivo");
            });
        }

        // Función para abrir la edición de control de almacén
        function abrirEdicionControlAlmacen(item) {
            try {
                
                // Verificar que el sistema esté disponible
                if (!window.materialEditDrawer) {
                    window.initializeMaterialDrawer();
                    
                    // Esperar un momento para la inicialización
                    setTimeout(() => {
                        abrirEdicionControlAlmacen(item);
                    }, 200);
                    return;
                }

                // Crear drawer específico para control de almacén si no existe
                if (!document.getElementById('controlAlmacenEditDrawer')) {
                    crearDrawerControlAlmacen();
                    
                    // Esperar un momento para que se cree el HTML antes de llenar
                    setTimeout(() => {
                        llenarFormularioControlAlmacen(materialData);
                        
                        // Mostrar el drawer
                        document.getElementById('controlAlmacenEditDrawer').classList.add('open');
                        if (document.getElementById('controlAlmacenOverlay')) {
                            document.getElementById('controlAlmacenOverlay').classList.add('active');
                        }
                        
                    }, 300);
                    return;
                }

                // Mapear los datos del control de almacén (usar los nombres exactos del servidor)
                const materialData = {
                    id: item.id || '',
                    forma_material: item.forma_material || '',
                    cliente: item.cliente || '',
                    codigo_material_original: item.codigo_material_original || '',
                    codigo_material: item.codigo_material || '',
                    material_importacion_local: item.material_importacion_local || '',
                    fecha_recibo: item.fecha_recibo || '',
                    fecha_fabricacion: item.fecha_fabricacion || '',
                    cantidad_actual: item.cantidad_actual || 0,
                    numero_lote_material: item.numero_lote_material || '',
                    codigo_material_recibido: item.codigo_material_recibido || '',
                    numero_parte: item.numero_parte || '',
                    cantidad_estandarizada: item.cantidad_estandarizada || 0,
                    codigo_material_final: item.codigo_material_final || '',
                    propiedad_material: item.propiedad_material || '',
                    especificacion: item.especificacion || '',
                    material_importacion_local_final: item.material_importacion_local_final || '',
                    // estado_desecho: item.estado_desecho || '', // Funcionalidad futura - deshabilitado
                    ubicacion_salida: item.ubicacion_salida || ''
                };


                // Llenar formulario del drawer
                llenarFormularioControlAlmacen(materialData);

                // Mostrar el drawer
                document.getElementById('controlAlmacenEditDrawer').classList.add('open');
                if (document.getElementById('controlAlmacenOverlay')) {
                    document.getElementById('controlAlmacenOverlay').classList.add('active');
                }


            } catch (error) {
                console.error('Error al abrir edición:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al abrir el editor: ' + error.message
                });
            }
        }

        // Función para crear el drawer específico de control de almacén
        function crearDrawerControlAlmacen() {
            const drawerHTML = `
                <!-- Overlay -->
                <div id="controlAlmacenOverlay" class="material-edit-overlay" onclick="cerrarDrawerControlAlmacen()"></div>
                
                <!-- Drawer de Control de Almacén -->
                <div id="controlAlmacenEditDrawer" class="material-edit-drawer">
                    <div class="drawer-header">
                        <h3><i class="fas fa-warehouse me-2"></i>Editar Control de Almacén</h3>
                        <button type="button" class="btn-close-drawer" onclick="cerrarDrawerControlAlmacen()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="drawer-body">
                        <form id="editControlAlmacenForm">
                            <input type="hidden" id="editControlId" name="id">
                            
                            <!-- Información del Material -->
                            <div class="form-section">
                                <h5><i class="fas fa-info-circle me-2"></i>Información del Material</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editFormaMaterial" class="form-label">
                                                <i class="fas fa-shapes me-1"></i>Forma del Material
                                            </label>
                                            <input type="text" class="form-control" id="editFormaMaterial" name="forma_material">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCliente" class="form-label">
                                                <i class="fas fa-building me-1"></i>Cliente
                                            </label>
                                            <input type="text" class="form-control" id="editCliente" name="cliente">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCodigoMaterialOriginal" class="form-label">
                                                <i class="fas fa-barcode me-1"></i>Código Material Original
                                            </label>
                                            <input type="text" class="form-control" id="editCodigoMaterialOriginal" name="codigo_material_original">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCodigoMaterial" class="form-label">
                                                <i class="fas fa-qrcode me-1"></i>Código de Material
                                            </label>
                                            <input type="text" class="form-control" id="editCodigoMaterial" name="codigo_material">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCodigoMaterialRecibido" class="form-label">
                                                <i class="fas fa-receipt me-1"></i>Código Material Recibido
                                            </label>
                                            <input type="text" class="form-control" id="editCodigoMaterialRecibido" name="codigo_material_recibido">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCodigoMaterialFinal" class="form-label">
                                                <i class="fas fa-check-circle me-1"></i>Código Material Final
                                            </label>
                                            <input type="text" class="form-control" id="editCodigoMaterialFinal" name="codigo_material_final">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editNumeroParte" class="form-label">
                                                <i class="fas fa-hashtag me-1"></i>Número de Parte
                                            </label>
                                            <input type="text" class="form-control" id="editNumeroParte" name="numero_parte">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editPropiedadMaterial" class="form-label">
                                                <i class="fas fa-tag me-1"></i>Propiedad Material
                                            </label>
                                            <input type="text" class="form-control" id="editPropiedadMaterial" name="propiedad_material">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editMaterialImportacionLocal" class="form-label">
                                                <i class="fas fa-globe me-1"></i>Material Importación/Local
                                            </label>
                                            <input type="text" class="form-control" id="editMaterialImportacionLocal" name="material_importacion_local">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editMaterialImportacionLocalFinal" class="form-label">
                                                <i class="fas fa-flag me-1"></i>Material Importación/Local Final
                                            </label>
                                            <input type="text" class="form-control" id="editMaterialImportacionLocalFinal" name="material_importacion_local_final">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fechas y Cantidades -->
                            <div class="form-section">
                                <h5><i class="fas fa-calendar-alt me-2"></i>Fechas y Cantidades</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editFechaRecibo" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Fecha de Recibo
                                            </label>
                                            <input type="date" class="form-control" id="editFechaRecibo" name="fecha_recibo">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editFechaFabricacion" class="form-label">
                                                <i class="fas fa-industry me-1"></i>Fecha de Fabricación
                                            </label>
                                            <input type="date" class="form-control" id="editFechaFabricacion" name="fecha_fabricacion">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCantidadActual" class="form-label">
                                                <i class="fas fa-sort-numeric-up me-1"></i>Cantidad Actual
                                            </label>
                                            <input type="number" class="form-control" id="editCantidadActual" name="cantidad_actual" step="0.01">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCantidadEstandarizada" class="form-label">
                                                <i class="fas fa-balance-scale me-1"></i>Cantidad Estandarizada
                                            </label>
                                            <input type="number" class="form-control" id="editCantidadEstandarizada" name="cantidad_estandarizada" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editNumeroLoteMaterial" class="form-label">
                                        <i class="fas fa-boxes me-1"></i>Número de Lote
                                    </label>
                                    <input type="text" class="form-control" id="editNumeroLoteMaterial" name="numero_lote_material">
                                </div>
                            </div>
                            
                            <!-- Ubicación y Estado -->
                            <div class="form-section">
                                <h5><i class="fas fa-map-marker-alt me-2"></i>Ubicación y Estado</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editUbicacionSalida" class="form-label">
                                                <i class="fas fa-location-arrow me-1"></i>Ubicación de Salida
                                            </label>
                                            <input type="text" class="form-control" id="editUbicacionSalida" name="ubicacion_salida">
                                        </div>
                                    </div>
                                    <div class="col-md-6" style="display: none;">
                                        <div class="form-group">
                                            <label for="editEstadoDesecho" class="form-label">
                                                <i class="fas fa-trash-alt me-1"></i>Estado de Desecho
                                            </label>
                                            <select class="form-control" id="editEstadoDesecho" name="estado_desecho">
                                                <option value="">Seleccionar...</option>
                                                <option value="Activo">Activo</option>
                                                <option value="Desecho">Desecho</option>
                                                <option value="Reparación">Reparación</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editEspecificacion" class="form-label">
                                        <i class="fas fa-file-alt me-1"></i>Especificación
                                    </label>
                                    <textarea class="form-control" id="editEspecificacion" name="especificacion" rows="3"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="drawer-footer">
                        <button type="button" class="btn btn-secondary me-2" onclick="cerrarDrawerControlAlmacen()">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="guardarEdicionControlAlmacen()">
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            `;
            
            // Insertar HTML en el body
            document.body.insertAdjacentHTML('beforeend', drawerHTML);
        }

        // Función para llenar el formulario con los datos
        function llenarFormularioControlAlmacen(data) {
            try {
                // Verificar que los elementos existan antes de llenarlos
                const elementos = {
                    'editControlId': data.id,
                    'editFormaMaterial': data.forma_material,
                    'editCliente': data.cliente,
                    'editCodigoMaterialOriginal': data.codigo_material_original,
                    'editCodigoMaterial': data.codigo_material,
                    'editCodigoMaterialRecibido': data.codigo_material_recibido,
                    'editCodigoMaterialFinal': data.codigo_material_final,
                    'editNumeroParte': data.numero_parte,
                    'editPropiedadMaterial': data.propiedad_material,
                    'editMaterialImportacionLocal': data.material_importacion_local,
                    'editMaterialImportacionLocalFinal': data.material_importacion_local_final,
                    'editFechaRecibo': data.fecha_recibo,
                    'editFechaFabricacion': data.fecha_fabricacion,
                    'editCantidadActual': data.cantidad_actual,
                    'editCantidadEstandarizada': data.cantidad_estandarizada,
                    'editNumeroLoteMaterial': data.numero_lote_material,
                    'editUbicacionSalida': data.ubicacion_salida,
                    // 'editEstadoDesecho': data.estado_desecho, // Funcionalidad futura - deshabilitado
                    'editEspecificacion': data.especificacion
                };

                for (const [elementId, valor] of Object.entries(elementos)) {
                    const elemento = document.getElementById(elementId);
                    if (elemento) {
                        // Conversión especial para estado_desecho deshabilitada - funcionalidad futura
                        /*
                        if (elementId === 'editEstadoDesecho') {
                            let valorTexto = '';
                            if (valor === 1 || valor === '1') {
                                valorTexto = 'Activo';
                            } else if (valor === 0 || valor === '0') {
                                valorTexto = 'Desecho';
                            } else {
                                valorTexto = valor || '';
                            }
                            elemento.value = valorTexto;
                        } else {
                            elemento.value = valor || '';
                        }
                        */
                        elemento.value = valor || '';
                        
                        // Agregar listener para detectar cambios en cantidad_actual
                        if (elementId === 'editCantidadActual' || elementId === 'editCantidadEstandarizada') {
                            elemento.addEventListener('input', function() {
                                // Listener para detectar cambios pero sin logs
                            });
                        }
                    } else {
                        // Elemento no encontrado - sin logs
                    }
                }
                
                // Formulario llenado correctamente
                
            } catch (error) {
                console.error('Error al llenar formulario:', error);
            }
        }

        // Función para cerrar el drawer
        function cerrarDrawerControlAlmacen() {
            
            const drawer = document.getElementById('controlAlmacenEditDrawer');
            const overlay = document.getElementById('controlAlmacenOverlay');
            
            if (drawer) {
                drawer.classList.remove('open');
            } else {
                console.warn('⚠️ Drawer no encontrado');
            }
            
            if (overlay) {
                overlay.classList.remove('active');
            } else {
                console.warn('⚠️ Overlay no encontrado');
            }
        }

        // Función para guardar los cambios
        function guardarEdicionControlAlmacen() {
            const form = document.getElementById('editControlAlmacenForm');
            if (!form) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Formulario no encontrado'
                });
                return;
            }
            
            const formData = new FormData(form);
            
            // Convertir FormData a objeto JSON, filtrando campos vacíos
            const data = {};
            for (let [key, value] of formData.entries()) {
                // Solo incluir campos que tienen contenido o son específicamente importantes
                if (value !== '' && value !== null && value !== undefined) {
                    data[key] = value;
                } else if (key === 'id') {
                    // El ID siempre debe incluirse aunque esté vacío
                    data[key] = value;
                }
            }
            
            // Verificar campos críticos
            const camposCriticos = ['id', 'forma_material', 'cliente', 'codigo_material'];
            for (const campo of camposCriticos) {
                if (!data[campo]) {
                    // Campo crítico faltante
                }
            }
            if (!data.id) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'ID de registro no encontrado'
                });
                return;
            }

            // Mostrar loading
            Swal.fire({
                title: 'Guardando...',
                text: 'Actualizando registro de control de almacén',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Enviar datos al servidor
            fetch('/actualizar_control_almacen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                Swal.close();
                
                if (result.success) {
                    // Mostrar mensaje personalizado según los campos modificados
                    let mensaje = 'Registro actualizado correctamente';
                    if (result.campos_modificados && result.campos_modificados.length > 0) {
                        mensaje += `\n\nCampos modificados: ${result.campos_modificados.join(', ')}`;
                    } else if (result.message && result.message.includes('No hay cambios')) {
                        mensaje = 'No se detectaron cambios que guardar';
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: mensaje,
                        timer: 3000,
                        showConfirmButton: false
                    }).then(() => {
                        // Cerrar drawer y recargar datos solo si hubo cambios
                        cerrarDrawerControlAlmacen();
                        if (result.campos_modificados && result.campos_modificados.length > 0) {
                            // Actualizar inventario consolidado automáticamente
                            actualizarInventarioConsolidadoTrasEdicion();
                            nuevaCargarDatos();
                        }
                    });
                    
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.error || 'Error al actualizar el registro'
                    });
                }
            })
            .catch(error => {
                Swal.close();
                console.error('❌ Error de conexión:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'Error al conectar con el servidor: ' + error.message
                });
            });
        }

        // Nueva función para actualizar inventario consolidado tras edición
        async function actualizarInventarioConsolidadoTrasEdicion() {
            try {
                
                // Actualización silenciosa en segundo plano - sin notificaciones

                // Llamar al endpoint de recálculo de inventario
                const response = await fetch('/recalcular_inventario_general', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        // Actualización silenciosa - sin notificaciones molestas
                        
                    } else {
                        console.warn('⚠️ Advertencia al actualizar inventario:', result.error);
                    }
                } else {
                    console.error('❌ Error HTTP al actualizar inventario:', response.status);
                }

            } catch (error) {
                console.error('❌ Error al actualizar inventario consolidado:', error);
                
                // Mostrar error solo en consola, no molestar al usuario
                Swal.fire({
                    icon: 'warning',
                    title: 'Advertencia',
                    text: 'La edición se guardó correctamente, pero hubo un problema al actualizar el inventario consolidado',
                    timer: 3000,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false
                });
            }
        }

        // ====== Función de Limpieza para AJAX ======
        function cleanupControlAlmacen() {
            
            // Limpiar estilos inline de campos de escaneo
            const campoLote = document.getElementById('escaneo-lote-proveedor');
            const campoEtiqueta = document.getElementById('escaneo-etiqueta-impresa');
            
            if (campoLote) {
                campoLote.style.background = '';
                campoLote.style.border = '';
                campoLote.style.boxShadow = '';
                campoLote.value = '';
            }
            
            if (campoEtiqueta) {
                campoEtiqueta.style.background = '';
                campoEtiqueta.style.border = '';
                campoEtiqueta.style.boxShadow = '';
                campoEtiqueta.style.cursor = '';
                campoEtiqueta.style.pointerEvents = '';
                campoEtiqueta.value = '';
            }
            
            // Cerrar modales abiertos
            const modales = [
                'modal-asignacion-lotes',
                'modal-unidades',
                'trazabilidad-modal',
                'modalCodigoMaterial'
            ];
            
            modales.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Limpiar variables globales
            if (typeof ultimoLoteEscaneado !== 'undefined') {
                window.ultimoLoteEscaneado = '';
            }
            if (typeof procesandoLote !== 'undefined') {
                window.procesandoLote = false;
            }
            if (typeof procesandoEtiqueta !== 'undefined') {
                window.procesandoEtiqueta = false;
            }
            if (typeof ultimaEtiquetaProcesada !== 'undefined') {
                window.ultimaEtiquetaProcesada = '';
            }
            
            // Resetear flag de listeners para permitir reinicialización
            if (document.body.dataset.controlAlmacenListenersAttached) {
                delete document.body.dataset.controlAlmacenListenersAttached;
            }
            
        }

        // ====== Exponer Funciones Globalmente para acceso externo (CRÍTICO) ======
        // Nota: initializeControlAlmacenEventListeners ya se expuso al principio
        window.guardarFormulario = guardarFormulario;
        window.abrirModalUnidades = abrirModalUnidades;
        window.manejarImpresion = manejarImpresion;
        window.verificarImpresoraZebra = verificarImpresoraZebra;
        window.consultarRegistros = consultarRegistros;
        window.exportarExcel = exportarExcel;
        window.importarExcelAlmacen = importarExcelAlmacen;
        window.cargarDatosDesdeServidor = cargarDatosDesdeServidor;
        window.nuevaCargarDatos = nuevaCargarDatos;
        window.inicializarControlAlmacen = inicializarControlAlmacen;
        window.cleanupControlAlmacen = cleanupControlAlmacen;

    </script>

    <!-- Script inline para inicialización después de carga AJAX -->
    <script>
    (function() {
        
        function tryInitialize() {
            if (typeof window.initializeControlAlmacenEventListeners === 'function') {
        // ========== NUEVA FUNCIONALIDAD: LOTE INTERNO AUTOMÁTICO ==========
        
        // Variable global para almacenar el lote interno generado
        window.loteInternoGenerado = null;
        
        // Función para generar lote interno basado en fecha y secuencial del día
        async function generarLoteInterno() {
            try {
                const today = new Date();
                const dia = String(today.getDate()).padStart(2, '0');
                const mes = String(today.getMonth() + 1).padStart(2, '0');
                const anio = today.getFullYear();
                const fechaFormato = `${dia}.${mes}.${anio}`;
                
                // Llamar al servidor para obtener el siguiente secuencial del día
                const response = await fetch('/obtener_secuencial_lote_interno', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fecha: fechaFormato
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener secuencial del día');
                }
                
                const data = await response.json();
                const secuencial = String(data.siguiente_secuencial).padStart(4, '0');
                window.loteInternoGenerado = `${fechaFormato}.${secuencial}`;
                
                return window.loteInternoGenerado;
            } catch (error) {
                console.error('Error generando lote interno:', error);
                // Generar lote local si hay error
                const today = new Date();
                const dia = String(today.getDate()).padStart(2, '0');
                const mes = String(today.getMonth() + 1).padStart(2, '0');
                const anio = today.getFullYear();
                window.loteInternoGenerado = `${dia}.${mes}.${anio}.0001`;
                return window.loteInternoGenerado;
            }
        }
        
        // Exponer la función globalmente para que pueda ser usada en procesarImpresionUnidades
        window.generarLoteInterno = generarLoteInterno;
        
        // Actualizar preview cuando el checkbox cambia
        const checkboxLoteInterno = document.getElementById('asignar-lote-interno');
        const previewLoteInterno = document.getElementById('lote-interno-preview');
        const previewLoteInternoText = document.getElementById('lote-interno-preview-text');
        
        if (checkboxLoteInterno) {
            checkboxLoteInterno.addEventListener('change', async function() {
                if (this.checked) {
                    const lote = await generarLoteInterno();
                    previewLoteInternoText.textContent = lote;
                    previewLoteInterno.style.display = 'block';
                } else {
                    previewLoteInterno.style.display = 'none';
                    window.loteInternoGenerado = null;
                }
            });
        }
        
        // ========== FIN LOTE INTERNO ==========

                window.initializeControlAlmacenEventListeners();
            } else {
                setTimeout(tryInitialize, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInitialize);
        } else {
            tryInitialize();
        }
    })();
    </script>

</body>
</html>
