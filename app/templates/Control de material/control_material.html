<!-- Estilos espec√≠ficos para Control de Material que complementan style.css -->
    <style>
        /* Contenedor principal */
        .material-container2 {
            background-color: #32323E;
            color: lightgray;
            min-height: 100vh;
            padding: 3px;
        }

        /* Botonera */
        .material-toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 2px;
            margin-bottom: 2px;
            padding: 3px 4px;
            background-color: #40424F;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .material-btn {
            padding: 2px 4px;
            border: none;
            border-radius: 2px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-size: 8px;
            transition: all 0.3s;
            font-weight: 500;
            line-height: 1.0;
            min-width: 50px;
            height: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .material-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .material-btn.secondary {
            background-color: #009944;
        }

        .material-btn.secondary:hover {
            background-color: #007d3b;
        }

        .material-btn.purple {
            background-color: #9b59b6;
        }

        .material-btn.purple:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }

        .material-btn.orange {
            background-color: #e67e22;
        }

        .material-btn.orange:hover {
            background-color: #d35400;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
        }

        .material-btn.gray {
            background-color: #95a5a6;
        }

        .material-btn.gray:hover {
            background-color: #7f8c8d;
        }

        /* Formulario con dise√±o consistente */
        .material-form-section {
            background-color: #40424F;
            border-radius: 2px;
            padding: 4px;
            margin-bottom: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .material-form-row {
            display: grid;
            gap: 4px;
            margin-bottom: 2px;
        }
        
        .material-form-group {
            display: flex;
            flex-direction: column;
        }
        
        .material-form-group label {
            font-weight: bold;
            margin-bottom: 1px;
            font-size: 8px;
            color: lightgray;
            line-height: 1.0;
        }
        
        .material-form-group input, .material-form-group select {
            padding: 2px 4px;
            border: 1px solid #95a5a6;
            border-radius: 2px;
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            font-size: 9px;
            height: 20px;
            line-height: 1.0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .material-form-group input:focus, .material-form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
            background-color: #ffffff !important;
            color: #2c3e50 !important;
        }
        
        /* Espec√≠fico para select dropdowns */
        .material-form-group select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="5" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 4px center;
            background-size: 8px 10px;
            padding-right: 16px;
        }
        
        /* Asegurar que las opciones del select tambi√©n sean visibles */
        .material-form-group select option {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            padding: 2px;
        }
        
        /* Placeholder text */
        .material-form-group input::placeholder {
            color: #7f8c8d !important;
            opacity: 1;
        }
        
        /* Reglas espec√≠ficas para los campos problem√°ticos */
        #forma_material, #cliente, #codigoMaterialOriginal, #codigoMaterialSelect {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            border: 1px solid #95a5a6 !important;
            font-size: 9px !important;
        }
        
        #forma_material:focus, #cliente:focus, #codigoMaterialOriginal:focus, #codigoMaterialSelect:focus {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            border-color: #3498db !important;
        }
        
        /* Opciones de select espec√≠ficas */
        #forma_material option, #cliente option, #codigoMaterialSelect option {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
        }
        
        /* Reglas adicionales para sobrescribir cualquier estilo inline */
        input[style*="flex"], select[style*="cursor"] {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            border: 1px solid #95a5a6 !important;
        }
        
        /* Asegurar visibilidad en todos los estados */
        .material-form-group input[type="text"],
        .material-form-group select {
            background: #ffffff !important;
            color: #2c3e50 !important;
            -webkit-text-fill-color: #2c3e50 !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }
        
        .three-column {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .two-column {
            grid-template-columns: 1fr 1fr;
        }

        /* Tabla */
        .material-table-container {
            background-color: #40424F;
            border-radius: 2px;
            padding: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .material-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 6px;
            background-color: #40424F;
        }

        .material-table th {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 2px 2px;
            text-align: center;
            border: 1px solid #34495e;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 6px;
            line-height: 1.0;
        }

        .material-table td {
            padding: 1px 2px;
            text-align: center;
            border: 1px solid #34495e;
            background-color: #40424F;
            color: lightgray;
            transition: background-color 0.3s;
            font-size: 6px;
            line-height: 1.0;
        }

        .material-table tr:hover td {
            background-color: #485563;
        }

        .material-table tr:nth-child(even) td {
            background-color: #44475A;
        }

        .material-table tr:nth-child(even):hover td {
            background-color: #485563;
        }

        .material-table input[type="checkbox"] {
            transform: scale(1.1);
            cursor: pointer;
            accent-color: #3498db;
        }

        .material-table .no-data {
            text-align: center;
            padding: 15px;
            color: #95a5a6;
            font-style: italic;
            background-color: #40424F;
            font-size: 10px;
        }

        /* Mensajes de estado */
        .material-loading {
            text-align: center;
            padding: 15px;
            color: #3498db;
            font-size: 10px;
        }

        .material-error {
            text-align: center;
            padding: 15px;
            color: #e74c3c;
            font-size: 10px;
        }

        /* Dropdown modal espec√≠fico para selecci√≥n de materiales */
        .dropdown-modal {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow: hidden;
            margin-top: 2px;
            min-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            color: #333;
            font-size: 12px;
            box-sizing: border-box;
            outline: none;
        }
        
        .search-input:focus {
            background-color: #fff;
            border-bottom-color: #007bff;
        }
        
        .dropdown-table-container {
            max-height: 250px;
            overflow-y: auto;
            background-color: white;
        }
        
        .dropdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background-color: white;
        }
        
        .dropdown-table th {
            background-color: #f1f3f4;
            color: #5f6368;
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
        }
        
        .dropdown-table td {
            padding: 8px 12px;
            text-align: left;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }
        
        .dropdown-table tr:hover td {
            background-color: #e3f2fd;
        }
        
        .dropdown-table tr:last-child td {
            border-bottom: none;
        }

        .original-code-btn {
            background-color: #1abc9c;
            color: white;
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 6px;
        }

        .total-info {
            color: #95a5a6;
            margin-top: 6px;
            font-size: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .material-toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .material-btn {
                width: 100%;
            }
            
            .material-table-container {
                padding: 15px;
            }
            
            .three-column {
                grid-template-columns: 1fr;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="material-container2">
        
        <style>
        /* Dropdown modal espec√≠fico para selecci√≥n de materiales */
        .dropdown-modal {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow: hidden;
            margin-top: 2px;
            min-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            color: #333;
            font-size: 12px;
            box-sizing: border-box;
            outline: none;
        }
        
        .search-input:focus {
            background-color: #fff;
            border-bottom-color: #007bff;
        }
        
        .dropdown-table-container {
            max-height: 250px;
            overflow-y: auto;
            background-color: white;
        }
        
        .dropdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background-color: white;
        }
        
        .dropdown-table th {
            background-color: #f1f3f4;
            color: #5f6368;
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
        }
        
        .dropdown-table td {
            padding: 8px 12px;
            text-align: left;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }
        
        .dropdown-table tr:hover td {
            background-color: #e3f2fd;
        }
        
        .dropdown-table tr:last-child td {
            border-bottom: none;
        }
        
        .original-code-btn {
            background-color: #1abc9c;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }     
        
        /* Estilo minimalista para campos de fecha */
        .material-form-group input[type="date"] {
            padding: 3px 4px !important;
            font-size: 10px !important;
            border: 1px solid #bdc3c7 !important;
            border-radius: 3px !important;
            background-color: #f8f9fa !important;
            color: #495057 !important;
            width: 110px !important;
            cursor: pointer;
        }
        
        .material-form-group input[type="date"]:focus {
            border-color: #3498db !important;
            background-color: #ffffff !important;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.1) !important;
        }
        
        .material-form-group input[type="date"]::-webkit-calendar-picker-indicator {
            filter: opacity(0.6);
            cursor: pointer;
            padding: 1px;
            border-radius: 2px;
            width: 10px;
            height: 10px;
        }
        
        .material-form-group input[type="date"]::-webkit-calendar-picker-indicator:hover {
            filter: opacity(1);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* Estilo minimalista para fechas en la toolbar */
        .material-toolbar input[type="date"] {
            padding: 2px 4px !important;
            font-size: 10px !important;
            border: 1px solid #95a5a6 !important;
            border-radius: 3px !important;
            background-color: #ecf0f1 !important;
            color: #2c3e50 !important;
            width: 105px !important;
            cursor: pointer;
        }
        
        .material-toolbar input[type="date"]:focus {
            border-color: #3498db !important;
            background-color: #ffffff !important;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.2) !important;
        }
        
        .material-toolbar input[type="date"]::-webkit-calendar-picker-indicator {
            filter: opacity(0.5);
            cursor: pointer;
            padding: 1px;
            width: 9px;
            height: 9px;
        }
        
        .material-toolbar input[type="date"]::-webkit-calendar-picker-indicator:hover {
            filter: opacity(0.8);
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .loading-message {
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
        <!-- Formulario con el dise√±o de CONTROL_DE_MATERIAL -->
        <div class="material-form-section">
            <!-- Primera fila: 3 columnas -->
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Forma de material:</label>
                    <select id="forma_material">
                        <option>OriginCode</option>
                    </select>
                </div>
                <div class="material-form-group">
                    <label>Cliente:</label>
                    <select id="cliente">
                        <option value="">Seleccionar</option>
                        <option value="LG_REFRIS">LG_REFRIS</option>
                        <option value="LG_ESTUFAS">LG_ESTUFAS</option>
                    </select>
                </div>
                <div class="material-form-group">
                    <label>C√≥digo de material original:</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="codigoMaterialOriginal" style="flex: 1;" placeholder="Escanear c√≥digo aqu√≠..." onkeydown="procesarScaneo(event)">
                    </div>
                </div>
            </div>

            <!-- Segunda fila: 3 columnas -->
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>C√≥digo de material:</label>
                    <div style="position: relative;">
                        <select id="codigoMaterialSelect" onclick="event.preventDefault(); abrirModalCodigoMaterial();" readonly style="cursor: pointer;">
                            <option value="">Seleccionar</option>
                        </select>
                        
                        <!-- Modal dropdown debajo del select -->
                        <div id="modalCodigoMaterial" class="dropdown-modal">
                            <input type="text" id="searchInput" class="search-input" placeholder="Buscar c√≥digo, nombre o especificaci√≥n..." onkeyup="filtrarTablaModal()">
                            <div class="dropdown-table-container">
                                <table class="dropdown-table">
                                    <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Nombre</th>
                                            <th>Especificaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaCodigosBody">
                                        <!-- Los datos se cargar√°n din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="material-form-group">
                    <label>Material importaci√≥n/local:</label>
                    <select id="material_importacion_local">
                        <option value="Customer Supply">Customer Supply</option>
                        <option value="Local">Local</option>
                        <option value="Importaci√≥n">Importaci√≥n</option>
                    </select>
                </div>
                <div class="material-form-group">
                    <label>Fecha de recibo:</label>
                    <input type="date" id="fecha_recibo" value="2025-07-08">
                </div>
            </div>

            <!-- Tercera fila: 3 columnas -->
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Fecha de fabricaci√≥n:</label>
                    <input type="date" id="fecha_fabricacion" value="2025-07-08">
                </div>
                <div class="material-form-group">
                    <label>Cantidad actual:</label>
                    <input type="text" id="cantidad_actual">
                </div>
                <div class="material-form-group">
                    <label>N√∫mero de lote de material:</label>
                    <input type="text" id="numero_lote_material">
                </div>
            </div>

            <!-- Cuarta fila: 3 columnas -->
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>C√≥digo de material recibido:</label>
                    <input type="text" id="codigo_material_recibido">
                </div>
                <div class="material-form-group">
                    <label>N√∫mero de parte:</label>
                    <input type="text" id="numero_parte_lower">
                </div>
                <div class="material-form-group">
                    <label>Cantidad estandarizada:</label>
                    <input type="text" id="cantidad_estandarizada">
                </div>
            </div>

            <!-- Quinta fila: 2 columnas -->
            <div class="material-form-row two-column">
                <div class="material-form-group">
                    <label>C√≥digo de material:</label>
                    <input type="text" id="codigo_material_lower">
                </div>
                <div class="material-form-group">
                    <label>Propiedad de material:</label>
                    <input type="text" id="propiedad_material">
                </div>
            </div>
        </div>

        <!-- Botonera usando el dise√±o de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <button class="material-btn gray">Conf. de impresora</button>
            <button class="material-btn purple">Registro autom√°tico</button>
            <button class="material-btn orange" id="btnGuardar" onclick="guardarFormulario()">Guardar</button>
            <button class="material-btn">Imprimir</button>
        </div>

        <!-- Secci√≥n de filtros usando el dise√±o de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                <label style="margin: 0; color: lightgray;">Fecha de recibo:</label>
                <input type="date" id="filtro_fecha_inicio" value="2025-07-08">
                <span style="color: lightgray;">~</span>
                <input type="date" id="filtro_fecha_fin" value="2025-07-08">
            </div>
            <button class="material-btn" id="btnConsultar" onclick="consultarRegistros()">Consultar</button>
            <button class="material-btn secondary">Exportar Excel</button>
        </div>

        <!-- Tabla de resultados -->
        <div class="material-table-container">
            <table class="material-table" id="tablaControlAlmacen">
                <thead>
                    <tr>
                        <th>C√≥digo de material recibido</th>
                        <th>C√≥digo de material</th>
                        <th>N√∫mero de parte</th>
                        <th>N√∫mero de lote de material</th>
                        <th>Propiedad de material</th>
                        <th>Cantidad actual</th>
                        <th>Cantidad estandarizada</th>
                        <th>Ubicaci√≥n de salida</th>
                        <th>Fecha de recibo</th>
                        <th>Especificaci√≥n</th>
                        <th>Material importaci√≥n/local</th>
                        <th>Estado de desecho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="12" class="no-data">
                            No hay datos para mostrar. Haga clic en "Consultar" para cargar los registros.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p class="total-info">Total Rows: 0</p>
        </div>

    </div>

    <script>
        let codigosMaterial = [];

        // Cargar c√≥digos de material al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina cargada - inicializando...');
            cargarCodigosMaterial();
            cargarClienteSeleccionado(); // Cargar la √∫ltima selecci√≥n de cliente
            cargarSiguienteSecuencial(); // Cargar el siguiente n√∫mero secuencial
        });

        // Funci√≥n para cargar la √∫ltima selecci√≥n de cliente
        async function cargarClienteSeleccionado() {
            try {
                const response = await fetch('/cargar_cliente_seleccionado');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cliente) {
                        const selectCliente = document.getElementById('cliente');
                        if (selectCliente) {
                            selectCliente.value = data.cliente;
                            console.log('‚úÖ Cliente cargado:', data.cliente);
                        }
                    }
                } else {
                    console.warn('Error al cargar cliente:', response.status);
                }
            } catch (error) {
                console.error('Error al cargar cliente seleccionado:', error);
            }
        }

        // Funci√≥n para guardar la selecci√≥n de cliente
        async function guardarClienteSeleccionado(cliente) {
            try {
                console.log('üíæ Guardando cliente seleccionado:', cliente);
                const response = await fetch('/guardar_cliente_seleccionado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cliente: cliente })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('‚úÖ Cliente guardado exitosamente en BD:', cliente);
                    } else {
                        console.error('‚ùå Error al guardar cliente:', data.error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Error en respuesta al guardar cliente:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al guardar cliente:', error);
            }
        }

        async function cargarCodigosMaterial() {
            try {
                const response = await fetch('/obtener_codigos_material');
                
                if (response.ok) {
                    codigosMaterial = await response.json();
                    console.log('‚úÖ C√≥digos de material cargados:', codigosMaterial.length);
                    
                    // Mostrar algunos ejemplos para verificar que incluyen cantidad_estandarizada
                    if (codigosMaterial.length > 0) {
                        console.log('üìã Ejemplo de material cargado:', codigosMaterial[0]);
                        console.log('üîç Campos disponibles:', Object.keys(codigosMaterial[0]));
                    }
                } else {
                    console.error('Error al cargar c√≥digos de material, status:', response.status);
                    // Si hay error, usar datos de prueba
                    codigosMaterial = [
                        {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                        {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                        {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                    ];
                    console.log('‚ö†Ô∏è Usando datos de prueba con cantidad_estandarizada');
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                // Si hay error, usar datos de prueba
                codigosMaterial = [
                    {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                    {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                    {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                ];
                console.log('‚ö†Ô∏è Usando datos de prueba por error de conexi√≥n');
            }
        }

        function abrirModalCodigoMaterial() {
            const modal = document.getElementById('modalCodigoMaterial');
            const tbody = document.getElementById('tablaCodigosBody');
            const searchInput = document.getElementById('searchInput');
            
            // Cerrar otros dropdowns si est√°n abiertos
            cerrarModalCodigoMaterial();
            
            // Limpiar b√∫squeda
            searchInput.value = '';
            
            // Llenar la tabla
            tbody.innerHTML = '';
            
            if (codigosMaterial.length === 0) {
                // Mostrar mensaje de "no hay datos"
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: #666;">No hay c√≥digos disponibles</td>';
            } else {
                codigosMaterial.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
            
            // Mostrar el modal con animaci√≥n suave
            modal.style.display = 'block';
            
            // Enfocar el campo de b√∫squeda
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }

        function cerrarModalCodigoMaterial() {
            document.getElementById('modalCodigoMaterial').style.display = 'none';
        }

        function seleccionarCodigo(codigo) {
            const select = document.getElementById('codigoMaterialSelect');
            
            // Buscar la informaci√≥n completa del c√≥digo seleccionado
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigo);
            
            // Actualizar el select con el c√≥digo seleccionado
            select.innerHTML = `
                <option value="${codigo}" selected>${codigo}</option>
                <option value="">Seleccionar</option>
            `;
            
            // Opcional: Tambi√©n mostrar la informaci√≥n completa visualmente
            if (codigoCompleto) {
                select.title = `${codigoCompleto.codigo} - ${codigoCompleto.nombre} - ${codigoCompleto.spec}`;
            }
            
            cerrarModalCodigoMaterial();
            
            // Llenar autom√°ticamente los campos inferiores despu√©s de seleccionar
            setTimeout(() => {
                llenarCamposInferiores(codigo);
            }, 500);
        }

        function filtrarTablaModal() {
            const input = document.getElementById('searchInput');
            const filtro = input.value.toLowerCase();
            const tbody = document.getElementById('tablaCodigosBody');
            
            tbody.innerHTML = '';
            
            const codigosFiltrados = codigosMaterial.filter(codigo => 
                codigo.codigo.toLowerCase().includes(filtro) ||
                codigo.nombre.toLowerCase().includes(filtro) ||
                codigo.spec.toLowerCase().includes(filtro)
            );
            
            if (codigosFiltrados.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 15px;">No se encontraron resultados</td>';
            } else {
                codigosFiltrados.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCodigoMaterial');
            const select = document.getElementById('codigoMaterialSelect');
            
            // Si se hace clic fuera del modal y del select, cerrar el modal
            if (!modal.contains(event.target) && !select.contains(event.target)) {
                cerrarModalCodigoMaterial();
            }
        });

        // Cargar configuraciones cuando se carga la p√°gina (sin cargar datos autom√°ticamente)
        document.addEventListener('DOMContentLoaded', function() {
            // NO llamar consultarRegistros() aqu√≠ - la tabla debe permanecer vac√≠a hasta que el usuario haga clic en "Consultar"
            
            // Agregar event listener al select de cliente
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    const clienteSeleccionado = this.value;
                    if (clienteSeleccionado) {
                        console.log('Cliente seleccionado:', clienteSeleccionado);
                        guardarClienteSeleccionado(clienteSeleccionado);
                        
                        // Resaltar visualmente que se guard√≥
                        this.style.backgroundColor = '#d4edda';
                        this.style.borderColor = '#c3e6cb';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, 1500);
                    }
                });
            }
        });

        function procesarScaneo(event) {
            // Detectar Enter (cuando termina el escaneo)
            if (event.key === 'Enter') {
                event.preventDefault();
                const codigoCompleto = event.target.value.trim();
                
                if (codigoCompleto) {
                    parsearYDistribuirCodigo(codigoCompleto);
                }
            }
        }

        function procesarCodigoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const codigoCompleto = input.value.trim();
            
            if (codigoCompleto) {
                parsearYDistribuirCodigo(codigoCompleto);
            } else {
                alert('Por favor, ingrese o escanear un c√≥digo antes de procesar.');
            }
        }

        function parsearYDistribuirCodigo(codigoCompleto) {
            console.log('C√≥digo escaneado:', codigoCompleto);
            
            // Dividir por "/" para obtener las partes
            const partes = codigoCompleto.split('/');
            
            if (partes.length < 8) {
                alert('Formato de c√≥digo inv√°lido. Debe contener al menos 8 secciones separadas por "/"');
                return;
            }
            
            // Extraer los datos seg√∫n tu especificaci√≥n
            const codigoMaterial = partes[0];           // M2124740058
            const cantidadActual = partes[2];           // 4000  
            const numeroLote = partes[7];               // IA3116H14
            
            // Distribuir a los campos correspondientes
            if (codigoMaterial) {
                // Buscar y seleccionar el c√≥digo de material en el dropdown
                buscarYSeleccionarCodigoMaterial(codigoMaterial);
            }
            
            if (cantidadActual) {
                const inputCantidad = document.getElementById('cantidad_actual');
                if (inputCantidad) {
                    inputCantidad.value = cantidadActual;
                }
            }
            
            if (numeroLote) {
                const inputLote = document.getElementById('numero_lote_material');
                if (inputLote) {
                    inputLote.value = numeroLote;
                }
            }
            
            // Mostrar resumen de lo procesado
            console.log('Datos extra√≠dos:');
            console.log('- C√≥digo de material:', codigoMaterial);
            console.log('- Cantidad actual:', cantidadActual);
            console.log('- N√∫mero de lote:', numeroLote);
            
            // Opcional: Mostrar notificaci√≥n visual
            mostrarNotificacionEscaneo(codigoMaterial, cantidadActual, numeroLote);
        }

        function buscarYSeleccionarCodigoMaterial(codigo) {
            // Buscar si el c√≥digo existe en la lista de materiales
            const codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
            
            if (codigoEncontrado) {
                // Si existe, seleccionarlo autom√°ticamente
                seleccionarCodigo(codigo);
                console.log('C√≥digo de material encontrado y seleccionado:', codigo);
                console.log('Datos del material:', codigoEncontrado);
            } else {
                // Si no existe, mostrar en el dropdown pero sin seleccionar
                const select = document.getElementById('codigoMaterialSelect');
                select.innerHTML = `
                    <option value="${codigo}" selected>${codigo} (C√≥digo escaneado - no encontrado en BD)</option>
                    <option value="">Seleccionar</option>
                `;
                select.style.backgroundColor = '#fff3cd'; // Resaltar en amarillo
                console.warn('C√≥digo de material no encontrado en la base de datos:', codigo);
                
                // Tambi√©n llenar campos b√°sicos aunque no est√© en BD
                llenarCamposInferiores(codigo);
                
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 3000);
            }
        }

        function mostrarNotificacionEscaneo(codigo, cantidad, lote) {
            // Llenar autom√°ticamente los campos inferiores
            llenarCamposInferiores(codigo);
        }

        // Contador global para n√∫meros secuenciales del c√≥digo de material recibido
        let contadorSecuencial = 1;
        let proximoCodigoCompleto = '';

        // Funci√≥n para cargar el siguiente n√∫mero secuencial desde la base de datos
        async function cargarSiguienteSecuencial(codigoMaterial = '') {
            try {
                console.log('üîÑ Cargando siguiente n√∫mero secuencial desde BD...');
                
                // Construir URL con c√≥digo de material si est√° disponible
                let url = '/obtener_siguiente_secuencial';
                if (codigoMaterial) {
                    url += `?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                    console.log(`üìã Solicitando secuencial para c√≥digo: ${codigoMaterial}`);
                }
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        contadorSecuencial = data.siguiente_secuencial || 1;
                        proximoCodigoCompleto = data.proximo_codigo_completo || '';
                        
                        console.log(`‚úÖ Siguiente secuencial cargado desde BD: ${contadorSecuencial}`);
                        console.log(`üìÖ Fecha actual: ${data.fecha_actual}`);
                        console.log(`üîç C√≥digo material: ${data.codigo_material || 'Sin c√≥digo'}`);
                        console.log(`üìä Secuencial m√°s alto encontrado: ${data.secuencial_mas_alto_encontrado}`);
                        console.log(`üî¢ Pr√≥ximo c√≥digo completo: ${proximoCodigoCompleto}`);
                    } else {
                        console.warn('‚ö†Ô∏è Error en respuesta del secuencial:', data.error);
                        contadorSecuencial = 1;
                        proximoCodigoCompleto = '';
                    }
                } else {
                    console.error('‚ùå Error HTTP al cargar secuencial:', response.status);
                    contadorSecuencial = 1;
                    proximoCodigoCompleto = '';
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n al cargar secuencial:', error);
                contadorSecuencial = 1;
                proximoCodigoCompleto = '';
            }
        }

        function llenarCamposInferiores(codigoMaterial) {
            // Buscar la informaci√≥n completa del c√≥digo de material
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
            
            // Recargar el contador espec√≠fico para este c√≥digo de material
            console.log(`üîÑ Recargando contador para c√≥digo de material: ${codigoMaterial}`);
            cargarSiguienteSecuencial(codigoMaterial).then(() => {
                // Una vez cargado el contador, proceder a llenar los campos
                llenarCamposConContador(codigoMaterial, codigoCompleto);
            });
        }
        
        function llenarCamposConContador(codigoMaterial, codigoCompleto) {
            // Usar el pr√≥ximo c√≥digo completo obtenido del backend (formato: CODIGO/YYYYMMDD0001)
            const codigoMaterialRecibidoCompleto = proximoCodigoCompleto || `${codigoMaterial}/${new Date().toISOString().slice(0,10).replace(/-/g,'')}${String(contadorSecuencial).padStart(4, '0')}`;
            
            console.log('Llenando campos inferiores:');
            console.log('- C√≥digo de material base:', codigoMaterial);
            console.log('- C√≥digo de material recibido completo:', codigoMaterialRecibidoCompleto);
            console.log('- Contador secuencial:', contadorSecuencial);
            
            // Llenar campos con IDs espec√≠ficos usando la informaci√≥n de la base de datos
            if (codigoCompleto) {
                console.log('- Informaci√≥n del material encontrada:', codigoCompleto);
                
                // Llenar campos con IDs espec√≠ficos
                llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto); // C√≥digo completo: CODIGO/YYYYMMDD0001
                llenarCampoPorId('codigo_material_lower', codigoMaterial); // Solo el c√≥digo base
                llenarCampoPorId('numero_parte_lower', codigoCompleto.numero_parte || String(contadorSecuencial).padStart(4, '0'));
                llenarCampoPorId('cantidad_estandarizada', codigoCompleto.cantidad_estandarizada || ''); // Usar standarpack
                llenarCampoPorId('cantidad_actual', codigoCompleto.cantidad_estandarizada || ''); // Tambi√©n llenar cantidad actual con standarpack
                llenarCampoPorId('propiedad_material', codigoCompleto.propiedad_material || '');
                
                // El n√∫mero de lote material queda vac√≠o porque ahora el lote est√° en codigo_material_recibido
                llenarCampoPorId('numero_lote_material', '');
                
                console.log('- Cantidad estandarizada (standarpack):', codigoCompleto.cantidad_estandarizada);
                console.log('- Cantidad actual (copiada de standarpack):', codigoCompleto.cantidad_estandarizada);
                console.log('- Propiedad material:', codigoCompleto.propiedad_material);
            } else {
                console.warn('- Material no encontrado en la base de datos');
                // Si no se encuentra el c√≥digo completo, llenar con valores b√°sicos
                llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                llenarCampoPorId('codigo_material_lower', codigoMaterial);
                llenarCampoPorId('numero_parte_lower', String(contadorSecuencial).padStart(4, '0'));
                llenarCampoPorId('numero_lote_material', '');
                // No llenar cantidad_estandarizada, cantidad_actual ni propiedad_material si no hay datos
            }
            
            // El contador espec√≠fico ya fue cargado para este c√≥digo de material
        }

        function llenarCampoPorId(idCampo, valor) {
            const campo = document.getElementById(idCampo);
            if (campo && valor) {
                campo.value = valor;
                console.log(`‚úÖ Campo ${idCampo} llenado con: ${valor}`);
                
                // Resaltar visualmente el campo que se llen√≥
                campo.style.backgroundColor = '#e3f2fd';
                campo.style.transition = 'background-color 0.3s';
                
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 2000);
                
            } else if (!campo) {
                console.warn(`‚ùå Campo no encontrado con ID: ${idCampo}`);
            } else if (!valor) {
                console.warn(`‚ö†Ô∏è Valor vac√≠o para campo: ${idCampo}`);
            }
        }

        function llenarCampoInferior(labelTexto, valor) {
            const labels = document.querySelectorAll('label');
            let campoEncontrado = false;
            
            // Buscar desde el final hacia atr√°s para encontrar los campos inferiores
            for (let i = labels.length - 1; i >= 0; i--) {
                const label = labels[i];
                if (label.textContent.includes(labelTexto)) {
                    // Si es "C√≥digo de material:" tomar el √∫ltimo (inferior)
                    if (labelTexto === 'C√≥digo de material:' && campoEncontrado) {
                        continue; // Saltar el primero, queremos el √∫ltimo
                    }
                    
                    const input = label.parentNode.querySelector('input');
                    if (input) {
                        input.value = valor;
                        input.style.backgroundColor = '#e3f2fd'; // Resaltar en azul claro
                        input.style.transition = 'background-color 0.3s';
                        
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 3000);
                        
                        campoEncontrado = true;
                        
                        // Para "C√≥digo de material:" solo tomar el √∫ltimo
                        if (labelTexto !== 'C√≥digo de material:') {
                            break;
                        }
                    }
                }
            }
            
            if (!campoEncontrado) {
                console.warn('Campo no encontrado:', labelTexto);
            }
        }

        // Funci√≥n para reiniciar el contador (opcional, para usar cuando sea necesario)
        // Funci√≥n para recargar el contador desde la base de datos
        function recargarContador() {
            cargarSiguienteSecuencial();
            console.log('Recargando contador secuencial desde la base de datos...');
        }

        // Funci√≥n opcional para forzar recarga del contador (para testing/debug)
        function forzarRecargaContador() {
            console.log('üîÑ Forzando recarga del contador secuencial...');
            cargarSiguienteSecuencial().then(() => {
                alert(`Contador recargado. Pr√≥ximo secuencial: ${String(contadorSecuencial).padStart(4, '0')}`);
            });
        }

        // Funci√≥n para verificar y llenar manualmente (para testing)
        function llenarCamposInferioresManual() {
            const selectCodigo = document.getElementById('codigoMaterialSelect');
            const codigoSeleccionado = selectCodigo.value;
            
            if (codigoSeleccionado) {
                llenarCamposInferiores(codigoSeleccionado);
            } else {
                alert('Por favor, seleccione primero un c√≥digo de material');
            }
        }

        // Funci√≥n para guardar el formulario
        function guardarFormulario() {
            try {
                // Recopilar todos los datos del formulario
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: document.getElementById('codigoMaterialOriginal').value,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: document.getElementById('numero_lote_material').value,
                    codigo_material_recibido: document.getElementById('codigo_material_recibido').value,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value
                };
                
                // Validar campos requeridos
                if (!formData.codigo_material_original) {
                    alert('Por favor, ingrese el c√≥digo de material original');
                    return;
                }
                
                console.log('Datos a guardar:', formData);
                
                // Deshabilitar bot√≥n mientras se guarda
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                // Enviar datos al servidor
                fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    console.log('Save response status:', response.status);
                    console.log('Save response headers:', response.headers.get('content-type'));
                    
                    // Verificar si la respuesta es JSON
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // Si no es JSON, probablemente es una redirecci√≥n a login
                        throw new Error('No autenticado - redirigiendo a login');
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert('Registro guardado exitosamente');
                        
                        // IMPORTANTE: Recargar el siguiente lote para el c√≥digo actual despu√©s de guardar
                        const codigoActual = document.getElementById('codigoMaterialSelect').value;
                        if (codigoActual) {
                            console.log(`üîÑ Recargando siguiente lote para c√≥digo '${codigoActual}' despu√©s de guardar...`);
                            cargarSiguienteSecuencial(codigoActual);
                        } else {
                            console.log('üîÑ Recargando lote por defecto despu√©s de guardar...');
                            cargarSiguienteSecuencial();
                        }
                        
                        // Limpiar formulario
                        limpiarFormulario();
                        // Recargar tabla autom√°ticamente
                        consultarRegistros();
                    } else {
                        alert('Error al guardar: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('No autenticado')) {
                        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
                        window.location.href = '/login';
                    } else {
                        alert('Error al guardar el registro: ' + error.message);
                    }
                })
                .finally(() => {
                    // Rehabilitar bot√≥n
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                });
                
            } catch (error) {
                console.error('Error al procesar formulario:', error);
                alert('Error al procesar el formulario');
            }
        }
        
        // Funci√≥n para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('forma_material').selectedIndex = 0;
            document.getElementById('cliente').selectedIndex = 0;
            document.getElementById('codigoMaterialOriginal').value = '';
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 0;
            
            // Restablecer fechas a hoy
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha_recibo').value = hoy;
            document.getElementById('fecha_fabricacion').value = hoy;
            
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            
            // El contador secuencial se recarga desde BD despu√©s de cada guardado exitoso
            console.log('Formulario limpiado. Pr√≥ximo n√∫mero secuencial ser√°:', String(contadorSecuencial).padStart(4, '0'));
        }
        
        // Funci√≥n para consultar registros
        function consultarRegistros() {
            console.log('üîÑ === CONSULTANDO REGISTROS ===');
            
            const fechaInicio = document.getElementById('filtro_fecha_inicio').value;
            const fechaFin = document.getElementById('filtro_fecha_fin').value;
            
            console.log('üìÖ Filtros:', { fechaInicio, fechaFin });
            
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.disabled = true;
                btnConsultar.textContent = 'Consultando...';
            }
            
            // Construir URL con par√°metros
            let url = '/consultar_control_almacen';
            const params = new URLSearchParams();
            
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            console.log('üåê URL de consulta:', url);
            
            // Mostrar mensaje de carga
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="loading-message" style="text-align: center; padding: 25px; color: #3498db; font-size: 14px;">
                            <div class="spinner-border text-primary" role="status" style="width: 1.5rem; height: 1.5rem; margin-right: 10px;">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            Cargando registros...
                        </td>
                    </tr>
                `;
            }
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log('üì° Respuesta recibida:');
                    console.log('  - Status:', response.status);
                    console.log('  - Status Text:', response.statusText);
                    console.log('  - Content-Type:', response.headers.get('content-type'));
                    console.log('  - URL:', response.url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                    }
                    
                    // Verificar si la respuesta es JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        console.log('‚úÖ Respuesta es JSON v√°lida');
                        return response.json();
                    } else {
                        console.error('‚ùå Respuesta NO es JSON:', contentType);
                        throw new Error('Respuesta no es JSON - posible redirecci√≥n a login');
                    }
                })
                .then(data => {
                    console.log('üìä === DATOS PARSEADOS ===');
                    console.log('Tipo:', typeof data);
                    console.log('Es array:', Array.isArray(data));
                    console.log('Datos completos:', data);
                    
                    if (Array.isArray(data)) {
                        console.log(`‚úÖ Array v√°lido con ${data.length} elementos`);
                        cargarDatosEnTabla(data);
                    } else if (data && data.error) {
                        console.error('‚ùå Error del servidor:', data.error);
                        alert('Error del servidor: ' + data.error);
                    } else {
                        console.error('‚ùå Respuesta inv√°lida:', data);
                        alert('Respuesta inv√°lida del servidor');
                    }
                })
                .catch(error => {
                    console.error('‚ùå === ERROR EN FETCH ===');
                    console.error('Error completo:', error);
                    console.error('Mensaje:', error.message);
                    
                    if (error.message.includes('login') || error.message.includes('autenticado')) {
                        console.log('üîí Error de autenticaci√≥n detectado');
                        alert('Sesi√≥n expirada. Redirigiendo al login...');
                        window.location.href = '/login';
                    } else {
                        console.log('üîß Error general de red/servidor');
                        alert('Error al consultar registros: ' + error.message);
                        
                        // Mostrar mensaje de error en la tabla
                        const tbody = document.querySelector('table tbody');
                        if (tbody) {
                            tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 20px; color: red;">
                                ‚ùå Error al cargar datos: ${error.message}<br>
                                <button onclick="consultarRegistros()" style="margin-top: 10px; padding: 5px 10px;">Reintentar</button>
                            </td></tr>`;
                        }
                    }
                })
                .finally(() => {
                    console.log('üèÅ Finalizando consulta...');
                    if (btnConsultar) {
                        btnConsultar.disabled = false;
                        btnConsultar.textContent = 'Consultar';
                    }
                });
        }
        
        // Funci√≥n para cargar datos en la tabla
        function cargarDatosEnTabla(datos) {
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            if (!tbody) {
                console.error('No se encontr√≥ el tbody de la tabla');
                return;
            }
            
            // Limpiar la tabla
            tbody.innerHTML = '';
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="no-data">No hay registros disponibles</td>
                    </tr>
                `;
                actualizarTotalRows(0);
                return;
            }
            
            // Crear filas para cada registro
            datos.forEach((item) => {
                const row = tbody.insertRow();
                
                row.insertCell(0).textContent = item.codigo_material_recibido || '-';
                row.insertCell(1).textContent = item.codigo_material_final || item.codigo_material || '-';
                row.insertCell(2).textContent = item.numero_parte || '-';
                row.insertCell(3).textContent = item.numero_lote_material || '-';
                row.insertCell(4).textContent = item.propiedad_material || '-';
                row.insertCell(5).textContent = item.cantidad_actual || '-';
                row.insertCell(6).textContent = item.cantidad_estandarizada || '-';
                row.insertCell(7).textContent = item.ubicacion_salida || 'Pendiente'; // Pendiente para futura integraci√≥n
                row.insertCell(8).textContent = item.fecha_recibo || '-';
                // Mostramos "propiedad de material" en la columna "Especificaci√≥n"
                row.insertCell(9).textContent = item.propiedad_material || '-';
                row.insertCell(10).textContent = item.material_importacion_local || '-';
                
                // Crear checkbox para estado de desecho
                const estadoDesechodCheckbox = `<input type="checkbox" ${(item.estado_desecho === 1 || item.estado_desecho === '1' || item.estado_desecho === true) ? 'checked' : ''} onchange="actualizarEstadoDesecho('${item.id}', this.checked)">`;
                row.insertCell(11).innerHTML = estadoDesechodCheckbox;
            });
            
            actualizarTotalRows(datos.length);
        }
        
        function actualizarTotalRows(count) {
            const totalInfo = document.querySelector('.total-info');
            if (totalInfo) {
                totalInfo.textContent = `Total Rows: ${count}`;
            }
        }
        
        // Funci√≥n para actualizar estado de desecho
        function actualizarEstadoDesecho(id, estadoDesecho) {
            console.log('Actualizando estado de desecho:', id, estadoDesecho);
            
            fetch('/actualizar_estado_desecho_almacen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                    estado_desecho: estadoDesecho
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Estado de desecho actualizado correctamente');
                    showMessage('Estado de desecho actualizado correctamente', 'success');
                } else {
                    console.error('Error al actualizar estado de desecho:', data.error);
                    showMessage('Error: ' + data.error, 'error');
                    // Revertir el checkbox si hubo error
                    const checkboxes = document.querySelectorAll(`input[onchange*="${id}"][onchange*="actualizarEstadoDesecho"]`);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = !estadoDesecho;
                    });
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                showMessage('Error de conexi√≥n', 'error');
                // Revertir el checkbox si hubo error
                const checkboxes = document.querySelectorAll(`input[onchange*="${id}"][onchange*="actualizarEstadoDesecho"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !estadoDesecho;
                });
            });
        }

        // La tabla permanece vac√≠a hasta que el usuario haga clic en "Consultar"
    </script>