<style>
/* Specific styles for Control de Salida layout */
.salida-container {
    background-color: #32323E;
    color: lightgray;
    padding: 15px;
    font-size: 12px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* Updated Grid Layout */
.salida-form-grid {
    display: grid;
    /* Using 6 columns for precise alignment */
    grid-template-columns: repeat(6, 1fr);
    gap: 10px 15px;
    background-color: #40424F;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
    align-items: end; /* Align items to the bottom of their cell */
}

.salida-form-group {
    display: flex;
    flex-direction: column;
}

.salida-form-group label {
    margin-bottom: 5px;
    font-weight: 500;
}

.salida-form-group input[type="text"],
.salida-form-group input[type="date"],
.salida-form-group select {
    padding: 6px 8px;
    font-size: 12px;
    height: 28px;
    box-sizing: border-box;
}

/* Column Span Helpers */
.g-col-span-1 { grid-column: span 1; }
.g-col-span-2 { grid-column: span 2; }
.g-col-span-3 { grid-column: span 3; }
.g-col-span-4 { grid-column: span 4; }

.checkbox-group {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
    height: 100%; /* Ensure it takes full cell height */
    padding-bottom: 5px; /* Align with input fields */
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.button-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.salida-btn {
    border: none;
    padding: 6px 12px;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    font-size: 12px;
    transition: background-color 0.3s;
    height: 28px;
}

.salida-btn.reiniciar {
    background-color: #95a5a6;
    color: white;
}
.salida-btn.reiniciar:hover {
    background-color: #7f8c8d;
}

.salida-btn.guardar {
    background-color: #e67e22;
    color: white;
}
.salida-btn.guardar:hover {
    background-color: #d35400;
}

.salida-tabs {
    margin-bottom: 10px;
}

.salida-tab-btn {
    background-color: #40424F;
    color: lightgray;
    border: 1px solid #2c3e50;
    border-bottom: none;
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 4px 4px 0 0;
    margin-right: 5px;
    font-size: 12px;
}

.salida-tab-btn.active {
    background-color: #3498db;
    color: white;
    border-color: #3498db;
}

.salida-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.salida-tables-container {
    display: flex;
    gap: 15px;
    flex-grow: 1;
}

.salida-table-wrapper {
    flex: 1;
    background-color: #40424F;
    padding: 10px;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
}

.salida-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

.salida-table th,
.salida-table td {
    border: 1px solid #2c3e50;
    padding: 6px;
    text-align: center;
    white-space: nowrap;
}

.salida-table th {
    background-color: #2c3e50;
    color: #ecf0f1;
    position: sticky;
    top: 0;
}

.salida-table td {
    background-color: #44475A;
}

.salida-table .no-data {
    height: 200px;
    text-align: center;
    vertical-align: middle;
    color: #95a5a6;
}

/* Historial de Salida Styles */
#historial-salida-content {
    display: none; /* Hidden by default */
    flex-direction: column;
    flex-grow: 1;
}

.historial-filter-bar {
    background-color: #40424F;
    padding: 8px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-bottom: 2px solid #3498db;
}

.historial-filter-bar label {
    font-weight: 500;
}

.historial-filter-bar input[type="date"],
.historial-filter-bar input[type="text"] {
    height: 28px;
    font-size: 12px;
    padding: 6px 8px;
}

.historial-filter-bar .salida-btn {
    height: 28px;
    padding: 0 15px;
}

.historial-filter-bar .consultar {
    background-color: #3498db;
    color: white;
}
.historial-filter-bar .consultar:hover {
    background-color: #2980b9;
}

.historial-filter-bar .exportar {
    background-color: #27ae60;
    color: white;
}
.historial-filter-bar .exportar:hover {
    background-color: #219a52;
}

.historial-table-container {
    background-color: #40424F;
    padding: 10px;
    border-radius: 4px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow-x: auto;
}

.total-rows {
    margin-top: 10px;
    font-size: 12px;
    text-align: right;
    padding-right: 5px;
}
</style>

<div class="salida-container">
    <!-- Form Grid -->
    <div class="salida-form-grid">
        <!-- Row 1 -->
        <div class="salida-form-group g-col-span-2">
            <label for="numero_lote">N√∫mero de lote:</label>
            <input type="text" id="numero_lote">
        </div>
        <div class="salida-form-group g-col-span-2">
            <label for="modelo">Modelo:</label>
            <select id="modelo"><option>Seleccionar</option></select>
        </div>
        <div class="salida-form-group g-col-span-2">
            <label for="depto_salida">Departamento de salida:</label>
            <select id="depto_salida"><option>Seleccionar</option></select>
        </div>

        <!-- Row 2 -->
        <div class="salida-form-group g-col-span-2">
            <label for="codigo_recibido">C√≥digo de material recibido:</label>
            <input type="text" id="codigo_recibido">
        </div>
        <div class="checkbox-group g-col-span-1">
            <label><input type="checkbox"> Verificaci√≥n de BOM</label>
            <label><input type="checkbox"> Validaci√≥n de c√≥digo original</label>
        </div>
        <div class="checkbox-group g-col-span-1">
             <label><input type="checkbox"> PEPS</label>
        </div>
        <div class="salida-form-group g-col-span-1">
            <label for="proceso_salida">Proceso de salida:</label>
            <select id="proceso_salida"><option>Seleccionar</option></select>
        </div>
        <div class="button-group g-col-span-1">
            <button class="salida-btn reiniciar">Reiniciar</button>
        </div>

        <!-- Row 3 -->
        <div class="salida-form-group g-col-span-2">
            <label for="codigo_original">C√≥digo de material original:</label>
            <input type="text" id="codigo_original" style="background-color: #004080 !important; color: white !important; border-color: #004080 !important;">
        </div>
        <div class="g-col-span-3">
            <!-- Empty cell for alignment -->
        </div>
        <div class="button-group g-col-span-1">
            <button class="salida-btn guardar">Guardar</button>
        </div>
        
        <!-- Row 4 -->
        <div class="salida-form-group g-col-span-2">
            <label for="disp_codigo_material">C√≥digo de material:</label>
            <input type="text" id="disp_codigo_material" readonly>
        </div>
        <div class="salida-form-group g-col-span-4">
            <label for="disp_especificacion">Especificaci√≥n de material:</label>
            <input type="text" id="disp_especificacion" readonly>
        </div>

        <!-- Row 5 -->
        <div class="salida-form-group g-col-span-2">
            <label for="disp_numero_parte">N√∫mero de parte:</label>
            <input type="text" id="disp_numero_parte" readonly>
        </div>
        <div class="salida-form-group g-col-span-2">
            <label for="disp_cantidad_actual">Cantidad actual:</label>
            <input type="text" id="disp_cantidad_actual" readonly>
        </div>
        <div class="salida-form-group g-col-span-2">
            <label for="disp_lote_material">N√∫mero de lote de material:</label>
            <input type="text" id="disp_lote_material" readonly>
        </div>
    </div>

    <!-- Tabs -->
    <div class="salida-tabs">
        <button id="tab-registro" class="salida-tab-btn active" data-target="registro-salida-content">Registro de salida</button>
        <button id="tab-historial" class="salida-tab-btn" data-target="historial-salida-content">Historial de salida</button>
    </div>

    <!-- Tab Content -->
    <div id="registro-salida-content" class="salida-content" style="display: flex;">
        <div class="salida-tables-container">
            <!-- Left Table -->
            <div class="salida-table-wrapper">
                <table class="salida-table">
                    <thead>
                        <tr>
                            <th>Proceso</th>
                            <th>C√≥digo de material</th>
                            <th>N√∫mero de parte</th>
                            <th>Cantidad de salida</th>
                            <th>Cantidad total</th>
                            <th>Propiedad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="no-data">No hay dato registrado</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Right Table -->
            <div class="salida-table-wrapper">
                <table class="salida-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>C√≥digo de material</th>
                            <th>N√∫mero de parte</th>
                            <th>Cantidad</th>
                            <th>N√∫mero de lote</th>
                            <th>Propiedad</th>
                            <th>Nivel</th>
                            <th>Especificaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="no-data">No hay dato registrado</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historial-salida-content" class="salida-content">
        <!-- Filter Bar -->
        <div class="historial-filter-bar">
            <label for="fecha_salida_inicio">Fecha de salida</label>
            <input type="date" id="fecha_salida_inicio">
            <span>~</span>
            <input type="date" id="fecha_salida_fin">
            <label for="historial_num_lote" style="margin-left: 10px;">Num. de lote</label>
            <input type="text" id="historial_num_lote">
            <button class="salida-btn consultar" style="margin-left: auto;">Consultar</button>
            <button class="salida-btn exportar">Exportar el excel</button>
        </div>
        <!-- History Table -->
        <div class="historial-table-container">
            <table class="salida-table">
                <thead>
                    <tr>
                        <th>Fecha de salida</th>
                        <th>Proceso de salida</th>
                        <th>C√≥digo de material recibido</th>
                        <th>C√≥digo de material</th>
                        <th>N√∫mero de parte</th>
                        <th>Disp.</th>
                        <th>Hist.</th>
                        <th>C√≥digo de material original</th>
                        <th>N√∫mero de lote</th>
                        <th>M√°quina(L√≠nea)</th>
                        <th>Departamento de...</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="11" class="no-data">No hay dato registrado</td></tr>
                </tbody>
            </table>
        </div>
        <div class="total-rows">
            Total Rows: 0
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // === ESTABLECER FECHAS DE HOY ===
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_salida_inicio').value = today;
    document.getElementById('fecha_salida_fin').value = today;

    const tabButtons = document.querySelectorAll('.salida-tab-btn');
    const tabContents = document.querySelectorAll('.salida-content');
    const formGrid = document.querySelector('.salida-form-grid');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Deactivate all buttons and hide all content
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.style.display = 'none');

            // Activate the clicked button
            this.classList.add('active');

            // Show/hide the main form based on the selected tab
            const targetId = this.getAttribute('data-target');
            if (targetId === 'historial-salida-content') {
                formGrid.style.display = 'none';
            } else {
                formGrid.style.display = 'grid';
            }
            
            // Show the target content
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.style.display = 'flex'; // Use flex for proper layout
            }
        });
    });

    // === NUEVO: Autocompletar datos al ingresar c√≥digo de material recibido ===
    const codigoRecibidoInput = document.getElementById('codigo_recibido');
    if (codigoRecibidoInput) {
        console.log('‚úÖ Campo codigo_recibido encontrado y configurado');
        
        // Funci√≥n para buscar el c√≥digo
        async function buscarCodigoRecibido() {
            const codigo = codigoRecibidoInput.value.trim();
            console.log(`üîç Buscando c√≥digo: "${codigo}"`);
            
            if (!codigo) {
                console.log('‚ö†Ô∏è C√≥digo vac√≠o, no se ejecuta b√∫squeda');
                return;
            }
            
            console.log('üì° Enviando petici√≥n al servidor...');
            
            try {
                const url = `/buscar_codigo_recibido?codigo_material_recibido=${encodeURIComponent(codigo)}`;
                console.log(`üåê URL: ${url}`);
                
                // Buscar en la base de datos de entradas (control_material_almacen)
                const response = await fetch(url);
                console.log(`üì° Respuesta del servidor: Status ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Datos recibidos:', data);
                    
                    if (data.success && data.registro) {
                        console.log('‚úÖ C√≥digo encontrado, llenando campos...');
                        
                        // Autocompletar los campos con la informaci√≥n encontrada
                        document.getElementById('numero_lote').value = data.registro.numero_lote_material || '';
                        document.getElementById('codigo_original').value = data.registro.codigo_material_original || '';
                        document.getElementById('disp_codigo_material').value = data.registro.codigo_material || '';
                        document.getElementById('disp_especificacion').value = data.registro.especificacion || '';
                        document.getElementById('disp_numero_parte').value = data.registro.numero_parte || '';
                        document.getElementById('disp_cantidad_actual').value = data.registro.cantidad_actual || '';
                        document.getElementById('disp_lote_material').value = data.registro.numero_lote_material || '';
                        
                        console.log('üìù Campos llenados correctamente');
                        
                        // Resaltar campos que se llenaron autom√°ticamente
                        const campos = ['numero_lote', 'codigo_original', 'disp_codigo_material', 'disp_especificacion', 'disp_numero_parte', 'disp_cantidad_actual', 'disp_lote_material'];
                        campos.forEach(id => {
                            const campo = document.getElementById(id);
                            if (campo && campo.value) {
                                campo.style.backgroundColor = '#d4edda';
                                campo.style.borderColor = '#c3e6cb';
                                setTimeout(() => {
                                    campo.style.backgroundColor = '';
                                    campo.style.borderColor = '';
                                }, 3000);
                            }
                        });
                        
                        // Mostrar mensaje de √©xito
                        console.log('‚úÖ Autocompletado exitoso');
                        alert('C√≥digo encontrado y campos completados autom√°ticamente');
                    } else {
                        console.log('‚ùå C√≥digo no encontrado en respuesta');
                        // Si no se encuentra, mostrar mensaje
                        alert('C√≥digo de material recibido no encontrado en el almac√©n');
                        // Limpiar los campos
                        document.getElementById('numero_lote').value = '';
                        document.getElementById('codigo_original').value = '';
                        document.getElementById('disp_codigo_material').value = '';
                        document.getElementById('disp_especificacion').value = '';
                        document.getElementById('disp_numero_parte').value = '';
                        document.getElementById('disp_cantidad_actual').value = '';
                        document.getElementById('disp_lote_material').value = '';
                    }
                } else {
                    console.error(`‚ùå Error del servidor: ${response.status}`);
                    const errorText = await response.text();
                    console.error('Error text:', errorText);
                    alert(`Error del servidor: ${response.status}`);
                }
            } catch (error) {
                console.error('üí• Error al buscar c√≥digo recibido en almacen:', error);
                alert('Error al buscar el c√≥digo en la base de datos');
            }
        }
        
        // Evento para cuando se pierde el foco del campo (change)
        codigoRecibidoInput.addEventListener('change', function() {
            console.log('üéØ Evento "change" activado');
            buscarCodigoRecibido();
        });
        
        // Evento para cuando se presiona Enter
        codigoRecibidoInput.addEventListener('keypress', function(event) {
            console.log(`‚å®Ô∏è Tecla presionada: ${event.key}`);
            if (event.key === 'Enter') {
                console.log('üéØ Enter presionado, ejecutando b√∫squeda');
                event.preventDefault();
                buscarCodigoRecibido();
            }
        });
        
        // Evento adicional para input (detecta cualquier cambio mientras escribe)
        codigoRecibidoInput.addEventListener('input', function() {
            console.log('üìù Contenido del campo cambi√≥:', this.value);
        });
        
    } else {
        console.error('‚ùå Campo codigo_recibido NO encontrado en el DOM');
    }

    // === GUARDAR SALIDA DE LOTE ===
    const btnGuardar = document.querySelector('.salida-btn.guardar');
    if (btnGuardar) {
        btnGuardar.addEventListener('click', async function() {
            // Recopilar datos del formulario
            const codigo_material_recibido = document.getElementById('codigo_recibido').value.trim();
            const numero_lote = document.getElementById('numero_lote').value.trim();
            const modelo = document.getElementById('modelo').value;
            const depto_salida = document.getElementById('depto_salida').value;
            const proceso_salida = document.getElementById('proceso_salida').value;
            const cantidad_salida = document.getElementById('disp_cantidad_actual').value;
            
            // Validaciones
            if (!codigo_material_recibido) {
                alert('Debes ingresar el c√≥digo de material recibido');
                return;
            }
            
            if (!cantidad_salida || parseFloat(cantidad_salida) <= 0) {
                alert('La cantidad de salida debe ser mayor a 0');
                return;
            }
            
            // Fecha de salida: usa hoy por defecto
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fecha_salida = `${year}-${month}-${day}`;
            
            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';
            
            try {
                const response = await fetch('/guardar_salida_lote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido,
                        numero_lote,
                        modelo,
                        depto_salida,
                        proceso_salida,
                        cantidad_salida,
                        fecha_salida
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Salida registrada exitosamente');
                    // Limpiar formulario
                    limpiarFormularioSalida();
                    // Si estamos en el tab de historial, actualizar la tabla
                    if (document.getElementById('tab-historial').classList.contains('active')) {
                        consultarHistorialSalidas();
                    }
                } else {
                    alert('Error al registrar salida: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n al guardar salida');
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.textContent = 'Guardar';
            }
        });
    }
    
    // === CONSULTAR HISTORIAL DE SALIDAS ===
    const btnConsultarHistorial = document.querySelector('.historial-filter-bar .consultar');
    if (btnConsultarHistorial) {
        btnConsultarHistorial.addEventListener('click', consultarHistorialSalidas);
    }
    
    // === FUNCI√ìN PARA LIMPIAR FORMULARIO ===
    function limpiarFormularioSalida() {
        document.getElementById('numero_lote').value = '';
        document.getElementById('codigo_recibido').value = '';
        document.getElementById('codigo_original').value = '';
        document.getElementById('disp_codigo_material').value = '';
        document.getElementById('disp_especificacion').value = '';
        document.getElementById('disp_numero_parte').value = '';
        document.getElementById('disp_cantidad_actual').value = '';
        document.getElementById('disp_lote_material').value = '';
        // Resetear selects a primera opci√≥n
        document.getElementById('modelo').selectedIndex = 0;
        document.getElementById('depto_salida').selectedIndex = 0;
        document.getElementById('proceso_salida').selectedIndex = 0;
    }
    
    // === FUNCI√ìN PARA CONSULTAR HISTORIAL ===
    async function consultarHistorialSalidas() {
        const fechaInicio = document.getElementById('fecha_salida_inicio').value;
        const fechaFin = document.getElementById('fecha_salida_fin').value;
        const numeroLote = document.getElementById('historial_num_lote').value.trim();
        
        const params = new URLSearchParams();
        if (fechaInicio) params.append('fecha_inicio', fechaInicio);
        if (fechaFin) params.append('fecha_fin', fechaFin);
        if (numeroLote) params.append('numero_lote', numeroLote);
        
        try {
            const response = await fetch(`/consultar_historial_salidas?${params.toString()}`);
            if (response.ok) {
                const data = await response.json();
                cargarHistorialEnTabla(data);
            } else {
                console.error('Error al consultar historial');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
    
    // === FUNCI√ìN PARA CARGAR HISTORIAL EN TABLA ===
    function cargarHistorialEnTabla(datos) {
        const tbody = document.querySelector('#historial-salida-content .salida-table tbody');
        tbody.innerHTML = '';
        
        if (!datos || datos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="no-data">No hay registros de salida</td></tr>';
            document.querySelector('.total-rows').textContent = 'Total Rows: 0';
            return;
        }
        
        datos.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.fecha_salida || ''}</td>
                <td>${item.proceso_salida || ''}</td>
                <td>${item.codigo_material_recibido || ''}</td>
                <td>${item.codigo_material || ''}</td>
                <td>${item.numero_parte || ''}</td>
                <td>${item.disp || ''}</td>
                <td>${item.hist || ''}</td>
                <td>${item.codigo_material_original || ''}</td>
                <td>${item.numero_lote || ''}</td>
                <td>${item.maquina_linea || ''}</td>
                <td>${item.departamento || ''}</td>
            `;
            tbody.appendChild(row);
        });
        
        document.querySelector('.total-rows').textContent = `Total Rows: ${datos.length}`;
    }
    
    // === BOT√ìN REINICIAR ===
    const btnReiniciar = document.querySelector('.salida-btn.reiniciar');
    if (btnReiniciar) {
        btnReiniciar.addEventListener('click', limpiarFormularioSalida);
    }
});
</script>