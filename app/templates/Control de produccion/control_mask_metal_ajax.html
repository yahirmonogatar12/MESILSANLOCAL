<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Metal Mask — Cuadrícula Vacía + Registrar</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/control_metal_mask.css') }}">
</head>
<body>
<div id="mm-app" data-module="metal-mask">
  <div id="mm-topbar" role="region" aria-label="Toolbar">
    <h1>Estado de Desuso</h1>
    <div id="mm-filter">
      <select id="mm-disuse" aria-label="Filtro de Desuso">
        <option value="ALL" selected>Todos</option><option value="Uso">Uso</option><option value="Desuso">Desuso</option><option value="Scrap">Scrap</option>
      </select>
      <button class="mm-btn" id="mm-btn-search">Buscar</button>
    </div>
    <button class="mm-btn mm-btn-primary" id="mm-btn-open">Registrar</button>
    <button class="mm-btn" id="mm-btn-export">Exportar Excel</button>
    <button class="mm-btn" id="mm-btn-import" title="Sube un .xlsx/.csv desde tu backend">Registrar Excel</button>
  </div>
  <section id="mm-grid-wrap" aria-label="Grid">
    <div id="mm-grid-scroll">
      <table id="mm-grid">
        <thead><tr>
          <th style="min-width:160px">Número de Gestión</th>
          <th style="min-width:110px">Caja de Almacenamiento</th>
          <th style="min-width:110px">Código PCB</th>
          <th style="min-width:90px">Lado</th>
          <th style="min-width:130px">Fecha de Producción</th>
          <th class="mm-num" style="min-width:95px">Conteo Usado</th>
          <th class="mm-num" style="min-width:95px">Conteo Máximo</th>
          <th class="mm-num" style="min-width:120px">Porcentaje(%)</th>
          <th class="mm-num" style="min-width:95px">Tolerancia</th>
          <th style="min-width:220px">Nombre del Modelo</th>
          <th class="mm-num" style="min-width:110px">Tensión(Mín)</th>
          <th class="mm-num" style="min-width:110px">Tensión(Máx)</th>
          <th class="mm-num" style="min-width:110px">Grosor</th>
          <th style="min-width:140px">Proveedor</th>
          <th style="min-width:170px">Fecha de Registro</th>
          <th style="min-width:90px">Desuso</th>
        </tr></thead>
        <tbody id="mm-grid-body"></tbody>
      </table>
    </div>
    <div id="mm-footer"><span id="mm-total">Total de Filas : 0</span>
  </section>
</div>
<aside id="mm-drawer" aria-hidden="true" aria-label="Register panel">
  <header><strong id="mm-drawer-title">Gestión de Metal Mask — Registrar</strong><button class="mm-btn" id="mm-btn-close" aria-label="Cerrar">✕</button></header>
  <form id="mm-form">
    <div class="mm-field"><label for="mm-management_no">Número de Gestión</label><input id="mm-management_no" class="mm-input" placeholder="EBR420050-01-T01" required /></div>
    <div class="mm-field"><label for="mm-storage_box">Caja de Almacenamiento</label><div class="mm-row"><input id="mm-storage_box" class="mm-input" placeholder="NO02-003" readonly /><button type="button" class="mm-btn" onclick="openStorageModal()">Elegir</button></div></div>
    <div class="mm-field"><label for="mm-pcb_code">Código PCB</label><input id="mm-pcb_code" class="mm-input" placeholder="MAIN_PCB / KEY_PCB / KNOB_PCB" /></div>
    <div class="mm-field"><label for="mm-side">Lado</label><select id="mm-side" class="mm-select"><option value="">Elegir</option><option value="TOP">Superior</option><option value="BOT">Inferior</option><option value="SINGLE">Único</option></select></div>
    <div class="mm-field"><label for="mm-prod_date">Fecha de Producción</label><input id="mm-prod_date" type="date" class="mm-input" /></div>
    <div class="mm-row">
      <div class="mm-field"><label for="mm-max_count">Conteo Máximo</label><input id="mm-max_count" type="number" min="0" step="1" class="mm-input" value="50000" /></div>
      <div class="mm-field"><label for="mm-allowance">Tolerancia</label><input id="mm-allowance" type="number" min="0" step="1" class="mm-input" value="0" /></div>
    </div>
    <div class="mm-field"><label for="mm-model_name">Nombre del Modelo</label><input id="mm-model_name" class="mm-input" placeholder="Hyundai Mobis ... / 루팡Good Refresh ..." /></div>
    <div class="mm-row">
      <div class="mm-field"><label for="mm-tension_min">Tensión(Mín)</label><input id="mm-tension_min" type="number" step="0.01" min="0" class="mm-input" value="0.20" /></div>
      <div class="mm-field"><label for="mm-tension_max">Tensión(Máx)</label><input id="mm-tension_max" type="number" step="0.01" min="0" class="mm-input" value="0.40" /></div>
    </div>
    <div class="mm-field"><label for="mm-thickness">Grosor</label><input id="mm-thickness" type="number" step="0.01" min="0" class="mm-input" value="0.13" /></div>
    <div class="mm-field"><label for="mm-supplier">Proveedor</label><input id="mm-supplier" class="mm-input" placeholder="JTEC / ..." /></div>
    <div class="mm-field"><label for="mm-disuse">Desuso</label><select id="mm-disuse-input" class="mm-select"><option value="Uso" selected>Uso</option><option value="Desuso">Desuso</option><option value="Scrap">Scrap</option></select></div>
    <input id="mm-used_count" type="hidden" value="0" />
  </form>
  <div id="mm-actions"><button class="mm-btn" id="mm-btn-reset" type="button">Limpiar</button><button class="mm-btn mm-btn-success" id="mm-btn-save" type="button">Registrar</button></div>
</aside>
<div id="mm-toast" role="status">Guardado</div>
<div id="mm-loading" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:var(--mm-panel); color:var(--mm-text); padding:20px; border-radius:10px; border:1px solid var(--mm-border);">Cargando...</div>
</div>

<!-- Storage Choice Modal -->
<div id="mm-storage-modal">
  <div class="mm-storage-content">
    <div class="mm-storage-header">
      <h2>Elegir Caja de Almacenamiento (Solo Disponibles)</h2>
      <button class="mm-storage-close" onclick="closeStorageModal()">×</button>
    </div>
    <div class="mm-storage-search">
      <input type="text" id="mm-storage-search" placeholder="Buscar por número de gestión, código o nombre..." oninput="filterStorageBoxes()">
    </div>
    <div class="mm-storage-table-wrap">
      <table class="mm-storage-table">
        <thead>
          <tr>
            <th>Número de Gestión</th>
            <th>Code</th>
            <th>Name</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="mm-storage-tbody">
        </tbody>
      </table>
    </div>
    <div class="mm-storage-actions">
      <button class="mm-btn" onclick="closeStorageModal()">Close</button>
      <button class="mm-btn mm-btn-primary" onclick="saveStorageChoice()">Save</button>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='js/MetalMask.js') }}"></script></body></html>
