<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ilsan Electronics</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Ejecuci√≥n de Manufactura para Ilsan Electronics">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ISEMM MES">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ISEMM MES">
    <meta name="msapplication-TileColor" content="#32323E">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../static/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../static/logo.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="shortcut icon" href="../static/logo.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Font LG Regular - COMENTADO: Problema MIME -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yahirmonogatari/lg-fonts/lg-regular.css"> -->
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/styleHeader.css">
    <link rel="stylesheet" href="/static/css/responsive-mobile.css">
    
    <style>
        /* ESTILOS ESPEC√çFICOS PARA PREVENIR PROBLEMAS DE DROPDOWN */
        .dropdown-menu {
            /* Prevenir que se abra autom√°ticamente */
            display: none !important;
        }
        
        .dropdown-menu.show {
            display: block !important;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* PREVENIR ANIMACIONES CONFLICTIVAS */
        .collapse.collapsing {
            transition: none !important;
        }
        
        /* ASEGURAR QUE LOS DROPDOWNS CERRADOS PERMANEZCAN CERRADOS */
        .collapse:not(.show) {
            display: none !important;
        }
        
        .collapse.show {
            display: block !important;
        }
        
        /* BOTONES DE DROPDOWN MEJORADOS */
        .btn[data-bs-toggle="collapse"]:after {
            content: '‚ñº';
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        
        .btn[data-bs-toggle="collapse"][aria-expanded="true"]:after {
            transform: rotate(180deg);
        }
        
        /* PREVENIR MULTIPLE ANIMACIONES EN COLLAPSE */
        [data-bs-toggle="collapse"] {
            pointer-events: auto;
        }
        
        [data-bs-toggle="collapse"].disabled {
            pointer-events: none;
        }
        
        /* BOT√ìN DE LOGOUT FIJO EN LA ESQUINA SUPERIOR DERECHA */
        .logout-button-fixed {
            position: fixed;
            top: 30px;
            right: 15px;
            z-index: 9999;
            background: linear-gradient(135deg, #833c0d 0%, #6d3010 100%);
            border: 2px solid #833c0d;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(131, 60, 13, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .logout-button-fixed:hover {
            background: linear-gradient(135deg, #6d3010 0%, #5a2708 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(131, 60, 13, 0.4);
            color: white;
        }
        
        .logout-button-fixed i {
            font-size: 16px;
        }
        
        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .logout-button-fixed {
                top: 35px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .logout-button-fixed i {
                font-size: 14px;
            }
        }
        
        /* ESTILOS PARA TABLA DE SALIDAS MEJORADA */
        .material-table {
            width: 100%;
        }
        
        .material-table th,
        .material-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Columna de c√≥digo original m√°s peque√±a */
        .material-table th:nth-child(7),
        .material-table td:nth-child(7) {
            max-width: 100px;
            width: 120px;
        }
        
        /* Tooltip hover effect */
        .material-table td[title]:hover {
            background-color: #f8f9fa;
            cursor: help;
        }

        /* ESTILOS PARA DROPDOWN DE MODELOS - CONTROL DE MODELOS */
        .bom-search-container {
            position: relative;
            display: inline-block;
        }

        .bom-search-dropdown {
            background-color: #34495e;
            color: #ecf0f1;
            border: 2px solid #2c3e50;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            min-width: 300px;
            transition: border-color 0.3s;
            font-weight: 500;
        }

        .bom-search-dropdown:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background-color: #2c3e50;
        }

        .bom-search-dropdown::placeholder {
            color: #95a5a6;
            font-style: italic;
        }

        .bom-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #2c3e50;
            border: 1px solid #34495e;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .bom-dropdown-item {
            padding: 8px 10px;
            color: lightgray;
            cursor: pointer;
            border-bottom: 1px solid #34495e;
            transition: background-color 0.2s;
            font-size: 11px;
        }

        .bom-dropdown-item:hover {
            background-color: #3498db;
            color: white;
        }

        .bom-dropdown-item:last-child {
            border-bottom: none;
        }

        .bom-dropdown-item.hidden {
            display: none;
        }

        .bom-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            background-color: #3C3940;
            border: #20688C 1px solid;
            color: white;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .bom-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
    </style>
    <!-- Deshabilitar logs de consola en producci√≥n -->
    <script>
       /* if (typeof console !== 'undefined') {
            console._log = console.log;
            console.log = function () {};
        }*/
    </script>

    <!-- Utilidades globales -->
    <script src="{{ url_for('static', filename='js/close-mobile-sidebar.js') }}"></script>
    <!-- Sistema de Permisos Dropdowns -->
    <script src="/static/js/permisos-dropdowns.js"></script>
    <!-- <script src="../static/js/permisos-botones.js"></script> COMENTADO: Versi√≥n con problemas -->
    <script src="/static/js/permisos-botones-simple.js"></script>
    <script src="/static/js/scriptMain.js"></script>
    
    <!-- Sistema de Gesti√≥n AJAX para Contenido Din√°mico -->
    <script src="{{ url_for('static', filename='js/ajax-content-manager.js') }}"></script>

    
</head>
<body>
    
    <div class="main-wrapper"></div>
    <header class="app-header">
        <div class="header-row">

            <!-- Logo y bienvenida a la izquierda -->
            <div class="container-logo-welcome-hamburguer">
            <div class="logo-welcome-container">    
                <img src="/static/logo.png" alt="Ilsan Electronics Logo" class="logo">
                <div class="welcome-text">
                    <span>Bienvenido,</span> {{ usuario }}
                                </div>
                
            </div>
            <!-- Hamburguesa solo visible en m√≥viles -->
            <div class="conatiner-hamburguer">
                <button class="hamburger-btn" id="menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
    
                </div>
            </div>
            
                    <!-- Botones de navegaci√≥n -->
            <div class="nav-buttons-container" id="nav-container">
                <button class="nav-button" id="Informaci√≥n Basica">
                    <img src="..\static\icons\info.png" class="icono-boton" alt="Informaci√≥n B√°sica">Informaci√≥n B√°sica
                </button>
                <button class="nav-button" id="Control de material">
                    <img src="..\static\icons\material.png" class="icono-boton" alt="Control de material">Control de material
                </button>
                <button class="nav-button" id="Control de producci√≥n">
                    <img src="..\static\icons\produccion.png" class="icono-boton" alt="Control de producci√≥n">Control de producci√≥n
                </button>
                <button class="nav-button" id="Control de proceso">
                    <img src="..\static\icons\proceso.png" class="icono-boton" alt="Control de proceso">Control de proceso
                </button>
                <button class="nav-button" id="Control de calidad">
                    <img src="..\static\icons\calidad.png" class="icono-boton" alt="Control de calidad">Control de calidad
                </button>
                <button class="nav-button" id="Control de resultados">
                    <img src="..\static\icons\resultados.png" class="icono-boton" alt="Control de resultados">Control de resultados
                </button>
                <button class="nav-button" id="Control de reporte">
                    <img src="..\static\icons\reporte.png" class="icono-boton" alt="Control de reporte">Control de reporte
                </button>
                <button class="nav-button" id="Configuraci√≥n de programa">
                    <img src="..\static\icons\configuracion.png" class="icono-boton" alt="Configuraci√≥n de programa">Configuraci√≥n de programa
                </button>
                {% if tiene_permisos_usuarios %}
                <button class="nav-button admin-only" onclick="window.location.href='/admin/panel'">
                    <img src="..\static\icons\engrane.png" class="icono-boton" alt="Panel de Administraci√≥n">Panel de Administraci√≥n
                </button>
                {% endif %}
            </div>
            
            <!-- Bot√≥n de logout posicionado absolutamente a la derecha -->
            <button class="logout-button-fixed" onclick="confirmarLogout()">
                <i class="fas fa-sign-out-alt"></i> Log out
            </button>
        </div>
    </header>

<div class="block-left col-md-3">
    
</div>

    <!-- Contenedor principal para el sidebar -->
<div class="main-content-container" id="material-container" style="display: none;">
    <div class="sidebar-content" id="sidebar-content">
        <div id="informacion-basica-content">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-material-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-produccion-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-proceso-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-calidad-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-resultados-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-reporte-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="configuracion-programa-content" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
    </div>
    
    <!-- Contenedor espec√≠fico para el contenido de Control de Material (LADO DERECHO) -->
    <div class="material-content-area" id="material-content-area" style="display: none;">
        <!-- Contenedor por defecto con informaci√≥n general -->
        <div id="material-info-container" style="display: block;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>

        <div id="control-salida-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-retorno-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="recibo-pago-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="historial-material-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="estatus-material-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="material-sustituto-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="consultar-peps-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="longterm-inventory-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="registro-material-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="historial-inventario-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="inventario-rollos-smd-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="ajuste-numero-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="control-almacen-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <div id="historial-cambio-smt-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
    </div>
    
    <!-- Contenedor espec√≠fico para el contenido de Control de Producci√≥n (LADO DERECHO) -->
    <div class="produccion-content-area" id="produccion-content-area" style="display: none;">
        <!-- Contenedor por defecto con informaci√≥n general -->
        <div id="produccion-info-container" style="display: block;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        
        <!-- Aqu√≠ se pueden agregar m√°s contenedores espec√≠ficos para Control de Producci√≥n -->
        <!-- Por ejemplo: -->
        <!-- <div id="control-embarque-container" style="display: none;"> -->
        <!--     El contenido se cargar√° din√°micamente con JavaScript -->
        <!-- </div> -->
    </div>
    
    <!-- Contenedor espec√≠fico para el contenido de Control de Proceso (LADO DERECHO) -->
    <div class="control-proceso-content-area" id="control-proceso-content-area" style="display: none;">
        <!-- Contenedor por defecto con informaci√≥n general -->
        <div id="control-proceso-info-container" style="display: block;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        <!-- Contenedor espec√≠fico para Control de producci√≥n SMT -->
        <div id="control-produccion-smt-container" style="display: none;">
            <!-- Contenedor espec√≠fico para Control de producci√≥n SMT AJAX -->
        </div>
        <div id="Control de produccion SMT-unique-container" style="display: none;">
                <!-- El contenido se cargar√° din√°micamente con AJAX -->
            </div>
        <div id="operacion-linea-smt-unique-container" style="display: none;">
                <!-- El contenido se cargar√° din√°micamente con AJAX -->
            </div>
        <div id="inventario-imd-terminado-unique-container" style="display: none;">
                <!-- El contenido se cargar√° din√°micamente con AJAX -->
            </div>
        <!-- Aqu√≠ se pueden agregar m√°s contenedores espec√≠ficos para Control de Proceso -->
        <!-- Por ejemplo: -->
        <!-- <div id="control-calidad-proceso-container" style="display: none;"> -->
        <!--     El contenido se cargar√° din√°micamente con JavaScript -->
        <!-- </div> -->
    </div>
    
    <!-- Contenedor espec√≠fico para el contenido de Informaci√≥n B√°sica (LADO DERECHO) -->
    <div class="informacion-basica-content-area" id="informacion-basica-content-area" style="display: none;">
        <!-- Contenedor por defecto con informaci√≥n general -->
        <div id="info-basica-default-container" style="display: block;">
            <h2>Informaci√≥n B√°sica</h2>
            <p>Seleccione una opci√≥n del men√∫ lateral para ver el contenido correspondiente.</p>
        </div>
        
        <!-- Contenedores para cada opci√≥n del sidebar de Informaci√≥n B√°sica -->
        <div id="admin-usuario-info-container" style="display: none;">
            <h2>Administracion de usuario</h2>
            <p>Contenido para Administracion de usuario - Por implementar</p>
        </div>
        
        <div id="admin-menu-info-container" style="display: none;">
            <h2>Administraci√≥n de men√∫</h2>
            <p>Contenido para Administraci√≥n de men√∫ - Por implementar</p>
        </div>
        
        <div id="admin-autoridad-info-container" style="display: none;">
            <h2>Administraci√≥n de autoridad</h2>
            <p>Contenido para Administraci√≥n de autoridad - Por implementar</p>
        </div>
        
        <div id="control-codigo-info-container" style="display: none;">
            <h2>Control de lista de c√≥digo</h2>
            <p>Contenido para Control de lista de c√≥digo - Por implementar</p>
        </div>
        
        <div id="admin-itinerario-info-container" style="display: none;">
            <h2>Administraci√≥n de itinerario</h2>
            <p>Contenido para Administraci√≥n de itinerario - Por implementar</p>
        </div>
        
        <div id="consultar-licencias-info-container" style="display: none;">
            <h2>Consultar licencias</h2>
            <p>Contenido para Consultar licencias - Por implementar</p>
        </div>
        
        <div id="control-departamento-info-container" style="display: none;">
            <h2>Control de departamento</h2>
            <p>Contenido para Control de departamento - Por implementar</p>
        </div>
        
        <div id="control-proceso-info-container" style="display: none;">
            <h2>Control de proceso</h2>
            <p>Contenido para Control de proceso - Por implementar</p>
        </div>
        
        <div id="control-orden-proceso-info-container" style="display: none;">
            <h2>Control de orden de proceso</h2>
            <p>Contenido para Control de orden de proceso - Por implementar</p>
        </div>
        
        <div id="control-orden-proceso2-info-container" style="display: none;">
            <h2>Control de orden de proceso 2</h2>
            <p>Contenido para Control de orden de proceso 2 - Por implementar</p>
        </div>
        
        <div id="control-defecto-info-container" style="display: none;">
            <h2>Control de defecto por proceso</h2>
            <p>Contenido para Control de defecto por proceso - Por implementar</p>
        </div>
        
        <div id="control-interfaces-info-container" style="display: none;">
            <h2>Control de interfaces de m√°quina</h2>
            <p>Contenido para Control de interfaces de m√°quina - Por implementar</p>
        </div>
        
        <div id="control-interlock-info-container" style="display: none;">
            <h2>Control de interlock de m√°quina en l√≠nea</h2>
            <p>Contenido para Control de interlock de m√°quina en l√≠nea - Por implementar</p>
        </div>
        
        <div id="control-material-info-container" style="display: none;">
            <!-- El contenido se cargar√° din√°micamente con JavaScript -->
        </div>
        
        <div id="configuracion-msl-info-container" style="display: none;">
            <h2>Configuraci√≥n de MSL</h2>
            <p>Contenido para Configuraci√≥n de MSL - Por implementar</p>
        </div>
        
        <div id="control-cliente-info-container" style="display: none;">
            <h2>Control de cliente</h2>
            <p>Contenido para Control de cliente - Por implementar</p>
        </div>
        
        <div id="control-proveedor-info-container" style="display: none;">
            <h2>Control de proveedor</h2>
            <p>Contenido para Control de proveedor - Por implementar</p>
        </div>
        
        <div id="control-moneda-info-container" style="display: none;">
            <h2>Control de moneda</h2>
            <p>Contenido para Control de moneda - Por implementar</p>
        </div>
        
        <div id="info-empresa-info-container" style="display: none;">
            <h2>Informaci√≥n de empresa</h2>
            <p>Contenido para Informaci√≥n de empresa - Por implementar</p>
        </div>
        
        <!-- Contenedores adicionales para funciones del sidebar -->
        <div id="control-modelos-info-container" style="display: none;">
            <!-- CONTROL DE MODELOS CON DROPDOWN DEL MISMO ESTILO QUE CREAR PLAN DE PRODUCCION -->
            <div id="modelosMainContainer" style="font-family: 'LG regular', sans-serif; background-color: #32323E; color: lightgray; min-height: 100vh; padding: 2px;">
                
                <!-- T√≠tulo -->
                <div style="background-color: #34334E; padding: 12px; margin-bottom: 10px; border: #20688C 1px solid;">
                    <h2 style="margin: 0; color: lightgray; font-size: 18px;">Control de modelos</h2>
                </div>

                <!-- Formulario de Modelo -->
                <div id="modeloFormContainer" style="background-color: #40424F; padding: 15px; margin-bottom: 10px; border: #20688C 1px solid;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; align-items: end;">
                        <div style="display: flex; flex-direction: column;">
                            <label style="color: lightgray; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Modelo</label>
                            <div class="bom-search-container" style="position: relative; display: inline-block;">
                                <input type="text" class="bom-search-dropdown" id="modeloSelector" placeholder="Seleccione un modelo" onkeyup="filtrarModelosControl()" onclick="mostrarDropdownControl()" style="background-color: #34495e; color: #ecf0f1; border: 2px solid #2c3e50; border-radius: 4px; padding: 8px 12px; font-size: 12px; min-width: 300px; transition: border-color 0.3s; font-weight: 500;" />
                                <div class="bom-dropdown-list" id="modeloDropdownList" style="position: absolute; top: 100%; left: 0; right: 0; background-color: #2c3e50; border: 1px solid #34495e; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 10000; box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: none;">
                                    <!-- Los modelos se cargar√°n din√°micamente -->
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="btnCargarModelo" class="bom-btn" style="padding: 4px 8px; border: none; border-radius: 3px; background-color: #3C3940; border: #20688C 1px solid; color: white; cursor: pointer; font-size: 10px; transition: all 0.3s; font-weight: 500;" onclick="cargarModeloSeleccionado()">Cargar</button>
                            <button id="btnLimpiarModelo" class="bom-btn" style="padding: 4px 8px; border: none; border-radius: 3px; background-color: #95a5a6; border: #20688C 1px solid; color: white; cursor: pointer; font-size: 10px; transition: all 0.3s; font-weight: 500;" onclick="limpiarSeleccionModelo()">Limpiar</button>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n del Modelo Seleccionado -->
                <div id="modeloInfoContainer" style="background-color: #40424F; padding: 15px; border: #20688C 1px solid; display: none;">
                    <h3 style="color: lightgray; margin: 0 0 15px 0; font-size: 14px;">Informaci√≥n del Modelo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="color: #95a5a6; font-size: 11px; display: block; margin-bottom: 3px;">C√≥digo de Modelo:</label>
                            <div id="modeloCodigo" style="color: lightgray; font-size: 12px; padding: 5px; background-color: #2c3e50; border-radius: 3px;">-</div>
                        </div>
                        <div>
                            <label style="color: #95a5a6; font-size: 11px; display: block; margin-bottom: 3px;">Nombre:</label>
                            <div id="modeloNombre" style="color: lightgray; font-size: 12px; padding: 5px; background-color: #2c3e50; border-radius: 3px;">-</div>
                        </div>
                        <div>
                            <label style="color: #95a5a6; font-size: 11px; display: block; margin-bottom: 3px;">Descripci√≥n:</label>
                            <div id="modeloDescripcion" style="color: lightgray; font-size: 12px; padding: 5px; background-color: #2c3e50; border-radius: 3px;">-</div>
                        </div>
                        <div>
                            <label style="color: #95a5a6; font-size: 11px; display: block; margin-bottom: 3px;">Estado:</label>
                            <div id="modeloEstado" style="color: lightgray; font-size: 12px; padding: 5px; background-color: #2c3e50; border-radius: 3px;">-</div>
                        </div>
                    </div>
                </div>

                <!-- Mensaje informativo cuando no hay modelos -->
                <div id="modeloSinDatosContainer" style="background-color: #40424F; padding: 20px; border: #20688C 1px solid; text-align: center; display: none;">
                    <div style="color: #f39c12; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        No hay modelos registrados en Control de BOM
                    </div>
                    <div style="color: #95a5a6; font-size: 12px; margin-bottom: 20px;">
                        Para usar esta funci√≥n, primero debe agregar modelos en el m√≥dulo Control de BOM de Informaci√≥n B√°sica.
                    </div>
                    <button class="bom-btn" style="background-color: #3498db;" onclick="irAControlBOM()">
                        Ir a Control de BOM
                    </button>
                </div>

                <!-- Contador de resultados -->
                <div id="modeloResultCounter" style="color: #95a5a6; font-size: 11px; margin-top: 10px; text-align: center;">
                    Modelos disponibles: 0
                </div>
            </div>
        </div>
        
        <div id="control-bom-info-container" style="display: none;">
            <h2>Control de BOM</h2>
            <p>Contenido para Control de BOM - Por implementar</p>
        </div>
        
        <div id="control-bom-smt-info-container" style="display: none;">
            <h2>Control de BOM de SMT</h2>
            <p>Contenido para Control de BOM de SMT - Por implementar</p>
        </div>
        
        <div id="control-maquina-inf-info-container" style="display: none;">
            <h2>Control de m√°quina</h2>
            <p>Contenido para Control de m√°quina - Por implementar</p>
        </div>
        
        <div id="control-maquina-info-container" style="display: none;">
            <h2>Control de defecto por proceso (m√°quina)</h2>
            <p>Contenido para Control de defecto por proceso (m√°quina) - Por implementar</p>
        </div>
        
        <div id="control-maquina-linea-info-container" style="display: none;">
            <h2>Control de m√°quina en l√≠nea</h2>
            <p>Contenido para Control de m√°quina en l√≠nea - Por implementar</p>
        </div>
    </div>
</div>

    <!-- Sistema nuevo desactivado - usando mobile-lists-hamburger.js -->
    <button class="mobile-lists-toggle" id="mobile-lists-toggle" title="Ver listas">
    <i class="bi bi-list-ul"></i>
</button>

<div class="mobile-lists-overlay" id="mobile-lists-overlay"></div>

<div class="mobile-lists-menu" id="mobile-lists-menu">
    <div class="mobile-lists-header">
        <span id="mobile-lists-title">Informaci√≥n B√°sica</span>
        <button class="mobile-lists-close" id="mobile-lists-close">√ó</button>
    </div>
    <div class="mobile-lists-content" id="mobile-lists-content">
    </div>
</div>

    <!-- Agrega este overlay justo despu√©s del header -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay"></div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ANIMACIONES PARA DROPDOWNS EN DESKTOP -->
    <link rel="stylesheet" href="../static/css/desktop-dropdown-animations.css">
    
    <!-- SISTEMA UNIFICADO DE DROPDOWNS - √öNICO ARCHIVO NECESARIO -->
    <script src="../static/js/unified-dropdowns.js"></script>
    
    <!-- MOBILE LISTS HAMBURGER MENU -->
    <script src="../static/js/mobile-lists-hamburger.js"></script>
    
    <!-- FALLBACK PARA DROPDOWNS - Solo se ejecuta si el sistema unificado falla -->
    <script>
        // Verificar si el sistema unificado se carg√≥ correctamente
        setTimeout(function() {
            if (typeof window.unifiedDropdowns === 'undefined') {
                console.warn(' Sistema unificado de dropdowns no se carg√≥, ejecutando fallback...');
                
                // FALLBACK ULTRA-SIMPLE
                document.addEventListener('DOMContentLoaded', function() {
                    
                    function setupSimpleFallback() {
                        
                        const toggleButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
                        
                        toggleButtons.forEach(function(button) {
                            // Remover listeners existentes
                            const newButton = button.cloneNode(true);
                            button.parentNode.replaceChild(newButton, button);
                            
                            newButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const targetSelector = this.getAttribute('data-bs-target');
                                if (!targetSelector) return;
                                
                                const targetElement = document.querySelector(targetSelector);
                                if (!targetElement) return;
                                
                                const isOpen = targetElement.classList.contains('show');
                                
                                // Cerrar todos los otros primero
                                document.querySelectorAll('.collapse.show').forEach(el => {
                                    if (el !== targetElement) {
                                        el.classList.remove('show');
                                        el.style.display = 'none';
                                    }
                                });
                                
                                // Toggle este elemento
                                if (isOpen) {
                                    targetElement.classList.remove('show');
                                    targetElement.style.display = 'none';
                                    this.setAttribute('aria-expanded', 'false');
                                } else {
                                    targetElement.classList.add('show');
                                    targetElement.style.display = 'block';
                                    this.setAttribute('aria-expanded', 'true');
                                }
                                
                                return false;
                            });
                        });
                        
                    }
                    
                    setupSimpleFallback();
                    
                    // Re-configurar cuando se carga contenido din√°mico
                    const originalCargarContenido = window.cargarContenidoDinamico;
                    if (originalCargarContenido) {
                        window.cargarContenidoDinamico = function(containerId, templatePath, initCallback) {
                            return originalCargarContenido(containerId, templatePath, function() {
                                if (initCallback) initCallback();
                                setTimeout(setupSimpleFallback, 100);
                            });
                        };
                    }
                    
                    // Funci√≥n AJAX para Control de operaci√≥n de l√≠nea SMT - ELIMINADA (MOVIDA A SCOPE GLOBAL)
                });
            }
        }, 1000);
        
        // ============================================= 
        // FUNCIONES AJAX GLOBALES - FUERA DEL IIFE
        // ============================================= 
        
        // NOTA: mostrarControlOperacionLineaSMT est√° ahora definida en scriptMain.js
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // ============================================= 
        // PWA SERVICE WORKER REGISTRATION
        // ============================================= 
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('../static/sw.js')
                    .then(function(registration) {
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nueva versi√≥n disponible
                                    if (confirm('Nueva versi√≥n disponible. ¬øDesea actualizar?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                        
                    })
                    .catch(function(error) {
                    });
                
                // Manejar mensajes del Service Worker
                navigator.serviceWorker.addEventListener('message', function(event) {
                    const { type, data } = event.data;
                    
                    switch (type) {
                        case 'INSTALL_AVAILABLE':
                            showInstallPrompt();
                            break;
                        case 'APP_INSTALLED':
                            break;
                    }
                });
            });
        }
        
        // ============================================= 
        // PWA INSTALL PROMPT
        // ============================================= 
        let deferredPrompt;
        let installButton;
        
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            // Crear bot√≥n de instalaci√≥n si no existe
            if (!installButton && window.innerWidth <= 768) {
                installButton = document.createElement('button');
                installButton.textContent = 'üì± Instalar App';
                installButton.className = 'btn btn-primary install-btn';
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    border-radius: 25px;
                    padding: 10px 15px;
                    font-size: 14px;
                    background: linear-gradient(45deg, var(--accent-color), #2980b9);
                    border: none;
                    color: white;
                    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                    animation: pulse 2s infinite;
                `;
                
                // A√±adir animaci√≥n CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); }
                    }
                    .install-btn:hover {
                        transform: scale(1.1);
                        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
                    }
                `;
                document.head.appendChild(style);
                
                installButton.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(result) {
                            if (result.outcome === 'accepted') {
                            } else {
                            }
                            deferredPrompt = null;
                            hideInstallButton();
                        });
                    }
                });
                
                document.body.appendChild(installButton);
            }
        }
        
        function hideInstallButton() {
            if (installButton) {
                installButton.style.display = 'none';
                setTimeout(() => {
                    if (installButton && installButton.parentNode) {
                        installButton.parentNode.removeChild(installButton);
                    }
                    installButton = null;
                }, 300);
            }
        }
        
        function showInstallPrompt() {
            showInstallButton();
        }
        
        // Ocultar bot√≥n de instalaci√≥n cuando la app ya est√° instalada
        window.addEventListener('appinstalled', function() {
            hideInstallButton();
            
            // Mostrar mensaje de bienvenida
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    alert('¬°App instalada exitosamente! Ahora puedes acceder desde tu pantalla de inicio.');
                }, 1000);
            }
        });
        
        // ============================================= 
        // PWA UTILITIES
        // ============================================= 
        
        // Detectar si la app est√° ejecut√°ndose como PWA
        function isPWA() {
            return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
        }
        
        // Aplicar estilos espec√≠ficos para PWA
        if (isPWA()) {
            document.body.classList.add('pwa-mode');
            
            // A√±adir estilos espec√≠ficos para PWA
            const pwaStyle = document.createElement('style');
            pwaStyle.textContent = `
                .pwa-mode .app-header {
                    padding-top: env(safe-area-inset-top, 0);
                }
                .pwa-mode .main-content-container {
                    padding-bottom: env(safe-area-inset-bottom, 0);
                }
            `;
            document.head.appendChild(pwaStyle);
        }
        
        // Funci√≥n para verificar conectividad
        function updateOnlineStatus() {
            const status = navigator.onLine ? 'online' : 'offline';
            document.body.classList.toggle('offline', !navigator.onLine);
            
            if (!navigator.onLine) {
                // Mostrar indicador de offline
                showOfflineIndicator();
            } else {
                hideOfflineIndicator();
            }
        }
        
        function showOfflineIndicator() {
            let indicator = document.getElementById('offline-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.textContent = 'üì∂ Sin conexi√≥n - Modo offline';
                indicator.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background-color: #e74c3c;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    z-index: 2000;
                    font-size: 14px;
                `;
                document.body.appendChild(indicator);
            }
        }
        
        function hideOfflineIndicator() {
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Escuchar cambios de conectividad
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Verificar estado inicial
        updateOnlineStatus();
        

    </script>
    <script>
        // ============================================= 
        // MOBILE NAVIGATION ENHANCED
        // ============================================= 
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menu-toggle');
            const navContainer = document.getElementById('nav-container');
            const overlay = document.getElementById('mobile-nav-overlay');
            const mobileListsToggle = document.getElementById('mobile-lists-toggle');
            const mobileListsMenu = document.getElementById('mobile-lists-menu');
            const mobileListsOverlay = document.getElementById('mobile-lists-overlay');
            const mobileListsClose = document.getElementById('mobile-lists-close');
            const mobileListsContent = document.getElementById('mobile-lists-content');
            const mobileListsTitle = document.getElementById('mobile-lists-title');
            
            // Verificar si estamos en dispositivo m√≥vil
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            // Funci√≥n para cerrar men√∫ principal
            function closeMenu() {
                if (navContainer) navContainer.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
                if (menuToggle) menuToggle.classList.remove('active');
                document.body.classList.remove('menu-open');
            }
            
            // Funci√≥n para mostrar/ocultar el bot√≥n flotante
            function toggleMobileListsButton() {
                if (isMobile() && mobileListsToggle) {
                    const materialContainer = document.getElementById('material-container');
                    const hasContentLoaded = materialContainer && materialContainer.style.display !== 'none';
                    
                    if (hasContentLoaded) {
                        mobileListsToggle.style.display = 'flex';
                    } else {
                        mobileListsToggle.style.display = 'none';
                        closeMobileListsMenu(); // Cerrar men√∫ si no hay contenido
                    }
                }
            }
            
            // Funci√≥n para abrir men√∫ de listas m√≥vil
            function openMobileListsMenu() {
                if (isMobile() && mobileListsMenu && mobileListsOverlay) {
                    // Cargar contenido del sidebar actual
                    loadCurrentSidebarContent();
                    
                    // Mostrar men√∫ y overlay
                    mobileListsMenu.classList.add('active');
                    mobileListsOverlay.classList.add('active');
                    mobileListsToggle.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // Funci√≥n para cerrar men√∫ de listas m√≥vil
            function closeMobileListsMenu() {
                if (mobileListsMenu && mobileListsOverlay) {
                    mobileListsMenu.classList.remove('active');
                    mobileListsOverlay.classList.remove('active');
                    mobileListsToggle.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            // Funci√≥n para cargar contenido del sidebar en el men√∫ m√≥vil
            function loadCurrentSidebarContent() {
                // Detectar qu√© secci√≥n est√° activa para cargar la lista correspondiente
                const activeSection = detectActiveSection();
                loadListContent(activeSection);
            }
            
            // Funci√≥n para detectar qu√© secci√≥n est√° activa
            function detectActiveSection() {
                // Lista de contenedores y sus secciones correspondientes
                const sectionContainers = [
                    { id: 'informacion-basica-content-area', section: 'informacion-basica' },
                    { id: 'material-container', section: 'control-material' },
                    { id: 'produccion-content-area', section: 'control-produccion' },
                    { id: 'control-proceso-content-area', section: 'control-proceso' },
                    { id: 'control-calidad-content-area', section: 'control-calidad' }
                ];
                
                // Buscar cu√°l contenedor est√° visible
                for (const container of sectionContainers) {
                    const element = document.getElementById(container.id);
                    if (element && element.style.display !== 'none') {
                        return container.section;
                    }
                }
                
                // Tambi√©n verificar por URL o contexto actual
                const currentPath = window.location.pathname;
                if (currentPath.includes('informacion') || currentPath.includes('usuario')) {
                    return 'informacion-basica';
                } else if (currentPath.includes('material')) {
                    return 'control-material';
                } else if (currentPath.includes('produccion')) {
                    return 'control-produccion';
                } else if (currentPath.includes('proceso')) {
                    return 'control-proceso';
                } else if (currentPath.includes('calidad')) {
                    return 'control-calidad';
                }
                
                // Por defecto, devolver informaci√≥n b√°sica
                return 'informacion-basica';
            }
            
            // Funci√≥n para cargar el contenido de las listas
            function loadListContent(section) {
                let listUrl = '';
                let title = '';
                
                // Mapear secciones a archivos de listas
                switch(section) {
                    case 'informacion-basica':
                        listUrl = '/templates/LISTAS/LISTA_INFORMACIONBASICA.html';
                        title = 'Informaci√≥n B√°sica';
                        break;
                    case 'control-material':
                        listUrl = '/templates/LISTAS/LISTA_DE_MATERIALES.html';
                        title = 'Control de Material';
                        break;
                    case 'control-produccion':
                        listUrl = '/templates/LISTAS/LISTA_CONTROLDEPRODUCCION.html';
                        title = 'Control de Producci√≥n';
                        break;
                    case 'control-proceso':
                        listUrl = '/templates/LISTAS/LISTA_CONTROL_DE_PROCESO.html';
                        title = 'Control de Proceso';
                        break;
                    case 'control-calidad':
                        listUrl = '/templates/LISTAS/LISTA_CONTROL_DE_CALIDAD.html';
                        title = 'Control de Calidad';
                        break;
                    default:
                        listUrl = '/templates/LISTAS/LISTA_INFORMACIONBASICA.html';
                        title = 'Informaci√≥n B√°sica';
                }
                
                // Cargar el archivo de lista
                fetch(`/cargar_template`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ template_path: listUrl.replace('/templates/', '') })
})
.then(response => {
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    console.log('Fetch successful, status:', response.status);
    return response.text();
})
.then(html => {
    console.log('HTML received, length:', html.length);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const sidebar = tempDiv.querySelector('.app-sidebar');
    if (sidebar) {
        console.log('Sidebar found, sections:', sidebar.querySelectorAll('.sidebar-section').length);
        convertSidebarToMobileFormat(sidebar);
        mobileListsTitle.textContent = title;
        console.log('Conversion completed, content set');
    } else {
        console.log('No sidebar found in HTML');
        mobileListsContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: white;">
                <p>No se encontraron listas para esta secci√≥n</p>
                <p style="font-size: 12px; color: #ccc;">Secci√≥n: ${title}</p>
            </div>
        `;
        mobileListsTitle.textContent = title;
    }
})
.catch(error => {
    console.error('Error cargando lista:', error);
    mobileListsContent.innerHTML = `
        <div style="text-align: center; padding: 40px; color: white;">
            <p>Error cargando la lista</p>
            <p style="font-size: 12px; color: #ccc;">${error.message}</p>
        </div>
    `;
    mobileListsTitle.textContent = title;
});
            }
            
            // Funci√≥n para convertir el sidebar a formato m√≥vil
            function convertSidebarToMobileFormat(sidebar) {
                const sections = sidebar.querySelectorAll('.sidebar-section');
                let mobileHTML = '';

                sections.forEach((section) => {
                    const dropdownBtn = section.querySelector('.sidebar-dropdown-btn');
                    const dropdownList = section.querySelector('.sidebar-dropdown-list');
                    
                    if (dropdownBtn && dropdownList) {
                        // Extraer el ID del bot√≥n para el collapse
                        const targetId = dropdownBtn.getAttribute('data-bs-target');
                        const sectionId = targetId ? targetId.replace('#', '') : 'section_' + Math.random().toString(36).substr(2, 9);
                        
                        const title = dropdownBtn.textContent.trim();
                        const links = dropdownList.querySelectorAll('.sidebar-link');
                        
                        mobileHTML += `
                            <div class="mobile-sidebar-section">
                                <button class="mobile-sidebar-dropdown-btn" data-bs-target="#mobile_${sectionId}">
                                    <span>${title}</span>
                                    <span class="mobile-sidebar-caret"><i class="bi bi-chevron-down"></i></span>
                                </button>
                                <ul class="mobile-sidebar-dropdown-list" id="mobile_${sectionId}">
                        `;
                        
                        links.forEach((link) => {
                            const text = link.textContent.trim();
                            const onclick = link.getAttribute('onclick');
                            
                            mobileHTML += `
                                <li class="mobile-sidebar-link" onclick="${onclick}">
                                    ${text}
                                </li>
                            `;
                        });
                        
                        mobileHTML += `
                                </ul>
                            </div>
                        `;
                    }
                });

                mobileListsContent.innerHTML = mobileHTML;
                setupMobileDropdowns();
                
                // Inicializar el sistema de permisos para el contenido cargado din√°micamente
                // if (typeof PermisosDropdowns !== 'undefined') {
                //     PermisosDropdowns.procesarNuevoContenido(mobileListsContent);
                // } // Comentado para evitar TypeError
            }
            
            // Funci√≥n para configurar dropdowns m√≥viles
            function setupMobileDropdowns() {
                const mobileDropdownBtns = mobileListsContent.querySelectorAll('.mobile-sidebar-dropdown-btn');
                
                mobileDropdownBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const targetId = this.getAttribute('data-bs-target');
                        if (targetId) {
                            const targetList = mobileListsContent.querySelector(targetId);
                            if (targetList) {
                                // Toggle activo
                                this.classList.toggle('active');
                                targetList.classList.toggle('active');
                            }
                        }
                    });
                });
                
                // Event listeners para los links m√≥viles
                const mobileLinks = mobileListsContent.querySelectorAll('.mobile-sidebar-link');
                mobileLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        // Cerrar el men√∫ al hacer clic en un enlace
                        closeMobileListsMenu();
                    });
                });
            }
            
            // Event listener para el bot√≥n flotante
            if (mobileListsToggle) {
                mobileListsToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (mobileListsMenu.classList.contains('active')) {
                        closeMobileListsMenu();
                    } else {
                        openMobileListsMenu();
                    }
                });
            }
            
            // Event listener para el bot√≥n de cerrar del men√∫ m√≥vil
            if (mobileListsClose) {
                mobileListsClose.addEventListener('click', function() {
                    closeMobileListsMenu();
                });
            }
            
            // Event listener para cerrar men√∫ tocando el overlay
            if (mobileListsOverlay) {
                mobileListsOverlay.addEventListener('click', function() {
                    closeMobileListsMenu();
                });
            }
            
            
            // Mostrar/ocultar bot√≥n flotante cuando se carga contenido
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        toggleMobileListsButton();
                    }
                });
            });
            
            const materialContainer = document.getElementById('material-container');
            if (materialContainer) {
                observer.observe(materialContainer, { attributes: true });
            }
            
            // Observar cambios en las √°reas de contenido para detectar cuando se cargan nuevas secciones
            const contentObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        // Verificar si alg√∫n contenido se hizo visible
                        if (mutation.target.style.display !== 'none') {
                            // Peque√±o delay para asegurar que el contenido est√© completamente cargado
                            setTimeout(() => {
                                loadCurrentSidebarContent();
                            }, 100);
                        }
                    }
                });
            });
            
            // Observar las √°reas de contenido principales
            const contentAreas = [
                'informacion-basica-content-area',
                'material-container',
                'produccion-content-area',
                'control-proceso-content-area',
                'control-calidad-content-area'
            ];
            
            contentAreas.forEach(areaId => {
                const area = document.getElementById(areaId);
                if (area) {
                    contentObserver.observe(area, { attributes: true });
                }
            });
            
            // Verificar al cargar la p√°gina
            toggleMobileListsButton();
            
            // Funci√≥n para abrir men√∫
            function openMenu() {
                if (navContainer) navContainer.classList.add('active');
                if (overlay) overlay.classList.add('active');
                if (menuToggle) menuToggle.classList.add('active');
                document.body.classList.add('menu-open');
            }
            
            // Toggle del men√∫ hamburguesa
            if (menuToggle && navContainer && overlay) {
                menuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (navContainer.classList.contains('active')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });
                
                // Cerrar men√∫ al hacer click en overlay
                overlay.addEventListener('click', function() {
                    closeMenu();
                });
                
                // Cerrar men√∫ al hacer click en un bot√≥n de navegaci√≥n (solo en m√≥vil)
                const navButtons = navContainer.querySelectorAll('.nav-button');
                navButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const buttonText = this.textContent.trim();
                        
                        if (isMobile()) {
                            // Mapeo de botones a funciones de carga de contenido
                            const buttonActions = {
                                'Informaci√≥n B√°sica': () => {
                                    window.mostrarInformacionBasica();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('informacion-basica-content', '/listas/informacion_basica');
                                    }, 100);
                                },
                                'Control de material': () => {
                                    window.mostrarControlMaterial();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-material-content', '/listas/control_material');
                                    }, 100);
                                },
                                'Control de producci√≥n': () => {
                                    window.mostrarControlProduccion();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-produccion-content', '/listas/control_produccion');
                                    }, 100);
                                },
                                'Control de proceso': () => {
                                    window.mostrarControlProceso();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-proceso-content', '/listas/control_proceso');
                                    }, 100);
                                },
                                'Control de calidad': () => {
                                    window.mostrarControlCalidad();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-calidad-content', '/listas/control_calidad');
                                    }, 100);
                                },
                                'Control de resultados': () => {
                                    window.mostrarControlResultados();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-resultados-content', '/listas/control_resultados');
                                    }, 100);
                                },
                                'Control de reporte': () => {
                                    window.mostrarControlReporte();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('control-reporte-content', '/listas/control_reporte');
                                    }, 100);
                                },
                                'Configuraci√≥n de programa': () => {
                                    window.mostrarConfiguracionPrograma();
                                    setTimeout(() => {
                                        cargarContenidoDinamico('configuracion-programa-content', '/listas/configuracion_programa');
                                    }, 100);
                                }
                            };
                            
                            // Ejecutar la acci√≥n correspondiente
                            if (buttonActions[buttonText]) {
                                buttonActions[buttonText]();
                            } else {
                                console.warn(` No se encontr√≥ acci√≥n para: ${buttonText}`);
                            }
                            
                            setTimeout(closeMenu, 300); // Peque√±o delay para mejor UX
                        }
                    });
                });
                
                // Cerrar men√∫ con tecla Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && navContainer.classList.contains('active')) {
                        closeMenu();
                    }
                });
                
                // Cerrar men√∫ al cambiar orientaci√≥n
                window.addEventListener('orientationchange', function() {
                    setTimeout(closeMenu, 100);
                    if (isMobile()) {
                        closeMobileSidebar(); // Cerrar sidebar al cambiar orientaci√≥n
                    }
                });
                
                // Cerrar men√∫ al redimensionar ventana
                window.addEventListener('resize', function() {
                    if (!isMobile()) {
                        closeMenu();
                        closeMobileSidebar(); // Cerrar sidebar en desktop
                        toggleMobileListsButton(); // Ocultar bot√≥n flotante en desktop
                    } else {
                        toggleMobileListsButton(); // Mostrar/ocultar bot√≥n seg√∫n contenido
                    }
                });
                
                // Cerrar sidebar m√≥vil con tecla Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isMobile()) {
                        closeMobileSidebar();
                    }
                });
            }
            
            // ============================================= 
            // TOUCH GESTURES PARA M√ìVIL
            // ============================================= 
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            // Detectar swipe gestures
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipeGesture();
            }, { passive: true });
            
            function handleSwipeGesture() {
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                const verticalDistance = Math.abs(touchEndY - touchStartY);
                
                // Solo procesar swipe horizontal si el vertical es m√≠nimo
                if (verticalDistance < 100 && Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0 && touchStartX < 50) {
                        // Swipe derecha desde el borde izquierdo - abrir men√∫
                        if (isMobile() && !navContainer.classList.contains('active')) {
                            openMenu();
                        }
                    } else if (swipeDistance < 0 && navContainer.classList.contains('active')) {
                        // Swipe izquierda - cerrar men√∫
                        closeMenu();
                    }
                }
            }
            
            // ============================================= 
            // OPTIMIZACIONES DE RENDIMIENTO M√ìVIL
            // ============================================= 
            
            // Throttle para eventos de scroll
            function throttle(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Optimizar scroll en m√≥viles
            if (isMobile()) {
                const scrollableElements = document.querySelectorAll('.sidebar-content, .material-content-area, .informacion-basica-content-area');
                scrollableElements.forEach(element => {
                    element.style.webkitOverflowScrolling = 'touch';
                    element.style.overflowScrolling = 'touch';
                    element.classList.add('scrollable');
                });
            }
            
            // Prevenir zoom en inputs (iOS)
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.style.fontSize < '16px') {
                        input.style.fontSize = '16px';
                    }
                });
            }
            
            // ============================================= 
            // VIEWPORT HEIGHT FIX PARA M√ìVILES
            // ============================================= 
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', vh + 'px');
            }
            
            setViewportHeight();
            window.addEventListener('resize', throttle(setViewportHeight, 250));
            window.addEventListener('orientationchange', function() {
                setTimeout(setViewportHeight, 500);
            });
            

        });    
    </script>

    <script>    
        // Mostrar/ocultar el contenedor de material seg√∫n el bot√≥n
        document.addEventListener('DOMContentLoaded', function() {
            
            // ===============================================
            // DEFINIR TODAS LAS FUNCIONES AL INICIO
            // ===============================================
            
            // Control de debugging - Cambia a true si necesitas mensajes de consola para debugging
            const DEBUG_MODE = false;
            
            // Funci√≥n de logging condicional
            function debugLog(...args) {
                if (DEBUG_MODE) {
                }
            }
            
            // NUEVA FUNCI√ìN: Cerrar todos los dropdowns en un contenedor
            function cerrarTodosLosDropdowns(container = document) {
                // Buscar todos los elementos con class "show" y "collapse"
                const elementosAbiertos = container.querySelectorAll('.collapse.show');
                elementosAbiertos.forEach(elemento => {
                    elemento.classList.remove('show');
                });
                
                // Buscar todos los botones con aria-expanded="true"
                const botonesExpandidos = container.querySelectorAll('[aria-expanded="true"]');
                botonesExpandidos.forEach(boton => {
                    boton.setAttribute('aria-expanded', 'false');
                });
            }
            
            // Hacer la funci√≥n disponible globalmente para debugging
            window.cerrarTodosLosDropdowns = cerrarTodosLosDropdowns;
            
            // Funci√≥n para limpiar event listeners duplicados de Bootstrap
            function limpiarEventListenersBootstrap() {
                
                try {
                    // Usar el sistema unificado si est√° disponible
                    if (window.unifiedDropdowns) {
                        window.unifiedDropdowns.cleanup();
                        window.unifiedDropdowns.init();
                        return;
                    }
                    
                    console.warn(' Sistema unificado no disponible, usando limpieza manual');
                    // Fallback manual (c√≥digo anterior)
                    const dropdownButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
                    dropdownButtons.forEach(button => {
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error en limpieza de event listeners:', error);
                }
            }
            
            // Funci√≥n mejorada para cerrar dropdowns
            function cerrarTodosLosDropdownsMejorada(container = null) {
                
                try {
                    // Usar el sistema unificado si est√° disponible
                    if (window.unifiedDropdowns) {
                        window.unifiedDropdowns.closeAll();
                        return;
                    }
                    
                    console.warn(' Sistema unificado no disponible, usando m√©todo manual');
                    // Fallback manual
                    document.querySelectorAll('.collapse.show').forEach(elemento => {
                        elemento.classList.remove('show');
                        elemento.style.display = 'none';
                    });
                    
                    document.querySelectorAll('[aria-expanded="true"]').forEach(boton => {
                        boton.setAttribute('aria-expanded', 'false');
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error cerrando dropdowns:', error);
                }
            }
            
            // Funci√≥n gen√©rica para cargar contenido din√°micamente
            window.cargarContenidoDinamico = function(containerId, templatePath, initCallback = null) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`‚úó Container ${containerId} no encontrado`);
                    return Promise.reject(`Container ${containerId} no encontrado`);
                }
                
                
                // 1. CERRAR TODOS LOS DROPDOWNS ANTES DE LIMPIAR
                cerrarTodosLosDropdownsMejorada();
                
                // 1.1. LIMPIAR TODAS LAS SELECCIONES ACTIVAS
                if (window.unifiedDropdowns && window.unifiedDropdowns.clearAllSelections) {
                    window.unifiedDropdowns.clearAllSelections();
                }
                
                // 2. LIMPIAR EL CONTENEDOR
                container.innerHTML = '<div class="loading-indicator">Cargando...</div>';
                
                // 3. CARGAR EL CONTENIDO DIN√ÅMICAMENTE
                return fetch(templatePath, {
                    method: 'GET',
                    credentials: 'same-origin', // Incluir cookies de sesi√≥n
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                        'Cache-Control': 'no-cache'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            // Manejar espec√≠ficamente errores de permisos
                            if (response.status === 403) {
                                return response.text().then(errorHtml => {
                                    container.innerHTML = errorHtml;
                                    throw new Error('Permisos insuficientes');
                                });
                            } else if (response.status === 401) {
                                // Usuario no autenticado
                                container.innerHTML = `
                                    <div style="
                                        display: flex; 
                                        flex-direction: column; 
                                        align-items: center; 
                                        justify-content: center; 
                                        height: 400px; 
                                        background: #2c2c2c; 
                                        color: #e0e0e0; 
                                        border-radius: 10px; 
                                        margin: 20px;
                                        text-align: center;
                                    ">
                                        <i class="fas fa-user-lock" style="font-size: 3rem; color: #ffc107; margin-bottom: 20px;"></i>
                                        <h3>Sesi√≥n Expirada</h3>
                                        <p>Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.</p>
                                        <button onclick="window.location.href='/login'" class="btn btn-primary mt-3">Iniciar Sesi√≥n</button>
                                    </div>
                                `;
                                throw new Error('Usuario no autenticado');
                            } else {
                                throw new Error('Error al cargar el contenido: ' + response.status);
                            }
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Verificar si el HTML devuelto es la p√°gina de login (indica sesi√≥n expirada)
                        if (html.includes('ILSAN LGMES - Inicio de Sesi√≥n') || html.includes('login-container')) {
                            container.innerHTML = `
                                <div style="
                                    display: flex; 
                                    flex-direction: column; 
                                    align-items: center; 
                                    justify-content: center; 
                                    height: 400px; 
                                    background: #2c2c2c; 
                                    color: #e0e0e0; 
                                    border-radius: 10px; 
                                    margin: 20px;
                                    text-align: center;
                                ">
                                    <i class="fas fa-user-lock" style="font-size: 3rem; color: #ffc107; margin-bottom: 20px;"></i>
                                    <h3>Sesi√≥n Expirada</h3>
                                    <p>Tu sesi√≥n ha expirado. Redirigiendo al login...</p>
                                </div>
                            `;
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                            throw new Error('Sesi√≥n expirada - redirigiendo al login');
                        }
                        
                        container.innerHTML = html;
                        
                        // 4. ESPERAR UN POCO ANTES DE INICIALIZAR COMPONENTES
                        setTimeout(() => {
                            // Re-inicializar tooltips si existen en el nuevo contenido
                            const tooltipTriggerList = container.querySelectorAll('[data-bs-toggle="tooltip"]');
                            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                                new bootstrap.Tooltip(tooltipTriggerEl);
                            });
                            
                            // 5. REINICIALIZAR EL SISTEMA UNIFICADO DE DROPDOWNS
                            if (window.unifiedDropdowns) {
                                window.unifiedDropdowns.init();
                            }
                            
                            
                            // Ejecutar callback de inicializaci√≥n si se proporciona
                            if (initCallback && typeof initCallback === 'function') {
                                initCallback();
                            }
                        }, 150);
                        
                        // Ejecutar cualquier script que pueda estar en el HTML cargado
                        const scripts = container.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.textContent = script.textContent;
                            }
                            document.head.appendChild(newScript);
                        });
                        
                        return html;
                    })
                    .catch(error => {
                        console.error('‚ùå Error al cargar el contenido:', error);
                        // Solo mostrar mensaje gen√©rico si no es un error de permisos
                        if (!error.message.includes('Permisos insuficientes') && !error.message.includes('Usuario no autenticado')) {
                            container.innerHTML = '<div class="error-message">Error al cargar el contenido. Por favor, intente nuevamente.</div>';
                        }
                        throw error;
                    });
            };
            
            // ===============================================
            // AHORA INICIALIZAR VARIABLES Y ELEMENTOS
            // ===============================================
            
            const materialContainer = document.getElementById('material-container');
            const informacionBasicaContent = document.getElementById('informacion-basica-content');
            const controlMaterialContent = document.getElementById('control-material-content');
            const controlProduccionContent = document.getElementById('control-produccion-content');
            const controlProcesoContent = document.getElementById('control-proceso-content');
            const controlCalidadContent = document.getElementById('control-calidad-content');
            const controlResultadosContent = document.getElementById('control-resultados-content');
            const controlReporteContent = document.getElementById('control-reporte-content');
            const configuracionProgramaContent = document.getElementById('configuracion-programa-content');
            const materialContentArea = document.getElementById('material-content-area');
            const produccionContentArea = document.getElementById('produccion-content-area');
            const controlProcesoContentArea = document.getElementById('control-proceso-content-area');
            const informacionBasicaContentArea = document.getElementById('informacion-basica-content-area');
            const materialInfoContainer = document.getElementById('material-info-container');
            const controlAlmacenContainer = document.getElementById('control-almacen-container');
            const controlSalidaContainer = document.getElementById('control-salida-container');
            const controlRetornoContainer = document.getElementById('control-retorno-container');
            const reciboPagoContainer = document.getElementById('recibo-pago-container');
            const historialMaterialContainer = document.getElementById('historial-material-container');
            const estatusMaterialContainer = document.getElementById('estatus-material-container');
            const materialSustitutoContainer = document.getElementById('material-sustituto-container');
            const consultarPepsContainer = document.getElementById('consultar-peps-container');
            const longtermInventoryContainer = document.getElementById('longterm-inventory-container');
            const registroMaterialContainer = document.getElementById('registro-material-container');
            const historialInventarioContainer = document.getElementById('historial-inventario-container');
            const inventarioRollosSMDContainer = document.getElementById('inventario-rollos-smd-container');
            const ajusteNumeroContainer = document.getElementById('ajuste-numero-container');
            const historialCambioSmtContainer = document.getElementById('historial-cambio-smt-container');
            const produccionInfoContainer = document.getElementById('produccion-info-container');
            const navButtons = document.querySelectorAll('.nav-button');
            
            // Funci√≥n para ocultar todo el contenido
            function hideAllContent() {
                console.log(' hideAllContent ejecut√°ndose...');
                
                // Ocultar todos los contenedores principales
                informacionBasicaContent.style.display = 'none';
                controlMaterialContent.style.display = 'none';
                controlProduccionContent.style.display = 'none';
                controlProcesoContent.style.display = 'none';
                controlCalidadContent.style.display = 'none';
                controlResultadosContent.style.display = 'none';
                if (controlReporteContent) controlReporteContent.style.display = 'none';
                configuracionProgramaContent.style.display = 'none';
                
                // FORZAR ocultar completamente las √°reas de contenido
                materialContentArea.style.display = 'none';
                produccionContentArea.style.display = 'none';
                controlProcesoContentArea.style.display = 'none';
                informacionBasicaContentArea.style.display = 'none';
                
                // FORZAR ocultar tambi√©n los sidebars
                const controlMaterialSidebar = document.getElementById('control-material-content');
                const controlProduccionSidebar = document.getElementById('control-produccion-content');
                if (controlMaterialSidebar) controlMaterialSidebar.style.display = 'none';
                if (controlProduccionSidebar) controlProduccionSidebar.style.display = 'none';
                
                // Limpiar contenido de los contenedores principales para evitar superposici√≥n
                const containersToClean = [
                    'informacion-basica-content',
                    'control-material-content', 
                    'control-produccion-content',
                    'control-proceso-content',
                    'control-calidad-content',
                    'control-resultados-content',
                    'control-reporte-content',
                    'configuracion-programa-content'
                ];
                
                containersToClean.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container && container.innerHTML.trim() !== '') {
                        // Solo limpiar si tiene contenido, mantener un placeholder
                        container.innerHTML = '<!-- El contenido se cargar√° din√°micamente con JavaScript -->';
                        console.log(`üßπ Contenido limpiado de: ${containerId}`);
                    }
                });
                
                // Limpiar solo el contenido din√°mico del √°rea de material, no los contenedores base
                const materialArea = document.getElementById('material-content-area');
                if (materialArea) {
                    // Solo limpiar si contiene contenido de Control de Embarque u otros contenidos din√°micos
                    const embarqueContainer = materialArea.querySelector('#embarque-main-container-unique');
                    if (embarqueContainer) {
                        embarqueContainer.remove();
                        console.log('üßπ Control de Embarque removido del DOM');
                    }
                }
                
                hideAllMaterialContainers();
                hideAllInformacionBasicaContainers();
                
                // Cerrar Control de Embarque cuando se cambie a otra secci√≥n
                console.log(' Intentando cerrar Control de Embarque...');
                if (typeof window.cerrarControlEmbarque === 'function') {
                    try {
                        window.cerrarControlEmbarque();
                        console.log(' Control de Embarque cerrado exitosamente');
                    } catch (error) {
                        console.error('‚ùå Error cerrando Control de Embarque:', error);
                    }
                } else {
                    console.log(' Funci√≥n cerrarControlEmbarque no disponible');
                }
            }
            
            // Funci√≥n para resetear completamente la pesta√±a de Informaci√≥n B√°sica
            function resetInformacionBasica() {
                // Llamar a la funci√≥n global de reseteo si existe
                if (typeof window.resetInfoBasicaToDefault === 'function') {
                    window.resetInfoBasicaToDefault();
                }
                
                // Asegurar que todos los sidebar-links funcionen
                const sidebarLinks = informacionBasicaContent.querySelectorAll('.sidebar-link');
                sidebarLinks.forEach(link => {
                    link.style.pointerEvents = 'auto';
                    link.style.cursor = 'pointer';
                });
            }
            
            // Funci√≥n para ocultar todos los contenedores de material
function hideAllMaterialContainers() {
    materialInfoContainer.style.display = 'none';
    controlAlmacenContainer.style.display = 'none';
    controlSalidaContainer.style.display = 'none';
    controlRetornoContainer.style.display = 'none';
    reciboPagoContainer.style.display = 'none';
    historialMaterialContainer.style.display = 'none';
    estatusMaterialContainer.style.display = 'none';
    materialSustitutoContainer.style.display = 'none';
    consultarPepsContainer.style.display = 'none';
    longtermInventoryContainer.style.display = 'none';
    registroMaterialContainer.style.display = 'none';
    historialInventarioContainer.style.display = 'none';
    inventarioRollosSMDContainer.style.display = 'none';
    ajusteNumeroContainer.style.display = 'none';
    historialCambioSmtContainer.style.display = 'none';
    const controlProcesoContentArea = document.getElementById('control-proceso-content-area');
    if (controlProcesoContentArea) controlProcesoContentArea.style.display = 'none';
    const controlProduccionSmtParent = document.getElementById('control-produccion-smt-container');
    if (controlProduccionSmtParent) controlProduccionSmtParent.style.display = 'none';
    const controlProduccionSmtContainer = document.getElementById('Control de produccion SMT-unique-container');
    if (controlProduccionSmtContainer) controlProduccionSmtContainer.style.display = 'none';
    const controlOperacionLineaContainer = document.getElementById('operacion-linea-smt-unique-container');
    if (controlOperacionLineaContainer) controlOperacionLineaContainer.style.display = 'none';
    const inventarioImdTerminadoContainer = document.getElementById('inventario-imd-terminado-unique-container');
    if (inventarioImdTerminadoContainer) inventarioImdTerminadoContainer.style.display = 'none';
}
        
            
            function hideAllInformacionBasicaContainers() {
                const containers = [
                    'info-basica-default-container',
                    'admin-usuario-info-container', 
                    'admin-menu-info-container',
                    'admin-autoridad-info-container',
                    'control-codigo-info-container',
                    'admin-itinerario-info-container',
                    'consultar-licencias-info-container',
                    'control-departamento-info-container',
                    'control-proceso-info-container',
                    'control-orden-proceso-info-container',
                    'control-orden-proceso2-info-container',
                    'control-defecto-info-container',
                    'control-interfaces-info-container',
                    'control-interlock-info-container',
                    'control-material-info-container',
                    'configuracion-msl-info-container',
                    'control-cliente-info-container',
                    'control-proveedor-info-container',
                    'control-moneda-info-container',
                    'info-empresa-info-container',
                    // Contenedores adicionales para sidebar
                    'control-modelos-info-container',
                    'control-bom-info-container',
                    'control-bom-smt-info-container',
                    'control-maquina-inf-info-container',
                    'control-maquina-info-container',
                    'control-maquina-linea-info-container'
                ];
                
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.style.display = 'none';
                    }
                });
            }
            
            // Hacer la funci√≥n disponible globalmente
            window.hideAllInformacionBasicaContainers = hideAllInformacionBasicaContainers;
            
            // Funciones globales para mostrar cada contenedor de Informaci√≥n B√°sica
            window.mostrarAdminUsuarioInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('admin-usuario-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarAdminMenuInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('admin-menu-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarAdminAutoridadInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('admin-autoridad-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlCodigoInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-codigo-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarAdminItinerarioInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('admin-itinerario-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarConsultarLicenciasInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('consultar-licencias-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlDepartamentoInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-departamento-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlProcesoInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-proceso-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlOrdenProcesoInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-orden-proceso-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlOrdenProceso2Info = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-orden-proceso2-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlDefectoInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-defecto-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlInterfacesInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-interfaces-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlInterlockInfo = function() {

                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-interlock-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarConfiguracionMSLInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('configuracion-msl-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlClienteInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-cliente-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlProveedorInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-proveedor-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            // NUEVA FUNCI√ìN: Control de material para Informaci√≥n B√°sica
            window.mostrarControlMaterialInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-material-info-container');
                if (container) {
                    container.style.display = 'block';
                    
                    // Cargar el contenido din√°micamente del endpoint espec√≠fico
                    cargarContenidoDinamico('control-material-info-container', '/informacion_basica/control_de_material')
                        .then(() => {
                        })
                        .catch(error => {
                            console.error('‚ùå Error cargando Control de Material de Informaci√≥n B√°sica:', error);
                            container.innerHTML = '<div class="error-message"><h3>Error al cargar el contenido</h3><p>No se pudo cargar Control de Material. Por favor, intente nuevamente.</p></div>';
                        });
                }
            };
            
            // Funciones adicionales para el sidebar de Informaci√≥n B√°sica
            window.mostrarControlModelosInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-modelos-info-container');
                if (container) {
                    container.style.display = 'block';
                    // Cargar modelos cuando se muestra el contenedor
                    cargarModelosControl();
                }
            };
            
            window.mostrarControlBOMInfo = function() {
                // Verificar permisos antes de continuar
                if (typeof PermisosDropdowns !== 'undefined' && 
                    !PermisosDropdowns.tienePermiso('LISTA_INFORMACIONBASICA', 'Control de produccion', 'Control de BOM')) {
                    return false;
                }
                
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-bom-info-container');
                if (container) {
                    container.style.display = 'block';
                    
                    // Cargar el contenido din√°micamente del endpoint espec√≠fico
                    cargarContenidoDinamico('control-bom-info-container', '/informacion_basica/control_de_bom')
                        .then(() => {
                        })
                        .catch(error => {
                            console.error('‚ùå Error cargando Control de BOM de Informaci√≥n B√°sica:', error);
                            // El error ya se muestra en cargarContenidoDinamico, no hacer nada m√°s aqu√≠
                        });
                }
            };
            
            window.mostrarControlBOMSMTInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-bom-smt-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.Controlmaquinainf = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-maquina-inf-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlMaquinaInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-maquina-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            window.mostrarControlMaquinaLineaInfo = function() {
                hideAllInformacionBasicaContainers();
                const container = document.getElementById('control-maquina-linea-info-container');
                if (container) {
                    container.style.display = 'block';
                }
            };
            
            // Funci√≥n para mostrar el contenido por defecto de material
            window.mostrarInfoMaterial = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                materialInfoContainer.style.display = 'block';
                
                // IMPORTANTE: Ocultar contenedor de producci√≥n
                produccionContentArea.style.display = 'none';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('material-info-container', '/material/info')
                    .catch(error => console.error('Error cargando info material:', error));
            };
            
            // Funci√≥n global para mostrar el contenido de almac√©n
            window.mostrarControlAlmacen = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                controlAlmacenContainer.style.display = 'block';
                
                // IMPORTANTE: Ocultar contenedor de producci√≥n
                produccionContentArea.style.display = 'none';
                
                // Cargar contenido din√°micamente con callback de inicializaci√≥n
                cargarContenidoDinamico('control-almacen-container', '/material/control_almacen', () => {

                    
                    // Intentar inicializar funciones de control de almac√©n (sin mensajes de advertencia)
                    if (typeof window.inicializarControlAlmacenModule === 'function') {
                        window.inicializarControlAlmacenModule();
                    } else if (typeof window.inicializarControlAlmacen === 'function') {
                        window.inicializarControlAlmacen();
                    } else {
                        // Intentar m√©todos individuales sin mensajes de error
                        if (typeof cargarCodigosMaterial === 'function') cargarCodigosMaterial();
                        if (typeof cargarClienteSeleccionado === 'function') cargarClienteSeleccionado();
                        if (typeof cargarSiguienteSecuencial === 'function') cargarSiguienteSecuencial();
                    }
                })
                .catch(error => {
                    console.error('Error cargando control de almac√©n:', error);
                });
                

            };
            
            // Funci√≥n global para mostrar Control de Embarque
            window.mostrarControlEmbarque = function() {
                hideAllMaterialContainers();
                produccionContentArea.style.display = 'block';
                produccionInfoContainer.style.display = 'block';
                
                // IMPORTANTE: Ocultar contenedor de material
                materialContentArea.style.display = 'none';
                
                // Cargar contenido din√°micamente de Control de Embarque en el contenedor de producci√≥n
                cargarContenidoDinamico('produccion-info-container', '/control_produccion/control_embarque', () => {
                    // Despu√©s de cargar, asegurar que el contenedor est√© visible
                    const embarqueContainer = document.querySelector('#embarque-main-container-unique');
                    if (embarqueContainer) {
                        embarqueContainer.style.display = 'block';
                        embarqueContainer.style.visibility = 'visible';
                        embarqueContainer.style.opacity = '1';
                        console.log('Control de Embarque cargado y mostrado correctamente');
                    }
                    
                    // Inicializar el m√≥dulo de Control de Embarque
                    if (typeof window.initControlEmbarque === 'function') {
                        window.initControlEmbarque();
                        console.log('M√≥dulo Control de Embarque inicializado');
                    } else {
                        console.warn('Funci√≥n initControlEmbarque no encontrada');
                    }
                })
                .catch(error => {
                    console.error('Error cargando Control de Embarque:', error);
                });
            };
            
            // Funci√≥n global para mostrar Crear Plan de Producci√≥n
            window.mostrarCrearPlanProduccion = function() {
                hideAllMaterialContainers();
                produccionContentArea.style.display = 'block';
                produccionInfoContainer.style.display = 'block';
                
                // IMPORTANTE: Ocultar contenedor de material
                materialContentArea.style.display = 'none';
                
                // Cargar contenido din√°micamente de Crear Plan de Producci√≥n en el contenedor de producci√≥n
                cargarContenidoDinamico('produccion-info-container', '/control_produccion/crear_plan', () => {
                    // Despu√©s de cargar, asegurar que el contenedor est√© visible
                    const planContainer = document.querySelector('#plan-produccion-main-container-unique');
                    if (planContainer) {
                        planContainer.style.display = 'block';
                        planContainer.style.visibility = 'visible';
                        planContainer.style.opacity = '1';
                        console.log('Crear Plan de Producci√≥n cargado y mostrado correctamente');
                    }
                    
                    // Inicializar el m√≥dulo de Crear Plan de Producci√≥n
                    if (typeof window.initCrearPlanProduccion === 'function') {
                        window.initCrearPlanProduccion();
                        console.log('M√≥dulo Crear Plan de Producci√≥n inicializado');
                    } else {
                        console.warn('Funci√≥n initCrearPlanProduccion no encontrada');
                    }
                })
                .catch(error => {
                    console.error('Error cargando Crear Plan de Producci√≥n:', error);
                });
            };
            
            // Funci√≥n global para mostrar PLAN SMT
            window.mostrarPlanSMT = function() {
                hideAllMaterialContainers();
                produccionContentArea.style.display = 'block';
                produccionInfoContainer.style.display = 'block';
                
                // IMPORTANTE: Ocultar contenedor de material
                materialContentArea.style.display = 'none';
                
                // Cargar contenido din√°micamente de PLAN SMT en el contenedor de producci√≥n
                cargarContenidoDinamico('produccion-info-container', '/control_produccion/plan_smt', () => {
                    // Despu√©s de cargar, asegurar que el contenedor est√© visible
                    const planSMTContainer = document.querySelector('#plan-smt-main-container-unique');
                    if (planSMTContainer) {
                        planSMTContainer.style.display = 'block';
                        planSMTContainer.style.visibility = 'visible';
                        planSMTContainer.style.opacity = '1';
                        console.log('PLAN SMT cargado y mostrado correctamente');
                    }
                    
                    // Inicializar el m√≥dulo de PLAN SMT
                    if (typeof window.initPlanSMT === 'function') {
                        window.initPlanSMT();
                        console.log('M√≥dulo PLAN SMT inicializado');
                    } else {
                        console.warn('Funci√≥n initPlanSMT no encontrada');
                    }
                })
                .catch(error => {
                    console.error('Error cargando PLAN SMT:', error);
                });
            };
            
            // Funci√≥n AJAX para Control de producci√≥n SMT
            window.mostrarControldeproduccionSMT = function() {
                console.log('üöÄ Iniciando carga AJAX de Control de producci√≥n SMT...');
                
                try {
                    hideAllMaterialContainers();
                    
                    // Mostrar el √°rea de control de proceso
                    const controlProcesoArea = document.getElementById('control-produccion-smt-container');
                    if (controlProcesoArea) {
                        controlProcesoArea.style.display = 'block';
                        controlProcesoArea.style.visibility = 'visible';
                        controlProcesoArea.style.opacity = '1';
                        controlProcesoArea.style.position = 'relative';
                        controlProcesoArea.style.zIndex = '1000';
                    }
                    
                    // Asegurar que el contenedor espec√≠fico est√© disponible
                    // 2. ASEGURAR QUE EL CONTENEDOR ESPEC√çFICO EXISTA Y EST√â DISPONIBLE
                    let smtContainer = document.getElementById('Control de produccion SMT-unique-container');
                    let smtParentContainer = document.getElementById('control-produccion-smt-container');
                    if (!smtContainer) {
                        // Si no existe, crearlo dentro del √°rea de control de proceso
                        console.log('üîß Creando contenedor Control de produccion SMT-unique-container');
                        smtContainer = document.createElement('div');
                        smtContainer.id = 'Control de produccion SMT-unique-container';
                        // FORZAR ESTILOS PARA OVERRIDE CSS
                        smtContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative; z-index: 1001; width: 100%; min-height: 400px; padding: 5px;';
                        controlProcesoArea.appendChild(smtContainer);
                        // Mostrar contenedor padre si existe
                        if (smtParentContainer) {
                            smtParentContainer.style.display = 'block';
                        }
                    } else {
                        // FORZAR ESTILOS PARA OVERRIDE CSS
                        smtContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative; z-index: 1001; width: 100%; min-height: 400px; padding: 5px;';
                        // Mostrar contenedor padre si existe
                        if (smtParentContainer) {
                            smtParentContainer.style.display = 'block';
                        }
                    }
                    
                    // IMPORTANTE: Ocultar contenedor de material
                    materialContentArea.style.display = 'none';
                    
                    // Cargar contenido din√°micamente usando la ruta AJAX
                    cargarContenidoDinamico('Control de produccion SMT-unique-container', '/control_proceso/control_produccion_smt', () => {
                        console.log(' Control de producci√≥n SMT AJAX cargado exitosamente');
                        
                        // Verificar que el contenedor espec√≠fico est√© visible
                        const smtContainer = document.querySelector('#Control de produccion SMT-unique-container');
                        if (smtContainer) {
                            smtContainer.style.display = 'block';
                            smtContainer.style.visibility = 'visible';
                            smtContainer.style.opacity = '1';
                            
                            console.log(' Contenedor principal de Control de producci√≥n SMT AJAX inicializado');
                        }
                        
                        // Ejecutar inicializaci√≥n espec√≠fica del m√≥dulo si existe
                        if (typeof window.inicializarControlProduccionSMT === 'function') {
                            window.inicializarControlProduccionSMT();
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error cargando Control de producci√≥n SMT AJAX:', error);
                        
                        // Mostrar mensaje de error al usuario
                        const errorContainer = document.querySelector('#Control de produccion SMT-unique-container');
                        if (errorContainer) {
                            errorContainer.innerHTML = `
                                <div class="error-message" style="padding: 20px; text-align: center; color: #dc3545;">
                                    <h3>‚ùå Error al cargar Control de producci√≥n SMT</h3>
                                    <p>No se pudo cargar el m√≥dulo. Por favor, intente nuevamente.</p>
                                    <button onclick="window.mostrarControldeproduccionSMT()" class="btn btn-primary">Reintentar</button>
                                </div>
                            `;
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico en mostrarControldeproduccionSMT:', error);
                    alert('Error cr√≠tico al cargar Control de producci√≥n SMT. Consulte la consola para m√°s detalles.');
                }
            };
            
            // Funci√≥n AJAX para Control de Embarque con sufijo √∫nico
            window.mostrarControlembarque = function() {
                console.log('üöÄ Iniciando carga AJAX de Control de Embarque...');
                
                try {
                    hideAllMaterialContainers();
                    produccionContentArea.style.display = 'none';
                    controlProcesoContentArea.style.display = 'block';
                    produccionInfoContainer.style.display = 'block';
                    
                    // IMPORTANTE: Ocultar contenedor de material
                    materialContentArea.style.display = 'none';
                    
                    // Cargar contenido din√°micamente usando la ruta AJAX
                    cargarContenidoDinamico('embarque-unique-container', '/Control de embarque', () => {
                        console.log(' Control de Embarque AJAX cargado exitosamente');
                        
                        // Verificar que el contenedor espec√≠fico est√© visible
                        const embarqueContainer = document.querySelector('#embarque-unique-container');
                        if (embarqueContainer) {
                            embarqueContainer.style.display = 'block';
                            embarqueContainer.style.visibility = 'visible';
                            embarqueContainer.style.opacity = '1';
                            
                            // Verificar contenedor principal interno
                            const mainContainer = document.querySelector('#embarque-main-container-unique-embarque');
                            if (mainContainer) {
                                mainContainer.style.display = 'block';
                                console.log(' Contenedor principal de Control de Embarque AJAX inicializado');
                            }
                            
                            // Auto-inicializaci√≥n ya est√° incluida en el template
                            console.log(' Control de Embarque AJAX completamente funcional');
                        } else {
                            console.error('‚ùå No se encontr√≥ el contenedor embarque-unique-container');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error cargando Control de Embarque AJAX:', error);
                        
                        // Manejo robusto de errores
                        if (error.status === 404) {
                            alert('Error 404: M√≥dulo Control de Embarque no encontrado');
                        } else if (error.status === 500) {
                            alert('Error 500: Error interno del servidor');
                        } else if (error.status === 401 || error.status === 403) {
                            alert('Error de autenticaci√≥n. Redirigiendo al login...');
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        } else {
                            alert('Error de conexi√≥n. Verifique su conexi√≥n a internet.');
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico en mostrarControlembarque:', error);
                    alert('Error cr√≠tico al cargar el m√≥dulo Control de Embarque');
                }
            };
            
            // Funci√≥n AJAX para Inventario IMD Terminado
            window.mostrarInventarioIMDTerminado = function() {
                console.log('üöÄ Iniciando carga AJAX de Inventario IMD Terminado...');
                
                try {
                    hideAllMaterialContainers();
                    
                    // Mostrar el √°rea de control de proceso
                    controlProcesoContentArea.style.display = 'block';
                    
                    // IMPORTANTE: Ocultar otras √°reas
                    materialContentArea.style.display = 'none';
                    produccionContentArea.style.display = 'none';
                    
                    // Asegurar que el contenedor espec√≠fico exista y est√© disponible
                    let imdContainer = document.getElementById('inventario-imd-terminado-unique-container');
                    
                    if (!imdContainer) {
                        // Si no existe, crearlo dentro del √°rea de control de proceso
                        console.log('üîß Creando contenedor inventario-imd-terminado-unique-container');
                        imdContainer = document.createElement('div');
                        imdContainer.id = 'inventario-imd-terminado-unique-container';
                        imdContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative; z-index: 1001; width: 100%; min-height: 400px; padding: 5px;';
                        controlProcesoContentArea.appendChild(imdContainer);
                    } else {
                        // Forzar estilos para override CSS
                        imdContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative; z-index: 1001; width: 100%; min-height: 400px; padding: 5px;';
                    }
                    
                    // Ocultar otros contenedores espec√≠ficos
                    const otherContainers = [
                        'control-proceso-info-container',
                        'Control de produccion SMT-unique-container',
                        'operacion-linea-smt-unique-container'
                    ];
                    
                    otherContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.style.display = 'none';
                        }
                    });
                    
                    // Cargar contenido din√°micamente usando la versi√≥n AJAX
                    cargarContenidoDinamico('inventario-imd-terminado-unique-container', '/control_proceso/inventario_imd_terminado', () => {
                        console.log(' Inventario IMD Terminado AJAX cargado exitosamente');
                        
                        // Verificar que el contenedor espec√≠fico est√© visible
                        const inventarioContainer = document.querySelector('#inventario-imd-terminado-unique-container');
                        if (inventarioContainer) {
                            inventarioContainer.style.display = 'block';
                            inventarioContainer.style.visibility = 'visible';
                            inventarioContainer.style.opacity = '1';
                            
                            console.log(' Contenedor de Inventario IMD Terminado inicializado');
                            console.log(' Inventario IMD Terminado AJAX completamente funcional');
                        } else {
                            console.error('‚ùå No se encontr√≥ el contenedor inventario-imd-terminado-unique-container');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error cargando Inventario IMD Terminado AJAX:', error);
                        
                        // Manejo espec√≠fico de errores
                        let errorMessage = 'Error desconocido al cargar el m√≥dulo';
                        let shouldRedirect = false;
                        
                        // Verificar tipo de error
                        if (error.message && error.message.includes('Permisos insuficientes')) {
                            errorMessage = 'No tienes permisos para acceder a este m√≥dulo';
                        } else if (error.message && error.message.includes('Usuario no autenticado')) {
                            errorMessage = 'Sesi√≥n expirada. Redirigiendo al login...';
                            shouldRedirect = true;
                        } else if (error.status === 404) {
                            errorMessage = 'M√≥dulo Inventario IMD Terminado no encontrado';
                        } else if (error.status === 500) {
                            errorMessage = 'Error interno del servidor';
                        } else if (error.status === 401 || error.status === 403) {
                            errorMessage = 'Error de autenticaci√≥n. Redirigiendo al login...';
                            shouldRedirect = true;
                        } else if (error.status === 0 || !error.status) {
                            errorMessage = 'Error de conexi√≥n al servidor';
                        } else {
                            errorMessage = `Error ${error.status}: ${error.message || 'Error del servidor'}`;
                        }
                        
                        // Mostrar mensaje espec√≠fico en consola para debugging
                        console.error(`Error espec√≠fico: ${errorMessage}`, error);
                        
                        // Redirigir si es necesario
                        if (shouldRedirect) {
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        }
                        
                        // Mostrar contenedor con mensaje de error y bot√≥n de reintentar
                        const errorContainer = document.getElementById('inventario-imd-terminado-unique-container');
                        if (errorContainer) {
                            errorContainer.innerHTML = `
                                <div style="text-align: center; padding: 40px; background: #32323E; color: #ecf0f1; border-radius: 8px;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                                    <h3>Error al cargar Inventario IMD Terminado</h3>
                                    <p>${errorMessage}</p>
                                    ${!shouldRedirect ? `
                                    <button onclick="window.mostrarInventarioIMDTerminado()" style="
                                        background: #3498db; 
                                        color: white; 
                                        border: none; 
                                        padding: 10px 20px; 
                                        border-radius: 5px; 
                                        cursor: pointer; 
                                        margin-top: 20px;
                                        font-size: 14px;
                                    ">Reintentar</button>
                                    ` : ''}
                                </div>
                            `;
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico en mostrarInventarioIMDTerminado:', error);
                    alert('Error cr√≠tico al cargar el m√≥dulo Inventario IMD Terminado');
                }
            };
            
            // Funciones para mostrar otros contenidos
            window.mostrarControlSalida = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                controlSalidaContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente con callback de inicializaci√≥n
                cargarContenidoDinamico('control-salida-container', '/material/control_salida', () => {
                    // üöÄ INICIALIZACI√ìN PRINCIPAL DE CONTROL DE SALIDA
                    if (typeof window.inicializarControlSalidaModule === 'function') {
                        console.log('üîß Ejecutando inicializarControlSalidaModule...');
                        window.inicializarControlSalidaModule();
                    } else if (typeof inicializarControlSalida === 'function') {
                        console.log('üîß Ejecutando inicializarControlSalida...');
                        inicializarControlSalida();
                    } else {
                        console.warn(' Funciones de inicializaci√≥n de Control de Salida no disponibles');
                    }

                    // ÔøΩ ACTIVACI√ìN AUTOM√ÅTICA DEL SISTEMA DE AUTO-ENTER PARA AJAX
                    setTimeout(() => {
                        console.log(' ACTIVANDO AUTO-ENTER SIMPLE DESPU√âS DE CARGA AJAX...');
                        
                        // Verificar que el contenido se haya cargado
                        const codigoInput = document.getElementById('salida_codigo_material_recibido');
                        const verificacionInput = document.getElementById('salida_verificacion_codigo');
                        
                        if (codigoInput && verificacionInput) {
                            // Activar configuraci√≥n de auto-Enter SIMPLE
                            if (typeof configurarEventListenersEscaneo === 'function') {
                                console.log(' Configurando event listeners de escaneo SIMPLE...');
                                configurarEventListenersEscaneo();
                                
                                // Test inmediato para verificar que funciona
                                console.log('üß™ Auto-Enter configurado, campo enfocado');
                                codigoInput.focus();
                                
                                // Mostrar funciones de test disponibles
                                console.log('üí° Funciones de test disponibles:');
                                console.log('   - testAutoEnterSimple() - Simula escaneo completo');
                                console.log('   - verificarAutoEnter() - Verifica configuraci√≥n');
                                
                                // Test autom√°tico simple
                                setTimeout(() => {
                                    console.log('üî¨ Ejecutando test autom√°tico b√°sico...');
                                    if (typeof window.verificarAutoEnter === 'function') {
                                        window.verificarAutoEnter();
                                    }
                                }, 500);
                            } else {
                                console.warn(' configurarEventListenersEscaneo no disponible');
                            }
                            
                            // Activar observador AJAX si est√° disponible
                            if (typeof configurarObservadorAJAX === 'function') {
                                console.log('üëÅÔ∏è Activando observador AJAX...');
                                configurarObservadorAJAX();
                            }
                            
                            // Auto-enfocar el campo de c√≥digo para iniciar el flujo
                            setTimeout(() => {
                                codigoInput.focus();
                                console.log(' Auto-Enter SIMPLE ACTIVADO - Escribe 8+ caracteres');
                            }, 200);
                            
                        } else {
                            console.warn(' Campos de entrada no encontrados para auto-Enter');
                        }
                    }, 300); // Tiempo suficiente para que el DOM se estabilice

                    // üîß RECONEXI√ìN DE EVENT LISTENERS (MANTENER COMPATIBILIDAD)
                    setTimeout(() => {
                        console.log('üîß Reconectando event listeners adicionales...');
                        
                        // Reconectar evento de escaneo (respaldo)
                        const codigoInput = document.getElementById('salida_codigo_material_recibido');
                        if (codigoInput && typeof procesarEscaneoRapido === 'function') {
                            // Solo agregar si no tiene el listener ya
                            if (!codigoInput.dataset.listenerAdded) {
                                codigoInput.addEventListener('keydown', procesarEscaneoRapido);
                                codigoInput.dataset.listenerAdded = 'true';
                                console.log(' Event listener de escaneo reconectado (respaldo)');
                            }
                        }
                        
                        // Reconectar evento de verificaci√≥n (respaldo)
                        const verificacionInput = document.getElementById('salida_verificacion_codigo');
                        if (verificacionInput && typeof procesarVerificacion === 'function') {
                            // Solo agregar si no tiene el listener ya
                            if (!verificacionInput.dataset.listenerAdded) {
                                verificacionInput.addEventListener('keydown', procesarVerificacion);
                                verificacionInput.dataset.listenerAdded = 'true';
                                console.log(' Event listener de verificaci√≥n reconectado (respaldo)');
                            }
                        }
                        
                        // Reconectar bot√≥n de guardar salida (respaldo)
                        const btnGuardar = document.getElementById('salida_btnGuardarSalida');
                        if (btnGuardar && typeof procesarSalidaManual === 'function') {
                            // Solo agregar si no tiene el listener ya
                            if (!btnGuardar.dataset.listenerAdded) {
                                btnGuardar.addEventListener('click', procesarSalidaManual);
                                btnGuardar.dataset.listenerAdded = 'true';
                                console.log(' Event listener de bot√≥n guardar reconectado (respaldo)');
                            }
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('Error cargando control de salida:', error);
                });
            };
            
            window.mostrarControlRetorno = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                controlRetornoContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente con callback de inicializaci√≥n
                cargarContenidoDinamico('control-retorno-container', '/material/control_retorno', () => {
                    
                    // Intentar inicializar funciones de control de retorno
                    if (typeof window.initControlRetorno === 'function') {
                        window.initControlRetorno();
                    } else if (typeof initControlRetorno === 'function') {
                        initControlRetorno();
                    }
                })
                .catch(error => {
                    console.error('Error cargando control de retorno:', error);
                });
                
            };
            
            window.mostrarReciboPago = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                reciboPagoContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('recibo-pago-container', '/material/recibo_pago', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initReciboPago === 'function') {
                        initReciboPago();
                    }
                });
            };
            
            window.mostrarHistorialMaterial = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                historialMaterialContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('historial-material-container', '/material/historial_material', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initHistorialMaterial === 'function') {
                        initHistorialMaterial();
                    }
                });
            };
            
            window.mostrarEstatusMaterial = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                estatusMaterialContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente usando la ruta del servidor
                cargarContenidoDinamico('estatus-material-container', '/material/estatus_material', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas del estatus de material si es necesario
                    if (typeof window.initEstatusMaterial === 'function') {
                        window.initEstatusMaterial();
                    }
                });
            };
            
            window.mostrarMaterialSustituto = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                materialSustitutoContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('material-sustituto-container', '/material/material_sustituto', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initMaterialSustituto === 'function') {
                        initMaterialSustituto();
                    }
                });
            };
            
            window.mostrarConsultarPeps = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                consultarPepsContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('consultar-peps-container', '/material/consultar_peps', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initConsultarPeps === 'function') {
                        initConsultarPeps();
                    }
                });
            };
            
            window.mostrarLongtermInventory = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                longtermInventoryContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('longterm-inventory-container', '/material/longterm_inventory', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initLongtermInventory === 'function') {
                        initLongtermInventory();
                    }
                });
            };
            
            window.mostrarRegistroMaterial = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                registroMaterialContainer.style.display = 'block';
                
                // Cargar el contenido din√°micamente
                cargarContenidoDinamico('registro-material-container', '/material/registro_material', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas del registro de material si es necesario
                    if (typeof initRegistroMaterial === 'function') {
                        initRegistroMaterial();
                    }
                });
            };
            
            window.mostrarHistorialInventario = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                historialInventarioContainer.style.display = 'block';
                
                // Cargar el contenido din√°micamente
                cargarContenidoDinamico('historial-inventario-container', '/material/historial_inventario', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas del historial de inventario si es necesario
                    if (typeof initHistorialInventario === 'function') {
                        initHistorialInventario();
                    }
                });
            };
            
            window.mostrarInventarioRollosSMD = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                inventarioRollosSMDContainer.style.display = 'block';
                
                // Cargar el contenido din√°micamente
                cargarContenidoDinamico('inventario-rollos-smd-container', '/smd/inventario', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas del inventario de rollos SMD si es necesario
                    if (typeof initInventarioRollosSMD === 'function') {
                        initInventarioRollosSMD();
                    }
                });
            };
            
            window.mostrarAjusteNumero = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                ajusteNumeroContainer.style.display = 'block';
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('ajuste-numero-container', '/material/ajuste_numero', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas si es necesario
                    if (typeof initAjusteNumero === 'function') {
                        initAjusteNumero();
                    }
                });
            };
            
            // Funci√≥n global para mostrar Historial de cambio de material SMT
            window.mostrarHistorialCambioSMT = function() {
                hideAllMaterialContainers();
                materialContentArea.style.display = 'block';
                historialCambioSmtContainer.style.display = 'block';
                
                // Cargar estilos espec√≠ficos para SMT si no est√°n cargados
                if (!document.getElementById('historial-smt-styles')) {
                    const link = document.createElement('link');
                    link.id = 'historial-smt-styles';
                    link.rel = 'stylesheet';
                    link.href = '/static/css/historial-smt.css';
                    document.head.appendChild(link);
                    console.log(' Estilos SMT cargados din√°micamente');
                }
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('historial-cambio-smt-container', '/historial-cambio-material-smt-ajax', () => {
                    
                    // Inicializar funcionalidades espec√≠ficas del historial de cambio de material SMT
                    if (typeof initHistorialCambioSMT === 'function') {
                        initHistorialCambioSMT();
                    }
                    
                    console.log(' Historial de cambio de material SMT cargado correctamente');
                });
            };
            
            // Funci√≥n global para mostrar Control de Material
            window.mostrarControlMaterial = function() {
                hideAllContent();
                materialContainer.style.display = 'block';
                controlMaterialContent.style.display = 'block';
                
                // IMPORTANTE: Asegurar que produccion-content-area est√© oculto
                 produccionContentArea.style.display = 'none';
                 
                 // IMPORTANTE: Ocultar tambi√©n el sidebar de Control de Producci√≥n
                 const controlProduccionSidebar = document.getElementById('control-produccion-content');
                 if (controlProduccionSidebar) {
                     controlProduccionSidebar.style.display = 'none';
                 }
                
                // Cargar contenido din√°micamente del sidebar de materiales
                cargarContenidoDinamico('control-material-content', '/listas/control_material')
                    .then(() => {
                        // IMPORTANTE: NO ocultar material-content-area aqu√≠
                        // Las funciones espec√≠ficas (mostrarInfoMaterial, mostrarControlAlmacen) lo manejar√°n
                        hideAllInformacionBasicaContainers();
                        informacionBasicaContentArea.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Error cargando Control de Material:', error);
                        // IMPORTANTE: NO ocultar material-content-area en el error
                        hideAllInformacionBasicaContainers();
                        informacionBasicaContentArea.style.display = 'none';
                    });
            };
            
            // Funci√≥n global para mostrar Control de Producci√≥n
            window.mostrarControlProduccion = function() {
                hideAllContent();
                materialContainer.style.display = 'block';
                controlProduccionContent.style.display = 'block';
                produccionContentArea.style.display = 'block';
                produccionInfoContainer.style.display = 'block';
                
                // IMPORTANTE: Asegurar que material-content-area est√© oculto
                materialContentArea.style.display = 'none';
                hideAllMaterialContainers();
                
                // IMPORTANTE: Ocultar tambi√©n el sidebar de Control de Material
                const controlMaterialSidebar = document.getElementById('control-material-content');
                if (controlMaterialSidebar) {
                    controlMaterialSidebar.style.display = 'none';
                }
                
                // Cargar contenido din√°micamente
                cargarContenidoDinamico('produccion-info-container', '/produccion/info')
                    .catch(error => console.error('Error cargando info producci√≥n:', error));
            };
            
            // Funci√≥n global para mostrar Control de Proceso
            window.mostrarControlProceso = function() {
                hideAllContent();
                materialContainer.style.display = 'block';
                controlProcesoContent.style.display = 'block';
                controlProcesoContentArea.style.display = 'block';
                
                // Mostrar contenedor por defecto de control de proceso
                const controlProcesoInfoContainer = document.getElementById('control-proceso-info-container');
                if (controlProcesoInfoContainer) {
                    controlProcesoInfoContainer.style.display = 'block';
                }
                
                // IMPORTANTE: Asegurar que otras √°reas est√©n ocultas
                materialContentArea.style.display = 'none';
                produccionContentArea.style.display = 'none';
                informacionBasicaContentArea.style.display = 'none';
                hideAllMaterialContainers();
                
                // IMPORTANTE: Ocultar sidebars de otras secciones
                const controlMaterialSidebar = document.getElementById('control-material-content');
                const controlProduccionSidebar = document.getElementById('control-produccion-content');
                if (controlMaterialSidebar) {
                    controlMaterialSidebar.style.display = 'none';
                }
                if (controlProduccionSidebar) {
                    controlProduccionSidebar.style.display = 'none';
                }
                
                // Cargar contenido din√°micamente del sidebar de control de proceso
                cargarContenidoDinamico('control-proceso-content', '/listas/control_proceso')
                    .then(() => {
                        console.log(' Contenido de Control de Proceso cargado exitosamente');
                    })
                    .catch(error => {
                        console.error('Error cargando Control de Proceso:', error);
                    });
            };
            
            // Funci√≥n global para ocultar el contenido de almac√©n
            window.ocultarControlAlmacen = function() {
                materialContentArea.style.display = 'none';
                hideAllMaterialContainers();
            };
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover la clase 'active' de todos los botones
                    navButtons.forEach(b => b.classList.remove('active'));
                    // Agregar la clase 'active' al bot√≥n clickeado
                    this.classList.add('active');
                    
                    // Ocultar todo el contenido primero
                    hideAllContent();
                    
                    if (this.id === 'Informaci√≥n Basica') {
                        materialContainer.style.display = 'block';
                        informacionBasicaContent.style.display = 'block';
                        informacionBasicaContentArea.style.display = 'block';
                        
                        // Cargar contenido din√°micamente y mostrar contenedor por defecto
                        cargarContenidoDinamico('informacion-basica-content', '/listas/informacion_basica')
                            .then(() => {
                                // Asegurar que el √°rea de contenido est√© visible
                                informacionBasicaContentArea.style.display = 'block';
                                hideAllInformacionBasicaContainers();
                                const defaultContainer = document.getElementById('info-basica-default-container');
                                if (defaultContainer) {
                                    defaultContainer.style.display = 'block';
                                }
                            })
                            .catch(error => {
                                console.error('Error cargando Informaci√≥n B√°sica:', error);
                                // Fallback: mostrar contenedor por defecto aunque falle la carga
                                informacionBasicaContentArea.style.display = 'block';
                                hideAllInformacionBasicaContainers();
                                const defaultContainer = document.getElementById('info-basica-default-container');
                                if (defaultContainer) {
                                    defaultContainer.style.display = 'block';
                                }
                            });
                        
                    } else if (this.id === 'Control de material') {
                        // Usar la funci√≥n global para mostrar Control de Material
                        if (typeof window.mostrarControlMaterial === 'function') {
                            window.mostrarControlMaterial();
                        } else {
                            // Fallback si la funci√≥n no est√° disponible
                            materialContainer.style.display = 'block';
                            controlMaterialContent.style.display = 'block';
                            materialContentArea.style.display = 'none';
                            produccionContentArea.style.display = 'none';
                        }
                        
                    } else if (this.id === 'Control de producci√≥n') {
                        // Usar la funci√≥n dedicada que maneja correctamente los contenedores
                        window.mostrarControlProduccion();
                        
                        // Cargar contenido din√°micamente en el sidebar
                        cargarContenidoDinamico('control-produccion-content', '/listas/control_produccion')
                            .catch(error => console.error('Error cargando Control de Producci√≥n:', error));
                        
                    } else if (this.id === 'Control de proceso') {
                        // Usar la funci√≥n global para mostrar Control de Proceso
                        window.mostrarControlProceso();
                        
                    } else if (this.id === 'Control de calidad') {
                        materialContainer.style.display = 'block';
                        controlCalidadContent.style.display = 'block';
                        materialContentArea.style.display = 'none';
                        
                        // Cargar contenido din√°micamente
                        cargarContenidoDinamico('control-calidad-content', '/listas/control_calidad')
                            .catch(error => console.error('Error cargando Control de Calidad:', error));
                        
                    } else if (this.id === 'Control de resultados') {
                        materialContainer.style.display = 'block';
                        controlResultadosContent.style.display = 'block';
                        materialContentArea.style.display = 'none';
                        
                        // Cargar contenido din√°micamente
                        cargarContenidoDinamico('control-resultados-content', '/listas/control_resultados')
                            .catch(error => console.error('Error cargando Control de Resultados:', error));
                        
                    } else if (this.id === 'Control de reporte') {
                        materialContainer.style.display = 'block';
                        if (controlReporteContent) controlReporteContent.style.display = 'block';
                        materialContentArea.style.display = 'none';
                        
                        // Cargar contenido din√°micamente
                        cargarContenidoDinamico('control-reporte-content', '/listas/control_reporte')
                            .catch(error => console.error('Error cargando Control de Reporte:', error));
                        
                    } else if (this.id === 'Configuraci√≥n de programa') {
                        materialContainer.style.display = 'block';
                        configuracionProgramaContent.style.display = 'block';
                        materialContentArea.style.display = 'none';
                        
                        // Cargar contenido din√°micamente
                        cargarContenidoDinamico('configuracion-programa-content', '/listas/configuracion_programa')
                            .catch(error => console.error('Error cargando Configuraci√≥n de Programa:', error));
                        
                    } else {
                        materialContainer.style.display = 'none';
                        // FORZAR ocultar el √°rea de material para cualquier otro caso
                        materialContentArea.style.display = 'none';
                    }
                });
            });
            
            // Por defecto oculto
            materialContainer.style.display = 'none';
            
            // FORZAR estado inicial correcto
            materialContentArea.style.display = 'none';
            hideAllMaterialContainers();
            
            // Activar por defecto la primera pesta√±a (Informaci√≥n B√°sica) si no hay ninguna activa
            const activeButton = document.querySelector('.nav-button.active');
            if (!activeButton) {
                const infoBasicaButton = document.getElementById('Informaci√≥n Basica');
                if (infoBasicaButton) {
                    infoBasicaButton.classList.add('active');
                }
            }
        });
        
        // Funci√≥n para confirmar logout
        function confirmarLogout() {
            if (confirm('¬øEst√° seguro que desea cerrar la sesi√≥n?')) {
                // Mostrar mensaje de cierre
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    color: white;
                    font-size: 1.2rem;
                    text-align: center;
                `;
                overlay.innerHTML = `
                    <div>
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <div>Cerrando sesi√≥n...</div>
                    </div>
                `;
                document.body.appendChild(overlay);
                
                // Redirigir despu√©s de un breve delay
                setTimeout(() => {
                    window.location.href = '/logout';
                }, 1000);
            }
        }
        
        // Inicializar el sistema de permisos cuando la p√°gina est√© completamente cargada
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof PermisosDropdowns !== 'undefined') {
                PermisosDropdowns.init();
            }
        });
        
        // ===============================================
        // CONTROL DE SALIDA - FUNCIONES EMBEBIDAS
        // ===============================================
        
        // Variables globales para Control de Salida
        let materialActual = null;
        let verificacionCompletada = false;

        // Funci√≥n global para inicializar cuando se muestra el control de salida
        window.inicializarControlSalidaModule = function() {
            setTimeout(() => {
                inicializarControlSalida();
            }, 100);
        };

        // Funci√≥n de inicializaci√≥n simplificada
        function inicializarControlSalida() {
            // Establecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            const fechaSalidaForm = document.getElementById('salida_fecha_salida_form');
            
            if (fechaSalidaForm) fechaSalidaForm.value = hoy;

            // Establecer fecha actual en los filtros de historial
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (fechaDesde) fechaDesde.value = hoy;
            if (fechaHasta) fechaHasta.value = hoy;

            // Configurar listeners para el checkbox de registro autom√°tico
            configurarRegistroAutomatico();

            // Cargar modelos disponibles en el BOM
            if (typeof cargarModelosBOM === 'function') {
                cargarModelosBOM();
            }

            // Enfocar campo de c√≥digo
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                setTimeout(() => codigoInput.focus(), 100);
            }

            // Mostrar por defecto las tablas de registro
            if (typeof mostrarRegistroSalida === 'function') {
                mostrarRegistroSalida();
            }
        }

        // Nueva funci√≥n para configurar el comportamiento del registro autom√°tico
        function configurarRegistroAutomatico() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                // Configurar estado inicial
                actualizarModoRegistro();
                
                // Listener para cambios en el checkbox
                checkbox.addEventListener('change', function() {
                    actualizarModoRegistro();
                });
            }
        }

        // Funci√≥n para actualizar el modo de registro seg√∫n el checkbox
        function actualizarModoRegistro() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                if (checkbox.checked) {
                    btnGuardar.style.display = 'none';
                } else {
                    btnGuardar.style.display = 'block';
                }
            }
        }

        // FUNCI√ìN PRINCIPAL: Procesar escaneo ultra r√°pido
        async function procesarEscaneoRapido(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const codigo = event.target.value.trim();
                
                if (!codigo) {
                    return;
                }
                
                try {
                    const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                    const data = await response.json();

                    if (!data.success || !data.material) {
                        mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                        return;
                    }

                    const material = data.material;
                    
                    rellenarCamposMaterial(material);
                    materialActual = material;
                    
                    limpiarVerificacion();
                    
                    const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                    if (campoVerificacion) {
                        setTimeout(() => {
                            campoVerificacion.focus();
                        }, 300);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensajeSimple('Error al buscar material', 'error');
                }
            }
        }

        // Nueva funci√≥n para procesar verificaci√≥n de salida
        function procesarVerificacion(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const codigoVerificacion = event.target.value.trim();
                
                if (!codigoVerificacion) {
                    return;
                }
                
                if (!materialActual) {
                    mostrarMensajeSimple('Primero debe escanear un material', 'error');
                    event.target.value = '';
                    return;
                }
                
                const coincidencias = verificarCoincidencias(codigoVerificacion, materialActual);
                
                if (coincidencias.length > 0) {
                    mostrarMensajeSimple(` Verificado: ${coincidencias.join(', ')}`, 'success');
                    verificacionCompletada = true;
                    
                    event.target.style.border = '2px solid #27ae60';
                    event.target.readOnly = true;
                    
                    const checkbox = document.getElementById('salida_registroAutomatico');
                    const registroAutomatico = checkbox ? checkbox.checked : false;
                    
                    if (registroAutomatico) {
                        setTimeout(async () => {
                            await procesarSalidaAutomaticaDespuesVerificacion();
                        }, 500);
                    } else {
                        mostrarMensajeSimple('Verificaci√≥n completada - Haga clic en "Guardar Salida"', 'info');
                    }
                    
                } else {
                    mostrarMensajeSimple('‚ùå C√≥digo no coincide con el material', 'error');
                    verificacionCompletada = false;
                    event.target.value = '';
                    event.target.focus();
                }
            }
        }

        // Funci√≥n para verificar coincidencias entre el c√≥digo escaneado y los datos del material
        function verificarCoincidencias(codigoVerificacion, material) {
            const coincidencias = [];
            
            const camposAVerificar = [
                { campo: 'codigo_material_recibido', nombre: 'C√≥digo Recibido' },
                { campo: 'codigo_material', nombre: 'C√≥digo Material' },
                { campo: 'codigo_material_original', nombre: 'C√≥digo Original' },
                { campo: 'numero_parte', nombre: 'N√∫mero de Parte' },
                { campo: 'numero_lote_material', nombre: 'Lote' }
            ];
            
            camposAVerificar.forEach(item => {
                const valorCampo = material[item.campo];
                if (valorCampo && codigoVerificacion.includes(valorCampo)) {
                    coincidencias.push(item.nombre);
                }
                if (valorCampo && valorCampo.includes(codigoVerificacion)) {
                    if (!coincidencias.includes(item.nombre)) {
                        coincidencias.push(item.nombre);
                    }
                }
            });
            
            return coincidencias;
        }

        // Funci√≥n para limpiar verificaci√≥n cuando se cambie de material
        function limpiarVerificacion() {
            const campoVerificacion = document.getElementById('salida_verificacion_codigo');
            
            if (campoVerificacion) {
                campoVerificacion.value = '';
                campoVerificacion.style.border = '2px solid #e74c3c';
                campoVerificacion.readOnly = false;
            }
            
            verificacionCompletada = false;
        }

        // üîß FUNCI√ìN PARA CONSULTAR ESPECIFICACI√ìN POR N√öMERO DE PARTE
        async function consultarEspecificacionPorNumeroParte(numeroParte) {
            console.log('ÔøΩ Consultando especificaci√≥n para n√∫mero de parte:', numeroParte);
            
            try {
                const response = await fetch(`/consultar_especificacion_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Respuesta del servidor:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Datos recibidos:', data);
                
                if (data.success && data.especificacion) {
                    console.log(` Especificaci√≥n encontrada desde campo '${data.campo_origen}':`, data.especificacion);
                    return data.especificacion;
                } else {
                    console.log('‚ùå No se encontr√≥ especificaci√≥n:', data.error || 'Sin especificaci√≥n disponible');
                    
                    // Si tenemos informaci√≥n del material, mostrarla para debug
                    if (data.campos_disponibles) {
                        console.log('ÔøΩ Campos disponibles en el material:', data.campos_disponibles);
                    }
                    
                    return null;
                }
                
            } catch (error) {
                console.error('‚ùå Error al consultar especificaci√≥n:', error);
                return null;
            }
        }

        // üîß FUNCI√ìN MEJORADA PARA CONSULTAR ESPECIFICACI√ìN DESDE HISTORIAL DE SALIDAS
        async function consultarEspecificacionDesdeHistorial(numeroParte) {
            console.log('üì° Consultando especificaci√≥n desde historial para n√∫mero de parte:', numeroParte);
            
            try {
                // Consultar historial de salidas directamente
                const response = await fetch(`/consultar_historial_salidas?numero_parte=${encodeURIComponent(numeroParte)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Datos de historial recibidos:', data);
                    
                    if (data.success && data.salidas && data.salidas.length > 0) {
                        // Buscar la especificaci√≥n m√°s reciente en el historial
                        for (const salida of data.salidas) {
                            if (salida.especificacion_material && salida.especificacion_material.trim()) {
                                console.log(` Especificaci√≥n encontrada en historial:`, salida.especificacion_material);
                                return salida.especificacion_material.trim();
                            }
                        }
                        console.log(' No se encontr√≥ especificaci√≥n en ninguna salida del historial');
                    } else {
                        console.log(' No hay historial de salidas para este n√∫mero de parte');
                    }
                } else {
                    console.log('‚ùå Error al consultar historial:', response.status);
                }
                
                return null;
                
            } catch (error) {
                console.error('‚ùå Error al consultar especificaci√≥n desde historial:', error);
                return null;
            }
        }

        // Funci√≥n para rellenar campos del material
        function rellenarCamposMaterial(material) {
            console.log('üîç RELLENANDO CAMPOS - Material recibido:', material);
            
            const campos = [
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            campos.forEach(campoId => {
                const campo = document.getElementById(campoId);
                const propiedad = campoId.replace('salida_', '');
                
                // üîß MANEJO ESPECIAL PARA N√öMERO DE LOTE
                if (campoId === 'salida_numero_lote_material') {
                    let numeroLote = null;
                    
                    // Buscar en diferentes propiedades posibles
                    const propiedadesPosibles = [
                        'numero_lote_material',
                        'numero_lote',
                        'lote_material',
                        'lote',
                        'numero_de_lote',
                        'numeroLote'
                    ];
                    
                    for (const prop of propiedadesPosibles) {
                        if (material[prop] !== undefined && material[prop] !== null && material[prop] !== '') {
                            numeroLote = material[prop];
                            console.log(` N√∫mero de lote encontrado en propiedad '${prop}':`, numeroLote);
                            break;
                        }
                    }
                    
                    if (numeroLote && campo) {
                        campo.value = numeroLote;
                        console.log(' Campo n√∫mero de lote rellenado:', numeroLote);
                    } else {
                        console.log(' No se encontr√≥ n√∫mero de lote en ninguna propiedad');
                        console.log(' Propiedades disponibles en material:', Object.keys(material));
                    }
                }
                // üîß MANEJO ESPECIAL PARA ESPECIFICACI√ìN
                else if (campoId === 'salida_especificacion_material') {
                    let especificacion = null;
                    
                    // Buscar en diferentes propiedades posibles
                    const propiedadesEspecificacion = [
                        'especificacion_material',
                        'especificacion',
                        'descripcion_material',
                        'descripcion',
                        'nombre_material'
                    ];
                    
                    for (const prop of propiedadesEspecificacion) {
                        if (material[prop] !== undefined && material[prop] !== null && material[prop] !== '') {
                            especificacion = material[prop];
                            console.log(` Especificaci√≥n encontrada en propiedad '${prop}':`, especificacion);
                            break;
                        }
                    }
                    
                    if (especificacion && campo) {
                        campo.value = especificacion;
                        console.log(' Campo especificaci√≥n rellenado:', especificacion);
                    } else {
                        console.log(' No se encontr√≥ especificaci√≥n directamente');
                        
                        // Si no encontramos especificaci√≥n, intentar consultarla desde historial primero
                        if (material.numero_parte) {
                            console.log('üîç Intentando consultar especificaci√≥n desde historial por n√∫mero de parte...');
                            consultarEspecificacionDesdeHistorial(material.numero_parte)
                                .then(especificacionHistorial => {
                                    if (especificacionHistorial && campo) {
                                        campo.value = especificacionHistorial;
                                        console.log(' Especificaci√≥n desde historial rellenada:', especificacionHistorial);
                                        
                                        // Actualizar el material actual con la especificaci√≥n encontrada
                                        if (materialActual) {
                                            materialActual.especificacion_material = especificacionHistorial;
                                            materialActual.especificacion = especificacionHistorial;
                                        }
                                    } else {
                                        // Si no hay en historial, intentar consulta directa a BD como fallback
                                        console.log('üîç No hay especificaci√≥n en historial, intentando consulta directa...');
                                        consultarEspecificacionPorNumeroParte(material.numero_parte)
                                            .then(especificacionConsultada => {
                                                if (especificacionConsultada && campo) {
                                                    campo.value = especificacionConsultada;
                                                    console.log(' Especificaci√≥n desde BD directa rellenada:', especificacionConsultada);
                                                    
                                                    // Actualizar el material actual con la especificaci√≥n encontrada
                                                    if (materialActual) {
                                                        materialActual.especificacion_material = especificacionConsultada;
                                                        materialActual.especificacion = especificacionConsultada;
                                                    }
                                                }
                                            });
                                    }
                                });
                        }
                    }
                } else {
                    // Manejo normal para otros campos
                    if (campo && material[propiedad]) {
                        campo.value = material[propiedad];
                    }
                }
            });
            
            // üîç DEBUG: Mostrar informaci√≥n completa del material
            console.log('üìä INFORMACI√ìN COMPLETA DEL MATERIAL:');
            console.log('- C√≥digo material:', material.codigo_material || 'N/A');
            console.log('- N√∫mero parte:', material.numero_parte || 'N/A');
            console.log('- Cantidad actual:', material.cantidad_actual || 'N/A');
            console.log('- N√∫mero lote (todas las propiedades):');
            
            const propiedadesLote = [
                'numero_lote_material',
                'numero_lote',
                'lote_material', 
                'lote',
                'numero_de_lote',
                'numeroLote'
            ];
            
            propiedadesLote.forEach(prop => {
                if (material.hasOwnProperty(prop)) {
                    console.log(`  ‚Ä¢ ${prop}:`, material[prop]);
                }
            });
        }

        // Nueva funci√≥n para procesamiento autom√°tico despu√©s de verificaci√≥n exitosa
        async function procesarSalidaAutomaticaDespuesVerificacion() {
            try {
                const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
                
                if (!codigo || !materialActual || !verificacionCompletada) {
                    mostrarMensajeSimple('Error: faltan datos para procesar salida', 'error');
                    return;
                }
                
                const modelo = document.getElementById('salida_modelo')?.value || 'SIN_MODELO';
                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // üîß OBTENER N√öMERO DE LOTE DE M√öLTIPLES PROPIEDADES POSIBLES
                let numeroLote = '';
                const propiedadesLote = [
                    'numero_lote_material',
                    'numero_lote',
                    'lote_material',
                    'lote',
                    'numero_de_lote',
                    'numeroLote'
                ];
                
                for (const prop of propiedadesLote) {
                    if (materialActual[prop] !== undefined && materialActual[prop] !== null && materialActual[prop] !== '') {
                        numeroLote = materialActual[prop];
                        console.log(` Usando n√∫mero de lote de propiedad '${prop}':`, numeroLote);
                        break;
                    }
                }
                
                if (!numeroLote) {
                    console.log(' ADVERTENCIA: No se encontr√≥ n√∫mero de lote en el material');
                }

                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: numeroLote,
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        // NO enviar especificacion_material - el backend la obtendr√° del original
                        proceso_salida: 'AUTO',  // Cambiar de 'SMD' a 'AUTO' para determinaci√≥n autom√°tica
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    const modeloTexto = modelo === 'SIN_MODELO' ? ' (sin modelo)' : ` (${modelo})`;
                    const procesoDestino = salidaData.proceso_destino || 'PRODUCCION';
                    
                    mostrarMensajeSimple(
                        `‚úÖ Salida autom√°tica procesada: ${cantidadSalida}${modeloTexto} ‚Üí ${procesoDestino}`, 
                        'success'
                    );
                    
                    setTimeout(() => {
                        limpiarCamposMaterial();
                    }, 1000);
                    
                } else {
                }
                
            } catch (error) {
                console.error('‚ùå Error en procesamiento autom√°tico:', error);
                mostrarMensajeSimple('Error interno en procesamiento autom√°tico', 'error');
            }
        }

        // Nueva funci√≥n para procesamiento manual NEUTRALIZADA para salida r√°pida
        async function procesarSalidaManual() {
            console.log('üîß procesarSalidaManual llamada desde MaterialTemplate');
            
            // OVERRIDE: Si est√° en modo salida r√°pida, usar la funci√≥n espec√≠fica
            if (window.SALIDA_RAPIDA_ACTIVA && window.guardarSalida) {
                console.log(' Detectado modo salida r√°pida, usando funci√≥n espec√≠fica');
                window.guardarSalida();
                return;
            }
            
            const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
            
            if (!codigo) {
                mostrarMensajeSimple('Ingrese c√≥digo de material', 'error');
                return;
            }
            
            if (!materialActual) {
                mostrarMensajeSimple('Primero busque el material escaneando o escribiendo c√≥digo', 'error');
                return;
            }
            
            // ELIMINADO: validaci√≥n de verificaci√≥n para permitir salida directa
            console.log('‚ö° Procesando salida manual SIN verificaci√≥n desde MaterialTemplate');
            
            try {
                const modelo = document.getElementById('salida_modelo')?.value || 'SIN_MODELO';
                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // üîß OBTENER N√öMERO DE LOTE DE M√öLTIPLES PROPIEDADES POSIBLES
                let numeroLote = '';
                const propiedadesLote = [
                    'numero_lote_material',
                    'numero_lote',
                    'lote_material',
                    'lote',
                    'numero_de_lote',
                    'numeroLote'
                ];
                
                for (const prop of propiedadesLote) {
                    if (materialActual[prop] !== undefined && materialActual[prop] !== null && materialActual[prop] !== '') {
                        numeroLote = materialActual[prop];
                        console.log(` Usando n√∫mero de lote de propiedad '${prop}':`, numeroLote);
                        break;
                    }
                }
                
                if (!numeroLote) {
                    console.log(' ADVERTENCIA: No se encontr√≥ n√∫mero de lote en el material');
                }

                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: numeroLote,
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        // NO enviar especificacion_material - el backend la obtendr√° del original
                        proceso_salida: 'AUTO',  // Cambiar de 'SMD' a 'AUTO' para determinaci√≥n autom√°tica
                        codigo_verificacion: 'AUTO' // SIEMPRE AUTO, SIN VERIFICACI√ìN
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    const modeloTexto = modelo === 'SIN_MODELO' ? ' (sin modelo)' : ` (${modelo})`;
                    const procesoDestino = salidaData.proceso_destino || 'PRODUCCION';
                    
                    mostrarMensajeSimple(
                        `‚úÖ Salida procesada: ${cantidadSalida}${modeloTexto} ‚Üí ${procesoDestino}`, 
                        'success'
                    );
                    
                    // Limpiar y preparar para siguiente
                    setTimeout(() => {
                        if (typeof limpiarCamposMaterial === 'function') {
                            limpiarCamposMaterial();
                        }
                    }, 800);
                    
                } else {
                    mostrarMensajeSimple('Error al procesar salida: ' + (salidaData.error || 'Error desconocido'), 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error en procesamiento manual desde MaterialTemplate:', error);
                mostrarMensajeSimple('Error interno en procesamiento manual', 'error');
            }
        }

        // Funci√≥n para limpiar campos del material
        function limpiarCamposMaterial() {
            const campos = [
                'salida_codigo_material_recibido',
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            campos.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.value = '';
                }
            });
            
            limpiarVerificacion();
            materialActual = null;
            
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                setTimeout(() => codigoInput.focus(), 100);
            }
        }

        // üîß FUNCI√ìN DE DEBUGGING PARA N√öMERO DE LOTE
        window.debugNumeroLote = function() {
            console.log('üß™ VERIFICANDO N√öMERO DE LOTE DESDE BASE DE DATOS:');
            console.log('================================================');
            
            if (!materialActual) {
                console.log('‚ùå No hay material actual cargado');
                console.log('üí° Primero escanee un c√≥digo de material');
                return { error: 'No hay material cargado' };
            }
            
            console.log('üì¶ Material actual completo:', materialActual);
            
            // Verificar todas las propiedades posibles de n√∫mero de lote
            const propiedadesLote = [
                'numero_lote_material',
                'numero_lote',
                'lote_material',
                'lote',
                'numero_de_lote',
                'numeroLote'
            ];
            
            console.log('üîç Buscando n√∫mero de lote en todas las propiedades:');
            const resultados = {};
            
            propiedadesLote.forEach(prop => {
                const valor = materialActual[prop];
                resultados[prop] = valor;
                console.log(`  ‚Ä¢ ${prop}:`, valor || 'NO ENCONTRADO');
            });
            
            // Verificar que el campo visual muestre el n√∫mero de lote
            const campoLote = document.getElementById('salida_numero_lote_material');
            if (campoLote) {
                console.log(' Campo visual n√∫mero de lote:', campoLote.value || 'VAC√çO');
            } else {
                console.log('‚ùå Campo visual de n√∫mero de lote no encontrado');
            }
            
            // Buscar el mejor n√∫mero de lote disponible
            let mejorLote = null;
            for (const prop of propiedadesLote) {
                if (materialActual[prop] !== undefined && materialActual[prop] !== null && materialActual[prop] !== '') {
                    mejorLote = materialActual[prop];
                    console.log(` MEJOR N√öMERO DE LOTE ENCONTRADO: '${mejorLote}' (de propiedad '${prop}')`);
                    break;
                }
            }
            
            if (!mejorLote) {
                console.log(' NO SE ENCONTR√ì N√öMERO DE LOTE EN NINGUNA PROPIEDAD');
                console.log(' Todas las propiedades del material:', Object.keys(materialActual));
            }
            
            return {
                materialCompleto: materialActual,
                propiedadesLote: resultados,
                campoVisual: campoLote ? campoLote.value : null,
                mejorLoteEncontrado: mejorLote
            };
        };
        
        // üîß FUNCI√ìN PARA FORZAR RELLENADO CON DEBUGGING
        window.forzarRellenadoLote = function() {
            console.log('üîß FORZANDO RELLENADO DE N√öMERO DE LOTE...');
            
            if (!materialActual) {
                console.log('‚ùå No hay material cargado');
                return false;
            }
            
            const campoLote = document.getElementById('salida_numero_lote_material');
            if (!campoLote) {
                console.log('‚ùå Campo de n√∫mero de lote no encontrado');
                return false;
            }
            
            // Buscar n√∫mero de lote en cualquier propiedad
            const propiedades = [
                'numero_lote_material',
                'numero_lote', 
                'lote_material',
                'lote',
                'numero_de_lote',
                'numeroLote'
            ];
            
            for (const prop of propiedades) {
                const valor = materialActual[prop];
                if (valor !== undefined && valor !== null && valor !== '') {
                    campoLote.value = valor;
                    console.log(` N√∫mero de lote forzado: '${valor}' (de propiedad '${prop}')`);
                    return true;
                }
            }
            
            console.log(' No se pudo forzar - no hay n√∫mero de lote disponible');
            return false;
        };
        
        // üîß FUNCI√ìN PARA DEBUGGING DE TABLA HISTORIAL
        window.debugTablaHistorial = function() {
            console.log('üß™ DEBUGGING TABLA HISTORIAL DE SALIDAS:');
            console.log('=====================================');
            
            // Intentar obtener los datos m√°s recientes de la tabla
            const tabla = document.getElementById('salida_tablaSalidas');
            if (!tabla) {
                console.log('‚ùå Tabla de salidas no encontrada');
                return { error: 'Tabla no encontrada' };
            }
            
            const filas = tabla.querySelectorAll('tbody tr');
            console.log(`üìä Filas encontradas en tabla: ${filas.length}`);
            
            if (filas.length === 0) {
                console.log(' No hay filas en la tabla');
                return { filas: 0 };
            }
            
            // Analizar la primera fila con datos reales
            let filaConDatos = null;
            filas.forEach((fila, index) => {
                const celdas = fila.querySelectorAll('td');
                if (celdas.length > 1 && !celdas[0].textContent.includes('No hay dato')) {
                    filaConDatos = fila;
                    console.log(` Fila ${index + 1} tiene datos reales`);
                    return false; // Equivalente a break
                }
            });
            
            if (!filaConDatos) {
                console.log(' No se encontraron filas con datos reales');
                return { sinDatos: true };
            }
            
            const celdas = filaConDatos.querySelectorAll('td');
            
            const numeroLote = celdas[7]?.textContent || '';
            if (!numeroLote || numeroLote === '') {
                console.log('‚ùå EL N√öMERO DE LOTE EST√Å VAC√çO EN LA TABLA');
                console.log('üí° Esto indica que el servidor no est√° enviando el n√∫mero de lote');
                console.log('üí° O que est√° en una propiedad diferente a las que buscamos');
            } else {
                console.log(' N√öMERO DE LOTE ENCONTRADO EN TABLA:', numeroLote);
            }
            
            return {
                filas: filas.length,
                numeroLoteEnTabla: numeroLote,
                contenidoCompleto: Array.from(celdas).map(c => c.textContent)
            };
        };
        
        // üîß FUNCI√ìN PARA INTERCEPTAR RESPUESTA DEL SERVIDOR
        window.debugRespuestaServidor = function() {
            console.log('üîç INTERCEPTANDO PR√ìXIMA CONSULTA AL SERVIDOR...');
            
            // Interceptar fetch temporalmente
            const originalFetch = window.fetch;
            let interceptorActivo = true;
            
            window.fetch = function(...args) {
                const [url] = args;
                
                if (interceptorActivo && url.includes('consultar_historial_salidas')) {
                    console.log(' INTERCEPTADO - Consulta al historial de salidas');
                    
                    return originalFetch.apply(this, args)
                        .then(response => {
                            return response.clone().json().then(data => {
                                console.log('üì• RESPUESTA COMPLETA DEL SERVIDOR:');
                                console.log(data);
                                
                                if (data.salidas && data.salidas.length > 0) {
                                    console.log('ÔøΩ ANALIZANDO PRIMERA SALIDA:');
                                    const primeraSalida = data.salidas[0];
                                    console.log('ÔøΩüì¶ Objeto completo primera salida:', primeraSalida);
                                    
                                    // Buscar especificaci√≥n en todas las propiedades posibles
                                    const propiedadesEspec = [
                                        'especificacion_material',
                                        'especificacion',
                                        'especification',
                                        'spec',
                                        'description',
                                        'descripcion'
                                    ];
                                    
                                    console.log('üîç PROPIEDADES DE ESPECIFICACI√ìN:');
                                    propiedadesEspec.forEach(prop => {
                                        if (primeraSalida.hasOwnProperty(prop)) {
                                            console.log(`   ${prop}:`, primeraSalida[prop]);
                                        } else {
                                            console.log(`  ‚ùå ${prop}: NO ENCONTRADO`);
                                        }
                                    });
                                    
                                    // Buscar n√∫mero de lote
                                    const propiedadesLote = [
                                        'numero_lote_material',
                                        'numero_lote',
                                        'lote_material',
                                        'lote',
                                        'numero_de_lote',
                                        'numeroLote'
                                    ];
                                    
                                    console.log('üîç PROPIEDADES DE N√öMERO DE LOTE:');
                                    propiedadesLote.forEach(prop => {
                                        if (primeraSalida.hasOwnProperty(prop)) {
                                            console.log(`   ${prop}:`, primeraSalida[prop]);
                                        } else {
                                            console.log(`  ‚ùå ${prop}: NO ENCONTRADO`);
                                        }
                                    });
                                    
                                    console.log(' TODAS LAS PROPIEDADES DISPONIBLES:');
                                    console.log(Object.keys(primeraSalida));
                                } else {
                                    console.log(' No hay salidas en la respuesta o formato diferente');
                                    console.log('üîç Estructura de datos recibida:', Object.keys(data));
                                }
                                
                                // Restaurar fetch original
                                window.fetch = originalFetch;
                                interceptorActivo = false;
                                
                                return response;
                            });
                        });
                }
                
                return originalFetch.apply(this, args);
            };
            
            console.log(' Interceptor activado. Ahora haga una consulta al historial.');
            console.log('üí° El interceptor se desactivar√° autom√°ticamente despu√©s de la primera consulta');
            
            return 'Interceptor activado - Consulte el historial para ver los datos del servidor';
        };
        
        console.log(' Funciones de debugging de tabla instaladas');
        console.log('üí° Comandos disponibles:');
        console.log('   - debugTablaHistorial() - Ver contenido actual de la tabla');
        console.log('   - debugRespuestaServidor() - Interceptar pr√≥xima respuesta del servidor');
        console.log('   - debugEspecificacionMaterial() - Verificar especificaci√≥n del material actual');
        console.log('   - repararTablaEspecificacion() - Reparar tabla actual con especificaci√≥n del material');
        console.log('   - activarEspecificacionAutomatica() - SOLUCI√ìN PERMANENTE: Siempre mostrar especificaciones');
        console.log('   - forzarInterceptorEspecificacion() - FORZAR interceptor sin HISTORIAL_GLOBAL');
        console.log('   - probarConsultaEspecificacion() - PROBAR consulta por n√∫mero de parte 0RH5602C622');

        // üîß FUNCI√ìN DE PRUEBA PARA CONSULTAR ESPECIFICACI√ìN
        window.probarConsultaEspecificacion = async function() {
            console.log('üß™ PROBANDO CONSULTA DE ESPECIFICACI√ìN...');
            console.log('=======================================');
            
            const numeroParte = '0RH5602C622';
            console.log('üîç Consultando n√∫mero de parte:', numeroParte);
            
            try {
                const especificacion = await consultarEspecificacionPorNumeroParte(numeroParte);
                
                if (especificacion) {
                    console.log(' ESPECIFICACI√ìN ENCONTRADA:', especificacion);
                    
                    // Si estamos en control de salida, rellenar el campo
                    const campoEspecificacion = document.getElementById('salida_especificacion_material');
                    if (campoEspecificacion) {
                        campoEspecificacion.value = especificacion;
                        console.log(' Campo de especificaci√≥n actualizado');
                    }
                    
                    return especificacion;
                } else {
                    console.log('‚ùå No se pudo obtener especificaci√≥n');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error en prueba de consulta:', error);
                return null;
            }
        };
        
        // üîß FUNCI√ìN SIMPLE PARA FORZAR INTERCEPTOR
        window.forzarInterceptorEspecificacion = function() {
            console.log('üöÄ FORZANDO INTERCEPTOR DE ESPECIFICACI√ìN...');
            
            // Resetear bandera si ya existe
            window.fetchInterceptorEspecificacion = false;
            
            const originalFetch = window.fetch;
            
            window.fetch = function(...args) {
                const [url] = args;
                
                if (url.includes('consultar_historial_salidas')) {
                    console.log(' INTERCEPTANDO CONSULTA DE HISTORIAL:', url);
                    
                    return originalFetch.apply(this, args)
                        .then(response => {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return response.json().then(data => {
                                    console.log('üì¶ DATOS ORIGINALES DEL SERVIDOR:', data);
                                    
                                    if (data.success && Array.isArray(data.salidas)) {
                                        let especificacionUsada = null;
                                        
                                        // Obtener especificaci√≥n del material actual
                                        if (materialActual) {
                                            especificacionUsada = materialActual.especificacion || 
                                                                materialActual.especificacion_material;
                                        }
                                        
                                        // Si no hay especificaci√≥n del material, buscar en los datos
                                        if (!especificacionUsada) {
                                            const conEspec = data.salidas.find(s => s.especificacion || s.especificacion_material);
                                            if (conEspec) {
                                                especificacionUsada = conEspec.especificacion || conEspec.especificacion_material;
                                            }
                                        }
                                        
                                        // Aplicar especificaci√≥n a todas las filas
                                        const especFinal = especificacionUsada || 'Sin especificaci√≥n disponible';
                                        
                                        data.salidas.forEach((salida, index) => {
                                            salida.especificacion_material = especFinal;
                                            salida.especificacion = especFinal;
                                            console.log(` Fila ${index + 1} - Especificaci√≥n: ${especFinal}`);
                                        });
                                        
                                        console.log(' ESPECIFICACIONES APLICADAS A TODAS LAS FILAS');
                                    }
                                    
                                    return new Response(JSON.stringify(data), {
                                        status: response.status,
                                        statusText: response.statusText,
                                        headers: response.headers
                                    });
                                });
                            }
                            return response;
                        });
                }
                
                return originalFetch.apply(this, args);
            };
            
            window.fetchInterceptorEspecificacion = true;
            console.log(' INTERCEPTOR FORZADO ACTIVADO');
            console.log('üí° Pr√≥xima consulta de historial ser√° interceptada');
            return true;
        };
        
        // üîß FUNCI√ìN PARA REPARAR TABLA ACTUAL CON ESPECIFICACI√ìN
        window.repararTablaEspecificacion = function() {
            if (!materialActual) {
                console.log('‚ùå No hay material cargado');
                return false;
            }
            
            const especificacion = materialActual.especificacion || materialActual.especificacion_material || 'Sin especificaci√≥n';
            console.log('üîß REPARANDO TABLA CON ESPECIFICACI√ìN:', especificacion);
            
            const tabla = document.getElementById('salida_tablaSalidas');
            if (!tabla) {
                console.log('‚ùå Tabla no encontrada');
                return false;
            }
            
            const filas = tabla.querySelectorAll('tbody tr');
            let reparadas = 0;
            
            filas.forEach((fila, index) => {
                const celdas = fila.querySelectorAll('td');
                
                // Verificar que no sea la fila de "no hay datos" y que tenga la cantidad correcta de celdas
                if (celdas.length >= 9 && !celdas[0].textContent.includes('No hay dato')) {
                    const celdaEspecificacion = celdas[8]; // Columna de especificaci√≥n (√≠ndice 8)
                    
                    if (!celdaEspecificacion.textContent || celdaEspecificacion.textContent.trim() === '') {
                        celdaEspecificacion.textContent = especificacion;
                        celdaEspecificacion.style.color = '#27ae60'; // Verde para indicar que fue reparado
                        celdaEspecificacion.title = 'Especificaci√≥n reparada desde material actual';
                        reparadas++;
                        console.log(` Fila ${index + 1} reparada con especificaci√≥n`);
                    }
                }
            });
            
            console.log(` REPARACI√ìN COMPLETADA: ${reparadas} filas reparadas`);
            return reparadas > 0;
        };
        
        // üîß FUNCI√ìN PARA ACTIVAR ESPECIFICACI√ìN AUTOM√ÅTICA PERMANENTE
        window.activarEspecificacionAutomatica = function() {
            console.log('üîß ACTIVANDO ESPECIFICACI√ìN AUTOM√ÅTICA PERMANENTE...');
            
            // M√âTODO 1: Interceptar HISTORIAL_GLOBAL si est√° disponible
            if (typeof window.HISTORIAL_GLOBAL !== 'undefined' && window.HISTORIAL_GLOBAL.actualizarTabla) {
                const originalUpdateTable = window.HISTORIAL_GLOBAL.actualizarTabla;
                
                window.HISTORIAL_GLOBAL.actualizarTabla = function(salidas) {
                    console.log(' INTERCEPTANDO ACTUALIZACI√ìN - Agregando especificaciones autom√°ticamente');
                    
                    // Agregar especificaci√≥n a cada salida usando el material actual si existe
                    salidas.forEach((salida, index) => {
                        if ((!salida.especificacion_material || salida.especificacion_material === '') && 
                            (!salida.especificacion || salida.especificacion === '')) {
                            
                            // Si hay material actual, usar su especificaci√≥n
                            if (materialActual && (materialActual.especificacion || materialActual.especificacion_material)) {
                                const especificacion = materialActual.especificacion || materialActual.especificacion_material;
                                salida.especificacion_material = especificacion;
                                salida.especificacion = especificacion;
                                console.log(` Especificaci√≥n agregada a fila ${index + 1}:`, especificacion);
                            } else {
                                // Si no hay material actual, buscar en la primera salida que tenga especificaci√≥n
                                const salidaConEspec = salidas.find(s => s.especificacion || s.especificacion_material);
                                if (salidaConEspec) {
                                    const especificacion = salidaConEspec.especificacion || salidaConEspec.especificacion_material;
                                    salida.especificacion_material = especificacion;
                                    salida.especificacion = especificacion;
                                    console.log(` Especificaci√≥n copiada a fila ${index + 1}:`, especificacion);
                                } else {
                                    // √öltimo recurso: especificaci√≥n por defecto
                                    salida.especificacion_material = 'Especificaci√≥n no disponible';
                                    salida.especificacion = 'Especificaci√≥n no disponible';
                                }
                            }
                        }
                    });
                    
                    // Llamar funci√≥n original con datos modificados
                    return originalUpdateTable.call(this, salidas);
                };
                
                console.log(' ESPECIFICACI√ìN AUTOM√ÅTICA ACTIVADA PERMANENTEMENTE (HISTORIAL_GLOBAL)');
                console.log('üí° Todas las futuras consultas al historial mostrar√°n especificaciones');
                return true;
            }
            
            // M√âTODO 2: Interceptar fetch para modificar respuestas del servidor
            if (!window.fetchInterceptorEspecificacion) {
                console.log('üîß HISTORIAL_GLOBAL no disponible - Activando interceptor fetch...');
                
                const originalFetch = window.fetch;
                
                window.fetch = function(...args) {
                    const [url] = args;
                    
                    // Interceptar consultas de historial
                    if (url.includes('consultar_historial_salidas')) {
                        return originalFetch.apply(this, args)
                            .then(response => {
                                return response.clone().json().then(data => {
                                    console.log('üîç Interceptando respuesta del servidor:', data);
                                    
                                    // Modificar datos antes de devolver
                                    if (data.success && Array.isArray(data.salidas)) {
                                        data.salidas.forEach((salida, index) => {
                                            if (!salida.especificacion_material && materialActual) {
                                                salida.especificacion_material = materialActual.especificacion || 
                                                                               materialActual.especificacion_material || 
                                                                               'Especificaci√≥n desde material';
                                                console.log(` Especificaci√≥n a√±adida a fila ${index + 1}:`, salida.especificacion_material);
                                            }
                                        });
                                        console.log(' Especificaciones a√±adidas a respuesta del servidor');
                                    }
                                    
                                    // Devolver respuesta modificada
                                    return new Response(JSON.stringify(data), {
                                        status: response.status,
                                        statusText: response.statusText,
                                        headers: response.headers
                                    });
                                });
                            })
                            .catch(() => originalFetch.apply(this, args));
                    }
                    
                    return originalFetch.apply(this, args);
                };
                
                window.fetchInterceptorEspecificacion = true;
                console.log(' ESPECIFICACI√ìN AUTOM√ÅTICA ACTIVADA (Interceptor fetch)');
                console.log('üí° Las consultas al historial ser√°n interceptadas y modificadas');
                return true;
            }
            
            console.log(' Interceptor ya estaba activo');
            return true;
        };
        
        // üîß FUNCI√ìN PARA DEBUGGING DE ESPECIFICACI√ìN
        window.debugEspecificacionMaterial = function() {
            console.log('üß™ VERIFICANDO ESPECIFICACI√ìN DE MATERIAL:');
            console.log('=========================================');
            
            if (!materialActual) {
                console.log('‚ùå No hay material actual cargado');
                console.log('üí° Primero escanee un c√≥digo de material');
                return { error: 'No hay material cargado' };
            }
            
            console.log('üì¶ Material actual completo:', materialActual);
            
            // Verificar todas las propiedades posibles de especificaci√≥n
            const propiedadesEspecificacion = [
                'especificacion_material',
                'especificacion',
                'especification',
                'spec',
                'description',
                'descripcion'
            ];
            
            console.log('üîç Buscando especificaci√≥n en todas las propiedades:');
            const resultados = {};
            
            propiedadesEspecificacion.forEach(prop => {
                const valor = materialActual[prop];
                resultados[prop] = valor;
                console.log(`  ‚Ä¢ ${prop}:`, valor || 'NO ENCONTRADO');
            });
            
            // Verificar que el campo visual muestre la especificaci√≥n
            const campoEspecificacion = document.getElementById('salida_especificacion_material');
            if (campoEspecificacion) {
                console.log(' Campo visual especificaci√≥n:', campoEspecificacion.value || 'VAC√çO');
            } else {
                console.log('‚ùå Campo visual de especificaci√≥n no encontrado');
            }
            
            // Buscar la mejor especificaci√≥n disponible
            let mejorEspecificacion = null;
            for (const prop of propiedadesEspecificacion) {
                if (materialActual[prop] !== undefined && materialActual[prop] !== null && materialActual[prop] !== '') {
                    mejorEspecificacion = materialActual[prop];
                    console.log(` MEJOR ESPECIFICACI√ìN ENCONTRADA: '${mejorEspecificacion}' (de propiedad '${prop}')`);
                    break;
                }
            }
            
            if (!mejorEspecificacion) {
                console.log(' NO SE ENCONTR√ì ESPECIFICACI√ìN EN NINGUNA PROPIEDAD');
                console.log(' Todas las propiedades del material:', Object.keys(materialActual));
            }
            
            return {
                materialCompleto: materialActual,
                propiedadesEspecificacion: resultados,
                campoVisual: campoEspecificacion ? campoEspecificacion.value : null,
                mejorEspecificacionEncontrada: mejorEspecificacion
            };
        };

        // Funci√≥n para mostrar mensajes simples
        function mostrarMensajeSimple(mensaje, tipo) {
            const colores = {
                success: '#27ae60',
                error: '#e74c3c',
                info: '#3498db',
                warning: '#f39c12'
            };
            
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colores[tipo] || '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            div.textContent = mensaje;
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }

        // Funciones dummy para evitar errores
        function mostrarRegistroSalida() {
            console.log('Mostrando registro de salida');
        }
        
        function mostrarHistorialSalida() {
            console.log('Mostrando historial de salida');
        }
        
        function cargarModelosBOM() {
            console.log('Cargando modelos BOM');
        }
        
        function filtrarModelosSalida() {
            console.log('Filtrando modelos');
        }
        
        function mostrarDropdownSalida() {
            console.log('Mostrando dropdown');
        }
        
        function actualizarCantidadesPlan() {
            console.log('Actualizando cantidades plan');
        }
        
        function consultarSalidas() {
            console.log('Consultando salidas');
        }
        
        function limpiarFiltros() {
            console.log('Limpiando filtros');
        }
        
        function exportarExcel() {
            console.log('Exportando Excel');
        }
        
        // ===============================================
        // FIN CONTROL DE SALIDA - FUNCIONES EMBEBIDAS
        // ===============================================
</script>
</div>

<!-- ===================================================================== -->
<!-- üî• FUNCIONES GLOBALES PARA HISTORIAL DE SALIDA - SIEMPRE DISPONIBLES -->
<!-- ===================================================================== -->
<script>
(function() {
    console.log('üöÄ INICIANDO SISTEMA GLOBAL DE HISTORIAL DE SALIDA');
    
    // ===================================================================
    // üî• OBJETO GLOBAL PERSISTENTE PARA HISTORIAL DE SALIDA
    // ===================================================================
    window.HISTORIAL_GLOBAL = {
        activo: false,
        instalado: false,
        
        // Funci√≥n principal para mostrar historial
        mostrar: function() {
            console.log('üî• EJECUTANDO HISTORIAL_GLOBAL.mostrar()');
            
            try {
                // Buscar elementos cada vez (por si fueron recreados por AJAX)
                const elementos = {
                    historial: document.getElementById('historialSection'),
                    registro: document.getElementById('tablasRegistroSalida'),
                    btnHistorial: document.getElementById('btnHistorialSalida'),
                    btnRegistro: document.getElementById('btnRegistroSalida')
                };
                
                console.log('üìä Elementos encontrados:', {
                    historial: !!elementos.historial,
                    registro: !!elementos.registro,
                    btnHistorial: !!elementos.btnHistorial,
                    btnRegistro: !!elementos.btnRegistro
                });
                
                if (!elementos.historial) {
                    console.error('‚ùå historialSection NO ENCONTRADO');
                    console.log('üîç Intentando encontrar en toda la p√°gina...');
                    
                    // Buscar en todo el documento
                    const todosLosElementos = document.querySelectorAll('*');
                    const historialEncontrados = [];
                    
                    todosLosElementos.forEach(el => {
                        if (el.id && el.id.toLowerCase().includes('historial')) {
                            historialEncontrados.push(el.id);
                        }
                    });
                    
                    console.log('üîç Elementos con "historial" encontrados:', historialEncontrados);
                    
                    alert('ERROR: No se encontr√≥ la secci√≥n de historial.\n\nAseg√∫rate de estar en la secci√≥n "Control de Salida"');
                    return 'Error: Debes estar en Control de Salida';
                }
                
                if (!elementos.registro) {
                    console.error('‚ùå tablasRegistroSalida NO ENCONTRADO');
                    alert('ERROR: No se encontr√≥ la secci√≥n de registro');
                    return 'Error: Secci√≥n de registro no encontrada';
                }
                
                // CAMBIOS DIRECTOS Y SIMPLES
                console.log('üîß Aplicando cambios de visibilidad...');
                
                // Ocultar registro
                elementos.registro.style.display = 'none';
                elementos.registro.style.visibility = 'hidden';
                
                // Mostrar historial
                elementos.historial.style.display = 'block';
                elementos.historial.style.visibility = 'visible';
                elementos.historial.style.opacity = '1';
                
                // Configurar fechas
                const hoy = new Date().toISOString().split('T')[0];
                const fechaDesde = document.getElementById('salida_fecha_desde');
                const fechaHasta = document.getElementById('salida_fecha_hasta');
                
                if (fechaDesde) fechaDesde.value = hoy;
                if (fechaHasta) fechaHasta.value = hoy;
                
                // Cambiar apariencia de botones
                if (elementos.btnHistorial) {
                    elementos.btnHistorial.style.backgroundColor = '#3498db';
                    elementos.btnHistorial.style.color = 'white';
                    elementos.btnHistorial.style.fontWeight = 'bold';
                }
                if (elementos.btnRegistro) {
                    elementos.btnRegistro.style.backgroundColor = '#95a5a6';
                    elementos.btnRegistro.style.color = '#2c3e50';
                }
                
                console.log(' HISTORIAL MOSTRADO EXITOSAMENTE');
                console.log('üìä Estado final:', {
                    historialDisplay: elementos.historial.style.display,
                    registroDisplay: elementos.registro.style.display
                });
                
                // Scroll al historial
                setTimeout(() => {
                    elementos.historial.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
                
                this.activo = true;
                return ' HISTORIAL ACTIVADO GLOBALMENTE';
                
            } catch (error) {
                console.error('‚ùå Error en HISTORIAL_GLOBAL.mostrar:', error);
                alert('ERROR: ' + error.message);
                return 'Error: ' + error.message;
            }
        },
        
        // Funci√≥n para mostrar registro de salida
        mostrarRegistro: function() {
            console.log(' EJECUTANDO HISTORIAL_GLOBAL.mostrarRegistro()');
            
            try {
                const elementos = {
                    historial: document.getElementById('historialSection'),
                    registro: document.getElementById('tablasRegistroSalida'),
                    btnHistorial: document.getElementById('btnHistorialSalida'),
                    btnRegistro: document.getElementById('btnRegistroSalida')
                };
                
                if (!elementos.historial || !elementos.registro) {
                    console.error('‚ùå Elementos no encontrados para mostrar registro');
                    return 'Error: Elementos no encontrados';
                }
                
                // Ocultar historial
                elementos.historial.style.display = 'none';
                elementos.historial.style.visibility = 'hidden';
                
                // Mostrar registro
                elementos.registro.style.display = 'flex';
                elementos.registro.style.visibility = 'visible';
                elementos.registro.style.opacity = '1';
                
                // Cambiar apariencia de botones
                if (elementos.btnRegistro) {
                    elementos.btnRegistro.style.backgroundColor = '#3498db';
                    elementos.btnRegistro.style.color = 'white';
                    elementos.btnRegistro.style.fontWeight = 'bold';
                }
                if (elementos.btnHistorial) {
                    elementos.btnHistorial.style.backgroundColor = '#95a5a6';
                    elementos.btnHistorial.style.color = '#2c3e50';
                    elementos.btnHistorial.style.fontWeight = 'normal';
                }
                
                console.log(' REGISTRO MOSTRADO EXITOSAMENTE');
                
                // Scroll al registro
                setTimeout(() => {
                    elementos.registro.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
                
                this.activo = false;
                return ' REGISTRO ACTIVADO';
                
            } catch (error) {
                console.error('‚ùå Error en HISTORIAL_GLOBAL.mostrarRegistro:', error);
                return 'Error: ' + error.message;
            }
        },
        
        // Funci√≥n para consultar salidas - OPTIMIZADA PARA VELOCIDAD
        consultar: function() {
            console.log('ÔøΩ EJECUTANDO CONSULTA ULTRA-R√ÅPIDA...');
            
            try {
                const codigoFiltro = document.getElementById('salida_filtro_codigo')?.value?.trim() || '';
                const fechaDesde = document.getElementById('salida_fecha_desde')?.value || '';
                const fechaHasta = document.getElementById('salida_fecha_hasta')?.value || '';

                // Validaci√≥n de fechas
                if (fechaDesde && fechaHasta && fechaDesde > fechaHasta) {
                    alert('La fecha desde no puede ser mayor que la fecha hasta');
                    return 'Error: Fechas inv√°lidas';
                }

                // Mostrar indicador de carga normal
                const tbody = document.querySelector('#salida_tablaSalidas tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 12px; color: #3498db; font-size: 14px;"><i class="fas fa-circle-notch fa-spin"></i> Cargando...</td></tr>';
                }

                let url = '/consultar_historial_salidas';
                const params = new URLSearchParams();

                if (codigoFiltro) params.append('codigo_material', codigoFiltro);
                if (fechaDesde) params.append('fecha_desde', fechaDesde);
                if (fechaHasta) params.append('fecha_hasta', fechaHasta);

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                console.log('Consultando URL optimizada:', url);

                return fetch(url, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        console.log('üì° Respuesta recibida:', {
                            status: response.status,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries())
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        // üîç VERIFICAR SI LA RESPUESTA ES HTML (P√ÅGINA DE LOGIN) EN LUGAR DE JSON
                        const contentType = response.headers.get('content-type');
                        console.log('üìÑ Content-Type:', contentType);
                        
                        if (contentType && contentType.includes('text/html')) {
                            console.error('‚ùå La respuesta es HTML (p√°gina de login) - Usuario no autenticado');
                            throw new Error('Sesi√≥n expirada. Por favor, recargue la p√°gina e inicie sesi√≥n nuevamente.');
                        }
                        
                        return response.json();
                    })
                    .then(responseData => {
                        console.log('üì• Respuesta recibida:', responseData);
                        
                        // Manejar nueva estructura de respuesta con contador
                        let salidas = responseData;
                        let totalRegistros = 0;
                        let mostrados = 0;
                        
                        if (responseData && typeof responseData === 'object' && responseData.datos) {
                            // Nueva estructura con contador
                            salidas = responseData.datos;
                            totalRegistros = responseData.total || 0;
                            mostrados = responseData.mostrados || salidas.length;
                        } else if (Array.isArray(responseData)) {
                            // Estructura antigua (array directo)
                            salidas = responseData;
                            totalRegistros = salidas.length;
                            mostrados = salidas.length;
                        }
                        
                        if (Array.isArray(salidas)) {
                            this.actualizarTablaSalidas(salidas);
                            this.actualizarContadorResultados(totalRegistros, mostrados);
                            return ` ${mostrados} de ${totalRegistros} registros consultados`;
                        } else {
                            throw new Error(responseData.error || 'Respuesta inv√°lida del servidor');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error al consultar salidas:', error);
                        this.mostrarMensaje('Error al consultar salidas: ' + error.message, 'error');
                        return 'Error: ' + error.message;
                    });

            } catch (error) {
                console.error('‚ùå Error en HISTORIAL_GLOBAL.consultar:', error);
                this.mostrarMensaje('Error interno: ' + error.message, 'error');
                return 'Error: ' + error.message;
            }
        },
        
        // Funci√≥n para actualizar tabla de salidas
        actualizarTablaSalidas: function(salidas) {
            const tbody = document.querySelector('#salida_tablaSalidas tbody');
            if (!tbody) {
                console.error('‚ùå Tabla de salidas no encontrada');
                return;
            }
            
            if (salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">No hay datos registrados</td></tr>';
                return;
            }

            let html = '';
            salidas.forEach(salida => {
                html += `
                    <tr>
                        <td>${this.formatearFecha(salida.fecha_salida) || ''}</td>
                        <td>${salida.proceso_salida || ''}</td>
                        <td>${salida.codigo_material_recibido || ''}</td>
                        <td>${salida.codigo_material || ''}</td>
                        <td>${salida.numero_parte || ''}</td>
                        <td>${salida.disp || ''}</td>
                        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${salida.codigo_material_original || ''}">${salida.codigo_material_original || ''}</td>
                        <td>${this.obtenerNumeroLote(salida)}</td>
                        <td>${salida.especificacion_material || salida.especificacion || ''}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            console.log(' Tabla actualizada con', salidas.length, 'registros');
        },
        
        // Funci√≥n para actualizar contador de resultados
        actualizarContadorResultados: function(total, mostrados) {
            const contadorElemento = document.getElementById('salida_totalInfo');
            if (contadorElemento) {
                if (total === mostrados) {
                    contadorElemento.textContent = `Total Rows: ${total}`;
                } else {
                    contadorElemento.textContent = `Total Rows: ${mostrados} de ${total}`;
                }
                contadorElemento.style.color = '#FFFFFF';
                contadorElemento.style.fontWeight = 'bold';
            }
        },
        
        // üîß Funci√≥n para obtener n√∫mero de lote de m√∫ltiples propiedades posibles
        obtenerNumeroLote: function(salida) {
            if (!salida) return '';
            
            // Lista de propiedades posibles donde puede estar el n√∫mero de lote
            const propiedadesLote = [
                'numero_lote_material',
                'numero_lote',
                'lote_material',
                'lote',
                'numero_de_lote',
                'numeroLote'
            ];
            
            // Buscar en cada propiedad
            for (const prop of propiedadesLote) {
                const valor = salida[prop];
                if (valor !== undefined && valor !== null && valor !== '') {
                    return valor;
                }
            }
            
            // Si no encuentra nada, devolver string vac√≠o
            return '';
        },
        
        // Funci√≥n para formatear fechas
        formatearFecha: function(fechaISO) {
            if (!fechaISO) return '';
            try {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return fechaISO;
            }
        },
        
        // Funci√≥n para mostrar mensajes
        mostrarMensaje: function(mensaje, tipo) {
            let contenedor = document.getElementById('historial-global-mensaje');
            if (!contenedor) {
                contenedor = document.createElement('div');
                contenedor.id = 'historial-global-mensaje';
                contenedor.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 100000;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                document.body.appendChild(contenedor);
            }

            // Establecer color seg√∫n tipo
            switch (tipo) {
                case 'success':
                    contenedor.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    contenedor.style.backgroundColor = '#e74c3c';
                    break;
                case 'info':
                    contenedor.style.backgroundColor = '#3498db';
                    break;
                default:
                    contenedor.style.backgroundColor = '#95a5a6';
            }

            contenedor.textContent = mensaje;
            contenedor.style.display = 'block';

            // Auto-ocultar despu√©s de 3 segundos
            setTimeout(() => {
                contenedor.style.display = 'none';
            }, 3000);
        },
        
        // Funci√≥n para instalar el onclick
        instalar: function() {
            console.log('üîß INSTALANDO ONCLICK GLOBAL...');
            
            const btnHistorial = document.getElementById('btnHistorialSalida');
            const btnRegistro = document.getElementById('btnRegistroSalida');
            const btnConsultar = document.querySelector('button[onclick*="consultarSalidas"]') || 
                               document.getElementById('btnConsultarSalidas') ||
                               document.querySelector('button:contains("Consultar")');
            
            if (!btnHistorial) {
                console.log('‚è≥ Bot√≥n historial no encontrado en esta p√°gina');
                return 'Bot√≥n historial no encontrado - Navega a Control de Salida';
            }
            
            // INSTALAR ONCLICK HISTORIAL
            btnHistorial.removeAttribute('onclick');
            btnHistorial.onclick = null;
            btnHistorial.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(' CLICK HISTORIAL INTERCEPTADO - Ejecutando HISTORIAL_GLOBAL');
                this.mostrar();
                return false;
            };
            
            // INSTALAR ONCLICK REGISTRO
            if (btnRegistro) {
                btnRegistro.removeAttribute('onclick');
                btnRegistro.onclick = null;
                btnRegistro.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(' CLICK REGISTRO INTERCEPTADO - Ejecutando HISTORIAL_GLOBAL');
                    this.mostrarRegistro();
                    return false;
                };
                console.log(' Onclick registro instalado');
            }
            
            // BUSCAR E INSTALAR BOT√ìN CONSULTAR
            const botonesConsultar = document.querySelectorAll('button');
            botonesConsultar.forEach(btn => {
                if (btn.textContent && btn.textContent.toLowerCase().includes('consultar')) {
                    btn.removeAttribute('onclick');
                    btn.onclick = null;
                    btn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(' CLICK CONSULTAR INTERCEPTADO - Ejecutando HISTORIAL_GLOBAL');
                        this.consultar();
                        return false;
                    };
                    console.log(' Onclick consultar instalado en:', btn.textContent);
                }
            });
            
            this.instalado = true;
            console.log(' ONCLICK GLOBAL INSTALADO EXITOSAMENTE');
            return ' TODOS LOS ONCLICKS INSTALADOS';
        },
        
        // Funci√≥n para verificar estado
        verificar: function() {
            const estado = {
                sistema: 'HISTORIAL_GLOBAL',
                timestamp: new Date().toISOString(),
                instalado: this.instalado,
                activo: this.activo,
                elementos: {},
                pagina: window.location.pathname || 'desconocida'
            };
            
            // Verificar elementos
            const historial = document.getElementById('historialSection');
            const registro = document.getElementById('tablasRegistroSalida');
            const btnHistorial = document.getElementById('btnHistorialSalida');
            
            estado.elementos = {
                historial: !!historial,
                registro: !!registro,
                btnHistorial: !!btnHistorial
            };
            
            if (historial) {
                estado.estadoHistorial = {
                    display: historial.style.display || 'no definido',
                    visibility: historial.style.visibility || 'no definido',
                    computed: getComputedStyle(historial).display
                };
            }
            
            if (registro) {
                estado.estadoRegistro = {
                    display: registro.style.display || 'no definido',
                    visibility: registro.style.visibility || 'no definido',
                    computed: getComputedStyle(registro).display
                };
            }
            
            if (btnHistorial) {
                estado.estadoBoton = {
                    onclick: !!btnHistorial.onclick,
                    onclickGlobal: btnHistorial.onclick ? 
                        btnHistorial.onclick.toString().includes('HISTORIAL_GLOBAL') : false
                };
            }
            
            console.log('üìä Estado completo HISTORIAL_GLOBAL:', estado);
            return estado;
        },
        
        // Auto-instalaci√≥n inteligente
        autoInstalar: function() {
            console.log('ü§ñ AUTO-INSTALACI√ìN INTELIGENTE...');
            
            // Verificar si estamos en la p√°gina correcta
            const btn = document.getElementById('btnHistorialSalida');
            if (btn && !this.instalado) {
                this.instalar();
            }
            
            // Programar verificaciones futuras
            setTimeout(() => {
                if (!this.instalado) {
                    const btnNow = document.getElementById('btnHistorialSalida');
                    if (btnNow) {
                        this.instalar();
                    }
                }
            }, 2000);
        }
    };
    
    // ===================================================================
    // üî• FUNCIONES GLOBALES DE COMPATIBILIDAD
    // ===================================================================
    
    // Funci√≥n principal que siempre funciona
    window.debugHistorial = function() {
        console.log('üêõ DEBUG HISTORIAL GLOBAL');
        return window.HISTORIAL_GLOBAL.verificar();
    };
    
    // Funci√≥n simple para mostrar historial
    window.mostrarHistorial = function() {
        return window.HISTORIAL_GLOBAL.mostrar();
    };
    
    // Funci√≥n para mostrar registro
    window.mostrarRegistro = function() {
        return window.HISTORIAL_GLOBAL.mostrarRegistro();
    };
    
    // Funci√≥n para consultar salidas
    window.consultarSalidas = function() {
        return window.HISTORIAL_GLOBAL.consultar();
    };
    
    // Funci√≥n para instalar onclick
    window.instalarHistorial = function() {
        return window.HISTORIAL_GLOBAL.instalar();
    };
    
    // Funciones de compatibilidad hacia atr√°s
    window.mostrarHistorialSalida = function() {
        return window.HISTORIAL_GLOBAL.mostrar();
    };
    
    window.mostrarRegistroSalida = function() {
        return window.HISTORIAL_GLOBAL.mostrarRegistro();
    };
    
    // ===================================================================
    // üß™ FUNCIONES DE TEST GLOBALES PARA AUTO-ENTER
    // ===================================================================
    
    // üß™ FUNCI√ìN DE TEST SIMPLE PARA AUTO-ENTER (DISPONIBLE GLOBALMENTE)
    window.testAutoEnterSimple = function() {
        console.log('üß™ PROBANDO AUTO-ENTER SIMPLE DESDE MATERIAL TEMPLATE...');
        
        const codigoInput = document.getElementById('salida_codigo_material_recibido');
        if (!codigoInput) {
            console.error('‚ùå Campo c√≥digo no encontrado');
            return '‚ùå Campo c√≥digo no encontrado - ¬øEst√° en Control de Salida?';
        }
        
        // Limpiar campo
        codigoInput.value = '';
        codigoInput.focus();
        
        // Simular escaneo de c√≥digo largo
        const codigoPrueba = 'H5602C622.20250728026';
        console.log(' Escribiendo c√≥digo de prueba:', codigoPrueba);
        
        // Escribir caracter por caracter para simular escaneo real
        let i = 0;
        const escribirCaracter = () => {
            if (i < codigoPrueba.length) {
                codigoInput.value += codigoPrueba[i];
                
                // Disparar evento input
                const inputEvent = new Event('input', { bubbles: true });
                codigoInput.dispatchEvent(inputEvent);
                
                console.log(` Caracter ${i+1}/${codigoPrueba.length}: "${codigoPrueba[i]}" - Longitud total: ${codigoInput.value.length}`);
                
                i++;
                setTimeout(escribirCaracter, 50); // 50ms entre caracteres
            } else {
                console.log(' C√≥digo escrito completo, deber√≠a activar auto-Enter');
                console.log('üîç Valor final del campo:', codigoInput.value);
                
                // Verificar si hay listeners configurados
                const listeners = codigoInput.cloneNode().outerHTML.includes('addEventListener');
                console.log('üëÇ ¬øListeners configurados?', listeners ? 'S√≠' : 'No');
                
                // Test manual adicional: disparar Enter
                setTimeout(() => {
                    console.log('üß™ Disparando Enter manual como test adicional...');
                    const enterEvent = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        keyCode: 13,
                        code: 'Enter',
                        bubbles: true
                    });
                    codigoInput.dispatchEvent(enterEvent);
                }, 1000);
            }
        };
        
        escribirCaracter();
        return 'üß™ Test iniciado - observe la consola y los campos';
    };

    // üöÄ FUNCI√ìN ULTRA-SIMPLE PARA AUTO-ENTER (DISPONIBLE GLOBALMENTE)
    window.configurarEventListenersEscaneo = function() {
        console.log(' Configurando Auto-Enter ULTRA-SIMPLE desde MaterialTemplate...');
        
        const codigoInput = document.getElementById('salida_codigo_material_recibido');
        const verificacionInput = document.getElementById('salida_verificacion_codigo');
        
        if (codigoInput) {
            // M√âTODO 1: Auto-Enter basado en longitud del c√≥digo
            codigoInput.addEventListener('input', function(e) {
                const codigo = e.target.value.trim();
                console.log(' Input detectado:', codigo, 'Longitud:', codigo.length);
                
                // Si tiene 8+ caracteres, activar auto-Enter
                if (codigo.length >= 8) {
                    console.log('üöÄ AUTO-ENTER activado para c√≥digo:', codigo);
                    setTimeout(() => {
                        // Simular presionar Enter
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            keyCode: 13,
                            code: 'Enter',
                            bubbles: true
                        });
                        e.target.dispatchEvent(enterEvent);
                    }, 150); // 150ms de delay para estabilidad
                }
            });
            
            // M√âTODO 2: Procesamiento manual del Enter
            codigoInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    const codigo = e.target.value.trim();
                    if (codigo) {
                        // Buscar funci√≥n procesarEscaneoRapido si est√° disponible
                        if (typeof window.procesarEscaneoRapido === 'function') {
                            window.procesarEscaneoRapido(e);
                        } else if (typeof procesarEscaneoRapido === 'function') {
                            procesarEscaneoRapido(e);
                        } else {
                            console.log(' procesarEscaneoRapido no disponible');
                        }
                    }
                }
            });
            
            console.log(' Auto-Enter configurado para campo C√ìDIGO');
        } else {
            console.error('‚ùå Campo c√≥digo no encontrado');
        }
        
        if (verificacionInput) {
            // M√âTODO 1: Auto-Enter basado en longitud del c√≥digo
            verificacionInput.addEventListener('input', function(e) {
                const codigo = e.target.value.trim();
                console.log(' Input verificaci√≥n detectado:', codigo, 'Longitud:', codigo.length);
                
                // Si tiene 8+ caracteres, activar auto-Enter
                if (codigo.length >= 8) {
                    console.log('üöÄ AUTO-ENTER activado para verificaci√≥n:', codigo);
                    setTimeout(() => {
                        // Simular presionar Enter
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            keyCode: 13,
                            code: 'Enter',
                            bubbles: true
                        });
                        e.target.dispatchEvent(enterEvent);
                    }, 150); // 150ms de delay para estabilidad
                }
            });
            
            // M√âTODO 2: Procesamiento manual del Enter
            verificacionInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();

                    const codigo = e.target.value.trim();
                    if (codigo) {
                        // Buscar funci√≥n procesarVerificacion si est√° disponible
                        if (typeof window.procesarVerificacion === 'function') {
                            window.procesarVerificacion(e);
                        } else if (typeof procesarVerificacion === 'function') {
                            procesarVerificacion(e);
                        } else {
                            console.log(' procesarVerificacion no disponible');
                        }
                    }
                }
            });
            
            console.log(' Auto-Enter configurado para campo VERIFICACI√ìN');
        } else {
            console.error('‚ùå Campo verificaci√≥n no encontrado');
        }
        
        console.log(' AUTO-ENTER ULTRA-SIMPLE CONFIGURADO EXITOSAMENTE desde MaterialTemplate');
    };

    //  OBSERVADOR PARA DETECTAR CAMBIOS EN EL DOM (AJAX RELOADS) - GLOBAL
    window.configurarObservadorAJAX = function() {
        if (window.controlSalidaObserver) {
            window.controlSalidaObserver.disconnect();
        }
        
        window.controlSalidaObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                // Detectar si se agregaron nuevos nodos (carga AJAX)
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        // Si el nodo contiene elementos de control de salida
                        if (node.nodeType === 1 && 
                            (node.querySelector && node.querySelector('[id*="codigo"], [id*="cantidad"], input') ||
                             node.id && (node.id.includes('codigo') || node.id.includes('cantidad')))) {
                            
                            console.log(' DOM cambi√≥ (AJAX), reinstalando listeners de auto-Enter...');
                            
                            // Reinstalar listeners despu√©s de un breve delay
                            setTimeout(() => {
                                if (typeof window.configurarEventListenersEscaneo === 'function') {
                                    window.configurarEventListenersEscaneo();
                                }
                            }, 100);
                        }
                    });
                }
            });
        });
        
        // Observar cambios en el body o contenedor principal
        const targetNode = document.body;
        const config = { 
            childList: true, 
            subtree: true 
        };
        
        window.controlSalidaObserver.observe(targetNode, config);
        console.log('üëÅÔ∏è Observador AJAX activado para auto-Enter desde MaterialTemplate');
    };
    
    // üß™ FUNCI√ìN ADICIONAL PARA VERIFICAR ESTADO DEL AUTO-ENTER
    window.verificarAutoEnter = function() {
        console.log('üîç VERIFICANDO ESTADO DEL AUTO-ENTER...');
        
        const codigoInput = document.getElementById('salida_codigo_material_recibido');
        const verificacionInput = document.getElementById('salida_verificacion_codigo');
        
        const estado = {
            campoCodigoEncontrado: !!codigoInput,
            campoVerificacionEncontrado: !!verificacionInput,
            funcionConfiguracionDisponible: typeof configurarEventListenersEscaneo === 'function',
            funcionObservadorDisponible: typeof configurarObservadorAJAX === 'function',
            campoCodigoTieneValor: codigoInput ? codigoInput.value : 'N/A',
            campoCodigoEnfocado: document.activeElement === codigoInput
        };
        
        console.table(estado);
        
        if (estado.campoCodigoEncontrado && estado.funcionConfiguracionDisponible) {
            console.log(' Todo parece estar bien configurado');
            return ' Auto-Enter configurado correctamente';
        } else {
            console.log('‚ùå Faltan elementos para auto-Enter');
            return '‚ùå Configuraci√≥n incompleta';
        }
    };

    // ===================================================================
    // SISTEMA GLOBAL DE ENTER AUTOM√ÅTICO PARA ESCANEO
    // ===================================================================
    
    window.ENTER_AUTOMATICO_GLOBAL = {
        activo: false,
        timers: new Map(),
        campos: new Map(),
        
        // Configurar Enter autom√°tico para un campo espec√≠fico
        configurar: function(campoId, opciones = {}) {
            
            const campo = document.getElementById(campoId);
            if (!campo) {
                console.log(' Campo no encontrado:', campoId);
                return false;
            }
            
            // Opciones por defecto
            const config = {
                longitudMinima: opciones.longitudMinima || 8,
                velocidadMaxima: opciones.velocidadMaxima || 100,
                delayActivacion: opciones.delayActivacion || 200,
                funcionBusqueda: opciones.funcionBusqueda || null,
                ...opciones
            };
            
            // Guardar configuraci√≥n
            this.campos.set(campoId, {
                elemento: campo,
                config: config,
                ultimoTiempo: 0,
                valorAnterior: ''
            });
            
            // Limpiar listeners anteriores
            campo.removeEventListener('input', this._onInput);
            campo.removeEventListener('keydown', this._onKeydown);
            campo.removeEventListener('blur', this._onBlur);
            
            // Agregar nuevos listeners
            campo.addEventListener('input', (e) => this._onInput(e, campoId));
            campo.addEventListener('keydown', (e) => this._onKeydown(e, campoId));
            campo.addEventListener('blur', (e) => this._onBlur(e, campoId));
            
            console.log(' Enter autom√°tico configurado para:', campoId);
            return true;
        },
        
        // Event listener para input
        _onInput: function(event, campoId) {
            const campoData = window.ENTER_AUTOMATICO_GLOBAL.campos.get(campoId);
            if (!campoData) return;
            
            const tiempoActual = Date.now();
            const valorActual = event.target.value;
            const tiempoDiferencia = tiempoActual - campoData.ultimoTiempo;
            
            console.log(' Input detectado en', campoId, ':', {
                valor: valorActual,
                longitud: valorActual.length,
                tiempoDiferencia: tiempoDiferencia,
                esRapido: tiempoDiferencia < campoData.config.velocidadMaxima
            });
            
            // Limpiar timer anterior
            const timerAnterior = window.ENTER_AUTOMATICO_GLOBAL.timers.get(campoId);
            if (timerAnterior) {
                clearTimeout(timerAnterior);
            }
            
            // Detectar escaneo
            const caracteresAgregados = valorActual.length - campoData.valorAnterior.length;
            const esEscaneoRapido = tiempoDiferencia < campoData.config.velocidadMaxima && tiempoDiferencia > 0;
            const esTextoLargo = valorActual.length >= campoData.config.longitudMinima;
            const esMuchoTextoDeUnaVez = caracteresAgregados > 3;
            
            // Si detectamos escaneo
            if (esEscaneoRapido || esTextoLargo || esMuchoTextoDeUnaVez) {
                console.log(' ESCANEO DETECTADO en', campoId, '- Programando Enter autom√°tico...');
                
                // Programar Enter autom√°tico
                const timer = setTimeout(() => {
                    if (event.target.value.trim().length >= 5) {
                        window.ENTER_AUTOMATICO_GLOBAL._procesarEnterAutomatico(campoId);
                    }
                }, campoData.config.delayActivacion);
                
                window.ENTER_AUTOMATICO_GLOBAL.timers.set(campoId, timer);
            }
            
            // Actualizar datos
            campoData.ultimoTiempo = tiempoActual;
            campoData.valorAnterior = valorActual;
        },
        
        // Event listener para keydown
        _onKeydown: function(event, campoId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                console.log('üîç ENTER MANUAL DETECTADO en', campoId);
                
                // Limpiar timer de escaneo
                const timer = window.ENTER_AUTOMATICO_GLOBAL.timers.get(campoId);
                if (timer) {
                    clearTimeout(timer);
                    window.ENTER_AUTOMATICO_GLOBAL.timers.delete(campoId);
                }
                
                // Procesar inmediatamente
                window.ENTER_AUTOMATICO_GLOBAL._procesarEnterAutomatico(campoId);
            }
        },
        
        // Event listener para blur
        _onBlur: function(event, campoId) {
            const campoData = window.ENTER_AUTOMATICO_GLOBAL.campos.get(campoId);
            if (!campoData) return;
            
            const codigo = event.target.value.trim();
            if (codigo.length >= campoData.config.longitudMinima) {
                console.log('üëÅÔ∏è CAMPO PERDI√ì FOCO con c√≥digo largo en', campoId, ':', codigo);
                setTimeout(() => {
                    window.ENTER_AUTOMATICO_GLOBAL._procesarEnterAutomatico(campoId);
                }, 100);
            }
        },
        
        // Procesar Enter autom√°tico
        _procesarEnterAutomatico: function(campoId) {
            const campoData = this.campos.get(campoId);
            if (!campoData) return;
            
            const codigo = campoData.elemento.value.trim();

            
            if (!codigo || codigo.length < 5) {
                console.log(' C√≥digo muy corto, no se procesa');
                return;
            }
            
            // PASO 1: Simular eventos est√°ndar
            const enterEvent = new KeyboardEvent('keydown', {
                key: 'Enter',
                keyCode: 13,
                which: 13,
                bubbles: true,
                cancelable: true
            });
            campoData.elemento.dispatchEvent(enterEvent);
            
            const changeEvent = new Event('change', { bubbles: true });
            campoData.elemento.dispatchEvent(changeEvent);
            
            // PASO 2: Ejecutar funci√≥n de b√∫squeda espec√≠fica
            setTimeout(() => {
                if (campoData.config.funcionBusqueda) {
                    console.log('üîç EJECUTANDO FUNCI√ìN DE B√öSQUEDA:', campoData.config.funcionBusqueda.name || 'funci√≥n an√≥nima');
                    try {
                        campoData.config.funcionBusqueda(codigo);
                        this._mostrarMensaje('üöÄ C√≥digo escaneado - Auto-llenado activado', 'exito');
                    } catch (error) {
                        console.error('‚ùå Error en funci√≥n de b√∫squeda:', error);
                        this._mostrarMensaje('‚ùå Error en auto-llenado', 'error');
                    }
                } else {
                    // Buscar funci√≥n de b√∫squeda autom√°ticamente
                    this._buscarFuncionAutomatica(codigo);
                }
            }, 50);
        },
        
        // Buscar funci√≥n de b√∫squeda autom√°ticamente
        _buscarFuncionAutomatica: function(codigo) {
            // üõë DESHABILITADO TEMPORALMENTE PARA CONTROL DE SALIDA
            const currentUrl = window.location.pathname;
            if (currentUrl.includes('control_salida') || currentUrl.includes('salida')) {
                console.log('üõë AUTO-B√öSQUEDA DESHABILITADA para Control de Salida (evitar bucle infinito)');
                this._mostrarMensaje(' C√≥digo escaneado - Manual mode activo', 'info');
                return;
            }
            
            // Lista de funciones comunes de b√∫squeda
            const funcionesBusqueda = [
                'buscarMaterialPorCodigo',
                'buscarMaterial',
                'buscarPorCodigo',
                'searchMaterial'
            ];
            
            for (const nombreFuncion of funcionesBusqueda) {
                if (typeof window[nombreFuncion] === 'function') {
                    console.log('üîç FUNCI√ìN ENCONTRADA:', nombreFuncion);
                    try {
                        window[nombreFuncion](codigo);
                        this._mostrarMensaje('üöÄ C√≥digo escaneado - Auto-llenado activado', 'exito');
                        return;
                    } catch (error) {
                        console.error('‚ùå Error en', nombreFuncion, ':', error);
                    }
                }
            }
            
            console.log(' No se encontr√≥ funci√≥n de b√∫squeda autom√°tica');
            this._mostrarMensaje(' C√≥digo escaneado - Enter autom√°tico aplicado', 'info');
        },
        
        // Mostrar mensaje
        _mostrarMensaje: function(mensaje, tipo) {
            // Usar la funci√≥n existente si est√° disponible
            if (typeof mostrarExito === 'function' && tipo === 'exito') {
                mostrarExito(mensaje);
            } else if (typeof mostrarError === 'function' && tipo === 'error') {
                mostrarError(mensaje);
            } else if (typeof mostrarInfo === 'function') {
                mostrarInfo(mensaje);
            } else {
                // Fallback simple
                console.log('üí¨', mensaje);
            }
        },
        
        // Auto-instalar en Control de Salida
        autoInstalarSalida: function() {
            console.log('ÔøΩ AUTO-INSTALACI√ìN DESHABILITADA para Control de Salida (evitar bucle infinito)');
            console.log(' Control de Salida usa su propio sistema de event listeners');
            return; // DESHABILITADO TEMPORALMENTE
            
            console.log('ÔøΩüöÄ AUTO-INSTALACI√ìN ENTER AUTOM√ÅTICO PARA CONTROL DE SALIDA');
            
            // Configurar campo principal
            this.configurar('salida_codigo_material_recibido', {
                longitudMinima: 8,
                velocidadMaxima: 100,
                delayActivacion: 200,
                funcionBusqueda: window.buscarMaterialPorCodigo
            });
            
            // Configurar campo de verificaci√≥n
            this.configurar('salida_verificacion_codigo', {
                longitudMinima: 8,
                velocidadMaxima: 100,
                delayActivacion: 200
            });
            
            this.activo = true;
            console.log(' ENTER AUTOM√ÅTICO INSTALADO PARA CONTROL DE SALIDA');
        },
        
        // Verificar y reparar configuraci√≥n
        verificar: function() {
            console.log('üîç VERIFICANDO ENTER AUTOM√ÅTICO GLOBAL...');
            
            let reparaciones = 0;
            
            // Verificar campos configurados
            this.campos.forEach((campoData, campoId) => {
                const elemento = document.getElementById(campoId);
                if (!elemento) {
                    console.log(' Campo perdido:', campoId, '- Eliminando configuraci√≥n');
                    this.campos.delete(campoId);
                    reparaciones++;
                } else if (elemento !== campoData.elemento) {
                    console.log('üîß Elemento cambiado para:', campoId, '- Reconfigurando');
                    this.configurar(campoId, campoData.config);
                    reparaciones++;
                }
            });
            
            // Auto-instalar para Control de Salida si detectamos que estamos en esa p√°gina
            if (document.getElementById('salida_codigo_material_recibido') && !this.campos.has('salida_codigo_material_recibido')) {
                console.log(' Control de Salida detectado - AUTO-INSTALACI√ìN DESHABILITADA (evitar bucle infinito)');
                // this.autoInstalarSalida(); // DESHABILITADO TEMPORALMENTE
                // reparaciones++;
            }
        
            console.log(' Verificaci√≥n completada -', reparaciones, 'reparaciones realizadas');
            return {
                activo: this.activo,
                camposConfigurados: this.campos.size,
                reparaciones: reparaciones
            };
        }
    };
    
    // ===================================================================
    // FUNCIONES GLOBALES DE CONVENIENCIA PARA ENTER AUTOM√ÅTICO
    // ===================================================================
    
    // Funci√≥n global para testing
    window.testEnterAutomaticoEscaneo = function() {
        console.log('üß™ PROBANDO ENTER AUTOM√ÅTICO GLOBAL...');
        
        const codigoInput = document.getElementById('salida_codigo_material_recibido');
        if (!codigoInput) {
            return ' Campo c√≥digo no encontrado';
        }
        
        // Limpiar campo primero
        codigoInput.value = '';
        codigoInput.focus();
        
        // Simular escaneo
        const codigoPrueba = 'H5602C622.20250728026';
        console.log(' Simulando escaneo del c√≥digo:', codigoPrueba);
        
        codigoInput.value = codigoPrueba;
        const inputEvent = new Event('input', { bubbles: true });
        codigoInput.dispatchEvent(inputEvent);
        
        return ' Test ejecutado - Deber√≠a activar auto-llenado en 200ms';
    };
    
    // Funci√≥n global para forzar auto-llenado
    window.forzarAutoLlenado = function() {
        console.log('üîß FORZANDO AUTO-LLENADO...');
        
        const codigoInput = document.getElementById('salida_codigo_material_recibido');
        if (!codigoInput) {
            return ' Campo c√≥digo no encontrado';
        }
        
        const codigo = codigoInput.value.trim();
        if (!codigo) {
            return ' No hay c√≥digo en el campo';
        }
        
        if (typeof buscarMaterialPorCodigo === 'function') {
            console.log('üîç Ejecutando buscarMaterialPorCodigo para:', codigo);
            buscarMaterialPorCodigo(codigo);
            return ' Auto-llenado forzado ejecutado';
        } else {
            return ' Funci√≥n buscarMaterialPorCodigo no disponible';
        }
    };
    
    // ===================================================================
    //  AUTO-INSTALACI√ìN Y MONITOREO ENTER AUTOM√ÅTICO
    // ===================================================================
    
    // Auto-instalaci√≥n inmediata
    setTimeout(() => window.ENTER_AUTOMATICO_GLOBAL.verificar(), 500);
    setTimeout(() => window.ENTER_AUTOMATICO_GLOBAL.verificar(), 2000);
    setTimeout(() => window.ENTER_AUTOMATICO_GLOBAL.verificar(), 5000);
    
    console.log('üí° Funciones disponibles: testEnterAutomaticoEscaneo(), forzarAutoLlenado()');

    // ===================================================================
    //  AUTO-INSTALACI√ìN Y MONITOREO
    // ===================================================================
    
    // Auto-instalaci√≥n inmediata
    window.HISTORIAL_GLOBAL.autoInstalar();
    window.ENTER_AUTOMATICO_GLOBAL.verificar();
    
    // Auto-instalaci√≥n despu√©s de navegaci√≥n
    setTimeout(() => {
        window.HISTORIAL_GLOBAL.autoInstalar();
        window.ENTER_AUTOMATICO_GLOBAL.verificar();
    }, 1000);
    
    setTimeout(() => {
        window.HISTORIAL_GLOBAL.autoInstalar();
        window.ENTER_AUTOMATICO_GLOBAL.verificar();
    }, 3000);
    
    setTimeout(() => {
        window.HISTORIAL_GLOBAL.autoInstalar();
        window.ENTER_AUTOMATICO_GLOBAL.verificar();
    }, 5000);
    
    // Interceptar cargas AJAX para reinstalar
    const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
    if (originalInnerHTML) {
        Object.defineProperty(Element.prototype, 'innerHTML', {
            set: function(value) {
                originalInnerHTML.set.call(this, value);
                
                // Si se actualiza contenido relacionado con control de salida
                if (this.id && (
                    this.id.includes('control-salida') || 
                    this.id.includes('material') ||
                    this.id.includes('container')
                )) {
                    console.log(' Contenido AJAX actualizado, reinstalando sistemas globales...');
                    setTimeout(() => {
                        window.HISTORIAL_GLOBAL.autoInstalar();
                        window.ENTER_AUTOMATICO_GLOBAL.verificar();
                    }, 500);
                }
            },
            get: originalInnerHTML.get
        });
    }
    
    // Auto-test cuando se carga MaterialTemplate
    setTimeout(() => {
        if (document.getElementById('salida_codigo_material_recibido')) {
            console.log(' Control de Salida detectado - Auto-test disponible');
            console.log('üí° Ejecute: testAutoEnterSimple() para probar');
        }
    }, 1000);

    // ===== FUNCIONES PARA CONTROL DE MODELOS =====
    
    // Variables globales para Control de Modelos
    let modelosControlBOM = [];
    
    // Cargar modelos √∫nicos de BOM para Control de Modelos
    async function cargarModelosControl() {
        try {
            console.log('Cargando modelos desde /listar_modelos_bom para Control de Modelos...');
            const response = await fetch('/listar_modelos_bom', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const modelos = await response.json();
            console.log('Modelos recibidos para Control de Modelos:', modelos);
            
            if (Array.isArray(modelos) && modelos.length > 0) {
                // Si hay modelos en la base de datos BOM, usarlos
                modelosControlBOM = modelos.map(item => item.modelo || item).filter(modelo => modelo && modelo.trim() !== '');
                console.log('Modelos procesados para Control de Modelos:', modelosControlBOM);
                llenarDropdownModelosControl();
                actualizarContadorModelos();
                ocultarContainerSinDatos();
                mostrarMensajeModelos(`${modelosControlBOM.length} modelos cargados desde Control de BOM`, 'success');
            } else {
                // Si no hay modelos en BOM, mostrar mensaje informativo
                console.warn('No se encontraron modelos en la tabla BOM');
                modelosControlBOM = [];
                llenarDropdownModelosControl();
                actualizarContadorModelos();
                mostrarContainerSinDatos();
                mostrarMensajeModelos('No hay modelos registrados en Control de BOM. Agregue modelos desde Control de BOM primero.', 'warning');
            }
        } catch (error) {
            console.error('Error cargando modelos BOM para Control de Modelos:', error);
            mostrarMensajeModelos('Error cargando modelos de BOM: ' + error.message, 'error');
            modelosControlBOM = [];
            llenarDropdownModelosControl();
            actualizarContadorModelos();
        }
    }

    // Llenar dropdown de modelos para Control de Modelos
    function llenarDropdownModelosControl() {
        const dropdownList = document.getElementById('modeloDropdownList');
        
        if (!dropdownList) {
            console.error('Element modeloDropdownList not found');
            return;
        }
        
        dropdownList.innerHTML = '';
        
        if (modelosControlBOM.length === 0) {
            // Si no hay modelos, mostrar mensaje informativo
            const item = document.createElement('div');
            item.className = 'bom-dropdown-item';
            item.style.fontStyle = 'italic';
            item.style.color = '#95a5a6';
            item.textContent = 'No hay modelos en Control de BOM';
            item.onclick = function() { 
                mostrarMensajeModelos('Debe agregar modelos en Control de BOM primero', 'warning'); 
            };
            dropdownList.appendChild(item);
        } else {
            // Si hay modelos, mostrarlos normalmente
            modelosControlBOM.forEach(modelo => {
                const item = document.createElement('div');
                item.className = 'bom-dropdown-item';
                item.setAttribute('data-value', modelo);
                item.textContent = modelo;
                item.onclick = function() { seleccionarModeloControl(modelo); };
                dropdownList.appendChild(item);
            });
        }
        
        console.log(` ${modelosControlBOM.length} modelos cargados en dropdown Control de Modelos`);
    }

    // Funci√≥n para filtrar modelos en el dropdown de Control de Modelos
    function filtrarModelosControl() {
        const searchInput = document.getElementById('modeloSelector');
        const dropdownList = document.getElementById('modeloDropdownList');
        const searchTerm = searchInput.value.toLowerCase();
        
        // Mostrar el dropdown
        dropdownList.style.display = 'block';
        
        const items = dropdownList.querySelectorAll('.bom-dropdown-item');
        let hasVisibleItems = false;
        
        items.forEach(item => {
            const modeloText = item.textContent.toLowerCase();
            if (modeloText.includes(searchTerm)) {
                item.classList.remove('hidden');
                hasVisibleItems = true;
            } else {
                item.classList.add('hidden');
            }
        });
        
        // Si no hay coincidencias, ocultar el dropdown
        if (!hasVisibleItems && searchTerm.length > 0) {
            dropdownList.style.display = 'none';
        }
    }

    // Funci√≥n para mostrar dropdown de Control de Modelos
    function mostrarDropdownControl() {
        console.log('=== mostrarDropdownControl() llamada ===');
        const dropdownList = document.getElementById('modeloDropdownList');
        const searchInput = document.getElementById('modeloSelector');
        
        if (!dropdownList) {
            console.error('Element modeloDropdownList not found');
            return;
        }
        
        if (!searchInput) {
            console.error('Element modeloSelector not found');
            return;
        }
        
        console.log('Elementos encontrados OK');
        console.log('Modelos disponibles:', modelosControlBOM.length);
        
        // Forzar configuraci√≥n del dropdown
        dropdownList.style.display = 'block';
        dropdownList.style.zIndex = '10000';
        dropdownList.style.position = 'absolute';
        
        if (searchInput.value.trim() === '') {
            // Si el input est√° vac√≠o, mostrar todos los modelos
            const items = dropdownList.querySelectorAll('.bom-dropdown-item');
            console.log('Items en dropdown:', items.length);
            items.forEach(item => {
                item.classList.remove('hidden');
            });
            
            // Si no hay items, llenar el dropdown
            if (items.length === 0 && modelosControlBOM.length > 0) {
                console.log('Dropdown vac√≠o, llenando con modelos...');
                llenarDropdownModelosControl();
            }
        }
        
        console.log('Dropdown configurado - display:', dropdownList.style.display);
        console.log('=== fin mostrarDropdownControl() ===');
    }

    // Funci√≥n para seleccionar un modelo del dropdown de Control de Modelos
    function seleccionarModeloControl(modelo) {
        const searchInput = document.getElementById('modeloSelector');
        const dropdownList = document.getElementById('modeloDropdownList');
        
        searchInput.value = modelo;
        dropdownList.style.display = 'none';
        
        console.log('Modelo seleccionado para Control de Modelos:', modelo);
    }

    // Funci√≥n para cargar modelo seleccionado
    function cargarModeloSeleccionado() {
        const modeloSelector = document.getElementById('modeloSelector');
        const modeloSeleccionado = modeloSelector.value.trim();
        
        if (!modeloSeleccionado) {
            mostrarMensajeModelos('Por favor seleccione un modelo', 'error');
            return;
        }
        
        // Mostrar informaci√≥n del modelo
        const infoContainer = document.getElementById('modeloInfoContainer');
        infoContainer.style.display = 'block';
        
        // Ocultar container sin datos
        ocultarContainerSinDatos();
        
        // Llenar datos del modelo
        document.getElementById('modeloCodigo').textContent = modeloSeleccionado;
        document.getElementById('modeloNombre').textContent = modeloSeleccionado;
        document.getElementById('modeloDescripcion').textContent = 'Informaci√≥n detallada del modelo ' + modeloSeleccionado;
        document.getElementById('modeloEstado').textContent = 'Activo';
        
        mostrarMensajeModelos(`Modelo ${modeloSeleccionado} cargado exitosamente`, 'success');
    }

    // Funci√≥n para limpiar selecci√≥n de modelo
    function limpiarSeleccionModelo() {
        const modeloSelector = document.getElementById('modeloSelector');
        const dropdownList = document.getElementById('modeloDropdownList');
        const infoContainer = document.getElementById('modeloInfoContainer');
        
        modeloSelector.value = '';
        dropdownList.style.display = 'none';
        infoContainer.style.display = 'none';
        
        // Limpiar datos
        document.getElementById('modeloCodigo').textContent = '-';
        document.getElementById('modeloNombre').textContent = '-';
        document.getElementById('modeloDescripcion').textContent = '-';
        document.getElementById('modeloEstado').textContent = '-';
        
        mostrarMensajeModelos('Selecci√≥n limpiada', 'success');
    }

    // Actualizar contador de modelos
    function actualizarContadorModelos() {
        const contador = document.getElementById('modeloResultCounter');
        if (contador) {
            contador.textContent = `Modelos disponibles: ${modelosControlBOM.length}`;
        }
    }

    // Mostrar container sin datos
    function mostrarContainerSinDatos() {
        const sinDatosContainer = document.getElementById('modeloSinDatosContainer');
        const infoContainer = document.getElementById('modeloInfoContainer');
        
        if (sinDatosContainer) {
            sinDatosContainer.style.display = 'block';
        }
        if (infoContainer) {
            infoContainer.style.display = 'none';
        }
    }

    // Ocultar container sin datos
    function ocultarContainerSinDatos() {
        const sinDatosContainer = document.getElementById('modeloSinDatosContainer');
        if (sinDatosContainer) {
            sinDatosContainer.style.display = 'none';
        }
    }

    // Funci√≥n para ir a Control de BOM
    function irAControlBOM() {
        if (typeof window.mostrarControlBOMInfo === 'function') {
            window.mostrarControlBOMInfo();
            mostrarMensajeModelos('Redirigiendo a Control de BOM...', 'success');
        } else {
            mostrarMensajeModelos('Error: No se pudo acceder a Control de BOM', 'error');
        }
    }

    // Funci√≥n para mostrar mensajes espec√≠ficos de Control de Modelos
    function mostrarMensajeModelos(mensaje, tipo) {
        const msgDiv = document.createElement('div');
        msgDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 400px;
            background-color: ${tipo === 'success' ? '#27ae60' : tipo === 'warning' ? '#f39c12' : '#e74c3c'};
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        msgDiv.textContent = mensaje;
        
        document.body.appendChild(msgDiv);
        
        // Eliminar despu√©s de 4 segundos
        setTimeout(() => {
            if (document.body.contains(msgDiv)) {
                document.body.removeChild(msgDiv);
            }
        }, 4000);
    }

    // Event listener para cerrar dropdown cuando se hace clic fuera (Control de Modelos)
    document.addEventListener('click', function(event) {
        const modeloSearchContainer = document.querySelector('.bom-search-container');
        const modeloDropdownList = document.getElementById('modeloDropdownList');
        
        if (modeloSearchContainer && !modeloSearchContainer.contains(event.target)) {
            if (modeloDropdownList) {
                modeloDropdownList.style.display = 'none';
            }
        }
    });

    // ===== FIN FUNCIONES PARA CONTROL DE MODELOS =====


})();</script>

</body>
</html>
